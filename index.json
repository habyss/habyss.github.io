[{"content":"ç®€å•demoå®ç° ç®€å•å®ç°, ä»¥å¤§æ–‡ä»¶çš„md5ä½œä¸ºå”¯ä¸€key\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 @Slf4j @Api(tags = \u0026#34;å¤§æ–‡ä»¶ä¸Šä¼ \u0026#34;) @RestController @RequestMapping(\u0026#34;dict\u0026#34;) public class BigFileController { public static final String tmpPath = \u0026#34;E:/data/tempAppfiles/\u0026#34;; public static final String finalPath = \u0026#34;E:/data/finalAppfiles/\u0026#34;; private static final Map\u0026lt;String, Integer\u0026gt; chunkMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); /** * ä¸Šä¼ æ–‡ä»¶ * * @param dto dto * @return {@link String} */ @PostMapping(\u0026#34;uploadFile\u0026#34;) public ResponseResult\u0026lt;?\u0026gt; uploadFile(UploadFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); String tmpFileName = tmpPath + md5 + \u0026#34;/\u0026#34; + dto.getIndex() + \u0026#34;.tmp\u0026#34;; // åˆ†ç‰‡ç§’ä¼  if (chunkMap.get(tmpFileName) != null) { return ResponseResult.createBySuccess(); } createTmpPath(tmpPath + md5); try { FileCopyUtils.copy(dto.getFile().getBytes(), new File(tmpFileName)); } catch (IOException e) { e.printStackTrace(); throw new ServiceException(\u0026#34;æ–‡ä»¶ä¸Šä¼ å¤±è´¥\u0026#34;); } chunkMap.put(tmpFileName, dto.getIndex()); return ResponseResult.createBySuccess(); } /** * åˆå¹¶æ–‡ä»¶ * * @param dto dto * @return {@link String} */ @PostMapping(\u0026#34;mergeFile\u0026#34;) public ResponseResult\u0026lt;?\u0026gt; mergeFile(@RequestBody MergeFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); createTmpPath(finalPath + md5); try (Stream\u0026lt;Path\u0026gt; pathStream = Files.list(Paths.get(tmpPath + md5 + \u0026#34;/\u0026#34;));) { byte[] reduce = pathStream .sorted((s1, s2) -\u0026gt; { int n1 = Integer.parseInt(s1.getFileName().toString().split(\u0026#34;\\\\.\u0026#34;, 0)[0]); int n2 = Integer.parseInt(s2.getFileName().toString().split(\u0026#34;\\\\.\u0026#34;, 0)[0]); return Integer.compare(n1, n2); }) .map(this::readByteByPath) .filter(Objects::nonNull) .reduce(new byte[]{}, this::addBytes); String s = DigestUtils.md5DigestAsHex(reduce); FileCopyUtils.copy(reduce, new File(finalPath + md5 + \u0026#34;/\u0026#34; + dto.getFileName())); deleteDir(tmpPath + md5); } catch (IOException e) { e.printStackTrace(); } return ResponseResult.createBySuccess(); } /** * åˆ é™¤åˆ†ç‰‡ * */ private void deleteDir(String path) { Path dir = Paths.get(path); try (Stream\u0026lt;Path\u0026gt; pathStream = Files.list(dir)) { pathStream.forEach(p -\u0026gt; { try { Files.delete(p); // åˆ é™¤åˆ†ç‰‡ç¼“å­˜ä¿¡æ¯ chunkMap.remove(p.toString()); } catch (IOException e) { e.printStackTrace(); } }); Files.delete(dir); } catch (IOException e) { e.printStackTrace(); } } /** * è¯»æ–‡ä»¶ * */ private byte[] readByteByPath(Path i) { try { return Files.readAllBytes(i); } catch (IOException e) { e.printStackTrace(); return null; } } /** * åˆå¹¶æ–‡ä»¶ * */ public byte[] addBytes(byte[] data1, byte[] data2) { byte[] data3 = new byte[data1.length + data2.length]; System.arraycopy(data1, 0, data3, 0, data1.length); System.arraycopy(data2, 0, data3, data1.length, data2.length); return data3; } /** * åˆ›å»ºæ–‡ä»¶å¤¹ * */ private void createTmpPath(String pathString) { Path path = Paths.get(pathString); // å¹¶å‘ if (Files.exists(path)){ return; } synchronized (this) { if (Files.notExists(path)) { try { Files.createDirectory(path); } catch (IOException e) { e.printStackTrace(); throw new ServiceException(\u0026#34;åˆ›å»ºå¤±è´¥\u0026#34;); } } } } @Data public static class UploadFileDTO { @ApiModelProperty(\u0026#34;æ–‡ä»¶MD5\u0026#34;) private String md5; @ApiModelProperty(\u0026#34;åˆ†ç‰‡æ–‡ä»¶åºå·\u0026#34;) private Integer index; @ApiModelProperty(\u0026#34;åˆ†ç‰‡æ–‡ä»¶\u0026#34;) private MultipartFile file; } @Data public static class MergeFileDTO { @ApiModelProperty(\u0026#34;æ–‡ä»¶MD5\u0026#34;) private String md5; @ApiModelProperty(\u0026#34;åŸæ–‡ä»¶å å¸¦åç¼€\u0026#34;) private String fileName; } } demoç”¨ä½œç”Ÿäº§æ—¶éœ€è¦ä¼˜åŒ–çš„ç‚¹ 1. å¯¹æ¥rediså’Œmysql åˆ†ç‰‡ä¸Šä¼ çš„çŠ¶æ€, æ–‡ä»¶ä¸Šä¼ çš„çŠ¶æ€, æ–‡ä»¶çš„åœ°å€ç­‰ä¿¡æ¯, å­˜å‚¨åœ¨æ•°æ®åº“ä¸­, æˆ–redisç¼“å­˜, è§†æƒ…å†µè€Œå®š\n2. å¯¹æ¥é˜¿é‡Œäº‘/å¤©ç¿¼äº‘ç­‰äº‘å¯¹è±¡å­˜å‚¨æœåŠ¡ ä¸€èˆ¬åœ¨é¡¹ç›®ä¸­éƒ½æ˜¯ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹çš„å¯¹è±¡å‚¬å‡ºæœåŠ¡, éœ€è¦å¯¹æ¥ä¸€ä¸‹, ä¸€èˆ¬ä¹Ÿéƒ½æœ‰åˆ†ç‰‡ä¸Šä¼ çš„api\n3. æ–­ç‚¹ç»­ä¼  å½“æˆ‘ä»¬æŠŠåˆ†ç‰‡ä¿¡æ¯å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ—¶å€™, ä¹‹åå°±å¯ä»¥é€šè¿‡md5 key(æˆ–è‡ªå®šä¹‰å”¯ä¸€key, ä½†å‰åç«¯éœ€è¦æ²Ÿé€šç»Ÿä¸€), æ¥è·å–ä¹‹å‰çš„åˆ†ç‰‡ä¸Šä¼ çŠ¶æ€\n4. æ ¡éªŒmd5 åŸºäºåç«¯ä¸å®Œå…¨ä¿¡ä»»å®¢æˆ·ç«¯çš„æ€æƒ³, åç«¯éœ€è¦ç®—å‡ºåˆ†ç‰‡æˆ–å¤§æ–‡ä»¶ç‰¹å¾(å‰åç«¯æ²Ÿé€šç»Ÿä¸€ç‰¹å¾çš„è§„åˆ™, egç¬¬ä¸€ä¸ªåˆ†ç‰‡+æœ€åä¸€ä¸ªåˆ†ç‰‡)çš„md5, ä¸å‰ç«¯ä¼ çš„md5æ˜¯å¦ä¸€è‡´.. ç­‰ç­‰ä¹‹ç±»çš„æ ¡éªŒ, è§†æƒ…å†µè€Œå®š\n5. ç§’ä¼  éœ€è¦ä¸€ä¸ªæ–°çš„æ¥å£, åœ¨åˆ†ç‰‡ä¸Šä¼ ä¹‹å‰ä»æ•°æ®åº“è·å–æ•´ä¸ªå¤§æ–‡ä»¶ç‰¹å¾å¯¹åº”çš„md5 å¯¹åº”çš„æ–‡ä»¶ä¸Šä¼ çŠ¶æ€\nå®Œå…¨æ— ä¿¡æ¯\nå°±æ˜¯æ²¡æœ‰ä¸Šä¼ è¿‡, éœ€è¦åˆ†ç‰‡ä¸Šä¼ \nä¸€éƒ¨åˆ†ä¿¡æ¯\nä¸Šä¼ è¿‡ä¸€éƒ¨åˆ†, å¯åšæ–­ç‚¹ç»­ä¼ çš„å‰æ\næ•´ä¸ªå¤§æ–‡ä»¶å·²ä¸Šä¼ \nç§’ä¼ çš„å‰æåˆ¤æ–­\n6. å¹¶å‘é—®é¢˜ åˆ†ç‰‡ä¸Šä¼ ä¸€èˆ¬ä¸ºå¹¶å‘çŠ¶æ€, éœ€è¦å¤„ç†å¥½ä»£ç çš„å¹¶å‘é—®é¢˜\n7. åˆ†ç‰‡è§„åˆ™ åˆ†ç‰‡çš„å¤§å°è§„åˆ™æ˜¯å¦ç”±æœåŠ¡ç«¯æ¥æ§åˆ¶, è§†æƒ…å†µè€Œå®š\n8. å¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶ æ³¨æ„ç‚¹: æ–‡ä»¶éœ€è¦é¡ºåºåˆå¹¶, ä¸èƒ½ä¹±åº\næ€è·¯:\nå°†æ–‡ä»¶åºå·, å’Œæ–‡ä»¶æå–, æ”¾åœ¨Pairä¸­, å¹¶æ’åº\n1 2 3 List\u0026lt;Pair\u0026lt;Integer, byte[]\u0026gt;\u0026gt; pairs = pathStream .map(p -\u0026gt; Pair.of(Integer.parseInt(p.getFileName().toString().split(\u0026#34;\\\\.\u0026#34;, 0)[0]), readByteByPath(p))) .toList(); åˆ©ç”¨streamçš„groupingByå’Œmapping, å¯¹åºå·æ•´é™¤5åˆ†ç»„, åˆ†æˆä¸€å †ä¸€å †çš„\n1 2 3 Map\u0026lt;Integer, List\u0026lt;byte[]\u0026gt;\u0026gt; collect = pairs.stream() .sorted(Comparator.comparingInt(Pair::getKey)) .collect(Collectors.groupingBy(p -\u0026gt; p.getKey() / 5, Collectors.mapping(Pair::getValue, Collectors.toList()))); ä½¿ç”¨å¤šçº¿ç¨‹, æ¯å †ä¸€ä¸ªçº¿ç¨‹, å°†æ¯ä¸€å †åˆå¹¶\næ–¹å¼ä¸€: å¹¶è¡Œæµ\n1 2 3 4 5 pairs = joinPool.submit(() -\u0026gt; collect.entrySet().parallelStream() .map(entry -\u0026gt; Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes))) .toList() ).get(); æ–¹å¼äºŒ: CompletableFuture+è‡ªå®šä¹‰çº¿ç¨‹æ± \n1 2 3 4 pairs = collect.entrySet().stream() .map(en -\u0026gt; CompletableFuture.supplyAsync(() -\u0026gt; mergeBytes(en), executorService)) .map(CompletableFuture::join) .collect(Collectors.toList()); åˆ¤æ–­åˆå¹¶ålistçš„å¤§å°, å¦‚æœè¿˜æœ‰å¾ˆå¤š, åˆ™ç»§ç»­ç¬¬äºŒæ­¥, å¦åˆ™å†™å…¥æ–‡ä»¶(ä¹Ÿå°±æ˜¯å·²ç»åˆå¹¶å®Œäº†, åªå‰©ä¸‹ä¸€ä¸ª)\n1 2 3 4 5 while (pairs.size() \u0026gt; 1) {...} FileCopyUtils.copy(pairs.get(0).getValue(), new File(finalPath + md5 + \u0026#34;/\u0026#34; + dto.getFileName())); deleteDir(tmpPath + md5); æ–¹å¼ä¸€: ä½¿ç”¨æŒ‡å®šçº¿ç¨‹æ•°çš„å¹¶è¡Œæµ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 /** * åˆå¹¶æ–‡ä»¶ * * @param dto dto * @return {@link String} */ @PostMapping(\u0026#34;mergeFile\u0026#34;) public ResponseResult\u0026lt;?\u0026gt; mergeFile(@RequestBody MergeFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); createTmpPath(finalPath + md5); ForkJoinPool joinPool = new ForkJoinPool(5); try (Stream\u0026lt;Path\u0026gt; pathStream = Files.list(Paths.get(tmpPath + md5 + \u0026#34;/\u0026#34;));) { List\u0026lt;Pair\u0026lt;Integer, byte[]\u0026gt;\u0026gt; pairs = pathStream .map(p -\u0026gt; Pair.of(Integer.parseInt(p.getFileName().toString().split(\u0026#34;\\\\.\u0026#34;, 0)[0]), readByteByPath(p))) .toList(); while (pairs.size() \u0026gt; 1) { Map\u0026lt;Integer, List\u0026lt;byte[]\u0026gt;\u0026gt; collect = pairs.stream() .sorted(Comparator.comparingInt(Pair::getKey)) .collect(Collectors.groupingBy(p -\u0026gt; p.getKey() / 5, Collectors.mapping(Pair::getValue, Collectors.toList()))); pairs = joinPool.submit(() -\u0026gt; collect.entrySet().parallelStream() .map(entry -\u0026gt; Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes))) .toList() ).get(); } FileCopyUtils.copy(pairs.get(0).getValue(), new File(finalPath + md5 + \u0026#34;/\u0026#34; + dto.getFileName())); deleteDir(tmpPath + md5); } catch (Exception e) { e.printStackTrace(); } return ResponseResult.createBySuccess(); } æŒ‡å®šçº¿ç¨‹æ•°\n1 ForkJoinPool joinPool = new ForkJoinPool(5); æäº¤\n1 2 3 4 5 pairs = joinPool.submit(() -\u0026gt; collect.entrySet().parallelStream() .map(entry -\u0026gt; Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes))) .toList() ).get(); æ–¹å¼äºŒ: CompletableFuture+è‡ªå®šä¹‰çº¿ç¨‹æ±  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @PostMapping(\u0026#34;mergeFile\u0026#34;) public ResponseResult\u0026lt;?\u0026gt; mergeFile(@RequestBody MergeFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); createTmpPath(finalPath + md5); ExecutorService executorService = Executors.newFixedThreadPool(5); try (Stream\u0026lt;Path\u0026gt; pathStream = Files.list(Paths.get(tmpPath + md5 + \u0026#34;/\u0026#34;));) { List\u0026lt;Pair\u0026lt;Integer, byte[]\u0026gt;\u0026gt; pairs = pathStream .map(p -\u0026gt; Pair.of(Integer.parseInt(p.getFileName().toString().split(\u0026#34;\\\\.\u0026#34;, 0)[0]), readByteByPath(p))) .toList(); while (pairs.size() \u0026gt; 1) { Map\u0026lt;Integer, List\u0026lt;byte[]\u0026gt;\u0026gt; collect = pairs.stream() .sorted(Comparator.comparingInt(Pair::getKey)) .collect(Collectors.groupingBy(p -\u0026gt; p.getKey() / 5, Collectors.mapping(Pair::getValue, Collectors.toList()))); pairs = collect.entrySet().stream() .map(en -\u0026gt; CompletableFuture.supplyAsync(() -\u0026gt; mergeBytes(en), executorService)) .map(CompletableFuture::join) .collect(Collectors.toList()); } FileCopyUtils.copy(pairs.get(0).getValue(), new File(finalPath + md5 + \u0026#34;/\u0026#34; + dto.getFileName())); deleteDir(tmpPath + md5); } catch (Exception e) { e.printStackTrace(); } return ResponseResult.createBySuccess(); } public Pair\u0026lt;Integer, byte[]\u0026gt; mergeBytes(Map.Entry\u0026lt;Integer, List\u0026lt;byte[]\u0026gt;\u0026gt; entry) { return Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes)); } è‡ªå®šä¹‰çº¿ç¨‹æ± , æˆ–ä½¿ç”¨new Executor(\u0026hellip;\u0026hellip;);\n1 ExecutorService executorService = Executors.newFixedThreadPool(5); ä½¿ç”¨CompletableFuture\n1 2 3 4 pairs = collect.entrySet().stream() .map(en -\u0026gt; CompletableFuture.supplyAsync(() -\u0026gt; mergeBytes(en), executorService)) .map(CompletableFuture::join) .collect(Collectors.toList()); ä¼˜åŒ–ç‚¹ whileä¸­çš„æ¡ä»¶å¯ä»¥æ”¹å¤§ä¸€ç‚¹, ä¹Ÿå°±æ˜¯å®ç°åˆ†æƒ…å†µå¼€å¯å¤šçº¿ç¨‹, å½“æ–‡ä»¶æ•°è¶³å¤Ÿå¤šçš„æ—¶å€™å¼€å¯å¤šçº¿ç¨‹, å¦åˆ™ç›´æ¥ä¸»çº¿ç¨‹åˆå¹¶, è¿™æ ·å¯ä»¥é¿å…çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€, è§†æƒ…å†µè€Œå®š.\n","permalink":"https://habyss.github.io/posts/tech/big_file_upload/","summary":"ç®€å•demoå’Œå¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶ä¼˜åŒ–","title":"å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ "},{"content":"ğŸ’¡ ä¸å¯ä»¥å¯¹æŸ¥è¯¢å‚æ•°åŠ è§£å¯†\nğŸ’¡ ä¸ä¼šä¿®æ”¹åŸå¯¹è±¡æ•°æ®\nğŸ’¡ å¯¹äºæ‰‹å†™sqléœ€è¦ç‰¹æ®ŠæŒ‡å®š\nğŸ’¡ å¯¹äºésqlçš„CRUDå¯è‡ªåŠ¨åŠ è§£å¯†\n1. ésqlæŸ¥è¯¢ â€” æ•°æ®åº“å®ä½“ç±» 1 2 3 4 @TableName(value = \u0026#34;t_user_auth\u0026#34;, autoResultMap = true) @TableField(typeHandler = CryptHandler.class) private String cardNo; 2. ésqlæŸ¥è¯¢ â€” typrHandlerå®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Slf4j public class CryptHandler extends BaseTypeHandler\u0026lt;String\u0026gt; { @Override public void setNonNullParameter(PreparedStatement ps, int i, String parameter, JdbcType jdbcType) throws SQLException { log.warn(parameter); ps.setString(i, \u0026#34;DESUtil.encrypt(parameter)\u0026#34;); } @Override public String getNullableResult(ResultSet rs, String columnName) throws SQLException { String string = rs.getString(columnName); log.warn(string); return \u0026#34;DESUtil.decrypt(string)\u0026#34;; } @Override public String getNullableResult(ResultSet rs, int columnIndex) throws SQLException { String string = rs.getString(columnIndex); log.warn(string); return \u0026#34;DESUtil.decrypt(string)\u0026#34;; } @Override public String getNullableResult(CallableStatement cs, int columnIndex) throws SQLException { String string = cs.getString(columnIndex); log.warn(string); return \u0026#34;DESUtil.decrypt(string)\u0026#34;; } } 3. sqlæŸ¥è¯¢ â€” å…¶ä»–å¤æ‚æŸ¥è¯¢ 1 2 3 4 \u0026lt;resultMap id=\u0026#34;filterListMap\u0026#34; type=\u0026#34;com.somenet.response.patient.MPatientFilterResponse\u0026#34;\u0026gt; \u0026lt;result column=\u0026#34;card_no\u0026#34; property=\u0026#34;cardNo\u0026#34; typeHandler=\u0026#34;com.somenet.handler.crypt.CryptHandler\u0026#34; /\u0026gt; \u0026lt;/resultMap\u0026gt; \u0026lt;select id=\u0026#34;filterList\u0026#34; resultMap=\u0026#34;filterListMap\u0026#34; \u0026gt; ","permalink":"https://habyss.github.io/posts/tech/mybatis_plus_typehandler/","summary":"ğŸ’¡ ä¸å¯ä»¥å¯¹æŸ¥è¯¢å‚æ•°åŠ è§£å¯† ğŸ’¡ ä¸ä¼šä¿®æ”¹åŸå¯¹è±¡æ•°æ® ğŸ’¡ å¯¹äºæ‰‹å†™sqléœ€è¦ç‰¹æ®ŠæŒ‡å®š ğŸ’¡ å¯¹äºésqlçš„CRUDå¯è‡ªåŠ¨åŠ è§£å¯† 1. ésqlæŸ¥è¯¢ â€” æ•°æ®åº“å®ä½“ç±» 1 2","title":"åŸºäºmybatis-plus typeHandler åŠ è§£å¯†ç®€å•å®ç°"},{"content":"æ€è·¯ è¡¨ç»“æ„:\n1 2 3 4 5 6 7 8 9 create table scar_test.h_sort_table ( id bigint auto_increment primary key, `sort` bigint not null, update_time datetime null, create_time datetime null ) comment \u0026#39;æµ‹è¯•\u0026#39;; sortä¸ºåºå·, åˆå§‹é—´éš”ä¸º2^10=1024, ç±»å‹ä¸ºlong\næ–°å¢æ•°æ®æ—¶, éœ€è¦å…ˆæŸ¥å‡ºæœ€å¤§sort, ç„¶ååŠ ä¸Š2^10=1024\nå‰ç«¯ä¼ å‚æ•°æ®:\n1 2 3 4 5 6 7 8 { \u0026#34;currentId\u0026#34;: 23, \u0026#34;currentIndex\u0026#34;: 8, \u0026#34;preSort\u0026#34;: 21505, \u0026#34;nextSort\u0026#34;: 21504, \u0026#34;pageNum\u0026#34;: 1, \u0026#34;pageSize\u0026#34;: 10 } å½“æ‹–æ‹½åˆ°ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶, preSortä¸ºnull\nå½“æ‹–æ‹½åˆ°æœ€åä¸€ä¸ªå…ƒç´ æ—¶, nextSortä¸ºnull\næ­£å¸¸æ’åº: currentSort = (preSort - nextSort) / 2 + nextSort\né‡æ–°æ’åº: å°†æ­¤é¡µæ•°æ®ä»æ•°æ®åº“å…¨éƒ¨æŸ¥å‡º, è®¡ç®—å¹³å‡é—´éš”, æ‰¹é‡æ›´æ–°\nå¯èƒ½æƒ…å†µ:\n(preSort - nextSort) / 2 \u0026lt;= 0 æ­¤æ—¶å‰åå…ƒç´ ä¹‹é—´å·²ç»æ²¡æœ‰é—´éš”å¯ä»¥æ’å…¥å½“å‰å…ƒç´ , éœ€è¦*[é‡æ–°æ’åº]*\n(preSort - nextSort) / 2 \u0026gt; 0\næ­¤æ—¶å‰åå…ƒç´ ä¹‹é—´æœ‰é—´éš”, å¯ä»¥*[æ­£å¸¸æ’åº]*\npreSort == null\næ­¤æ—¶ä¸çŸ¥é“ä¸Šä¸€é¡µçš„æœ€åä¸€ä¸ªå…ƒç´ çš„sort, ç›´æ¥*[é‡æ–°æ’åº]*\nnextSort == null\næ­¤æ—¶ä¸çŸ¥é“ä¸‹ä¸€é¡µçš„æœ€åä¸€ä¸ªå…ƒç´ çš„sort, ç›´æ¥*[é‡æ–°æ’åº]*\nä»£ç å®ç° lomboké¡¹ç›®æ ¹è·¯å¾„å·²é…ç½®é»˜è®¤å…¨å±€é…ç½®, lombok.config\n1 2 3 config.stopBubbling=true lombok.equalsAndHashCode.callSuper=call lombok.accessors.chain=true å‰åç«¯äº¤äº’å…¥å‚ SortParam 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Data public class SortParam { // å½“å‰å…ƒç´ id private Long currentId; // å½“å‰å…ƒç´ åœ¨listä¸­çš„index private Integer currentIndex; // å‰ä¸€ä¸ªå…ƒç´ çš„sort æ‹–æ‹½åˆ°ç¬¬ä¸€ä¸ªæ—¶ä¸ºnull private Long preSort; // åä¸€ä¸ªå…ƒç´ çš„sort æ‹–æ‹½åˆ°æœ€åä¸€ä¸ªæ—¶ä¸ºnull private Long nextSort; // åˆ†é¡µå‚æ•° private Integer pageNum = 10; private Integer pageSize = 10; /** * éœ€è¦é‡æ–°æ’åº * * @return boolean */ public boolean needReSort() { return preSort == null || nextSort == null || (preSort - nextSort) / 2 \u0026lt;= 0; } /** * è®¡ç®—å½“å‰åºå· * * @return {@link Long} */ public Long calcCurrentSort() { return (preSort - nextSort) / 2 + nextSort; } } eg:\n1 2 3 4 5 6 7 8 { \u0026#34;currentId\u0026#34;: 23, \u0026#34;currentIndex\u0026#34;: 8, \u0026#34;preSort\u0026#34;: 21505, \u0026#34;nextSort\u0026#34;: 21504, \u0026#34;pageNum\u0026#34;: 1, \u0026#34;pageSize\u0026#34;: 10 } vo 1 2 3 4 5 @Data public class SortDataVo { private Long id; private Long sort; } entity 1 2 3 4 5 6 7 8 9 10 @Getter @Setter @TableName(\u0026#34;h_sort_table\u0026#34;) @ApiModel(value = \u0026#34;SortTableå¯¹è±¡\u0026#34;, description = \u0026#34;æµ‹è¯•\u0026#34;) public class SortTable extends BaseEntity { private static final long serialVersionUID = 1L; private Long sort; } base 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Data public class BaseEntity { @ApiModelProperty(\u0026#34;ID\u0026#34;) @TableId(value = \u0026#34;id\u0026#34;, type = IdType.AUTO) private Long id; @ApiModelProperty(\u0026#34;æ›´æ–°æ—¶é—´\u0026#34;) @TableField(fill = FieldFill.INSERT_UPDATE) private LocalDateTime updateTime; @ApiModelProperty(\u0026#34;åˆ›å»ºæ—¶é—´\u0026#34;) @TableField(fill = FieldFill.INSERT) private LocalDateTime createTime; @ApiModelProperty(\u0026#34;ä¿ç•™|åˆ é™¤\u0026#34;) @TableLogic private Boolean deleted; } controllerä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 @Slf4j @RestController @RequestMapping(\u0026#34;dict\u0026#34;) public class DictController { @Resource private ISortTableService sortTableService; /** * æ’åº * * @param sortParam æ’åºå‚æ•° * @return {@link ResponseResult}\u0026lt;{@link PageVo}\u0026lt;{@link SortDataVo}\u0026gt;\u0026gt; */ @PostMapping(\u0026#34;sort\u0026#34;) public ResponseResult\u0026lt;PageVo\u0026lt;SortDataVo\u0026gt;\u0026gt; sort(@RequestBody SortParam sortParam) { if (sortParam.needReSort()) { sortTableService.reSort(sortParam); }else { sortTableService.normalSort(sortParam); } PageVo\u0026lt;SortDataVo\u0026gt; pageVo = sortTableService.pageList(sortParam); return ResponseResult.createBySuccess(pageVo); } /** * æµ‹è¯•åˆå§‹åŒ–æ•°æ® * * @return {@link ResponseResult}\u0026lt;{@link ?}\u0026gt; */ @PostMapping(\u0026#34;init\u0026#34;) public ResponseResult\u0026lt;?\u0026gt; init() { sortTableService.init(); return ResponseResult.createBySuccess(); } } serviceä»£ç  service\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 public interface ISortTableService extends IService\u0026lt;SortTable\u0026gt; { /** * é‡æ–°æ’åº * * @param sortParam æ’åºå‚æ•° */ void reSort(SortParam sortParam); /** * æ­£å¸¸æ’åº * * @param sortParam æ’åºå‚æ•° */ void normalSort(SortParam sortParam); /** * åˆ†é¡µæŸ¥è¯¢ * * @param sortParam æ’åºå‚æ•° */ PageVo\u0026lt;SortDataVo\u0026gt; pageList(SortParam sortParam); void init(); } serviceImpl\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 @Service public class SortTableServiceImpl extends ServiceImpl\u0026lt;SortTableMapper, SortTable\u0026gt; implements ISortTableService { @Resource SortTableMapper sortTableMapper; @Override public void reSort(SortParam sortParam) { // é‡æ’æ—¶è·å–å½“å‰é¡µæ•°æ® List\u0026lt;SortDataVo\u0026gt; records = pageList(sortParam).getRecords(); int size = records.size(); Long maxSort = records.get(0).getSort(); Long minSort = records.get(size - 1).getSort(); // è®¡ç®—é‡æ’é—´éš” long intervalSort = (maxSort - minSort) / (size - 1); // å…ˆç§»å½“å‰å…ƒç´  records.removeIf(r -\u0026gt; Objects.equals(r.getId(), sortParam.getCurrentId())); // æ ¹æ®å…¥å‚çš„index æ”¾ç½®å½“å‰å…ƒç´  records.add(sortParam.getCurrentIndex(), new SortDataVo().setId(sortParam.getCurrentId())); // é‡æ’ é‡æ–°åˆ†é…sort for (SortDataVo record : records) { record.setSort(maxSort); maxSort -= intervalSort; } // ç»„è£…æ•°æ® æ‰¹é‡æ›´æ–° List\u0026lt;SortTable\u0026gt; sortTables = MapperUtil.mapAsList(records, SortTable.class); this.updateBatchById(sortTables); } @Override public void normalSort(SortParam sortParam) { // è®¡ç®—å½“å‰å…ƒç´ sort Long currentIndex = sortParam.calcCurrentSort(); SortTable sortTable = new SortTable().setSort(currentIndex); sortTable.setId(sortParam.getCurrentId()); sortTableMapper.updateById(sortTable); } @Override public PageVo\u0026lt;SortDataVo\u0026gt; pageList(SortParam sortParam) { Page\u0026lt;SortTable\u0026gt; page = PageHelper.startPage(sortParam) .doSelectPage(() -\u0026gt; sortTableMapper.selectList( Wrappers.\u0026lt;SortTable\u0026gt;lambdaQuery().orderByDesc(SortTable::getSort) ) ); return PageUtil.convertPage(page, SortDataVo.class); } @Override public void init() { long intervalSort = 1024; AtomicLong init = new AtomicLong(); List\u0026lt;SortTable\u0026gt; sortTables = IntStream.rangeClosed(1, 30) .mapToObj((r -\u0026gt; new SortTable().setSort(init.addAndGet(intervalSort)))) .toList(); this.saveBatch(sortTables); } } å·¥å…·ç±» MapperUtil, å¯¹BeanUtilsç®€å•å°è£…\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public class MapperUtil { public static \u0026lt;T, S\u0026gt; List\u0026lt;T\u0026gt; mapAsList(Collection\u0026lt;S\u0026gt; source, Class\u0026lt;T\u0026gt; target) { return source.stream().map(one -\u0026gt; map(one, target)).collect(Collectors.toList()); } public static \u0026lt;T, S\u0026gt; T map(S source, Class\u0026lt;T\u0026gt; target) { if (source == null) { return null; } T result; try { result = target.getDeclaredConstructor().newInstance(); } catch (InstantiationException | IllegalAccessException | InvocationTargetException | NoSuchMethodException ex) { throw new RuntimeException(ex); } BeanUtils.copyProperties(source, result); return result; } } PageUtil, åˆ†é¡µç»“æœç®€å•è½¬æ¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public class PageUtil { public static \u0026lt;T\u0026gt; PageVo\u0026lt;T\u0026gt; convertPage(Page\u0026lt;T\u0026gt; page) { return new PageVo\u0026lt;\u0026gt;(page.getPageNum(), page.getPageSize(), page.getTotal(), page.getResult()); } public static \u0026lt;V, T\u0026gt; PageVo\u0026lt;V\u0026gt; convertPage(Page\u0026lt;T\u0026gt; page, Class\u0026lt;V\u0026gt; vClass) { List\u0026lt;V\u0026gt; list = new ArrayList\u0026lt;\u0026gt;(); if (!CollectionUtils.isEmpty(page.getResult())) { list = MapperUtil.mapAsList(page.getResult(), vClass); } return new PageVo\u0026lt;\u0026gt;(page.getPageNum(), page.getPageSize(), page.getTotal(), list); } } å¦å¤– å¦‚æœé‡æ–°æ’åºçš„çš„å‰ç½®è®¡ç®—å‰ç«¯æ¥åšçš„è¯, å¯ä»¥çœå»åç«¯å»æ•°æ®åº“æŸ¥è¯¢å½“é¡µæ•°æ®, å› ä¸ºå‰ç«¯å·²ç»æœ‰äº†æ­¤é¡µçš„æ‰€æœ‰æ•°æ®.\nå½“æ—¶å¹¶æ²¡æœ‰é«˜å¹¶å‘åœºæ™¯, ç”¨æˆ·æ’åºä»…ä»…åªèƒ½æ’è‡ªå·±çš„æ•°æ®, ä¹Ÿå°±ä¸æ¶‰åŠå¹¶å‘ä¸‹çš„æ’åº\n","permalink":"https://habyss.github.io/posts/tech/%E6%8B%96%E6%8B%BD%E6%8E%92%E5%BA%8F/","summary":"æ€è·¯ è¡¨ç»“æ„: 1 2 3 4 5 6 7 8 9 create table scar_test.h_sort_table ( id bigint auto_increment primary key, `sort` bigint not null, update_time datetime null, create_time datetime null ) comment \u0026#39;æµ‹è¯•\u0026#39;; sortä¸ºåºå·, åˆå§‹é—´éš”ä¸º2^10=102","title":"æ‹–æ‹½æ’åºå®ç°"},{"content":"ä¸€ã€è¶…æ—¶ä¼˜åŒ– OpenFeign åº•å±‚å†…ç½®äº† Ribbon æ¡†æ¶ï¼Œå¹¶ä¸”ä½¿ç”¨äº† Ribbon çš„è¯·æ±‚è¿æ¥è¶…æ—¶æ—¶é—´å’Œè¯·æ±‚å¤„ç†è¶…æ—¶æ—¶é—´ä½œä¸ºå…¶è¶…æ—¶æ—¶é—´ï¼Œè€Œ Ribbon é»˜è®¤çš„è¯·æ±‚è¿æ¥è¶…æ—¶æ—¶é—´å’Œè¯·æ±‚å¤„ç†è¶…æ—¶æ—¶é—´éƒ½æ˜¯ 1s, å½“æˆ‘ä»¬ä½¿ç”¨ OpenFeign è°ƒç”¨äº†æœåŠ¡æ¥å£è¶…è¿‡ 1sï¼Œå°±ä¼šå‡ºç°é”™è¯¯.\nå› ä¸º 1s ç¡®å®å¤ªçŸ­äº†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è®¾ç½® OpenFeign çš„è¶…æ—¶æ—¶é—´ä»¥ä¿è¯å®ƒèƒ½æ­£ç¡®çš„å¤„ç†ä¸šåŠ¡ã€‚OpenFeign çš„è¶…æ—¶æ—¶é—´æœ‰ä»¥ä¸‹ä¸¤ç§æ›´æ”¹æ–¹æ³•ï¼š\né€šè¿‡ä¿®æ”¹ Ribbon çš„è¶…æ—¶æ—¶é—´ï¼Œè¢«åŠ¨çš„ä¿®æ”¹ OpenFeign çš„è¶…æ—¶æ—¶é—´ã€‚ ç›´æ¥ä¿®æ”¹ OpenFeign çš„è¶…æ—¶æ—¶é—´(æ¨èä½¿ç”¨)ã€‚ 1ã€è®¾ç½®Ribbonè¶…æ—¶æ—¶é—´(æœªéªŒè¯) åœ¨é¡¹ç›®é…ç½®æ–‡ä»¶ application.yml ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š\n1 2 3 ribbon: ReadTimeout: 5000 # è¯·æ±‚è¿æ¥çš„è¶…æ—¶æ—¶é—´ ConnectionTimeout: 10000 # è¯·æ±‚å¤„ç†çš„è¶…æ—¶æ—¶é—´ 2ã€è®¾ç½®OpenFeignè¶…æ—¶æ—¶é—´ åœ¨é¡¹ç›®é…ç½®æ–‡ä»¶ application.yml ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š\n1 2 3 4 5 6 feign: client: config: default: connect-timeout: 2000 read-timeout: 5000 æ¨èä½¿ç”¨æ­¤æ–¹å¼æ¥è®¾ç½® OpenFeign çš„è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºè¿™æ ·çš„é…ç½®è¯­ä¹‰æ›´æ˜ç¡®ã€‚\näºŒã€è¯·æ±‚è¿æ¥ä¼˜åŒ– OpenFeign åº•å±‚é€šä¿¡ç»„ä»¶é»˜è®¤ä½¿ç”¨ JDK è‡ªå¸¦çš„ URLConnection å¯¹è±¡è¿›è¡Œ HTTP è¯·æ±‚çš„ï¼Œå› ä¸ºæ²¡æœ‰ä½¿ç”¨è¿æ¥æ± ï¼Œæ‰€ä»¥æ€§èƒ½ä¸æ˜¯å¾ˆå¥½ã€‚æˆ‘ä»¬å¯ä»¥å°† OpenFeign çš„é€šè®¯ç»„ä»¶ï¼Œæ‰‹åŠ¨æ›¿æ¢æˆåƒ Apache HttpClient æˆ– OKHttp è¿™æ ·çš„ä¸“ç”¨é€šä¿¡ç»„ä»¶ï¼Œè¿™äº›çš„ä¸“ç”¨é€šä¿¡ç»„ä»¶è‡ªå¸¦è¿æ¥æ± å¯ä»¥æ›´å¥½åœ°å¯¹ HTTP è¿æ¥å¯¹è±¡è¿›è¡Œé‡ç”¨ä¸ç®¡ç†ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤§å¤§çš„æå‡ HTTP è¯·æ±‚çš„æ•ˆç‡ã€‚æ¥ä¸‹æ¥ä»¥ Apache HttpClient ä¸ºä¾‹ï¼Œæ¼”ç¤ºä¸€ä¸‹ä¸“ç”¨é€šè®¯ç»„ä»¶çš„ä½¿ç”¨ã€‚\n1ã€å¼•å…¥Apache HttpClientä¾èµ– åœ¨é¡¹ç›®çš„ä¾èµ–ç®¡ç†æ–‡ä»¶ pom.xml ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š\n1 2 3 4 5 6 7 8 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-starter-openfeign\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.github.openfeign\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;feign-httpclient\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; 2ã€å¼€å¯Apache HttpClientä½¿ç”¨ å¯åŠ¨ Apache HttpClient ç»„ä»¶ï¼Œåœ¨é¡¹ç›®é…ç½®æ–‡ä»¶ application.yml ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®,\n1 2 3 feign: httpclient: enabled: true ä¸‰ã€æ•°æ®å‹ç¼© OpenFeign é»˜è®¤ä¸ä¼šå¼€å¯æ•°æ®å‹ç¼©åŠŸèƒ½ï¼Œä½†æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨çš„å¼€å¯å®ƒçš„ Gzip å‹ç¼©åŠŸèƒ½ï¼Œè¿™æ ·å¯ä»¥æå¤§çš„æé«˜å®½å¸¦åˆ©ç”¨ç‡å’ŒåŠ é€Ÿæ•°æ®çš„ä¼ è¾“é€Ÿåº¦ï¼Œåœ¨é¡¹ç›®é…ç½®æ–‡ä»¶ application.yml ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 feign: compression: request: enabled: true # é»˜è®¤å°±æ˜¯è¿™äº›ç±»å‹ # mime-types: text/xml, application/xml, application/json min-request-size: 1024 response: enabled: true PSï¼šå¦‚æœæœåŠ¡æ¶ˆè´¹ç«¯çš„ CPU èµ„æºæ¯”è¾ƒç´§å¼ çš„è¯ï¼Œå»ºè®®ä¸è¦å¼€å¯æ•°æ®çš„å‹ç¼©åŠŸèƒ½ï¼Œå› ä¸ºæ•°æ®å‹ç¼©å’Œè§£å‹éƒ½éœ€è¦æ¶ˆè€— CPU çš„èµ„æºï¼Œè¿™æ ·åè€Œä¼šç»™ CPU å¢åŠ äº†é¢å¤–çš„è´Ÿæ‹…ï¼Œä¹Ÿä¼šå¯¼è‡´ç³»ç»Ÿæ€§èƒ½é™ä½ã€‚\nå››ã€è´Ÿè½½å‡è¡¡ä¼˜åŒ– OpenFeign åº•å±‚ä½¿ç”¨çš„æ˜¯ Ribbon åšè´Ÿè½½å‡è¡¡çš„ï¼ŒæŸ¥çœ‹æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒé»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥æ˜¯è½®è¯¢ç­–ç•¥\nç„¶è€Œé™¤äº†è½®è¯¢ç­–ç•¥ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰å…¶ä»– 6 ç§å†…ç½®çš„è´Ÿè½½å‡è¡¡ç­–ç•¥å¯ä»¥é€‰æ‹©ï¼Œè¿™äº›è´Ÿè½½å‡è¡¡ç­–ç•¥å¦‚ä¸‹ï¼š\n**æƒé‡ç­–ç•¥ï¼š**WeightedResponseTimeRuleï¼Œæ ¹æ®æ¯ä¸ªæœåŠ¡æä¾›è€…çš„å“åº”æ—¶é—´åˆ†é…ä¸€ä¸ªæƒé‡ï¼Œå“åº”æ—¶é—´è¶Šé•¿ï¼Œæƒé‡è¶Šå°ï¼Œè¢«é€‰ä¸­çš„å¯èƒ½æ€§ä¹Ÿå°±è¶Šä½ã€‚å®ƒçš„å®ç°åŸç†æ˜¯ï¼Œåˆšå¼€å§‹ä½¿ç”¨è½®è¯¢ç­–ç•¥å¹¶å¼€å¯ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œæ¯ä¸€æ®µæ—¶é—´æ”¶é›†ä¸€æ¬¡æ‰€æœ‰æœåŠ¡æä¾›è€…çš„å¹³å‡å“åº”æ—¶é—´ï¼Œç„¶åå†ç»™æ¯ä¸ªæœåŠ¡æä¾›è€…é™„ä¸Šä¸€ä¸ªæƒé‡ï¼Œæƒé‡è¶Šé«˜è¢«é€‰ä¸­çš„æ¦‚ç‡ä¹Ÿè¶Šå¤§ã€‚ **æœ€å°è¿æ¥æ•°ç­–ç•¥ï¼š**BestAvailableRuleï¼Œä¹Ÿå«æœ€å°å¹¶å‘æ•°ç­–ç•¥ï¼Œå®ƒæ˜¯éå†æœåŠ¡æä¾›è€…åˆ—è¡¨ï¼Œé€‰å–è¿æ¥æ•°æœ€å°çš„â¼€ä¸ªæœåŠ¡å®ä¾‹ã€‚å¦‚æœæœ‰ç›¸åŒçš„æœ€å°è¿æ¥æ•°ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨è½®è¯¢ç­–ç•¥è¿›è¡Œé€‰å–ã€‚ **åŒºåŸŸæ•æ„Ÿç­–ç•¥ï¼š**ZoneAvoidanceRuleï¼Œæ ¹æ®æœåŠ¡æ‰€åœ¨åŒºåŸŸ(zone)çš„æ€§èƒ½å’ŒæœåŠ¡çš„å¯ç”¨æ€§æ¥é€‰æ‹©æœåŠ¡å®ä¾‹ï¼Œåœ¨æ²¡æœ‰åŒºåŸŸçš„ç¯å¢ƒä¸‹ï¼Œè¯¥ç­–ç•¥å’Œè½®è¯¢ç­–ç•¥ç±»ä¼¼ã€‚ **å¯ç”¨æ•æ„Ÿæ€§ç­–ç•¥ï¼š**AvailabilityFilteringRuleï¼Œå…ˆè¿‡æ»¤æ‰éå¥åº·çš„æœåŠ¡å®ä¾‹ï¼Œç„¶åå†é€‰æ‹©è¿æ¥æ•°è¾ƒå°çš„æœåŠ¡å®ä¾‹ã€‚ **éšæœºç­–ç•¥ï¼š**RandomRuleï¼Œä»æœåŠ¡æä¾›è€…çš„åˆ—è¡¨ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªæœåŠ¡å®ä¾‹ã€‚ **é‡è¯•ç­–ç•¥ï¼š**RetryRuleï¼ŒæŒ‰ç…§è½®è¯¢ç­–ç•¥æ¥è·å–æœåŠ¡ï¼Œå¦‚æœè·å–çš„æœåŠ¡å®ä¾‹ä¸º null æˆ–å·²ç»å¤±æ•ˆï¼Œåˆ™åœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹å†…ä¸æ–­åœ°è¿›è¡Œé‡è¯•æ¥è·å–æœåŠ¡ï¼Œå¦‚æœè¶…è¿‡æŒ‡å®šæ—¶é—´ä¾ç„¶æ²¡è·å–åˆ°æœåŠ¡å®ä¾‹åˆ™è¿”å› nullã€‚ å‡ºäºæ€§èƒ½æ–¹é¢çš„è€ƒè™‘ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ç”¨æƒé‡ç­–ç•¥æˆ–åŒºåŸŸæ•æ„Ÿç­–ç•¥æ¥æ›¿ä»£è½®è¯¢ç­–ç•¥ï¼Œå› ä¸ºè¿™æ ·çš„æ‰§è¡Œæ•ˆç‡æœ€é«˜ã€‚\näº”ã€æ—¥å¿—çº§åˆ«ä¼˜åŒ– OpenFeign æä¾›äº†æ—¥å¿—å¢å¼ºåŠŸèƒ½ï¼Œå®ƒçš„æ—¥å¿—çº§åˆ«æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š\n**NONEï¼š**é»˜è®¤çš„ï¼Œä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—ã€‚ **BASICï¼š**ä»…è®°å½•è¯·æ±‚æ–¹æ³•ã€URLã€å“åº”çŠ¶æ€ç åŠæ‰§è¡Œæ—¶é—´ã€‚ **HEADERSï¼š**é™¤äº† BASIC ä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯ã€‚ **FULLï¼š**é™¤äº† HEADERS ä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„æ­£æ–‡åŠå…ƒæ•°æ®ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ¥è®¾ç½®æ—¥å¿—çº§åˆ«ï¼Œé…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 @Configuration public class OpenfeignConfig { @Bean Logger.Level feignLoggerLevel(){ return Logger.Level.FULL;//FULLæ˜¯è¯¦ç»†æ—¥å¿— } } logging: level: cn.xxx.service: debug å…¶ä¸­ cn.xxx.service ä¸º OpenFeign æ¥å£æ‰€åœ¨çš„åŒ…åã€‚è™½ç„¶ OpenFeign é»˜è®¤æ˜¯ä¸è¾“å‡ºä»»ä½•æ—¥å¿—ï¼Œä½†åœ¨å¼€å‘é˜¶æ®µå¯èƒ½ä¼šè¢«ä¿®æ”¹ï¼Œå› æ­¤åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬åº”ä»”ç»†æ£€æŸ¥å¹¶è®¾ç½®åˆç†çš„æ—¥å¿—çº§åˆ«ï¼Œä»¥æé«˜ OpenFeign çš„è¿è¡Œæ•ˆç‡ã€‚\næ€»ç»“ OpenFeign æ˜¯ Spring å®˜æ–¹æ¨å‡ºçš„ä¸€ç§å£°æ˜å¼æœåŠ¡è°ƒç”¨å’Œè´Ÿè½½å‡è¡¡ç»„ä»¶ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®æ¥ä¼˜åŒ– OpenFeign çš„è¿è¡Œï¼š\nä¿®æ”¹ OpenFeign çš„è¶…æ—¶æ—¶é—´ï¼Œè®© OpenFeign èƒ½å¤Ÿæ­£ç¡®çš„å¤„ç†ä¸šåŠ¡ã€‚ é€šè¿‡é…ç½®ä¸“ç”¨çš„é€šä¿¡ç»„ä»¶ Apache HttpClient æˆ– OKHttpï¼Œè®© OpenFeign å¯ä»¥æ›´å¥½åœ°å¯¹ HTTP è¿æ¥å¯¹è±¡è¿›è¡Œé‡ç”¨å’Œç®¡ç†ï¼Œä»¥æé«˜å…¶æ€§èƒ½ã€‚ å¼€å¯æ•°æ®å‹ç¼©åŠŸèƒ½ï¼Œå¯ä»¥æé«˜å®½å¸¦åˆ©ç”¨ç‡å’ŒåŠ é€Ÿæ•°æ®ä¼ è¾“é€Ÿåº¦ã€‚ ä½¿ç”¨åˆé€‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥æ¥æ›¿æ¢é»˜è®¤çš„è½®è¯¢è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå·²è·å¾—æ›´å¥½çš„æ‰§è¡Œæ•ˆç‡ã€‚ æ£€æŸ¥ç”Ÿæˆç¯å¢ƒä¸­ OpenFeign çš„æ—¥å¿—çº§åˆ«ï¼Œé€‰æ‹©åˆé€‚çš„æ—¥å¿—è¾“å‡ºçº§åˆ«ï¼Œé˜²æ­¢æ— æ•ˆçš„æ—¥å¿—è¾“å‡ºã€‚ ","permalink":"https://habyss.github.io/posts/tech/openfeign/","summary":"ä¸€ã€è¶…æ—¶ä¼˜åŒ– OpenFeign åº•å±‚å†…ç½®äº† Ribbon æ¡†æ¶ï¼Œå¹¶ä¸”ä½¿ç”¨äº† Ribbon çš„è¯·æ±‚è¿æ¥è¶…æ—¶æ—¶é—´å’Œè¯·æ±‚å¤„ç†è¶…æ—¶æ—¶é—´ä½œä¸ºå…¶è¶…æ—¶æ—¶é—´ï¼Œè€Œ Ribbon é»˜è®¤çš„è¯·æ±‚è¿æ¥è¶…æ—¶æ—¶é—´å’Œè¯·æ±‚å¤„ç†è¶…æ—¶æ—¶é—´","title":"OpenFeignä¼˜åŒ–"},{"content":"éœ€æ±‚ é¦–é¡µéœ€è¦å±•ç¤ºæœ€è¿‘ä¸ƒå¤©çš„ä¸€äº›æŒ‡æ ‡çš„ç»Ÿè®¡å›¾, è€Œæ•°æ®åº“ä¸­å®åœ¨ä¸åŒçš„åœ°æ–¹å­˜å‚¨çš„, ä¸”æ—¥æœŸå¹¶éè¿ç»­æœ‰æ•°æ®.\næ•°æ®åº“ å¸¸è§„ä½¿ç”¨groupbyåˆ†ç»„\n1 2 3 4 5 select count(id) countNum, date_format(create_time, \u0026#39;%Y-%m-%d\u0026#39;) date from table where xxx = #{xxx} and create_time \u0026lt;![CDATA[\u0026gt;=]]\u0026gt; #{start} group by date javaä»£ç å¤„ç†ç”Ÿæˆè¿ç»­æ—¥æœŸæµ 1 2 3 4 5 6 7 8 9 10 11 12 13 // è·å–æ•°æ®åº“æ•°æ®è½¬map Map\u0026lt;LocalDate, Long\u0026gt; xxxMap = xxxService.countInfo(parma, start).stream() .collect(Collectors.toMap(PatientCountInfo::getDate, PatientCountInfo::getRegistryCount)); Map\u0026lt;LocalDate, Long\u0026gt; yyyMap = yyyService.countInfo(parma, start).stream() .collect(Collectors.toMap(PatientCountInfo::getDate, PatientCountInfo::getConsultationCount)); // ç»„è£…ç›¸åº”æ—¥æœŸæ•°æ® List\u0026lt;ResultVo\u0026gt; result = start.datesUntil(end.plusDays(1)) .map(d -\u0026gt; new ResultVo() .setDate(d) .setXxxCount(xxxMap.getOrDefault(d, 0L)) .setYyyCount(yyyMap.getOrDefault(d, 0L)) ) .toList(); ä¸»è¦æ˜¯LocalDateä¸­çš„public Stream\u0026lt;LocalDate\u0026gt; datesUntil(LocalDate endExclusive)æ–¹æ³•å¯ä»¥ç”Ÿæˆè¿ç»­æ—¥æœŸæµ, å¤§å¤§ç®€åŒ–äº†ç”Ÿæˆè¿ç»­æ—¥æœŸçš„å¼€å‘.\n","permalink":"https://habyss.github.io/posts/tech/%E8%BF%9E%E7%BB%AD%E6%97%A5%E6%9C%9F%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE/","summary":"éœ€æ±‚ é¦–é¡µéœ€è¦å±•ç¤ºæœ€è¿‘ä¸ƒå¤©çš„ä¸€äº›æŒ‡æ ‡çš„ç»Ÿè®¡å›¾, è€Œæ•°æ®åº“ä¸­å®åœ¨ä¸åŒçš„åœ°æ–¹å­˜å‚¨çš„, ä¸”æ—¥æœŸå¹¶éè¿ç»­æœ‰æ•°æ®. æ•°æ®åº“ å¸¸è§„ä½¿ç”¨groupbyåˆ†ç»„ 1 2 3 4 5","title":"è¿ç»­æ—¥æœŸç»Ÿè®¡æ•°æ®/æ—¥æœŸæ— æ•°æ®å¡«å……"},{"content":"pom 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026lt;dependencies\u0026gt; \u0026lt;!-- resilience4j æŒ‰éœ€å¼•å…¥ æˆ– all--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.github.resilience4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;resilience4j-ratelimiter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${resilience4jVersion}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- resilience4j æŒ‰éœ€å¼•å…¥ æˆ– all--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.github.resilience4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;resilience4j-all\u0026lt;/artifactId\u0026gt; version\u0026gt;${resilience4jVersion}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.github.resilience4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;resilience4j-spring-boot2\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${resilience4jVersion}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- æƒ³ä½¿ç”¨resilience4jçš„æ³¨è§£åŠŸèƒ½ï¼Œéœ€è¦å¼•å…¥aop --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-aop\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; é…ç½® æ‚¨å¯ä»¥åœ¨springbootä¸­é…ç½®æ–­è·¯å™¨ã€é‡è¯•ã€é™æµå™¨ã€éš”ç¦»ã€çº¿ç¨‹æ± éš”ç¦»å’Œé™æ—¶å™¨å®ä¾‹ã€‚ä½¿ç”¨application.ymlè¿›è¡Œé…ç½®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 resilience4j.circuitbreaker: instances: backendA: registerHealthIndicator: true slidingWindowSize: 100 backendB: # å¥åº·ç›‘æ§å¼€å¯ registerHealthIndicator: true # è‹¥COUNT_BASEDï¼Œ10æ¬¡è°ƒç”¨ä¸­æœ‰50%å¤±è´¥ï¼ˆå³5æ¬¡ï¼‰æ‰“å¼€ç†”æ–­æ–­è·¯å™¨ï¼› # è‹¥TIME_BASEDï¼Œåœ¨10ç§’å†…ï¼ˆsliding-window-sizeï¼‰100%ï¼ˆslow-call-rate-thresholdï¼‰çš„è¯·æ±‚è¶…è¿‡2ç§’ï¼ˆslow-call-duration-thresholdï¼‰æ‰“å¼€æ–­è·¯å™¨ã€‚ slidingWindowSize: 10 # è¿è¡Œæ–­è·¯å™¨åœ¨HALF_OPENçŠ¶æ€ä¸‹æ—¶è¿›è¡Œ3æ¬¡è°ƒç”¨ï¼Œå¦‚æœæ•…éšœæˆ–æ…¢é€Ÿè°ƒç”¨ä»ç„¶é«˜äºé˜ˆå€¼ï¼Œæ–­è·¯å™¨å†æ¬¡è¿›å…¥æ‰“å¼€çŠ¶æ€ã€‚ permittedNumberOfCallsInHalfOpenState: 3 # æ»‘åŠ¨çª—å£æœŸç±»å‹ æ¬¡æ•°COUNT_BASED æ—¶é—´TIME_BASED é»˜è®¤COUNT_BASEDã€‚ slidingWindowType: TIME_BASED # æ¯ä¸ªæ»‘åŠ¨çª—å£æœŸ æœ€å°‘20æ¬¡è¯·æ±‚åç”Ÿæ•ˆ minimumNumberOfCalls: 20 # ä¸€æ—¦æ–­è·¯å™¨æ˜¯æ‰“å¼€çŠ¶æ€ï¼Œå®ƒä¼šæ‹’ç»è¯·æ±‚50ç§’é’Ÿï¼Œç„¶åè½¬å…¥åŠå¼€çŠ¶æ€ã€‚ waitDurationInOpenState: 50s # 50%çš„å¤±è´¥è¯·æ±‚, å¼€å¯æ–­è·¯ failureRateThreshold: 50 eventConsumerBufferSize: 10 recordFailurePredicate: io.github.robwin.exception.RecordFailurePredicate resilience4j.retry: instances: backendA: maxRetryAttempts: 3 waitDuration: 10s enableExponentialBackoff: true exponentialBackoffMultiplier: 2 retryExceptions: - org.springframework.web.client.HttpServerErrorException - java.io.IOException ignoreExceptions: - io.github.robwin.exception.BusinessException backendB: maxRetryAttempts: 3 waitDuration: 10s retryExceptions: - org.springframework.web.client.HttpServerErrorException - java.io.IOException ignoreExceptions: - io.github.robwin.exception.BusinessException resilience4j.bulkhead: instances: backendA: maxConcurrentCalls: 10 backendB: maxWaitDuration: 10ms maxConcurrentCalls: 20 resilience4j.thread-pool-bulkhead: instances: backendC: maxThreadPoolSize: 1 coreThreadPoolSize: 1 queueCapacity: 1 resilience4j.ratelimiter: instances: backendA: # é™æµ10ä¸ª limitForPeriod: 10 # æ¯ç§’ limitRefreshPeriod: 1s # è¢«é˜»å¡çš„çº¿ç¨‹æœ€é•¿ç­‰å¾…æ—¶é—´, è¶…æ—¶ä¼šå¼‚å¸¸ timeoutDuration: 0 registerHealthIndicator: true # è¢«é˜»å¡æœ€å¤§çº¿ç¨‹æ•°é‡, è¶…å‡ºä¼šå¼‚å¸¸ eventConsumerBufferSize: 100 backendB: limitForPeriod: 6 limitRefreshPeriod: 500ms timeoutDuration: 3s resilience4j.timelimiter: instances: backendA: timeoutDuration: 2s cancelRunningFuture: true backendB: timeoutDuration: 1s cancelRunningFuture: false è¿˜å¯ä»¥è¦†ç›–é»˜è®¤é…ç½®ï¼Œå®šä¹‰å…±äº«é…ç½®å¹¶åœ¨springbootä¸­è¦†ç›–å®ƒä»¬åº”ç”¨ç¨‹åºapplication.yml é…ç½®æ–‡ä»¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 resilience4j.circuitbreaker: configs: default: slidingWindowSize: 100 permittedNumberOfCallsInHalfOpenState: 10 waitDurationInOpenState: 10000 failureRateThreshold: 60 eventConsumerBufferSize: 10 registerHealthIndicator: true someShared: slidingWindowSize: 50 permittedNumberOfCallsInHalfOpenState: 10 instances: backendA: baseConfig: default waitDurationInOpenState: 5000 backendB: baseConfig: someShared é€šè¿‡ä»£ç è¦†ç›–é»˜è®¤é…ç½® æ‚¨è¿˜å¯ä»¥é€šè¿‡å¯¹ç‰¹å®šå®ä¾‹åç§°ä½¿ç”¨Customizeræ¥è¦†ç›–ç‰¹å®šæ–­è·¯å™¨ã€éš”ç¦»ã€é‡è¯•ã€é™æµå™¨æˆ–é™æ—¶å™¨å®ä¾‹çš„é…ç½®ã€‚ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åœ¨é…ç½®çš„æ–­è·¯å™¨backendAå¯¹ä¸Šé¢çš„YAMLæ–‡ä»¶è¿›è¡Œè¦†ç›–ã€‚\n1 2 3 4 5 @Bean public CircuitBreakerConfigCustomizer testCustomizer() { return CircuitBreakerConfigCustomizer .of(\u0026#34;backendA\u0026#34;, builder -\u0026gt; builder.slidingWindowSize(100)); } Resilience4jæœ‰è‡ªå·±çš„customizerç±»å‹ï¼Œå¯ä»¥æŒ‰ä¸Šå›¾æ‰€ç¤ºä½¿ç”¨ï¼š\nResilienc4jç±»å‹ è‡ªå®šä¹‰ç±» Circuit breaker CircuitBreakerConfigCustomizer Retry RetryConfigCustomizer Rate limiter RateLimiterConfigCustomizer Bulkhead BulkheadConfigCustomizer ThreadPoolBulkhead ThreadPoolBulkheadConfigCustomizer Time Limiter TimeLimiterConfigCustomizer åˆ‡é¢çš„é¡ºåº Resilience4jçš„åˆ‡é¢æ‰§è¡Œé¡ºåºï¼š\n1 Retry ( CircuitBreaker ( RateLimiter ( TimeLimiter ( Bulkhead ( Function ) ) ) ) ) æ‰€ä»¥Retry æ˜¯æœ€åæ‰§è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @CircuitBreaker(name = BACKEND, fallbackMethod = \u0026#34;fallback\u0026#34;) @RateLimiter(name = BACKEND) @Bulkhead(name = BACKEND) @Retry(name = BACKEND, fallbackMethod = \u0026#34;fallback\u0026#34;) @TimeLimiter(name = BACKEND) public Mono\u0026lt;String\u0026gt; method(String param1) { return Mono.error(new NumberFormatException()); } private Mono\u0026lt;String\u0026gt; fallback(String param1, IllegalArgumentException e) { return Mono.just(\u0026#34;test\u0026#34;); } private Mono\u0026lt;String\u0026gt; fallback(String param1, RuntimeException e) { return Mono.just(\u0026#34;test\u0026#34;); } ","permalink":"https://habyss.github.io/posts/tech/resilience4j_%E7%86%94%E6%96%AD/","summary":"pom 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026lt;dependencies\u0026gt; \u0026lt;!-- resilience4j æŒ‰éœ€å¼•å…¥ æˆ– all--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.github.resilience4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;resilience4j-ratelimiter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${resilience4jVersion}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- resilience4j æŒ‰éœ€å¼•å…¥ æˆ– all--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.github.resilience4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;resilience4j-all\u0026lt;/artifactId\u0026gt; version\u0026gt;${resilience4jVersion}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.github.resilience4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;resilience4j-spring-boot2\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${resilience4jVersion}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- æƒ³ä½¿ç”¨resilienc","title":"resilience4j-spring-boot2 ç†”æ–­"},{"content":" æœ€è¿‘çœ‹åˆ°è§†é¢‘æµçš„ä¸œè¥¿, æµ…æµ…çœ‹äº†ä¸€ä¸‹, demoè®°å½•\nffmpegè§†é¢‘åˆ‡ç‰‡ 1 ffmpeg -i test.mp4 -c copy -f hls -hls_list_size 0 -hls_time 10 -hls_segment_filename \u0026#39;file%03d.ts\u0026#39; out.m3u8 å‘½ä»¤ç®€å•è§£é‡Š:\n1.ffmpegåˆ‡ç‰‡å‘½ä»¤ï¼Œä»¥H264å’ŒAACçš„å½¢å¼å¯¹è§†é¢‘è¿›è¡Œè¾“å‡º\n1 ffmpeg -i input.mp4 -c:v libx264 -c:a aac -strict -2 -f hls output.m3u8 2.ffmpegè½¬åŒ–æˆHLSæ—¶é™„å¸¦çš„æŒ‡ä»¤\n1 ffmpeg -i output.mp4 -c:v libx264 -c:a aac -strict -2 -f hls -hls_list_size 0 -hls_time 5 output1.m3u8 é»˜è®¤çš„æ¯ç‰‡é•¿åº¦ä¸º 2 ç§’ï¼Œm3u8 æ–‡ä»¶ä¸­é»˜è®¤åªä¿å­˜æœ€æ–°çš„ 5 æ¡ç‰‡çš„ä¿¡æ¯ï¼Œå¯¼è‡´æœ€åæ’­æ”¾çš„æ—¶å€™åªèƒ½æ’­æœ€åçš„ä¸€å°éƒ¨åˆ†ï¼ˆç›´æ’­çš„æ—¶å€™ç‰¹åˆ«æ³¨æ„ï¼‰\n-hls_time n è®¾ç½®æ¯ç‰‡çš„é•¿åº¦ï¼Œé»˜è®¤å€¼ä¸º 2ï¼Œå•ä½ä¸ºç§’ã€‚-hls_list_size n è®¾ç½®æ’­æ”¾åˆ—è¡¨ä¿å­˜çš„æœ€å¤šæ¡ç›®ï¼Œè®¾ç½®ä¸º 0 ä¼šä¿å­˜æœ‰æ‰€ç‰‡ä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸º5\n-hls_wrap n è®¾ç½®å¤šå°‘ç‰‡ä¹‹åå¼€å§‹è¦†ç›–ï¼Œå¦‚æœè®¾ç½®ä¸º0åˆ™ä¸ä¼šè¦†ç›–ï¼Œé»˜è®¤å€¼ä¸º0ã€‚è¿™ä¸ªé€‰é¡¹èƒ½å¤Ÿé¿å…åœ¨ç£ç›˜ä¸Šå­˜å‚¨è¿‡å¤šçš„ ç‰‡ï¼Œè€Œä¸”èƒ½å¤Ÿé™åˆ¶å†™å…¥ç£ç›˜çš„æœ€å¤šçš„ç‰‡çš„æ•°é‡\n-hls_start_number n è®¾ç½®æ’­æ”¾åˆ—è¡¨ä¸­ sequence number çš„å€¼ä¸º numberï¼Œé»˜è®¤å€¼ä¸º 0\næ³¨æ„ï¼šæ’­æ”¾åˆ—è¡¨çš„ sequence number å¯¹æ¯ä¸ª segment æ¥è¯´éƒ½å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œè€Œä¸”å®ƒä¸èƒ½å’Œç‰‡çš„æ–‡ä»¶åï¼ˆå½“ä½¿ç”¨ wrap é€‰é¡¹æ—¶ï¼Œæ–‡ä»¶åæœ‰å¯èƒ½ä¼šé‡å¤ä½¿ç”¨ï¼‰æ··æ·†\n-c:v å°†å¤„ç†åçš„æµæ‹·è´\n-c copy [å‘½ä»¤ç®€å†™]copyæµ\nåç«¯demo ç®€å•æä¾›æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @GetMapping(\u0026#34;v/{fileName}\u0026#34;) public void video(@PathVariable String fileName, HttpServletResponse response) throws IOException { byte[] bytes = readByteByPath(Paths.get(\u0026#34;E:/test/\u0026#34; + fileName)); response.getOutputStream().write(Objects.requireNonNull(bytes)); } private byte[] readByteByPath(Path i) { try { return Files.readAllBytes(i); } catch (IOException e) { e.printStackTrace(); return null; } } å‰ç«¯demo hls.js 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Hls.js demo - basic usage\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;script src=\u0026#34;./dist/hls.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;center\u0026gt; \u0026lt;h1\u0026gt;Hls.js demo - basic usage\u0026lt;/h1\u0026gt; \u0026lt;video height=\u0026#34;600\u0026#34; id=\u0026#34;video\u0026#34; controls\u0026gt;\u0026lt;/video\u0026gt; \u0026lt;/center\u0026gt; \u0026lt;script\u0026gt; var video = document.getElementById(\u0026#39;video\u0026#39;); if (Hls.isSupported()) { var hls = new Hls({ debug: true, }); hls.loadSource(\u0026#39;http://localhost:8080/v/out.m3u8\u0026#39;); hls.attachMedia(video); hls.on(Hls.Events.MEDIA_ATTACHED, function () { video.muted = true; video.play(); }); } // hls.js is not supported on platforms that do not have Media Source Extensions (MSE) enabled. // When the browser has built-in HLS support (check using `canPlayType`), we can provide an HLS manifest (i.e. .m3u8 URL) directly to the video element through the `src` property. // This is using the built-in support of the plain video element, without using hls.js. // else if (video.canPlayType(\u0026#39;application/vnd.apple.mpegurl\u0026#39;)) { // video.src = \u0026#39;http://localhost:8080/v/out.m3u8\u0026#39;; // video.addEventListener(\u0026#39;canplay\u0026#39;, function () { // video.play(); // }); // } \u0026lt;/script\u0026gt; \u0026lt;!-- injected in netlify post processing step --\u0026gt; \u0026lt;div style=\u0026#34;position: absolute; top: 5px; right: 5px;\u0026#34;\u0026gt; \u0026lt;a rel=\u0026#34;noopener\u0026#34; href=\u0026#34;https://www.netlify.com\u0026#34; target=\u0026#34;_blank\u0026#34;\u0026gt;\u0026lt;img src=\u0026#34;https://www.netlify.com/img/global/badges/netlify-color-accent.svg\u0026#34; /\u0026gt;\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt;\u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ","permalink":"https://habyss.github.io/posts/tech/hls_ts_m3u8_demo/","summary":"æœ€è¿‘çœ‹åˆ°è§†é¢‘æµçš„ä¸œè¥¿, æµ…æµ…çœ‹äº†ä¸€ä¸‹, demoè®°å½• ffmpegè§†é¢‘åˆ‡ç‰‡ 1 ffmpeg -i test.mp4 -c copy -f hls -hls_list_size 0 -hls_time 10 -hls_segment_filename \u0026#39;file%03d.ts\u0026#39; out.m3u8 å‘½ä»¤ç®€å•è§£é‡Š: 1.ffmpegåˆ‡ç‰‡å‘½ä»¤ï¼Œä»¥","title":"hls ts m3u8 ffmpeg å‰åç«¯è§†é¢‘æµdemo"},{"content":"éœ€æ±‚ éœ€è¦æ¨¡ç³ŠæŸ¥è¯¢æ–‡ç« çš„æ ‡é¢˜\næ¢ç´¢ like å…ˆæµ‹è¯•ä¸€ä¸‹300wæ•°æ®é‡çš„è€—æ—¶\n1 2 3 4 5 6 7 8 9 10 11 \u0026gt; select count(1) from t_banner 1 row retrieved starting from 1 in 160 ms (execution: 136 ms, fetching: 24 ms) ä¸€å…±3114023æ¡æ•°æ® \u0026gt; select * from t_banner where banner_title = \u0026#39;title523521end\u0026#39; 2 rows retrieved starting from 1 in 35 ms (execution: 7 ms, fetching: 28 ms) \u0026gt; select * from t_banner where banner_title like \u0026#39;%523521%\u0026#39; 3 rows retrieved starting from 1 in 1 s 428 ms (execution: 1 s 410 ms, fetching: 18 ms) \u0026gt; select * from t_banner where banner_title like \u0026#39;title523521%\u0026#39; 2 rows retrieved starting from 1 in 42 ms (execution: 8 ms, fetching: 34 ms) \u0026gt; select * from t_banner where banner_title like \u0026#39;%523521end\u0026#39; 3 rows retrieved starting from 1 in 1 s 432 ms (execution: 1 s 409 ms, fetching: 23 ms) ç”±ä¸Šå¯ä»¥çœ‹å‡º\nåŠ ç´¢å¼•çš„æƒ…å†µä¸‹where banner_title = 'title523521end' å’Œ where banner_title like 'title523521%'æ˜¯èµ°ç´¢å¼•çš„, è€—æ—¶ä¸ªä½æ•°æ¯«ç§’\nè€Œwhere banner_title like '%523521%'å’Œwhere banner_title like '%523521end'è€—æ—¶1.5ç§’,æ˜¯ä¸èµ°ç´¢å¼•çš„, ä¹Ÿå°±æ˜¯ç´¢å¼•å¤±æ•ˆ, 1.5såœ¨é¡¹ç›®ä¸­å·²ç»å¾ˆä¸èƒ½æ¥å—äº†.\nfulltext å…ˆä½¿ç”¨ ngramåˆ†è¯å™¨ åˆ›å»ºå…¨æ–‡ç´¢å¼•\n1 create fulltext index f_banner_tile on t_banner (banner_title) with parser ngram; 300wçš„æ•°æ®, å­—æ®µé•¿åº¦åœ¨14-16, è€—æ—¶6min6 m 11 s 156 ms\nbooleanæ¨¡å¼ æ‰§è¡ŒæŸ¥è¯¢è¯­æ³•\n1 2 3 select * from t_banner where match(banner_title) against(\u0026#39;235213\u0026#39; in boolean mode); æ‰§è¡Œç»“æœ\n1 2 3 4 \u0026gt; select * from t_banner where match(banner_title) against(\u0026#39;235213\u0026#39; in boolean mode) 3 rows retrieved starting from 1 in 9 s 329 ms (execution: 9 s 305 ms, fetching: 24 ms) è€—æ—¶è¾¾åˆ°æƒŠäººçš„9s, æ¯”likeçš„1.5så¤šå¾—å¤š..\nnaturalæ¨¡å¼ æ‰§è¡ŒæŸ¥è¯¢è¯­æ³•\n1 2 3 select * from t_banner where match(banner_title) against(\u0026#39;235213\u0026#39; in natural language mode) æ‰§è¡Œç»“æœ\n1 2 3 4 \u0026gt; select * from t_banner where match(banner_title) against(\u0026#39;235213\u0026#39; in natural language mode) 740,887 rows retrieved starting from 1 in 16 s 798 ms (execution: 801 ms, fetching: 15 s 997 ms) å¯ä»¥çœ‹åˆ°è€—æ—¶800ms, ä½†æ˜¯åŒ¹é…çš„ç²¾å‡†åº¦ä¹Ÿå¤ªå·®äº†\u0026hellip;ä¸€å…±åŒ¹é…çš„3æ¡æ•°æ®, ç¡¬ç”Ÿç”ŸåŒ¹é…äº†74w\næ€»ç»“ å…¨æ–‡ç´¢å¼•çš„ç¡®å¯¹æ¨¡ç³ŠæŸ¥è¯¢æœ‰æ•ˆ, ä½†æ˜¯å ç”¨ç©ºé—´æ˜¯å¤§é‡çš„, æ‰€ä»¥ä¸ªäººè®¤ä¸ºæ›´åŠ é€‚ç”¨äºé•¿åº¦æ¯”è¾ƒçŸ­çš„å­—æ®µ, ä½†æ˜¯ä»–çš„åŒ¹é…çš„ç²¾å‡†åº¦æå·®,è€Œä¸”å®ƒçš„åˆ†è¯é€»è¾‘å¹¶ä¸åƒesçš„ikåˆ†è¯å™¨é‚£ä¹ˆåˆç†.\nè‡ªMySQL5.7.6ç‰ˆèµ·ï¼ŒMySQLå°†ngramå…¨æ–‡è§£æå™¨ä½œä¸ºå†…ç½®çš„æœåŠ¡å™¨æ’ä»¶, æ”¯æŒç”¨äºInnoDBå’ŒMyISAMå­˜å‚¨å¼•æ“çš„ngramå…¨æ–‡è§£æå™¨ã€‚\næ ¹æ®å®šä¹‰ï¼Œngramæ˜¯æ¥è‡ªæ–‡æœ¬åºåˆ—çš„å¤šä¸ªå­—ç¬¦çš„è¿ç»­åºåˆ—ã€‚ ngramå…¨æ–‡è§£æå™¨çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†æ–‡æœ¬åºåˆ—æ ‡è®°ä¸ºnä¸ªå­—ç¬¦çš„è¿ç»­åºåˆ—ã€‚\nä»¥ä¸‹è¯´æ˜äº†ngramå…¨æ–‡è§£æå™¨å¦‚ä½•æ ‡è®°ä¸åŒå€¼nçš„æ–‡æœ¬åºåˆ—ï¼š\n1 2 3 4 5 n = 1: \u0026#39;m\u0026#39;,\u0026#39;y\u0026#39;,\u0026#39;s\u0026#39;,\u0026#39;q\u0026#39;,\u0026#39;l\u0026#39; n = 2: \u0026#39;my\u0026#39;, \u0026#39;ys\u0026#39;, \u0026#39;sq\u0026#39;,\u0026#39;ql\u0026#39; n = 3: \u0026#39;mys\u0026#39;, \u0026#39;ysq\u0026#39;, \u0026#39;sql\u0026#39; n = 4: \u0026#39;mysq\u0026#39;, \u0026#39;ysql\u0026#39; n = 5: \u0026#39;mysql\u0026#39; 1 2 3 4 N=1 : \u0026#39;é½¿\u0026#39;, \u0026#39;è½®\u0026#39;, \u0026#39;ä¼ \u0026#39;, \u0026#39;åŠ¨\u0026#39;; N=2 : \u0026#39;é½¿è½®\u0026#39;, \u0026#39;è½®ä¼ \u0026#39;, \u0026#39;ä¼ åŠ¨\u0026#39;; N=3 : \u0026#39;é½¿è½®ä¼ \u0026#39;, \u0026#39;è½®ä¼ åŠ¨\u0026#39;; N=4 : \u0026#39;é½¿è½®ä¼ åŠ¨\u0026#39;; å¦å¤– mysqlé…ç½® 1 show variables like \u0026#39;%token%\u0026#39; nnodb_ft_min_token_size é»˜è®¤3ï¼Œè¡¨ç¤ºæœ€å°3ä¸ªå­—ç¬¦ä½œä¸ºä¸€ä¸ªå…³é”®è¯ï¼Œå¢å¤§è¯¥å€¼å¯å‡å°‘å…¨æ–‡ç´¢å¼•çš„å¤§å° innodb_ft_max_token_size é»˜è®¤84ï¼Œè¡¨ç¤ºæœ€å¤§84ä¸ªå­—ç¬¦ä½œä¸ºä¸€ä¸ªå…³é”®è¯ï¼Œé™åˆ¶è¯¥å€¼å¯å‡å°‘å…¨æ–‡ç´¢å¼•çš„å¤§å° ngram_token_size é»˜è®¤2ï¼Œè¡¨ç¤º2ä¸ªå­—ç¬¦ä½œä¸ºå†…ç½®åˆ†è¯è§£æå™¨çš„ä¸€ä¸ªå…³é”®è¯,åˆæ³•å–å€¼èŒƒå›´æ˜¯1-10ï¼Œå¦‚å¯¹â€œabcdâ€å»ºç«‹å…¨æ–‡ç´¢å¼•ï¼Œå…³é”®è¯ä¸ºâ€™abâ€™ï¼Œâ€˜bcâ€™ï¼Œâ€˜cdâ€™ å½“ä½¿ç”¨ngramåˆ†è¯è§£æå™¨æ—¶ï¼Œinnodb_ft_min_token_sizeå’Œinnodb_ft_max_token_size æ— æ•ˆ\nåœ¨my.cnfä¸­ä¿®æ”¹/æ·»åŠ å‚æ•° 1 2 [mysqld] ngram_token_size = 1 ä¿®æ”¹å¯åŠ¨å‚æ•° 1 mysqld --ngram_token_size=1 å‚æ•°å‡ä¸å¯åŠ¨æ€ä¿®æ”¹ï¼Œä¿®æ”¹åéœ€é‡å¯MySQLæœåŠ¡ï¼Œå¹¶é‡æ–°å»ºç«‹å…¨æ–‡ç´¢å¼•\nè¯­æ³• è‡ªç„¶è¯­è¨€æ¨¡å¼(NATURAL LANGUAGE MODE)\nè‡ªç„¶è¯­è¨€æ¨¡å¼æ˜¯MySQL é»˜è®¤çš„å…¨æ–‡æ£€ç´¢æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šæ–¹ç¬¬ä¸‰æ­¥æœç´¢æ—¶ï¼Œå¹¶æ²¡æœ‰æŒ‡å®šä½¿ç”¨å“ªç§æ¨¡å¼ï¼Œé»˜è®¤å°±æ˜¯è‡ªç„¶è¯­è¨€æ¨¡å¼ï¼Œè‡ªç„¶è¯­è¨€æ¨¡å¼ä¸èƒ½ä½¿ç”¨æ“ä½œç¬¦ï¼Œä¸èƒ½æŒ‡å®šå…³é”®è¯å¿…é¡»å‡ºç°æˆ–è€…å¿…é¡»ä¸èƒ½å‡ºç°ç­‰å¤æ‚æŸ¥è¯¢ï¼Œç±»ä¼¼likeã€‚\nBOOLEANæ¨¡å¼(BOOLEAN MODE)\nBOOLEANæ¨¡å¼å¯ä»¥ä½¿ç”¨æ“ä½œç¬¦ï¼Œå¯ä»¥æ”¯æŒæŒ‡å®šå…³é”®è¯å¿…é¡»å‡ºç°æˆ–è€…å¿…é¡»ä¸èƒ½å‡ºç°æˆ–è€…å…³é”®è¯çš„æƒé‡é«˜è¿˜æ˜¯ä½ç­‰å¤æ‚æŸ¥è¯¢ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026#39;apple banana\u0026#39; æ— æ“ä½œç¬¦ï¼Œè¡¨ç¤ºæˆ–ï¼Œè¦ä¹ˆåŒ…å«appleï¼Œè¦ä¹ˆåŒ…å«banana \u0026#39;+apple +juice\u0026#39; å¿…é¡»åŒæ—¶åŒ…å«ä¸¤ä¸ªè¯ \u0026#39;+apple macintosh\u0026#39; å¿…é¡»åŒ…å«appleï¼Œä½†æ˜¯å¦‚æœä¹ŸåŒ…å«macintoshçš„è¯ï¼Œç›¸å…³æ€§ä¼šæ›´é«˜ã€‚ \u0026#39;+apple -macintosh\u0026#39; å¿…é¡»åŒ…å«appleï¼ŒåŒæ—¶ä¸èƒ½åŒ…å«macintoshã€‚ \u0026#39;+apple ~macintosh\u0026#39; å¿…é¡»åŒ…å«appleï¼Œä½†æ˜¯å¦‚æœä¹ŸåŒ…å«macintoshçš„è¯ï¼Œç›¸å…³æ€§è¦æ¯”ä¸åŒ…å«macintoshçš„è®°å½•ä½ã€‚ \u0026#39;+apple +(\u0026gt;juice \u0026lt;pie)\u0026#39; æŸ¥è¯¢å¿…é¡»åŒ…å«appleå’Œjuiceæˆ–è€…appleå’Œpieçš„è®°å½•ï¼Œä½†æ˜¯apple juiceçš„ç›¸å…³æ€§è¦æ¯”apple pieé«˜ã€‚ \u0026#39;apple*\u0026#39; æŸ¥è¯¢åŒ…å«ä»¥appleå¼€å¤´çš„å•è¯çš„è®°å½•ï¼Œå¦‚appleã€applesã€appletã€‚ \u0026#39;\u0026#34;some words\u0026#34;\u0026#39; ä½¿ç”¨åŒå¼•å·æŠŠè¦æœç´ çš„è¯æ‹¬èµ·æ¥ï¼Œæ•ˆæœç±»ä¼¼äºlike \u0026#39;%some words%\u0026#39;ï¼Œ ä¾‹å¦‚â€œsome words of wisdomâ€ä¼šè¢«åŒ¹é…åˆ°ï¼Œè€Œâ€œsome noise wordsâ€å°±ä¸ä¼šè¢«åŒ¹é…ã€‚ ","permalink":"https://habyss.github.io/posts/tech/mysql_like_fulltext/","summary":"éœ€æ±‚ éœ€è¦æ¨¡ç³ŠæŸ¥è¯¢æ–‡ç« çš„æ ‡é¢˜ æ¢ç´¢ like å…ˆæµ‹è¯•ä¸€ä¸‹300wæ•°æ®é‡çš„è€—æ—¶ 1 2 3 4 5 6 7 8 9 10 11 \u0026gt; select count(1) from t_banner 1 row retrieved starting from 1 in 160 ms (execution: 136 ms, fetching: 24 ms) ä¸€å…±311402","title":"Mysql likeæ¨¡ç³ŠæŸ¥è¯¢ fullTextå…¨æ–‡ç´¢å¼•ä½¿ç”¨åœºæ™¯"},{"content":"æ ‡å‡†å†™æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 // å•ä¾‹æ¨¡å¼åŒé‡æ£€æŸ¥ private volatile static Singleton client; public static Singleton getSingleton() { if (client == null) { synchronized (Singleton.class) { if (client == null) { client = new Singleton(); } } } return client; } çº¿ç¨‹å¹¶å‘æ¶‰åŠä¸‰ä¸ªæ¦‚å¿µ: åŸå­æ€§ å¯è§æ€§ æœ‰åºæ€§\nvolatileçš„æ„ä¹‰ 1. æ— volatileæ—¶ 1 2 3 4 5 6 7 8 9 10 11 12 public static Singleton instance; public static Singleton getInstance() { if (instance == null) //1 { //2 synchronized(Singleton.class) { //3 if (instance == null) //4 instance = new Singleton(); //5 } } return instance; } â“ è¿™ç§æ–¹å¼å­˜åœ¨ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ\nä¹Ÿè®¸æœ‰äººè¯´å­˜åœ¨å¯è§æ€§é—®é¢˜ï¼šçº¿ç¨‹1æ‰§è¡Œå®Œç¬¬5æ­¥ï¼Œé‡Šæ”¾é”ã€‚çº¿ç¨‹2è·å¾—é”åæ‰§è¡Œåˆ°ç¬¬4æ­¥ï¼Œç”±äºå¯è§æ€§çš„åŸå› ï¼Œå‘ç°instanceè¿˜æ˜¯nullï¼Œä»è€Œåˆå§‹åŒ–äº†ä¸¤æ¬¡ã€‚\nä½†æ˜¯ä¸ä¼šå­˜åœ¨è¿™ç§æƒ…å†µï¼Œå› ä¸ºsynchronizedèƒ½ä¿è¯çº¿ç¨‹1åœ¨é‡Šæ”¾é”ä¹‹å‰ä¼šè®²å¯¹å˜é‡çš„ä¿®æ”¹åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ï¼Œçº¿ç¨‹2æ‹¿åˆ°çš„å€¼æ˜¯æœ€æ–°çš„ã€‚\nå®é™…å­˜åœ¨çš„é—®é¢˜æ˜¯æ— åºæ€§ã€‚\nç¬¬5æ­¥è¿™ä¸ªnewæ“ä½œæ˜¯æ— åºçš„ï¼Œå®ƒå¯èƒ½ä¼šè¢«ç¼–è¯‘æˆï¼š\na. å…ˆåˆ†é…å†…å­˜ï¼Œè®©instanceæŒ‡å‘è¿™å—å†…å­˜ b. åœ¨å†…å­˜ä¸­åˆ›å»ºå¯¹è±¡ ç„¶è€Œæˆ‘ä»¬éœ€è¦æ„è¯†åˆ°è¿™ä¹ˆä¸€ä¸ªé—®é¢˜ï¼Œsynchronizedè™½ç„¶æ˜¯äº’æ–¥çš„ï¼Œä½†ä¸ä»£è¡¨ä¸€æ¬¡å°±æŠŠæ•´ä¸ªè¿‡ç¨‹æ‰§è¡Œå®Œï¼Œå®ƒåœ¨ä¸­é—´æ˜¯å¯èƒ½é‡Šæ”¾æ—¶é—´ç‰‡çš„ï¼Œæ—¶é—´ç‰‡ä¸æ˜¯é”ã€‚ä¹Ÿå°±æ˜¯è¯´å¯èƒ½åœ¨aæ‰§è¡Œå®Œåï¼Œæ—¶é—´ç‰‡è¢«é‡Šæ”¾ï¼Œçº¿ç¨‹2æ‰§è¡Œåˆ°1ï¼Œè¿™æ—¶ä»–è¯»åˆ°çš„instanceæ˜¯ä¸æ˜¯nullå‘¢ï¼Ÿï¼ˆæ ‡è®°1ï¼‰\nåŸºäºå¯è§æ€§ï¼Œå¯èƒ½æ˜¯nullï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯nullã€‚\néå¸¸å¥‡è‘©çš„æ˜¯ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœè¯»åˆ°çš„æ˜¯nullï¼Œåè€Œæ²¡é—®é¢˜äº†ï¼Œæ¥ä¸‹æ¥ä¼šç­‰å¾…é”ï¼Œç„¶åå†æ¬¡åˆ¤æ–­æ—¶ä¸ä¸ºnullï¼Œæœ€åè¿”å›å•ä¾‹ã€‚\nå¦‚æœè¯»åˆ°çš„ä¸æ˜¯nullï¼Œé‚£ä¹ˆåäº†ï¼ŒæŒ‰é€»è¾‘å®ƒå°±ç›´æ¥return instanceäº†ï¼Œè¿™ä¸ªinstanceè¿˜æ²¡æ‰§è¡Œæ„é€ å‚æ•°ï¼Œå»åšäº‹æƒ…çš„è¯ï¼Œå¾ˆå¯èƒ½å°±å´©æºƒäº†ã€‚\n2. æœ‰volatitleæ—¶ 1 2 3 4 5 6 7 8 9 10 11 12 public volatile static Singleton instance; public static Singleton getInstance() { if (instance == null) //1 { //2 synchronized(Singleton.class) { //3 if (instance == null) //4 instance = new Singleton(); //5 } } return instance; } å”¯ä¸€çš„åŒºåˆ«æ˜¯åŠ äº†volatileå…³é”®å­—ï¼Œé‚£ä¹ˆä¼šæœ‰ä»€ä¹ˆç°è±¡ï¼Ÿ\nè¿™æ—¶è¦åŒºåˆ†jdkç‰ˆæœ¬äº†ï¼Œåœ¨jdk1.4åŠä¹‹å‰ï¼Œvolatileå¹¶ä¸èƒ½ä¿è¯newæ“ä½œçš„æœ‰åºæ€§ï¼Œä½†æ˜¯å®ƒèƒ½ä¿è¯å¯è§æ€§ï¼Œå› æ­¤æ ‡è®°1å¤„ï¼Œè¯»åˆ°çš„ä¸æ˜¯nullï¼Œå¯¼è‡´äº†é—®é¢˜ã€‚\nä»1.5å¼€å§‹ï¼ŒåŠ äº†volatileå…³é”®å­—çš„å¼•ç”¨ï¼Œå®ƒçš„åˆå§‹åŒ–å°±ä¸èƒ½æ˜¯ï¼š\na. å…ˆåˆ†é…å†…å­˜ï¼Œè®©instanceæŒ‡å‘è¿™å—å†…å­˜ b. åœ¨å†…å­˜ä¸­åˆ›å»ºå¯¹è±¡ è€Œåº”è¯¥æ˜¯ï¼š\na.åœ¨å†…å­˜ä¸­åˆ›å»ºå¯¹è±¡ b.è®©instanceæŒ‡å‘è¿™ä¸ªå¯¹è±¡. è¿™ç§å½¢å¼ï¼Œä¹Ÿå°±é¿å…äº†æ— åºæ€§é—®é¢˜ã€‚\n","permalink":"https://habyss.github.io/posts/tech/single_double/","summary":"æ ‡å‡†å†™æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 // å•ä¾‹æ¨¡å¼åŒé‡æ£€æŸ¥ private volatile static Singleton client; public static Singleton getSingleton() { if (client == null) { synchronized (Singleton.class) { if (client == null) { client = new Singleton(); } } } return client; } çº¿ç¨‹å¹¶å‘æ¶‰åŠä¸‰ä¸ªæ¦‚å¿µ:","title":"å•ä¾‹æ¨¡å¼åŒé‡æ£€æŸ¥"},{"content":"1. é˜¿é‡Œäº‘æ–‡ä»¶ä¸Šä¼  å‰æè®¾ç½®å¥½bucketå’Œç›¸åº”çš„url\ncontroller\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Value(\u0026#34;${oss.bucket}\u0026#34;) private String bucketName; @Value(\u0026#34;${oss.fileURL}\u0026#34;) private String OSS_URL; @PostMapping(\u0026#34;singleUpload\u0026#34;) @ApiOperation(\u0026#34;å•æ–‡ä»¶ä¸Šä¼ \u0026#34;) public ResponseResult\u0026lt;String\u0026gt; singleUpload( @ApiParam(\u0026#34;uni-appä¸Šä¼ æ—¶ nameå±æ€§\u0026#34;) @RequestParam(\u0026#34;file\u0026#34;) MultipartFile file, @RequestParam(value = \u0026#34;folderType\u0026#34;, defaultValue = \u0026#34;6\u0026#34;) Integer folderType) { String originalFilename = file.getOriginalFilename(); String pathFileName = OSSFolderEnum.valueOfCode(folderType).getFolder() + LocalDateTime.now().format(DateTimePatterns.F_YYYY_MM_DD_HH_MM_SS_SSS) + Objects.requireNonNull(originalFilename).substring(originalFilename.lastIndexOf(\u0026#34;.\u0026#34;)); OSSUtil.uploadFile(bucketName, pathFileName, file); String fileUrl = OSS_URL + pathFileName; return ResponseResult.createBySuccess(fileUrl); } utils, å•ä¾‹æ¨¡å¼åŒé‡æ£€æŸ¥è·å–client, é¿å…é‡å¤è·å–å’Œé‡Šæ”¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 /** * é˜¿é‡Œäº‘oss */ public class OSSUtil { public final static String endpoint = \u0026#34;\u0026#34;; public final static String accessKeyId = \u0026#34;\u0026#34;; public final static String accessKeySecret = \u0026#34;\u0026#34;; // å•ä¾‹æ¨¡å¼åŒé‡æ£€æŸ¥ private volatile static OSS client; public static OSS getOSSClient() { if (client == null) { synchronized (OSSUtil.class) { if (client == null) { client = new OSSClientBuilder().build(endpoint, accessKeyId, accessKeySecret); } } } return client; } public static void uploadFile(String bucketName, String ObjectName, MultipartFile file) { OSS ossClient = getOSSClient(); try (InputStream ins = file.getInputStream()) { ossClient.putObject(bucketName, ObjectName, ins); } catch (Exception e) { throw new ServiceException(\u0026#34;æ–‡ä»¶ä¸Šä¼ å¼‚å¸¸, è¯·ç¨åå†è¯•\u0026#34;); } } public static void deleteFile(String bucketName, String urlPath) { OSS ossClient = getOSSClient(); ossClient.deleteObject(bucketName, urlPath); } } OSSFolderEnum, ä¸åŒåˆ†ç±»çš„æ–‡ä»¶å­˜æ”¾çš„è·¯å¾„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 @Getter @AllArgsConstructor public enum OSSFolderEnum { USER_AVATAR(1, \u0026#34;web/avatar/\u0026#34;, \u0026#34;ç”¨æˆ·å¤´åƒ\u0026#34;), CONSULTATION_IMG(2, \u0026#34;web/xxxx/\u0026#34;, \u0026#34;xxx2\u0026#34;), HOSPITALIZATION(3, \u0026#34;web/xxx/\u0026#34;, \u0026#34;xxx3\u0026#34;), ARTICLE_IMG(4, \u0026#34;web/xxxxxx/\u0026#34;, \u0026#34;xxx4\u0026#34;), NOTICE_IMG(5, \u0026#34;web/notice/\u0026#34;, \u0026#34;xx5\u0026#34;), DEFAULT_IMG(6, \u0026#34;web/default/\u0026#34;, \u0026#34;DEFAULT\u0026#34;), ; private final int code; private final String folder; private final String desc; public static OSSFolderEnum valueOfCode(int code) { return Arrays.stream(OSSFolderEnum.values()) .filter(e -\u0026gt; e.getCode() == code) .findFirst() .orElse(DEFAULT_IMG); } } 2. å¤©ç¿¼äº‘ä¸Šä¼  controller\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Value(\u0026#34;${oos.bucket}\u0026#34;) private String bucketName; @Value(\u0026#34;${oos.fileURL}\u0026#34;) private String OOS_URL; @PostMapping(\u0026#34;singleUpload\u0026#34;) @ApiOperation(\u0026#34;å•æ–‡ä»¶ä¸Šä¼ \u0026#34;) public ResponseResult\u0026lt;Object\u0026gt; singleUpload( @NotNull(message = \u0026#34;è¯·é€‰æ‹©ç…§ç‰‡ä¸Šä¼ \u0026#34;) @RequestParam(\u0026#34;file\u0026#34;) MultipartFile file, @RequestParam(value = \u0026#34;folderType\u0026#34;, defaultValue = \u0026#34;6\u0026#34;) Integer folderType) { String originalFilename = file.getOriginalFilename(); String pathFileName = OSSFolderEnum.valueOfCode(folderType).getFolder() + LocalDateTime.now().format(DateTimePatterns.F_YYYY_MM_DD_HH_MM_SS_SSS) + Objects.requireNonNull(originalFilename).substring(originalFilename.lastIndexOf(\u0026#34;.\u0026#34;)); OosUtil.uploadFile(bucketName, pathFileName, file); String fileUrl = OOS_URL + pathFileName; return ResponseResult.createBySuccess(fileUrl); } utils, å•ä¾‹æ¨¡å¼åŒé‡æ£€æŸ¥è·å–client, é¿å…é‡å¤è·å–å’Œé‡Šæ”¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 public class OosUtil { private static final String accessKey = \u0026#34;\u0026#34;; private static final String secretKey = \u0026#34;\u0026#34;; private static final String endpoint = \u0026#34;\u0026#34;; // å•ä¾‹æ¨¡å¼åŒé‡æ£€æŸ¥ private volatile static AmazonS3 client; public static AmazonS3 getOOSClient() { if (client == null) { synchronized (OSSUtil.class) { if (client == null) { ClientConfiguration clientConfig = new ClientConfiguration(); // è®¾ç½®è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’ clientConfig.setConnectionTimeout(30 * 1000); // è®¾ç½® socket è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’ clientConfig.setSocketTimeout(30 * 1000); clientConfig.setProtocol(Protocol.HTTP); //è®¾ç½® http // è®¾ç½® V4 ç­¾åç®—æ³•ä¸­è´Ÿè½½æ˜¯å¦å‚ä¸ç­¾å S3ClientOptions options = new S3ClientOptions(); options.setPayloadSigningEnabled(true); // åˆ›å»º client client = new AmazonS3Client( new PropertiesCredentials(accessKey, secretKey)); // è®¾ç½® endpoint client.setEndpoint(endpoint); //è®¾ç½®é€‰é¡¹ client.setS3ClientOptions(options); } } } return client; } public static void uploadFile(String bucket, String fileName, MultipartFile file) { AmazonS3 oosClient = getOOSClient(); try (InputStream inputStream = file.getInputStream()) { oosClient.putObject(bucket, fileName, inputStream, null); } catch (Exception e) { throw new ServiceException(\u0026#34;ä¸Šä¼ æ–‡ä»¶å¤±è´¥, è¯·ç¨åå†è¯•\u0026#34;); } } public static void deleteFile(String bucketName, String urlPath) { getOOSClient().deleteObject(bucketName, urlPath); } } ","permalink":"https://habyss.github.io/posts/tech/oss_file_upload/","summary":"1. é˜¿é‡Œäº‘æ–‡ä»¶ä¸Šä¼  å‰æè®¾ç½®å¥½bucketå’Œç›¸åº”çš„url controller 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Value(\u0026#34;${oss.bucket}\u0026#34;) private String bucketName; @Value(\u0026#34;${oss.fileURL}\u0026#34;) private String OSS_URL; @PostMapping(\u0026#34;singleUpload\u0026#34;) @ApiOperation(\u0026#","title":"é˜¿é‡Œäº‘/å¤©ç¿¼äº‘æ–‡ä»¶ä¸Šä¼  å•ä¾‹ä¼˜åŒ–"},{"content":"é—®é¢˜ ä½¿ç”¨mybatisPlusè‡ªå¸¦çš„saveBatch() å’Œ updateBatchById() æ–¹æ³•è¿›è¡Œæ‰¹é‡æ’å…¥/æ›´æ–°æ—¶, ä»…ä»…30æ¡æ•°æ®è€—æ—¶3~5s.. è¿™å¾ˆä¸æ­£å¸¸\nåŸå›  æºç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public static \u0026lt;E\u0026gt; boolean executeBatch(Class\u0026lt;?\u0026gt; entityClass, Log log, Collection\u0026lt;E\u0026gt; list, int batchSize, BiConsumer\u0026lt;SqlSession, E\u0026gt; consumer) { Assert.isFalse(batchSize \u0026lt; 1, \u0026#34;batchSize must not be less than one\u0026#34;); return !CollectionUtils.isEmpty(list) \u0026amp;\u0026amp; executeBatch(entityClass, log, sqlSession -\u0026gt; { int size = list.size(); int idxLimit = Math.min(batchSize, size); int i = 1; for (E element : list) { consumer.accept(sqlSession, element); if (i == idxLimit) { sqlSession.flushStatements(); idxLimit = Math.min(idxLimit + batchSize, size); } i++; } }); } æ—¥å¿— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 ==\u0026gt; Preparing: INSERT INTO h_sort_table ( sort, update_time, create_time ) VALUES ( ?, ?, ? ) ==\u0026gt; Parameters: 1024(Long), 2022-12-05T14:41:28.705730(LocalDateTime), 2022-12-05T14:41:28.705730(LocalDateTime) ==\u0026gt; Parameters: 2048(Long), 2022-12-05T14:41:28.707724500(LocalDateTime), 2022-12-05T14:41:28.707724500(LocalDateTime) ==\u0026gt; Parameters: 3072(Long), 2022-12-05T14:41:28.708721100(LocalDateTime), 2022-12-05T14:41:28.708721100(LocalDateTime) ==\u0026gt; Parameters: 4096(Long), 2022-12-05T14:41:28.708721100(LocalDateTime), 2022-12-05T14:41:28.708721100(LocalDateTime) ==\u0026gt; Parameters: 5120(Long), 2022-12-05T14:41:28.709718200(LocalDateTime), 2022-12-05T14:41:28.709718200(LocalDateTime) ==\u0026gt; Parameters: 6144(Long), 2022-12-05T14:41:28.709718200(LocalDateTime), 2022-12-05T14:41:28.709718200(LocalDateTime) ==\u0026gt; Parameters: 7168(Long), 2022-12-05T14:41:28.709718200(LocalDateTime), 2022-12-05T14:41:28.709718200(LocalDateTime) ==\u0026gt; Parameters: 8192(Long), 2022-12-05T14:41:28.710715500(LocalDateTime), 2022-12-05T14:41:28.710715500(LocalDateTime) ==\u0026gt; Parameters: 9216(Long), 2022-12-05T14:41:28.711218100(LocalDateTime), 2022-12-05T14:41:28.711218100(LocalDateTime) ==\u0026gt; Parameters: 10240(Long), 2022-12-05T14:41:28.711218100(LocalDateTime), 2022-12-05T14:41:28.711218100(LocalDateTime) ==\u0026gt; Parameters: 11264(Long), 2022-12-05T14:41:28.711218100(LocalDateTime), 2022-12-05T14:41:28.711218100(LocalDateTime) ==\u0026gt; Parameters: 12288(Long), 2022-12-05T14:41:28.712222200(LocalDateTime), 2022-12-05T14:41:28.712222200(LocalDateTime) ==\u0026gt; Parameters: 13312(Long), 2022-12-05T14:41:28.713214500(LocalDateTime), 2022-12-05T14:41:28.713214500(LocalDateTime) ==\u0026gt; Parameters: 14336(Long), 2022-12-05T14:41:28.714212300(LocalDateTime), 2022-12-05T14:41:28.714212300(LocalDateTime) ==\u0026gt; Parameters: 15360(Long), 2022-12-05T14:41:28.715356500(LocalDateTime), 2022-12-05T14:41:28.715356500(LocalDateTime) ==\u0026gt; Parameters: 16384(Long), 2022-12-05T14:41:28.715356500(LocalDateTime), 2022-12-05T14:41:28.715356500(LocalDateTime) ==\u0026gt; Parameters: 17408(Long), 2022-12-05T14:41:28.716356500(LocalDateTime), 2022-12-05T14:41:28.716356500(LocalDateTime) ==\u0026gt; Parameters: 18432(Long), 2022-12-05T14:41:28.716356500(LocalDateTime), 2022-12-05T14:41:28.716356500(LocalDateTime) ==\u0026gt; Parameters: 19456(Long), 2022-12-05T14:41:28.717356(LocalDateTime), 2022-12-05T14:41:28.717356(LocalDateTime) ==\u0026gt; Parameters: 20480(Long), 2022-12-05T14:41:28.718350200(LocalDateTime), 2022-12-05T14:41:28.718350200(LocalDateTime) ==\u0026gt; Parameters: 21504(Long), 2022-12-05T14:41:28.718350200(LocalDateTime), 2022-12-05T14:41:28.718350200(LocalDateTime) ==\u0026gt; Parameters: 22528(Long), 2022-12-05T14:41:28.719348400(LocalDateTime), 2022-12-05T14:41:28.719348400(LocalDateTime) ==\u0026gt; Parameters: 23552(Long), 2022-12-05T14:41:28.719348400(LocalDateTime), 2022-12-05T14:41:28.719348400(LocalDateTime) ==\u0026gt; Parameters: 24576(Long), 2022-12-05T14:41:28.719348400(LocalDateTime), 2022-12-05T14:41:28.719348400(LocalDateTime) ==\u0026gt; Parameters: 25600(Long), 2022-12-05T14:41:28.720345700(LocalDateTime), 2022-12-05T14:41:28.720345700(LocalDateTime) ==\u0026gt; Parameters: 26624(Long), 2022-12-05T14:41:28.720345700(LocalDateTime), 2022-12-05T14:41:28.720345700(LocalDateTime) ==\u0026gt; Parameters: 27648(Long), 2022-12-05T14:41:28.721342300(LocalDateTime), 2022-12-05T14:41:28.721342300(LocalDateTime) ==\u0026gt; Parameters: 28672(Long), 2022-12-05T14:41:28.721342300(LocalDateTime), 2022-12-05T14:41:28.721342300(LocalDateTime) ==\u0026gt; Parameters: 29696(Long), 2022-12-05T14:41:28.722339400(LocalDateTime), 2022-12-05T14:41:28.722339400(LocalDateTime) ==\u0026gt; Parameters: 30720(Long), 2022-12-05T14:41:28.723336700(LocalDateTime), 2022-12-05T14:41:28.723336700(LocalDateTime) è¯·æ±‚è€—æ—¶ : 4054ms æŸ¥çœ‹æºç å’Œæ—¥å¿—å¯ä»¥çœ‹å‡º, mybatisPlusæ˜¯ä½¿ç”¨çš„å¾ªç¯å•æ¡æ•°æ®æ’å…¥, è¿™æ˜æ˜¾ä¸ç¬¦åˆæˆ‘ä»¬é«˜æ•ˆçš„éœ€æ±‚\nä¼˜åŒ– æ–¹å¼ä¸€, xmlä¸­æ‹¼æ¥ SQLè¯­å¥æ˜¯æœ‰é•¿åº¦é™åˆ¶ï¼Œåœ¨è¿›è¡Œæ•°æ®åˆå¹¶åœ¨åŒä¸€SQLä¸­åŠ¡å¿…ä¸èƒ½è¶…è¿‡SQLé•¿åº¦é™åˆ¶ï¼Œé€šè¿‡max_allowed_packeté…ç½®å¯ä»¥ä¿®æ”¹ï¼Œé»˜è®¤æ˜¯1Mï¼Œæµ‹è¯•æ—¶ä¿®æ”¹ä¸º8Mã€‚\nå¯ä»¥ä½¿ç”¨ideaæ’ä»¶æ¥ä»£æ›¿æˆ‘ä»¬æ‰‹å†™xml, æ¯”å¦‚MyBatisCodeHelper\ninsert:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;insert id=\u0026#34;insertList\u0026#34;\u0026gt; INSERT INTO h_sort_table( sort, id, update_time, create_time )VALUES \u0026lt;foreach collection=\u0026#34;list\u0026#34; item=\u0026#34;element\u0026#34; index=\u0026#34;index\u0026#34; separator=\u0026#34;,\u0026#34;\u0026gt; ( #{element.sort}, #{element.id}, #{element.updateTime}, #{element.createTime} ) \u0026lt;/foreach\u0026gt; \u0026lt;/insert\u0026gt; update:\néœ€è¦å¼€å¯mysqlçš„æ‰¹é‡æ“ä½œ \u0026amp;allowMultiQueries=true\nupdateçš„xmlæœ‰å¤šç§å†™æ³•, è¿™ç§æ˜¯å˜´è´±å¤§æ–¹ä¾¿çš„\nå…¶ä»–çš„è¿˜æœ‰case when ä»¥åŠ INSERT INTO â€¦ ON DUPLICATE KEY UPDATE\nsqlè¯­å¥forå¾ªç¯æ•ˆç‡å…¶å®ç›¸å½“é«˜çš„ï¼Œå› ä¸ºå®ƒä»…ä»…æœ‰ä¸€ä¸ªå¾ªç¯ä½“ï¼Œåªä¸è¿‡æœ€åupdateè¯­å¥æ¯”è¾ƒå¤šï¼Œé‡å¤§äº†å°±æœ‰å¯èƒ½é€ æˆ****sqlé˜»å¡****ã€‚\ncase whenè™½ç„¶æœ€ååªä¼šæœ‰ä¸€æ¡æ›´æ–°è¯­å¥ï¼Œä½†æ˜¯xmlä¸­çš„å¾ªç¯ä½“æœ‰ç‚¹å¤šï¼Œæ¯ä¸€ä¸ªcase when éƒ½è¦å¾ªç¯ä¸€élisté›†åˆï¼Œæ‰€ä»¥****å¤§æ‰¹é‡æ‹¼sqlçš„æ—¶å€™ä¼šæ¯”è¾ƒæ…¢****ï¼Œæ‰€ä»¥æ•ˆç‡é—®é¢˜ä¸¥é‡ã€‚ä½¿ç”¨çš„æ—¶å€™å»ºè®®åˆ†æ‰¹æ’å…¥ã€‚\nduplicate key updateå¯ä»¥çœ‹å‡ºæ¥æ˜¯æœ€å¿«çš„ï¼Œä½†æ˜¯ä¸€èˆ¬å¤§å…¬å¸éƒ½ç¦ç”¨ï¼Œ***å…¬å¸ä¸€èˆ¬éƒ½ç¦æ­¢ä½¿ç”¨replace intoå’ŒINSERT INTO â€¦ ON DUPLICATE KEY UPDATEï¼Œè¿™ç§sqlæœ‰å¯èƒ½ä¼šé€ æˆæ•°æ®ä¸¢å¤±å’Œä¸»ä»ä¸Šè¡¨çš„è‡ªå¢idå€¼ä¸ä¸€è‡´*ã€‚**è€Œä¸”ç”¨è¿™ä¸ªæ›´æ–°æ—¶ï¼Œè®°å¾—ä¸€å®šè¦åŠ ä¸Šidï¼Œè€Œä¸”valuesï¼ˆï¼‰æ‹¬å·é‡Œé¢æ”¾çš„æ˜¯æ•°æ®åº“å­—æ®µï¼Œä¸æ˜¯javaå¯¹è±¡çš„å±æ€§å­—æ®µã€‚\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;update id=\u0026#34;updateBatch\u0026#34; parameterType=\u0026#34;java.util.List\u0026#34; \u0026gt; \u0026lt;foreach collection=\u0026#34;list\u0026#34; item=\u0026#34;item\u0026#34; index=\u0026#34;index\u0026#34; open=\u0026#34;\u0026#34; close=\u0026#34;\u0026#34; separator=\u0026#34;;\u0026#34;\u0026gt; update h_sort_table \u0026lt;set \u0026gt; \u0026lt;if test=\u0026#34;item.sort != null\u0026#34; \u0026gt; sort = #{item.sort}, \u0026lt;/if\u0026gt; \u0026lt;/set\u0026gt; where id = #{item.id,jdbcType=BIGINT} \u0026lt;/foreach\u0026gt; \u0026lt;/update\u0026gt; æ–¹å¼äºŒ, æ‰©å±•mybatisPlus æ·»åŠ  InsertBatchMethod å’Œ UpdateBatchMethod ç±»ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 @Slf4j public class InsertBatchMethod extends AbstractMethod { @Override public MappedStatement injectMappedStatement(Class\u0026lt;?\u0026gt; mapperClass, Class\u0026lt;?\u0026gt; modelClass, TableInfo tableInfo) { final String sql = \u0026#34;\u0026lt;script\u0026gt;insert into %s %s values %s\u0026lt;/script\u0026gt;\u0026#34;; final String fieldSql = prepareFieldSql(tableInfo); final String valueSql = prepareValuesSql(tableInfo); final String sqlResult = String.format(sql, tableInfo.getTableName(), fieldSql, valueSql); // log.debug(\u0026#34;sqlResult-----\u0026gt;{}\u0026#34;, sqlResult); SqlSource sqlSource = languageDriver.createSqlSource(configuration, sqlResult, modelClass); return this.addInsertMappedStatement(mapperClass, modelClass, \u0026#34;insertBatch\u0026#34;, sqlSource, new NoKeyGenerator(), null, null); } private String prepareFieldSql(TableInfo tableInfo) { StringBuilder fieldSql = new StringBuilder(); fieldSql.append(tableInfo.getKeyColumn()).append(\u0026#34;,\u0026#34;); tableInfo.getFieldList().forEach(x -\u0026gt; fieldSql.append(x.getColumn()).append(\u0026#34;,\u0026#34;)); fieldSql.delete(fieldSql.length() - 1, fieldSql.length()); fieldSql.insert(0, \u0026#34;(\u0026#34;); fieldSql.append(\u0026#34;)\u0026#34;); return fieldSql.toString(); } private String prepareValuesSql(TableInfo tableInfo) { final StringBuilder valueSql = new StringBuilder(); valueSql.append(\u0026#34;\u0026lt;foreach collection=\\\u0026#34;list\\\u0026#34; item=\\\u0026#34;item\\\u0026#34; index=\\\u0026#34;index\\\u0026#34; open=\\\u0026#34;(\\\u0026#34; separator=\\\u0026#34;),(\\\u0026#34; close=\\\u0026#34;)\\\u0026#34;\u0026gt;\u0026#34;); valueSql.append(\u0026#34;#{item.\u0026#34;).append(tableInfo.getKeyProperty()).append(\u0026#34;},\u0026#34;); tableInfo.getFieldList().forEach(x -\u0026gt; valueSql.append(\u0026#34;#{item.\u0026#34;).append(x.getProperty()).append(\u0026#34;},\u0026#34;)); valueSql.delete(valueSql.length() - 1, valueSql.length()); valueSql.append(\u0026#34;\u0026lt;/foreach\u0026gt;\u0026#34;); return valueSql.toString(); } } @Slf4j public class UpdateBatchMethod extends AbstractMethod { @Override public MappedStatement injectMappedStatement(Class\u0026lt;?\u0026gt; mapperClass, Class\u0026lt;?\u0026gt; modelClass, TableInfo tableInfo) { String sql = \u0026#34;\u0026lt;script\u0026gt;\\n\u0026lt;foreach collection=\\\u0026#34;list\\\u0026#34; item=\\\u0026#34;item\\\u0026#34; separator=\\\u0026#34;;\\\u0026#34;\u0026gt;\\nupdate %s %s where %s=#{%s} %s\\n\u0026lt;/foreach\u0026gt;\\n\u0026lt;/script\u0026gt;\u0026#34;; String additional = tableInfo.isWithVersion() ? tableInfo.getVersionFieldInfo().getVersionOli(\u0026#34;item\u0026#34;, \u0026#34;item.\u0026#34;) : \u0026#34;\u0026#34; + tableInfo.getLogicDeleteSql(true, true); String setSql = sqlSet(tableInfo.isLogicDelete(), false, tableInfo, false, \u0026#34;item\u0026#34;, \u0026#34;item.\u0026#34;); String sqlResult = String.format(sql, tableInfo.getTableName(), setSql, tableInfo.getKeyColumn(), \u0026#34;item.\u0026#34; + tableInfo.getKeyProperty(), additional); // log.debug(\u0026#34;sqlResult-----\u0026gt;{}\u0026#34;, sqlResult); SqlSource sqlSource = languageDriver.createSqlSource(configuration, sqlResult, modelClass); return this.addUpdateMappedStatement(mapperClass, modelClass, \u0026#34;updateBatch\u0026#34;, sqlSource); } } æ·»åŠ è‡ªå®šä¹‰æ–¹æ³•SQLæ³¨å…¥å™¨ CustomizedSqlInjectorï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public class CustomizedSqlInjector extends DefaultSqlInjector { /** * å¦‚æœåªéœ€å¢åŠ æ–¹æ³•ï¼Œä¿ç•™mybatis plusè‡ªå¸¦æ–¹æ³•ï¼Œ * å¯ä»¥å…ˆè·å–super.getMethodList()ï¼Œå†æ·»åŠ add */ @Override public List\u0026lt;AbstractMethod\u0026gt; getMethodList(Class\u0026lt;?\u0026gt; mapperClass) { List\u0026lt;AbstractMethod\u0026gt; methodList = super.getMethodList(mapperClass); methodList.add(new InsertBatchMethod()); methodList.add(new UpdateBatchMethod()); return methodList; } } @Configuration @EnableTransactionManagement @MapperScan(\u0026#34;com.xxx.xxx.mapper\u0026#34;) public class MybatisPlusConfig { @Bean public CustomizedSqlInjector customizedSqlInjector() { return new CustomizedSqlInjector(); } } æ·»åŠ é€šç”¨ mapper å’Œ serviceï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 public interface BasicMapper\u0026lt;T\u0026gt; extends BaseMapper\u0026lt;T\u0026gt; { /** * è‡ªå®šä¹‰æ‰¹é‡æ’å…¥ */ int insertBatch(@Param(\u0026#34;list\u0026#34;) List\u0026lt;T\u0026gt; list); /** * è‡ªå®šä¹‰æ‰¹é‡æ›´æ–°ï¼Œæ¡ä»¶ä¸ºä¸»é”® */ int updateBatch(@Param(\u0026#34;list\u0026#34;) List\u0026lt;T\u0026gt; list); } public interface BasicService\u0026lt;T\u0026gt; extends IService\u0026lt;T\u0026gt; { int insertBatch(List\u0026lt;T\u0026gt; list); int updateBatch(List\u0026lt;T\u0026gt; list); } public class BasicServiceImpl\u0026lt;M extends BasicMapper\u0026lt;T\u0026gt;, T\u0026gt; extends ServiceImpl\u0026lt;M, T\u0026gt; implements BasicService\u0026lt;T\u0026gt; { @Override public int insertBatch(List\u0026lt;T\u0026gt; list) { return baseMapper.insertBatch(list); } @Override public int updateBatch(List\u0026lt;T\u0026gt; list) { return baseMapper.updateBatch(list); } } æ€»ç»“ é¡¹ç›®ä¸­ä½¿ç”¨æ‰¹é‡æ’å…¥å’Œæ‰¹é‡æ›´æ–°çš„åœ°æ–¹ä¸€èˆ¬å¹¶ä¸å¤š, æ¨èxmlæ–¹å¼.\nå½“ç„¶å¦‚æœé¡¹ç›®ä¸­å¤„ç†æ•°æ®è¿™ç§æ‰¹é‡çš„ä¸šåŠ¡æ¯”è¾ƒå¤š, æ¨èæ‰©å±•çš„æ–¹å¼, åç»­åªéœ€è¦å®ç°BasicServiceå°±okäº†.\n","permalink":"https://habyss.github.io/posts/tech/mybatis_plus_batch/","summary":"é—®é¢˜ ä½¿ç”¨mybatisPlusè‡ªå¸¦çš„saveBatch() å’Œ updateBatchById() æ–¹æ³•è¿›è¡Œæ‰¹é‡æ’å…¥/æ›´æ–°æ—¶, ä»…ä»…30æ¡æ•°æ®è€—æ—¶3~5s.. è¿™å¾ˆä¸æ­£å¸¸ åŸå›  æºç  1 2","title":"mybatisPlusä¸‹çš„æ‰¹é‡æ’å…¥ä¿®æ”¹ æ¢ç´¢"},{"content":"ç®€å•demoå®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 /** * çŸ­é“¾é‡å®šå‘ * * @param shortLink çŸ­é“¾æ¥ * @param response å“åº” * @throws IOException ioexception */ @GetMapping(\u0026#34;/s/{shortLink}\u0026#34;) public void shortLink(@PathVariable(\u0026#34;shortLink\u0026#34;) String shortLink, HttpServletResponse response) throws IOException { // ä»æ•°æ®åº“æˆ–è€…ç¼“å­˜ä¸­è·å–å¯¹åº”é“¾æ¥ String link = \u0026#34;https://www.baidu.com\u0026#34;; response.sendRedirect(StringUtils.hasText(link) ? link : \u0026#34;default\u0026#34;); } /** * è·å–çŸ­é“¾ * * @param link é“¾æ¥ * @return {@link String} */ @PostMapping(\u0026#34;shortLink\u0026#34;) public String getLink(String link) { // ç”ŸæˆçŸ­é“¾code, å¹¶å­˜å‚¨æ•°æ®åº“ return shortUrl(link).stream() .dropWhile(this::notExistInDb) .findAny() .orElseThrow(() -\u0026gt; new RuntimeException(\u0026#34;é“¾æ¥ç”Ÿæˆé”™è¯¯, ç¨åé‡è¯•\u0026#34;)); } /** * æ•°æ®åº“æ˜¯å¦å­˜åœ¨å¯¹åº”çŸ­é“¾ * * @param shortCode çŸ­ç½‘å€ * @return boolean */ private boolean notExistInDb(String shortCode) { // å»æ•°æ®åº“æŸ¥è¯¢ sqlå¯ä¼˜åŒ–ä¸º limit 1; return Instant.now().toEpochMilli() % 2 == 0; } /** * 4ç»„6ä½çŸ­é“¾æ¥å­—ç¬¦ä¸² * * @param url url * @return {@link List}\u0026lt;{@link String}\u0026gt; */ public static List\u0026lt;String\u0026gt; shortUrl(String url) { // å¯ä»¥è‡ªå®šä¹‰ç”Ÿæˆ MD5 åŠ å¯†å­—ç¬¦ä¼ å‰çš„æ··åˆ KEY String key = Instant.now().toString(); // è¦ä½¿ç”¨ç”Ÿæˆ URL çš„å­—ç¬¦ String[] chars = new String[]{\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;, \u0026#34;d\u0026#34;, \u0026#34;e\u0026#34;, \u0026#34;f\u0026#34;, \u0026#34;g\u0026#34;, \u0026#34;h\u0026#34;, \u0026#34;i\u0026#34;, \u0026#34;j\u0026#34;, \u0026#34;k\u0026#34;, \u0026#34;l\u0026#34;, \u0026#34;m\u0026#34;, \u0026#34;n\u0026#34;, \u0026#34;o\u0026#34;, \u0026#34;p\u0026#34;, \u0026#34;q\u0026#34;, \u0026#34;r\u0026#34;, \u0026#34;s\u0026#34;, \u0026#34;t\u0026#34;, \u0026#34;u\u0026#34;, \u0026#34;v\u0026#34;, \u0026#34;w\u0026#34;, \u0026#34;x\u0026#34;, \u0026#34;y\u0026#34;, \u0026#34;z\u0026#34;, \u0026#34;0\u0026#34;, \u0026#34;1\u0026#34;, \u0026#34;2\u0026#34;, \u0026#34;3\u0026#34;, \u0026#34;4\u0026#34;, \u0026#34;5\u0026#34;, \u0026#34;6\u0026#34;, \u0026#34;7\u0026#34;, \u0026#34;8\u0026#34;, \u0026#34;9\u0026#34;, \u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;C\u0026#34;, \u0026#34;D\u0026#34;, \u0026#34;E\u0026#34;, \u0026#34;F\u0026#34;, \u0026#34;G\u0026#34;, \u0026#34;H\u0026#34;, \u0026#34;I\u0026#34;, \u0026#34;J\u0026#34;, \u0026#34;K\u0026#34;, \u0026#34;L\u0026#34;, \u0026#34;M\u0026#34;, \u0026#34;N\u0026#34;, \u0026#34;O\u0026#34;, \u0026#34;P\u0026#34;, \u0026#34;Q\u0026#34;, \u0026#34;R\u0026#34;, \u0026#34;S\u0026#34;, \u0026#34;T\u0026#34;, \u0026#34;U\u0026#34;, \u0026#34;V\u0026#34;, \u0026#34;W\u0026#34;, \u0026#34;X\u0026#34;, \u0026#34;Y\u0026#34;, \u0026#34;Z\u0026#34; }; // å¯¹ä¼ å…¥ç½‘å€è¿›è¡Œ MD5 åŠ å¯† String sMD5EncryptResult = DigestUtils.md5DigestAsHex((key + url).getBytes()).toUpperCase(); ArrayList\u0026lt;String\u0026gt; results = new ArrayList\u0026lt;\u0026gt;(); //å¾—åˆ° 4ç»„çŸ­é“¾æ¥å­—ç¬¦ä¸² for (int i = 0; i \u0026lt; 4; i++) { // æŠŠåŠ å¯†å­—ç¬¦æŒ‰ç…§ 8 ä½ä¸€ç»„ 16 è¿›åˆ¶ä¸ 0x3FFFFFFF è¿›è¡Œä½ä¸è¿ç®— String sTempSubString = sMD5EncryptResult.substring(i * 8, i * 8 + 8); // è¿™é‡Œéœ€è¦ä½¿ç”¨ long å‹æ¥è½¬æ¢ï¼Œå› ä¸º Inteper .parseInt() åªèƒ½å¤„ç† 31 ä½ , é¦–ä½ä¸ºç¬¦å·ä½ , å¦‚æœä¸ç”¨ long ï¼Œåˆ™ä¼šè¶Šç•Œ long lHexLong = 0x3FFFFFFF \u0026amp; Long.parseLong(sTempSubString, 16); StringBuilder outChars = new StringBuilder(); //å¾ªç¯è·å¾—æ¯ç»„6ä½çš„å­—ç¬¦ä¸² for (int j = 0; j \u0026lt; 6; j++) { // æŠŠå¾—åˆ°çš„å€¼ä¸ 0x0000003D è¿›è¡Œä½ä¸è¿ç®—ï¼Œå–å¾—å­—ç¬¦æ•°ç»„ chars ç´¢å¼•(å…·ä½“éœ€è¦çœ‹charsæ•°ç»„çš„é•¿åº¦ ä»¥é˜²ä¸‹æ ‡æº¢å‡ºï¼Œæ³¨æ„èµ·ç‚¹ä¸º0) long index = 0x0000003D \u0026amp; lHexLong; // æŠŠå–å¾—çš„å­—ç¬¦ç›¸åŠ  outChars.append(chars[(int) index]); // æ¯æ¬¡å¾ªç¯æŒ‰ä½å³ç§» 5 ä½ lHexLong = lHexLong \u0026gt;\u0026gt; 5; } // æŠŠå­—ç¬¦ä¸²å­˜å…¥å¯¹åº”ç´¢å¼•çš„è¾“å‡ºæ•°ç»„ results.add(outChars.toString()); } // æŠŠå­—ç¬¦ä¸²å­˜å…¥å¯¹åº”ç´¢å¼•çš„è¾“å‡ºæ•°ç»„ return results; } ä¸šåŠ¡éœ€è¦åˆ†äº«é¡µé¢, åœ¨å‘é€çŸ­ä¿¡æˆ–è€…æ¶ˆæ¯æ—¶å¸¦çš„åŸé“¾æ¥å¤ªé•¿äº†, éœ€è¦ä½¿ç”¨çŸ­é“¾æ¥ä¼˜åŒ–, ç”±äºæ˜¯è‡ªå·±ä¸šåŠ¡ä½¿ç”¨, ä¸æ¶‰åŠç”¨æˆ·è‡ªå®šä¹‰é“¾æ¥çš„éƒ¨åˆ†, æ‰€ä»¥å°±è‡ªå·±æ­å»ºäº†ç®€å•çš„çŸ­é“¾æœåŠ¡.\nçŸ­é“¾-æ‘˜è¦ç®—æ³• å°†é•¿ç½‘å€md5ç”Ÿæˆ32ä½ç­¾åä¸², åˆ†ä¸º4æ®µ, æ¯æ®µ8ä¸ªå­—èŠ‚ï¼› å¯¹è¿™å››æ®µå¾ªç¯å¤„ç†, å–8ä¸ªå­—èŠ‚, å°†ä»–çœ‹æˆ16è¿›åˆ¶ä¸²ä¸0x3fffffff(30ä½1)ä¸æ“ä½œ, å³è¶…è¿‡30ä½çš„å¿½ç•¥å¤„ç†ï¼› è¿™30ä½åˆ†æˆ6æ®µ, æ¯5ä½çš„æ•°å­—ä½œä¸ºå­—æ¯è¡¨çš„ç´¢å¼•å–å¾—ç‰¹å®šå­—ç¬¦, ä¾æ¬¡è¿›è¡Œè·å¾—6ä½å­—ç¬¦ä¸²ï¼› æ€»çš„md5ä¸²å¯ä»¥è·å¾—4ä¸ª6ä½ä¸²ï¼›å–é‡Œé¢çš„ä»»æ„ä¸€ä¸ªå°±å¯ä½œä¸ºè¿™ä¸ªé•¿urlçš„çŸ­urlåœ°å€ï¼› è¿™ç§ç®—æ³•,è™½ç„¶ä¼šç”Ÿæˆ4ä¸ª,ä½†æ˜¯ä»ç„¶å­˜åœ¨é‡å¤å‡ ç‡ã€‚\nè™½ç„¶å‡ ç‡å¾ˆå°ï¼Œä½†æ˜¯è¯¥æ–¹æ³•ä¾ç„¶å­˜åœ¨ç¢°æ’çš„å¯èƒ½æ€§, æ‰€ä»¥ä½¿ç”¨äº†æ—¶é—´keyæ··æ·†, è®©ç”¨æˆ·ç¨åé‡è¯•.\nå­˜å‚¨/ç¼“å­˜ è§†æƒ…å†µè€Œå®š, æ¯”å¦‚å¤±æ•ˆæ—¶é—´, åŸŸåå•ç‹¬ä¿å­˜, å°†æœ€è¿‘çš„çƒ­ç‚¹æ•°æ®ç¼“å­˜ ç­‰ç­‰\n","permalink":"https://habyss.github.io/posts/tech/shorturl/","summary":"ç®€å•demoä»£ç , çŸ­é“¾ç”Ÿæˆç®—æ³•, é‡å®šå‘æ–¹å¼, å­˜å‚¨æ–¹å¼å’Œç¼“å­˜æ ¹æ®ä¸šåŠ¡æƒ…å†µå®ç°","title":"çŸ­é“¾æœåŠ¡å®ç°"},{"content":"é—®é¢˜ åœ¨æˆ‘ä»¬ä½¿ç”¨gitçš„æ—¶å€™, æœ‰æ—¶å€™å¯èƒ½æŸäº›åŠŸèƒ½ä»£ç ä¸éœ€è¦äº†, æˆ–è€…ç‰ˆæœ¬, æˆ–è€…è¯¯æäº¤ä¹‹ç±»çš„, éœ€è¦å°†è¿œç¨‹çš„ä»£ç å›é€€åˆ°æŸä¸ªç‰¹å®šçš„ç‰ˆæœ¬\nå› ä¸ºæ¶‰åŠå¤§é‡ä»£ç çš„ä¿®æ”¹, å¯¼è‡´ä¸€ä¸ªä¸ªçš„æ–‡ä»¶æ”¹å›å†æäº¤çš„è¯ä¼šéå¸¸éº»çƒ¦\nè¿™é‡Œè®°å½•äº†åœ¨Intellij Ideaä¸­å›æ»šè¿œç¨‹ä»£ç çš„æ“ä½œ\nå›æ»šæ“ä½œ 1. å›æ»šæœ¬åœ°ä»£ç  å…ˆå¤åˆ¶è¦å›æ»šçš„ç‰ˆæœ¬å·\nç„¶åé€‰æ‹©èœå•æ‡’ Git-\u0026gt;Repository-\u0026gt;Reset HEAD\nReset Type æœ‰ä¸‰ç§ï¼š\nmixed é»˜è®¤æ–¹å¼ï¼Œåªä¿ç•™æºç ï¼Œå›é€€ commit å’Œ index ä¿¡æ¯ soft å›é€€åˆ°æŸä¸ªç‰ˆæœ¬ï¼Œåªå›é€€äº† commit çš„ä¿¡æ¯ï¼Œä¸ä¼šæ¢å¤åˆ° index file ä¸€çº§ã€‚å¦‚æœè¿˜è¦æäº¤ï¼Œç›´æ¥ commit hard å½»åº•å›é€€ï¼Œæœ¬åœ°æºç ä¹Ÿä¼šå˜æˆä¸Šä¸€ä¸ªç‰ˆæœ¬å†…å®¹\næ­¤æ—¶æˆ‘ä»¬é€‰æ‹© Hard å½»åº•å›é€€, å¡«å…¥ç‰ˆæœ¬å·, ç‚¹å‡» Reset å°±èƒ½å°†æœ¬åœ°ä»£ç ç‰ˆæœ¬å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ã€‚\n2. å›æ»šè¿œç¨‹ä»£ç  ç¬¬ä¸€ç§ï¼Œç›´æ¥å¼ºåˆ¶æäº¤ï¼Œä½¿ç”¨ git å‘½ä»¤æäº¤ git push -fï¼Œä½†æ˜¯è¿™æ ·ä¼šæŠŠå›æ»šç‰ˆæœ¬ä¹‹åçš„æäº¤è®°å½•å…¨éƒ¨åˆ é™¤ï¼Œå› æ­¤ä¸å»ºè®®è¿™æ ·åšã€‚\nç¬¬äºŒç§ï¼Œç”¨å‰é¢æˆ‘ä»¬å›æ»šæœ¬åœ°çš„æ–¹å¼ï¼Œå†æ¬¡å›æ»šåˆ°æœ€æ–°ç‰ˆæœ¬ã€‚\nè·Ÿä¹‹å‰ä¸€æ ·çš„æ“ä½œ, ä¸è¿‡æ˜¯æœ€æ–°çš„ç‰ˆæœ¬å·.\nå†æ¬¡ Git-\u0026gt;Repository-\u0026gt;Reset HEAD, Reset Type é‡‡ç”¨ Mixed æ–¹å¼å°†æºç ä¿ç•™ï¼Œç„¶åç‚¹å‡» Resetã€‚\næ­¤æ—¶ä»£ç å·²ç»æ˜¯æ—§ç‰ˆæœ¬çš„ä»£ç ï¼Œå¹¶ä¸”ç‰ˆæœ¬è¿˜æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ­¤æ—¶æ­£å¸¸æäº¤ push åæœ¬åœ°å’Œè¿œç¨‹ä»£ç çš„å›æ»šå°±å®Œæˆäº†ã€‚\n","permalink":"https://habyss.github.io/posts/tool/git_reset/","summary":"å°†è¿œç¨‹çš„ä»£ç å›æ»šåˆ°æŸä¸ªç‰ˆæœ¬","title":"Gitå›æ»šæ–¹å¼ Idea"},{"content":"Javaä¸­çš„é” 1. ä¹è§‚é” ä¸€ç§ä¹è§‚æ€æƒ³, è¯»å–æ•°æ®çš„æ—¶å€™ä¹è§‚çš„è®¤ä¸ºåˆ«çš„çº¿ç¨‹ä¸ä¼šè¿›è¡Œä¿®æ”¹, æ‰€ä»¥è¯»å–çš„æ—¶å€™ä¸ä¸Šé”. å½“æ›´æ–°çš„æ—¶å€™ä¸Šé”, å¹¶åˆ¤æ–­å½“å‰å€¼æ˜¯å¦ä¸æœŸæœ›çš„ç›¸åŒ, ç›¸åŒåˆ™æ›´æ–°.\njavaä¸­çš„æœ¬åœ°æ–¹æ³•cas, æ•°æ®åº“ä¸€èˆ¬çš„versionå­—æ®µ\n2. æ‚²è§‚é” ä¸€ç§æ‚²è§‚æ€æƒ³, æ¯æ¬¡è¯»æ•°æ®çš„æ—¶å€™éƒ½æ‚²è§‚çš„è®¤ä¸ºåˆ«çš„çº¿ç¨‹ä¼šè¿›è¡Œä¿®æ”¹ , æ‰€ä»¥è¯»å–çš„æ—¶å€™ä¸Šé”. åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè¯»å†™æ“ä½œ.\njavaä¸­çš„synchronized, ReentrantLock\n3. è‡ªæ—‹é” ä¸ºäº†é¿å…çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€, è®©ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå¾ªç¯æ“ä½œ, è€Œä¸ºäº†é¿å…é•¿æ—¶é—´å ç”¨å¤„ç†å™¨æ—¶é—´, ä¸€æˆ˜æœ‰é»˜è®¤çš„è‡ªæ—‹æ¬¡æ•°, javaé»˜è®¤10æ¬¡, ä¹‹åä¼šä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼æŒ‚èµ·çº¿ç¨‹.\njavaä¸­casæ¯”è¾ƒå¤±è´¥åçš„è‡ªæ—‹\n4. å¯é‡å…¥é” å¯æœ‰æ•ˆé¿å…æ­»é”, ä»»æ„ä¸€ä¸ªçº¿ç¨‹åœ¨è·å–é”ä¹‹åèƒ½å†æ¬¡è·å–é”, ä½†å…¶ä»–çº¿ç¨‹ä¸å¯è·å–é”, ä¸ä¼šè¢«é”é˜»å¡. å†…ç½®è®¡æ•°å™¨\njavaä¸­çš„ReentrantLock, synchronizedä¿®é¥°\n5. è¯»å†™é” ReentrantReadWriteLock, åˆ†ä¸ºè¯»é”å’Œå†™é”, å¤šä¸ªè¯»é”ä¸äº’æ–¥, è¯»é”å’Œå†™é”äº’æ–¥.\nè¯»é”\u0026gt;å…è®¸å¤šä¸ªçº¿ç¨‹è·å–è¯»é”, åŒæ—¶è®¿é—®åŒä¸€ä¸ªèµ„æº\nå†™é”\u0026gt;åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–å†™é”, ä¸å…è®¸åŒæ—¶è®¿é—®åŒä¸€ä¸ªèµ„æº\n6. å…¬å¹³é” æŒ‰ç…§ç”³è¯·æ‰€çš„é¡ºåºæ¥è·å–é”, åœ¨å¹¶å‘ç¯å¢ƒä¸­, æ¯ä¸ªçº¿ç¨‹ä¼šå…ˆæŸ¥çœ‹æ­¤é”ç»´æŠ¤çš„ç­‰å¾…é˜Ÿåˆ—, å¦‚æœä¸ºç©º, åˆ™ç«™æœ‰é”, å¦‚æœä¸ä¸ºç©º, åˆ™åŠ å…¥åˆ°é˜Ÿåˆ—çš„æœ«å°¾, æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„åŸåˆ™å æœ‰é”.\n7. éå…¬å¹³é” çº¿ç¨‹å…ˆå°è¯•è·å–é”, å¦‚æœè·å–ä¸åˆ°, å†é‡‡ç”¨å…¬å¹³é”çš„æ–¹å¼. å³å¦‚æœå½“æ—¶é”çš„çŠ¶æ€åˆšå¥½æ˜¯æ²¡æœ‰è¢«å ç”¨çš„è¯, ç›´æ¥å æœ‰é”, ä¸å¿…ç­‰å¾…å’Œåˆ‡æ¢.\næ€§èƒ½ä¼šé«˜äºå…¬å¹³é”, ä½†æ˜¯æœ‰å¯èƒ½é€ æˆçº¿ç¨‹é¥¥é¥¿(æŸä¸ªçº¿ç¨‹å¾ˆé•¿æ—¶é—´å†…è·å–ä¸åˆ°é”)\nsynchronnized, ReentrantLockå¯æŒ‡å®š, ä½†é»˜è®¤æ˜¯éå…¬å¹³é”\n8. å…±äº«é” å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è·å–é”, ä»¥å…±äº«çš„æ–¹å¼æŒæœ‰é”.\njavaä¸­çš„ReentrantReadWriteLock\n9. ç‹¬å é” åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”\njavaä¸­çš„synchronnized, ReentrantLock\n10. ","permalink":"https://habyss.github.io/posts/tech/java%E4%B8%AD%E7%9A%84%E9%94%81/","summary":"Javaä¸­çš„é” 1. ä¹è§‚é” ä¸€ç§ä¹è§‚æ€æƒ³, è¯»å–æ•°æ®çš„æ—¶å€™ä¹è§‚çš„è®¤ä¸ºåˆ«çš„çº¿ç¨‹ä¸ä¼šè¿›è¡Œä¿®æ”¹, æ‰€ä»¥è¯»å–çš„æ—¶å€™ä¸ä¸Šé”. å½“æ›´æ–°çš„æ—¶å€™ä¸Šé”, å¹¶åˆ¤æ–­å½“å‰å€¼æ˜¯å¦ä¸","title":"Javaä¸­çš„é”"},{"content":"ç­–ç•¥æ¨¡å¼ ç­–ç•¥æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºæ¨¡å¼ï¼Œä¹Ÿæ˜¯æ›¿ä»£å¤§é‡ if else çš„åˆ©å™¨ã€‚ä»–èƒ½å¸®ä½ è§£å†³çš„åœºæ™¯ï¼Œä¸€èˆ¬æ˜¯å…·æœ‰åŒç±»å¯æ›¿ä»£çš„è¡Œä¸ºé€»è¾‘ç®—æ³•åœºæ™¯ã€‚\næ¯”å¦‚ï¼š\nä¸åŒç±»å‹çš„äº¤æ˜“æ–¹å¼ï¼ˆä¿¡ç”¨å¡ã€æ”¯ä»˜å®ã€å¾®ä¿¡ï¼‰ ä¸åŒçš„ç™»å½•æ–¹å¼ï¼ˆç”¨æˆ·åå¯†ç ã€æ‰‹æœºå·ã€é‚®ç®±ï¼‰ ç”Ÿæˆå”¯ä¸€çš„IDç­–ç•¥ï¼ˆUUIDã€è‡ªå¢ã€é›ªèŠ±ç®—æ³•ã€Leafç®—æ³•ï¼‰ ä»¥ä¸Šåœºæ™¯éƒ½å¯ä»¥ä½¿ç”¨ç­–ç•¥æ¨¡å¼åŒ…è£…ï¼Œæä¾›ç»™å¤–éƒ¨ä½¿ç”¨ã€‚\næ¨¡æ¿æ¨¡å¼ æ¨¡æ¿æ¨¡å¼çš„æ ¸å¿ƒè®¾è®¡æ€è·¯æ˜¯é€šè¿‡åœ¨æŠ½è±¡ç±»ä¸­å®šä¹‰æŠ½è±¡æ–¹æ³•çš„æ‰§è¡Œé¡ºåºï¼Œå¹¶å°†æŠ½è±¡æ–¹æ³•è®¾å®šä¸ºåªæœ‰å­ç±»å®ç°ï¼Œä½†ä¸è®¾è®¡ç‹¬ç«‹è®¿é—®çš„æ–¹æ³•ã€‚\nä»£ç  å®šä¹‰æšä¸¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public enum SignInMode { /** * éªŒè¯ç ç™»å½• */ SMS_CODE, /** * å¾®ä¿¡ç™»å½• */ WEI_XIN, /** * ç§’éªŒ */ MIAO_YAN, /** * å¯†ç  */ PASS_WORD; } å®šä¹‰æ¥å£ 1 2 3 4 5 6 public interface SignInHandler { boolean support(@NonNull SignInMode mode); String signIn(@NonNull AppSignInInput input); } å®šä¹‰æŠ½è±¡å®ç°ç±»(æ¨¡æ¿) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 @Slf4j public abstract class AbstractSignInHandler implements SignInHandler { @Override public String signIn(AppSignInInput input) { // ä¸åŒçš„ç™»é™†æ–¹å¼è·å–æ‰‹æœºå·çš„æ–¹å¼ä¸ä¸€è‡´ // å¤„ç†åçš„é¢å¤–å‚æ•°attachments String phoneNo = getPhoneNo(input, attachments); Verify.verifyNotNull(phoneNo); // æ‰‹æœºå·ç™»å½•æˆ–æ³¨å†Œ å¹¶è·å–ç”¨æˆ·ä¿¡æ¯ Pair\u0026lt;Integer, LocalDateTime\u0026gt; result = accountAuthService.signInOrSignUp(phoneNo); Integer accountId = result.getKey(); LocalDateTime signUpTime = result.getValue(); // è·å–è´¦å·ä¿¡æ¯ AppAccountInfoRecord accountInfoRecord = getAccount(accountId); // ç”Ÿæˆtokenè¿”å› å¹¶åœ¨rediså­˜å‚¨ç”¨æˆ·ä¿¡æ¯ ... return token; } /** * è·å–æ ¡éªŒè¿‡åçš„æ ¼å¼æ­£ç¡®çš„æ‰‹æœºå·ç  */ protected abstract String getPhoneNo(AppSignInInput input, Map\u0026lt;String, Object\u0026gt; attachments); å®šä¹‰ä¸åŒçš„ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Component public class PassWordSignInHandler extends AbstractSignInHandler { @Override public boolean support(SignInMode mode) { return SignInMode.PASS_WORD == mode; } @Override protected String getPhoneNo(AppSignInInput input, Map\u0026lt;String, Object\u0026gt; attachments) { return \u0026#34;phoneNo\u0026#34;; } } è°ƒç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @Slf4j @Component public class SignInManager { @Resource private List\u0026lt;SignInHandler\u0026gt; handlers; public String signIn(@NonNull AppSignInInput input) { SignInMode signInMode = input.getSignInMode(); return handlers.stream() .filter(it -\u0026gt; it.support(signInMode)) .findFirst() .orElseThrow(() -\u0026gt; new RuntimeException(\u0026#34;ä¸æ”¯æŒçš„çš„ç™»å½•æ¨¡å¼:\u0026#34; + signInMode)) .signIn(input); } } æ€»ç»“ ç­–ç•¥æ¨¡å¼ï¼š\nåœ¨loginæ–¹æ³•ä¸­é€šè¿‡ä¸åŒç™»å½•ç±»å‹ï¼Œäº¤ç»™æŒ‡å®šçš„ç±»æ‰§è¡Œç™»å½•é€»è¾‘ã€‚ï¼ˆä¹Ÿå°±æ˜¯æ‰¾æ¨¡æ¿ï¼‰ å„ç§æ¨¡æ¿æ³¨å…¥åˆ° List\u0026lt;SignInHandler\u0026gt; handlers ä¸­ æ¨¡æ¿æ¨¡å¼ï¼š\né¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª SignInHandler æ¥å£ï¼Œå…¶ä¸­å®šä¹‰äº†ç™»å½•ç›¸å…³æŠ½è±¡æ–¹æ³• åœ¨æŠ½è±¡ç±» AbstractSignInHandler ä¸­å®ç°ç™»å½•ç›¸å…³æ–¹æ³•ï¼Œä¾›å¤–éƒ¨è°ƒç”¨ï¼Œè¿™ä¸ªç±»æ˜¯æ¨¡æ¿æ¨¡å¼çš„çµé­‚ ğŸ’¡ æ ¹æ®é¡¹ç›®æƒ…å†µä½œå‡ºé€‚å½“ä¿®æ”¹å˜åŠ¨\n","permalink":"https://habyss.github.io/posts/tech/%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F-%E7%99%BB%E5%BD%95%E4%BC%98%E5%8C%96/","summary":"ç­–ç•¥æ¨¡å¼ ç­–ç•¥æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºæ¨¡å¼ï¼Œä¹Ÿæ˜¯æ›¿ä»£å¤§é‡ if else çš„åˆ©å™¨ã€‚ä»–èƒ½å¸®ä½ è§£å†³çš„åœºæ™¯ï¼Œä¸€èˆ¬æ˜¯å…·æœ‰åŒç±»å¯æ›¿ä»£çš„è¡Œä¸ºé€»è¾‘ç®—æ³•åœºæ™¯ã€‚ æ¯”å¦‚ï¼š ä¸åŒç±»å‹çš„äº¤æ˜“æ–¹å¼","title":"æ¨¡æ¿æ¨¡å¼\u0026ç­–ç•¥æ¨¡å¼-ç™»å½•ä¼˜åŒ–"},{"content":"springbootå¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºè‡ªå¸¦çš„banner, è¿™ä¸ªæ˜¯å¯ä»¥è‡ªå®šä¹‰çš„, è®°å½•ä¸€ä¸‹.\næˆ‘ä»¬åªéœ€è¦åœ¨springbooté¡¹ç›®çš„resourcesæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªbanner.txtæ–‡ä»¶å³å¯.\nå®šåˆ¶bannerçš„ç½‘ç«™\nhttps://patorjk.com/software/taag\n","permalink":"https://habyss.github.io/posts/tool/springboot_banner/","summary":"springbootå¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºè‡ªå¸¦çš„banner, è¿™ä¸ªæ˜¯å¯ä»¥è‡ªå®šä¹‰çš„, è®°å½•ä¸€ä¸‹. æˆ‘ä»¬åªéœ€è¦åœ¨springbooté¡¹ç›®çš„resourcesæ–‡","title":"SprintBootä¸‹çš„banner.text"},{"content":"å…¨å±€æ‹¦æˆª, åœ¨ MDC ä¸­æ’å…¥è‡ªå®šä¹‰ traceId ğŸ’¡ MDCï¼ˆMapped Diagnostic Contextï¼‰æœºåˆ¶å®ç°ï¼Œæ”¯æŒä¸»æµçš„Log4jã€Log4j2å’ŒLogbackæ—¥å¿—æ¡†æ¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @Order(Ordered.HIGHEST_PRECEDENCE) @Component @Slf4j public class TraceIdFilter extends OncePerRequestFilter { @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException { // æœåŠ¡é—´é€ä¼ traceId String traceId = request.getHeader(TraceIdUtil.TRACE_ID); if (StringUtils.hasText(traceId)){ TraceIdUtil.resetTraceId(traceId); }else { TraceIdUtil.resetTraceId(); } log.info(\u0026#34;---è¯·æ±‚åœ°å€: {} - {}\u0026#34;, request.getServletPath(), request.getQueryString()); chain.doFilter(request, response); } } å·¥å…·ç±» TraceIdUtils 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 @UtilityClass public class TraceIdUtils { public final static String TRACE_ID = \u0026#34;traceId\u0026#34;; public final static String DELIMITER = \u0026#34;-\u0026#34;; public final static String EMPTY = \u0026#34;\u0026#34;; /** * é‡ç½® traceId. * ä¸ºä¿è¯é“¾è·¯, è¯·æ±‚ä¸­æœ‰[å¼‚æ­¥/å¤šçº¿ç¨‹]æ‰§è¡Œæ—¶, * éœ€å…ˆè·å–å½“å‰traceId{@link TraceIdUtils#getTraceId()}, ç„¶ååœ¨æ–°çº¿ç¨‹ä¸­è®¾ç½®traceId * * @param uuid the uuid */ public void resetTraceId(String uuid) { MDC.put(TRACE_ID, uuid); } /** * é‡ç½®/åˆå§‹åŒ– traceId. */ public void resetTraceId() { MDC.put(TRACE_ID, UUID.randomUUID().toString().replaceAll(DELIMITER, EMPTY)); } /** * è·å–å½“å‰ traceId. * * @return the trace id */ public String getTraceId() { return MDC.get(TRACE_ID); } /** * åˆ é™¤å½“å‰ traceId. */ public void remove() { MDC.remove(TRACE_ID); } } æ—¥å¿—è¾“å‡ºé…ç½®æ–‡ä»¶ logback.xml ğŸ’¡ åœ¨é€‚å½“ä½ç½®æ·»åŠ  %X{traceId} , å–å‡ºåœ¨ MDC ä¸­è®¾ç½®çš„ traceId\n1 2 3 \u0026lt;pattern\u0026gt; %d{yyyy-MM-dd HH:mm:ss.SSS} %p %X{traceId} (%file:%line\\) - %m%n \u0026lt;/pattern\u0026gt; å¾®æœåŠ¡é€ä¼ openFeign åœ¨è¯·æ±‚å¤´ä¸­åŠ å…¥traceId, å¹¶åœ¨TraceIdFilterä¸­è¯»å–è¯·æ±‚å¤´\n1 2 3 4 5 6 7 8 9 @Component public class OpenFeignRequestInterceptor implements RequestInterceptor { @Override public void apply(RequestTemplate requestTemplate) { String traceId = TraceIdUtil.getTraceId(); requestTemplate.header(TraceIdUtil.TRACE_ID, traceId); } } ","permalink":"https://habyss.github.io/posts/tech/springboot_traceid/","summary":"å…¨å±€æ‹¦æˆª, åœ¨ MDC ä¸­æ’å…¥è‡ªå®šä¹‰ traceId ğŸ’¡ MDCï¼ˆMapped Diagnostic Contextï¼‰æœºåˆ¶å®ç°ï¼Œæ”¯æŒä¸»æµçš„Log4jã€Log4j2å’ŒLogbackæ—¥å¿—æ¡†æ¶ã€‚ 1","title":"TraceId æ—¥å¿—è·Ÿè¸ª"},{"content":"RabbitMq ç”Ÿäº§è€…ç¡®è®¤æ¶ˆæ¯è¢«æ¶ˆè´¹ æ¢ç´¢ æ¶ˆè´¹è€…æ‰‹åŠ¨ackçš„ä¸€äº›çŠ¶æ€, ç”Ÿäº§è€…æ˜¯ä¸èƒ½å‡†ç¡®å¾—çŸ¥çš„.\nä¾‹å¦‚:\n1 2 // å¤„ç†å¤±è´¥ é‡æ–°è¿›å…¥é˜Ÿåˆ— ç»§ç»­æ¶ˆè´¹ channel.basicNack(msg.getMessageProperties().getDeliveryTag(), false,true); å½“æ¶ˆè´¹è€…æŠŠæ¶ˆæ¯é‡æ–°æ”¾å…¥é˜Ÿåˆ—, ç”Ÿäº§è€…æ˜¯ä¸çŸ¥é“çš„\nâ€¦.\nè€Œ ç”Ÿäº§è€…çš„ convertSendAndReceive è™½ç„¶å¯ä»¥å¾—çŸ¥è¿”å›ä¿¡æ¯, ä½†æ˜¯å®ƒæ˜¯æœ‰æ¬¡æ•°é™åˆ¶çš„, è€Œæ¬¡æ•°æ˜¯æå‰è®¾å®šå¥½çš„, å¦‚æœæ¬¡æ•°èŒƒå›´å†…æ²¡æœ‰å¤„ç†æˆåŠŸ, åˆ™ä¼šæ¥æ”¶åˆ°null.\næ‰€ä»¥ä»ä¸èƒ½å‡†ç¡®å¾—çŸ¥æ¶ˆè´¹è€…çš„çŠ¶æ€.\nç”Ÿäº§è€…ä¸èƒ½å‡†ç¡®å¾—çŸ¥æ¶ˆè´¹è€…æ˜¯å¦æˆåŠŸæ¶ˆè´¹äº†æ¶ˆæ¯ é…ç½®æ–‡ä»¶ application.ymlä¸­å¢åŠ é…ç½®\n1 2 3 4 spring: rabbitmq: publisher-confirms: true publisher-returns: true ç”Ÿäº§è€…å¯ä»¥å®ç° RabbitTemplate.ReturnCallback, æ¥è·å–æ¶ˆæ¯åœ¨å‘é€åˆ°è·¯ç”±æˆ–è€…é˜Ÿåˆ—ä¸­çš„å¤±è´¥ä¿¡æ¯\næ™®é€šåˆ›å»ºç±»æ–¹å¼\nå®šä¹‰ReturnCallBackService\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 @Component public class ReturnCallBackService implements RabbitTemplate.ReturnCallback { /** * å‘é€åˆ°è·¯ç”±æˆ–è€…é˜Ÿåˆ—ä¸­çš„å¤±è´¥ä¿¡æ¯ * * @param message the returned message. * @param replyCode the reply code. * @param replyText the reply text. * @param exchange the exchange. * @param routingKey the routing key. */ @Override public void returnedMessage(Message message, int replyCode, String replyText, String exchange, String routingKey) { System.out.println(\u0026#34;return--message:\u0026#34; + new String(message.getBody()) + \u0026#34;,replyCode:\u0026#34; + replyCode + \u0026#34;,replyText:\u0026#34; + replyText + \u0026#34;,exchange:\u0026#34; + exchange + \u0026#34;,routingKey:\u0026#34; + routingKey); } } ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ä¹‹å‰è®¾ç½®\n1 rabbitTemplate.setReturnCallback(returnCallBackService); jdk8, åŒ¿åå‡½æ•°\nå‘é€æ¶ˆæ¯ä¹‹å‰è®¾ç½®\n1 2 3 4 rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -\u0026gt; { logger.info(\u0026#34;send message failed: \u0026#34; + replyCode + \u0026#34; \u0026#34; + replyText); rabbitTemplate.send(message); }); ç”Ÿäº§è€…å¯ä»¥å®ç° RabbitTemplate.ConfirmCallback, æ¥ç¡®è®¤æ¶ˆæ¯æ˜¯å¦å‘é€åˆ°å…·ä½“è·¯ç”±æˆ–è€…é˜Ÿåˆ—\næ™®é€šåˆ›å»ºç±»æ–¹å¼\nå®šä¹‰ConfirmCallback\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 @Component public class ConfirmCallbackService implements RabbitTemplate.ConfirmCallback { /** * ç¡®è®¤æ¶ˆæ¯æ˜¯å¦å‘é€åˆ°å…·ä½“è·¯ç”±æˆ–è€…é˜Ÿåˆ— * * @param correlationData correlation data for the callback. * @param ack true for ack, false for nack * @param cause An optional cause, for nack, when available, otherwise null. */ @Override public void confirm(CorrelationData correlationData, boolean ack, String cause) { System.out.println(\u0026#34;correlationData.getId() = \u0026#34; + correlationData.getId()); System.out.println(\u0026#34;ack = \u0026#34; + ack); if (ack){ System.err.println(\u0026#34;===============æ¶ˆæ¯å‘é€æˆåŠŸ============\u0026#34;); }else { //å‘é€å¤±è´¥ System.err.println(\u0026#34;================å¤±è´¥==================\u0026#34;); } System.out.println(\u0026#34;cause = \u0026#34; + cause); } } ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ä¹‹å‰è®¾ç½®\n1 rabbitTemplate.setConfirmCallback(confirmCallbackService); jdk8, åŒ¿åå‡½æ•°\nå‘é€æ¶ˆæ¯ä¹‹å‰è®¾ç½®\n1 2 3 4 5 6 7 8 9 rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -\u0026gt; { if (ack) { logger.info(\u0026#34;send message success: data [\u0026#34; + correlationData.getId() + \u0026#34;]\u0026#34;); // æ¸…é™¤é‡è¯•æœºåˆ¶ç¼“å­˜ // retryCache.del(Long.valueOf(correlationData.getId())); } else { logger.info(\u0026#34;send message failed: \u0026#34; + cause + correlationData.toString()); } }); æ‰‹åŠ¨ack æ¶ˆè´¹è€…çš„ @RabbitListener æ³¨è§£ä¸­æœ‰ containerFactory å­—æ®µ, å¯ä»¥æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰çš„ containerFactory .\nåˆ›å»ºè‡ªå®šä¹‰å¯ä»¥æ‰‹åŠ¨ackçš„ containerFactory:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Configuration public class ConsumeConfig { @Resource ConnectionFactory connectionFactory; @Bean(\u0026#34;rabbitListenerContainerFactoryAck\u0026#34;) public RabbitListenerContainerFactory\u0026lt;?\u0026gt; rabbitListenerContainerFactoryAck(){ SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory(); factory.setConnectionFactory(connectionFactory); factory.setAcknowledgeMode(AcknowledgeMode.MANUAL); return factory; } } åœ¨éœ€è¦æ‰‹åŠ¨ackçš„æ–¹æ³•ä¸ŠæŒ‡å®š bean\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @RabbitListener(queues = \u0026#34;update.crm.staff\u0026#34;,containerFactory = \u0026#34;rabbitListenerContainerFactoryAck\u0026#34;) @RabbitHandler public void updateCrmStaff(Channel channel, Message msg){ System.err.println(\u0026#34;========================æ¶ˆè´¹å¼€å§‹================\u0026#34;); try { byte[] body = msg.getBody(); String s = new String(body); JSONObject crmAgent = JSONObject.parseObject(s); // å¤„ç†å¤±è´¥ é‡æ–°è¿›å…¥é˜Ÿåˆ— ç»§ç»­æ¶ˆè´¹ channel.basicNack(msg.getMessageProperties().getDeliveryTag(), false,true); } catch (IOException e) { e.printStackTrace(); try { //å¤„ç†å¤±è´¥,ä¸¢å¼ƒæ¶ˆæ¯ channel.basicNack(msg.getMessageProperties().getDeliveryTag(), false,false); } catch (IOException e1) { e1.printStackTrace(); } } // æ‰‹åŠ¨ç¡®è®¤æ¶ˆè´¹ channel.basicAck(msg.getMessageProperties().getDeliveryTag(), false); System.err.println(\u0026#34;========================æ¶ˆè´¹ç»“æŸ================\u0026#34;); } } ","permalink":"https://habyss.github.io/posts/tech/rabbitmq_ack/","summary":"RabbitMq ç”Ÿäº§è€…ç¡®è®¤æ¶ˆæ¯è¢«æ¶ˆè´¹ æ¢ç´¢ æ¶ˆè´¹è€…æ‰‹åŠ¨ackçš„ä¸€äº›çŠ¶æ€, ç”Ÿäº§è€…æ˜¯ä¸èƒ½å‡†ç¡®å¾—çŸ¥çš„. ä¾‹å¦‚: 1 2 // å¤„ç†å¤±è´¥ é‡æ–°è¿›å…¥é˜Ÿåˆ— ç»§ç»­æ¶ˆè´¹ channel.basicNack(msg.getMessageProperties().getDeliveryTag(), false,true); å½“æ¶ˆè´¹è€…æŠŠæ¶ˆæ¯é‡æ–°","title":"rabbitmq ack æ¢ç´¢"},{"content":"é«˜å¹¶å‘æƒ…å†µä¸‹ RabbitMQ æœåŠ¡é™æµ springä¸‹é»˜è®¤ä¸º250, è‹¥é»˜å†™æœåŠ¡éœ€è¦é™æµæˆ–è€…éœ€è¦å¼ºåˆ¶é¡ºåºæ€§æ‰§è¡Œ, åˆ™éœ€è¦è‡ªå®šä¹‰qos\n1 2 3 4 5 @RabbitHandler @RabbitListener(queues = QueueConstant.RE_SMS_ORDER_NOT_PAID_QUEUE) public void process(Channel channel, Message message) throws IOException { channel.basicQos(12); } å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶æ¶ˆè´¹ä¸€ä¸ªæ¶ˆæ¯ ä½¿ç”¨å¹¿æ’­æ¨¡å¼, ç›‘å¬æ—¶ä¸æŒ‡å®šé˜Ÿåˆ—, åˆ™ä¼šäº§ç”Ÿéšå³é˜Ÿåˆ—\nä¸ºäº†é˜²æ­¢ç³»ç»Ÿè¿­ä»£é‡å¯äº§ç”Ÿçš„å¤§é‡éšæœºé˜Ÿåˆ—, éœ€è¦æ–­å¼€æ—¶åˆ é™¤éšæœºé˜Ÿåˆ—\n1 2 3 4 5 @RabbitListener(bindings = @QueueBinding( //æ³¨æ„è¿™é‡Œä¸è¦å®šä¹‰é˜Ÿåˆ—åç§°,ç³»ç»Ÿä¼šéšæœºäº§ç”Ÿ value = @Queue(exclusive = \u0026#34;true\u0026#34;),// exclusive = \u0026#34;true\u0026#34; æ–­å¼€æ—¶åˆ é™¤éšæœºé˜Ÿåˆ— é¿å…ç³»ç»Ÿè¿­ä»£é‡å¯äº§ç”Ÿçš„å¤§é‡éšæœºé˜Ÿåˆ— exchange = @Exchange(value = \u0026#34;å¡«å†™äº¤æ¢æœºåç§°\u0026#34;, type = ExchangeTypes.FANOUT) )) ","permalink":"https://habyss.github.io/posts/tech/rabbitmq_qos_random/","summary":"é«˜å¹¶å‘æƒ…å†µä¸‹ RabbitMQ æœåŠ¡é™æµ springä¸‹é»˜è®¤ä¸º250, è‹¥é»˜å†™æœåŠ¡éœ€è¦é™æµæˆ–è€…éœ€è¦å¼ºåˆ¶é¡ºåºæ€§æ‰§è¡Œ, åˆ™éœ€è¦è‡ªå®šä¹‰qos 1 2 3 4 5 @RabbitHandler @RabbitListener(queues = QueueConstant.RE_SMS_ORDER_NOT_PAID_QUEUE) public void process(Channel channel, Message message)","title":"rabbitmqé™æµQos å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶æ¶ˆè´¹ä¸€ä¸ªæ¶ˆæ¯"},{"content":"æ–¹å¼ä¸€: åŸç”ŸRabbitMqå»¶æ—¶é˜Ÿåˆ— ğŸ’¡ç¼ºç‚¹: æ¯ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯æ˜¯é¡ºåºçš„, é åçš„è¿‡æœŸæ—¶é—´çŸ­çš„æ¶ˆæ¯å¹¶ä¸èƒ½å…ˆæ‰§è¡Œ\né…ç½®é˜Ÿåˆ— æœºåˆ¶\nâ€œæ­»ä¿¡â€æ˜¯RabbitMQä¸­çš„ä¸€ç§æ¶ˆæ¯æœºåˆ¶ï¼Œå½“ä½ åœ¨æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯å‡ºç°ä»¥ä¸‹æƒ…å†µï¼š\næ¶ˆæ¯è¢«å¦å®šç¡®è®¤ï¼Œä½¿ç”¨ channel.basicNack æˆ– channel.basicReject ï¼Œå¹¶ä¸”æ­¤æ—¶requeue å±æ€§è¢«è®¾ç½®ä¸ºfalseã€‚ æ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„å­˜æ´»æ—¶é—´è¶…è¿‡è®¾ç½®çš„TTLæ—¶é—´ã€‚ æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯æ•°é‡å·²ç»è¶…è¿‡æœ€å¤§é˜Ÿåˆ—é•¿åº¦ã€‚ æ€è·¯:\nå£°æ˜ä¸€ä¸ªé»˜è®¤é˜Ÿåˆ— æˆ– äº¤æ¢æœºç»‘å®šçš„é˜Ÿåˆ—, ä¸è®¾ç½®æ¶ˆè´¹è€…, ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ— æ­»ä¿¡é˜Ÿåˆ—è®¾ç½®è½¬å‘äº¤æ¢æœºä»¥åŠè·¯ç”± ç”Ÿäº§è€…è®¾ç½®æ¶ˆæ¯è¿‡æœŸæ—¶é—´ æˆ– æ­»ä¿¡é˜Ÿåˆ—ç»Ÿä¸€è®¾ç½®è¿‡æœŸæ—¶é—´ è¿‡æœŸåè½¬å‘è‡³æ–°çš„äº¤æ¢æœº/é˜Ÿåˆ—è¿›è¡Œæ¶ˆè´¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 @Component public class DelayRabbitSmsOrderConfig { /** * é‡å‘ */ public static final String RE_SMS_ORSER_EXCHANGE = \u0026#34;re.sms.order\u0026#34;; public static final String RE_SMS_ORDER_NOT_PAID_K = \u0026#34;re.sms.order.not.k.paid\u0026#34;; public static final String RE_SMS_ORDER_NOT_PAID_QUEUE = \u0026#34;re.sms.order.not.q.paid\u0026#34;; /** * æ­»ä¿¡ */ public static final String DL_SMS_ORSER_EXCHANGE = \u0026#34;dead.sms.order\u0026#34;; public static final String DL_SMS_ORDER_NOT_PAID_K = \u0026#34;dead.sms.order.not.k.paid\u0026#34;; public static final String DL_SMS_ORDER_NOT_PAID_QUEUE = \u0026#34;dead.sms.order.not.q.paid\u0026#34;; /** * å£°æ˜é‡å‘äº¤æ¢æœº */ @Bean public Exchange reExchange() { return ExchangeBuilder .directExchange(RE_SMS_ORSER_EXCHANGE) .durable(true) .build(); } /** * å£°æ˜é‡å‘é˜Ÿåˆ— */ @Bean public Queue reQueue() { return QueueBuilder .durable(RE_SMS_ORDER_NOT_PAID_QUEUE) .build(); } /** * ç»‘å®šé‡å‘äº¤æ¢æœº é‡å‘è·¯ç”± */ @Bean public Binding reExchangeBinding(Exchange reExchange, Queue reQueue) { return BindingBuilder .bind(reQueue) .to(reExchange) .with(RE_SMS_ORDER_NOT_PAID_K) .noargs(); } /** * å£°æ˜æ­»ä¿¡é˜Ÿåˆ— */ @Bean public Queue dlQueue() { Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(4); // æŒ‡å®šè¿‡æœŸä¹‹åçš„äº¤æ¢æœºä¸ºé‡å‘äº¤æ¢æœº args.put(\u0026#34;x-dead-letter-exchange\u0026#34;, RE_SMS_ORSER_EXCHANGE); // æŒ‡å®šè¿‡æœŸä¹‹åçš„è·¯ç”±ä¸ºé‡å‘è·¯ç”± args.put(\u0026#34;x-dead-letter-routing-key\u0026#34;, RE_SMS_ORDER_NOT_PAID_K); // ç»Ÿä¸€çš„æ¯«ç§’å•ä½è¿‡æœŸ å¦‚æœè¿‡æœŸæ—¶é—´æ˜¯åŠ¨æ€çš„,éœ€è¦rabbitMqæ’ä»¶,å¹¶åœ¨æ¯æ¡æ¶ˆæ¯ä¸Šè®¾ç½®è¿‡æœŸæ—¶é—´ args.put(\u0026#34;x-expires\u0026#34;, \u0026#34;600000\u0026#34;); return QueueBuilder .durable(DL_SMS_ORDER_NOT_PAID_QUEUE) .withArguments(args) .build(); } // ä¸‹é¢ä¸¤ä¸ªå¯ä¸è®¾ç½®, åˆ™æ¶ˆè´¹è€…å‘æ¶ˆæ¯çš„æ—¶å€™ä¸è®¾ç½®äº¤æ¢æœºå’Œè·¯ç”±(å³ä½¿ç”¨é»˜è®¤çš„äº¤æ¢æœº) /** * å£°æ˜æ­»ä¿¡äº¤æ¢æœº */ @Bean public Exchange dlExchange() { return ExchangeBuilder .directExchange(DL_SMS_ORSER_EXCHANGE) .durable(true) .build(); } /** * ç»‘å®šæ­»ä¿¡äº¤æ¢æœº æ­»ä¿¡è·¯ç”± */ @Bean public Binding dlExchangeBinding(Exchange dlExchange, Queue dlQueue) { return BindingBuilder .bind(dlQueue) .to(dlExchange) .with(DL_SMS_ORDER_NOT_PAID_K) .noargs(); } } ç”Ÿäº§è€… 1 2 3 4 5 6 7 8 9 10 11 12 // å»¶æ—¶ åˆ›å•10minæœªæ”¯ä»˜ Message msg = MessageBuilder.withBody(params.getBytes()) .setContentType(MessageProperties.CONTENT_TYPE_JSON) .setContentEncoding(\u0026#34;utf-8\u0026#34;) // è‹¥ä¸Šé¢é…ç½®è®¾ç½®äº†æ­»ä¿¡äº¤æ¢æœº/æ­»ä¿¡è·¯ç”± åˆ™é…ç½®ä¸Š .setReceivedExchange(\u0026#34;\u0026#34;) .setReceivedRoutingKey(\u0026#34;\u0026#34;) .setMessageId(UUID.randomUUID() + \u0026#34;\u0026#34;) // è‹¥ä¸Šé¢é…ç½®è®¾ç½®äº†ç»Ÿä¸€çš„æ¯«ç§’å•ä½è¿‡æœŸ, åˆ™ä¸ç”¨é…ç½® .setExpiration(\u0026#34;600000\u0026#34;) .build(); amqpTemplate.convertAndSend(QueueConstant.DEAD_SMS_ORDER_QUEUE, msg); æ¶ˆè´¹è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Component public class SmsPushNotPaidReceiver { public static final Logger logger = LoggerFactory.getLogger(SmsPushNotPaidReceiver.class); @RabbitHandler // ç›‘å¬é‡å‘é˜Ÿåˆ— @RabbitListener(queues = QueueConstant.RE_SMS_ORDER_NOT_PAID_QUEUE) public void process(Message message) { logger.info(\u0026#34;----------- sms.notPayOrder start -----------\u0026#34;); String params = new String(message.getBody(), StandardCharsets.UTF_8); JSONObject param = JSONObject.parseObject(params); String code = param.getString(\u0026#34;code\u0026#34;); logger.info(\u0026#34;----------- sms.notPayOrder end -----------\u0026#34;); } } æ–¹å¼äºŒ: æ’ä»¶RabbitMqå»¶æ—¶é˜Ÿåˆ— ğŸ’¡ æ²¡æœ‰äº†åŸç”Ÿçš„ç¼ºç‚¹..\nğŸ’¡ éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šè‡ªå·±è£…å»¶æ—¶é˜Ÿåˆ—çš„æ’ä»¶, ç®€å•\né…ç½®é˜Ÿåˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 @Bean CustomExchange delayExchange() { //åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰äº¤æ¢æœºï¼Œå¯ä»¥å‘é€å»¶è¿Ÿæ¶ˆæ¯ Map\u0026lt;String, Object\u0026gt; args = new HashMap\u0026lt;\u0026gt;(); args.put(\u0026#34;x-delayed-type\u0026#34;, \u0026#34;direct\u0026#34;); return new CustomExchange(QueueEnum.QUEUE_CONSULTATION_END.getExchange(), \u0026#34;x-delayed-message\u0026#34;, true, false, args); } // æ·»åŠ å…¶ä»–å»¶æ—¶é˜Ÿåˆ—æ—¶, é‡å¤ä¸‹é¢ä¸¤ä¸ª @Bean public Queue consultationEndDelayQueue() { return new Queue(QueueEnum.QUEUE_CONSULTATION_END.getQueueName(), true); } @Bean public Binding consultationEndDelayBinding(CustomExchange delayExchange, Queue consultationEndDelayQueue) { return BindingBuilder .bind(consultationEndDelayQueue) .to(delayExchange) .with(QueueEnum.QUEUE_CONSULTATION_END.getRoutingKey()) .noargs(); } ç”Ÿäº§è€… 1 2 3 4 5 6 7 8 9 10 11 CommonEvent commonEvent = new CommonEvent().setId(id); long delayTime = timeoutConstant.getImageTextAutoEnd() * 60 * 60 * 1000L; rabbitTemplate.convertAndSend( QueueEnum.QUEUE_CONSULTATION_END.getExchange(), QueueEnum.QUEUE_CONSULTATION_END.getRoutingKey(), commonEvent, message -\u0026gt; { //ç»™æ¶ˆæ¯è®¾ç½®å»¶è¿Ÿæ¯«ç§’å€¼ message.getMessageProperties().setHeader(\u0026#34;x-delay\u0026#34;, delayTime); return message; }); æ¶ˆè´¹è€… 1 2 3 4 5 6 7 8 9 @Component @RabbitListener(queues = \u0026#34;consultation.end\u0026#34;) public class ConsultationCancelReceiver { @RabbitHandler public void handle(CommonEvent commonEvent) { } } ","permalink":"https://habyss.github.io/posts/tech/rabbitmq_delay/","summary":"æ–¹å¼ä¸€: åŸç”ŸRabbitMqå»¶æ—¶é˜Ÿåˆ— ğŸ’¡ç¼ºç‚¹: æ¯ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯æ˜¯é¡ºåºçš„, é åçš„è¿‡æœŸæ—¶é—´çŸ­çš„æ¶ˆæ¯å¹¶ä¸èƒ½å…ˆæ‰§è¡Œ é…ç½®é˜Ÿåˆ— æœºåˆ¶ â€œæ­»ä¿¡â€æ˜¯RabbitMQ","title":"rabbitmqå®ç°å»¶æ—¶é˜Ÿåˆ—"},{"content":"æ–¹å¼ä¸€: åŸºäºè¡¨è¾¾å¼ ä¾‹å¦‚ç®€å•æ—¥å¿—æ‰“å°: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Slf4j @Aspect @Component public class WebLogAspect { /** * xxxåŒ…åŠå…¶å­åŒ…ä¸‹çš„ä»¥Controllerç»“å°¾çš„ç±»çš„ä»»æ„æ–¹æ³• */ @Pointcut(\u0026#34;execution(public * com.xxx..*Controller.*(..))\u0026#34;) public void webLog(){} @Around(\u0026#34;webLog()\u0026#34;) public Object around(ProceedingJoinPoint jp) throws Throwable { StopWatch sw = new StopWatch(\u0026#34;è¯·æ±‚è€—æ—¶\u0026#34;); ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes(); HttpServletRequest request = Objects.requireNonNull(attributes).getRequest(); sw.start(); log.info(\u0026#34;---è¯·æ±‚æ¥æº : {}\u0026#34;, IpUtil.getIpAddress(request)); log.info(\u0026#34;---è¯·æ±‚æ–¹æ³• : {}.{}\u0026#34;, jp.getSignature().getDeclaringTypeName(), jp.getSignature().getName()); log.info(\u0026#34;---è¯·æ±‚å‚æ•° : {}\u0026#34;, Arrays.toString(jp.getArgs())); Object result = jp.proceed(); sw.stop(); log.info(\u0026#34;---è¯·æ±‚è€—æ—¶ : {}{}\u0026#34;, sw.getLastTaskTimeMillis(), \u0026#34;ms\u0026#34;); log.info(\u0026#34;---è¯·æ±‚è¿”å› : {}\u0026#34;, result); return result; } } æ–¹å¼äºŒ: åŸºäºæ³¨è§£ è¯´æ˜\n@Target({ElementType.TYPE, ElementType.METHOD}) ï¼šå…è®¸ä½¿ç”¨çš„åœ°æ–¹ï¼›å¦‚-ElementType.TYPE==ã€‹ç±»ï¼›ElementType.METHOD==ã€‹æ–¹æ³•\n@Retention(RetentionPolicy.RUNTIME)ï¼šæ³¨è§£ä¿ç•™åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡åå°„è·å¾—å®šä¹‰åœ¨æŸä¸ªç±»ä¸Šçš„æ‰€æœ‰æ³¨è§£\n@Inheritedï¼šå½“@Inheritedä¿®é¥°è¿‡çš„æ³¨è§£åŠ åœ¨æŸä¸ªç±»Aä¸Šæ—¶ï¼Œå‡å¦‚ç±»Bç»§æ‰¿äº†Aï¼Œåˆ™Bä¹Ÿä¼šå¸¦ä¸Šè¯¥æ³¨è§£ã€‚åŠ åœ¨æ¥å£ä¸Šæ— æ•ˆ\nä¾‹å¦‚åŸºäºæ³¨è§£çš„redisç¼“å­˜å®ç°: å®šä¹‰æ³¨è§£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Retention(RetentionPolicy.RUNTIME) // ä¸€èˆ¬æ˜¯è¿è¡Œæ—¶ @Target(ElementType.METHOD) // æ³¨è§£çº§åˆ« æ­¤å¤„ä¸ºæ–¹æ³•çº§ @Order(Ordered.HIGHEST_PRECEDENCE) // ä¼˜å…ˆçº§ public @interface RedisCache { /** * key * * @return {@link String} */ String key(); /** * è¿‡æœŸæ—¶é—´ * * @return int */ long expire() default 1; /** * æ—¶é—´å•ä½ * * @return {@link TimeUnit} */ TimeUnit timeUnit() default TimeUnit.DAYS; /** * æ–¹æ³•è¿”å›ä¸ºlisté›†åˆæ—¶ å¿…ä¼  å¦åˆ™å‡ºé”™ * * @return {@link Class} */ Class\u0026lt;?\u0026gt; listForClass() default RedisCache.class; } ä¸ºæ³¨è§£å¢åŠ aopç›¸å…³å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @Aspect @Component @Slf4j public class RedisCacheContract { @Resource RedisUtil redisUtil; @Around(\u0026#34;@annotation(redisCache)\u0026#34;) public Object redisAround(final ProceedingJoinPoint joinPoint, RedisCache redisCache) throws Throwable { Object result; MethodSignature signature = (MethodSignature) joinPoint.getSignature(); String key = redisCache.key() + \u0026#34;:\u0026#34; + Arrays.toString(joinPoint.getArgs()); if (redisUtil.hasKey(key)) { log.info(\u0026#34;hint redisCache {}\u0026#34;, key); // é»˜è®¤æ³¨è§£ ç›´æ¥ä½¿ç”¨åŸæ–¹æ³•çš„returnTypeæ¥è§£æjson if (redisCache.listForClass().isAssignableFrom(RedisCache.class)) { Class\u0026lt;?\u0026gt; returnType = signature.getReturnType(); result = redisUtil.get(key, returnType); if (result instanceof ResponseResult\u0026lt;?\u0026gt; r) { // è®¾ç½®æ–°çš„traceId r.setTraceId(TraceIdUtil.getTraceId()); } } else { // listæ³¨è§£, ä½¿ç”¨è‡ªå®šä¹‰classè§£æä¸ºList result = redisUtil.getAsList(key, redisCache.listForClass()); } } else { result = joinPoint.proceed(); redisUtil.set(key, result, redisCache.expire(), redisCache.timeUnit()); } return result; } } é™åˆ¶ipç¤ºä¾‹: å®šä¹‰æ³¨è§£\n1 2 3 4 5 6 7 8 9 10 11 @Retention(RetentionPolicy.RUNTIME) @Target(ElementType.METHOD) @Order(Ordered.HIGHEST_PRECEDENCE) public @interface RequestLimit { int count() default Integer.MAX_VALUE; long time() default 60000; boolean limitIp() default false; } å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 /** * @author kun.han * å¦‚æœæœ‰ç½‘å…³çš„è¯ åšåœ¨ç½‘å…³ */ @Slf4j @Aspect @Component public class RequestLimitContract { @Resource RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; private final static String KEY_PREFIX = \u0026#34;requestLimit:\u0026#34;; @Before(\u0026#34;@annotation(requestLimit)\u0026#34;) public void requestLimit(final JoinPoint joinPoint, RequestLimit requestLimit) { ValueOperations\u0026lt;String, String\u0026gt; ops = redisTemplate.opsForValue(); log.info(\u0026#34;limit - count\u0026#34; + requestLimit.count() + \u0026#34; time\u0026#34; + requestLimit.time()); // 1. redisè·å–è®¾ç½®ç”¨æˆ·çš„count, è¿‡æœŸæ—¶é—´ä¸ºtime åˆ¤æ–­æ˜¯å¦æ‹¦æˆª long userId = 123123123L; String userKey = KEY_PREFIX + userId; Long count = ops.increment(userKey); count = Objects.isNull(count) ? 0 : count; if (count \u0026gt; requestLimit.count()) { throw new ServiceException(\u0026#34;é™åˆ¶è®¿é—®\u0026#34;); } if (requestLimit.limitIp()) { // 2. ipæ‹¦æˆª redisè·å–è®¾ç½®ipçš„count, è¿‡æœŸæ—¶é—´ä¸ºtime åˆ¤æ–­æ˜¯å¦æ‹¦æˆª String ip = IpUtil.getIpAddress(); userKey = KEY_PREFIX + ip.replaceAll(\u0026#34;\\\\.\u0026#34;, \u0026#34;-\u0026#34;); count = ops.increment(userKey); count = Objects.isNull(count) ? 0 : count; if (count \u0026gt; requestLimit.count()) { throw new ServiceException(\u0026#34;é™åˆ¶è®¿é—®\u0026#34;); } log.info(ip); } } } ğŸ’¡ ä¸€èˆ¬æƒ…å†µä¸‹, è¿™ä¸¤ç§è¶³å¤Ÿä½¿ç”¨äº†.\n","permalink":"https://habyss.github.io/posts/tech/springboot_aop/","summary":"æ–¹å¼ä¸€: åŸºäºè¡¨è¾¾å¼ ä¾‹å¦‚ç®€å•æ—¥å¿—æ‰“å°: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Slf4j @Aspect @Component public class WebLogAspect { /** * xxxåŒ…åŠå…¶å­åŒ…ä¸‹çš„ä»¥Contro","title":"åŸºäºspringbootå¸¸ç”¨aopæ–¹å¼"},{"content":"UMLç±»å›¾å…³ç³» ğŸ’¡ UML å…¨ç§°Unified Modeling Language, ç»Ÿè®¡å»ºæ¨¡è¯­è¨€.\nUMLç±»å›¾ä¸­æœ‰å…­ç§å…³ç³»ï¼Œä»å¼±åˆ°å¼ºä¾æ¬¡æ˜¯ï¼š\nä¾èµ–å…³ç³» \u0026lt; å…³è”å…³ç³» \u0026lt; èšåˆå…³ç³» \u0026lt; ç»„åˆå…³ç³» \u0026lt; å®ç°å…³ç³» = æ³›åŒ–å…³ç³»\nç±»çš„æˆå‘˜å˜é‡å’Œæ–¹æ³•å‰é¢çš„ä¿®é¥°ç¬¦æœ‰public, private, protected, defaultï¼Œåœ¨UMLç±»å›¾ä¸­åˆ†åˆ«ç”¨ +, -, #, ~è¡¨ç¤ºã€‚\n1. ä¾èµ–å…³ç³» é€šç”¨æè¿°: ä¾èµ–å…³ç³»è¡¨ç¤ºæŸä¸ªç±»ä¾èµ–äºå¦å¤–ä¸€ä¸ªç±»\nä»£ç è¡¨ç°: æŸä¸ªç±»çš„æ–¹æ³•çš„å‚æ•°ä½¿ç”¨äº†å¦å¤–ä¸€ä¸ªç±»çš„å¯¹è±¡\nç®­å¤´æè¿°: ä¾èµ–å…³ç³»ä½¿ç”¨å¸¦ç®­å¤´çš„è™šçº¿è¡¨ç¤º, ç®­å¤´æŒ‡å‘è¢«ä¾èµ–çš„ç±»\nç¤ºä¾‹å›¾æ ·:\n2. å…³è”å…³ç³» é€šç”¨æè¿°: å…³è”å…³ç³»è¡¨ç¤ºä¸€ä¸ªç±»å’Œå¦å¤–ä¸€ä¸ªç±»çš„è”ç³», å¦‚è€å¸ˆå’Œå­¦ç”Ÿ\nä»£ç è¡¨ç°: æŸä¸ªç±»çš„æˆå‘˜å˜é‡æ˜¯å¦å¤–ä¸€ä¸ªç±»çš„å¯¹è±¡\nç®­å¤´æè¿°: ä¾èµ–å…³ç³»æœ‰å•å‘å’ŒåŒå‘, å•å‘ä½¿ç”¨å¸¦ç®­å¤´çš„å®çº¿è¡¨ç¤º, ç®­å¤´æŒ‡å‘è¢«å…³è”çš„ç±», åŒå‘ä½¿ç”¨åŒç®­å¤´æˆ–è€…æ²¡æœ‰ç®­å¤´çš„å®çº¿è¡¨ç¤º.\nç¤ºä¾‹å›¾æ ·:\n3. èšåˆå…³ç³» é€šç”¨æè¿°: èšåˆå…³ç³»æ˜¯å…³è”å…³ç³»çš„ä¸€ç§, è¡¨ç¤ºçš„æ˜¯æ•´ä½“ä¸éƒ¨åˆ†ä¹‹é—´çš„å…³ç³», å¦‚å­¦æ ¡å’Œè€å¸ˆ, è½¦å­å’Œè½®èƒ\nä»£ç è¡¨ç°: æŸä¸ªç±»çš„æˆå‘˜å˜é‡æ˜¯å¦å¤–ä¸€ä¸ªç±»çš„å¯¹è±¡\nç®­å¤´æè¿°: èšåˆå…³ç³»ä½¿ç”¨å¸¦ç©ºå¿ƒè±å½¢çš„å®çº¿è¡¨ç¤º, è±å½¢æŒ‡å‘æ•´ä½“\nç¤ºä¾‹å›¾æ ·:\n4. ç»„åˆå…³ç³» é€šç”¨æè¿°: ç»„åˆå…³ç³»æ˜¯å…³è”å…³ç³»çš„ä¸€ç§, æ˜¯ä¸€ç§æ¯”èšåˆå…³ç³»æ›´å¼ºçš„ä¸€ç§å…³ç³», éƒ¨åˆ†ä¸èƒ½è„±ç¦»æ•´ä½“è€Œå•ç‹¬å­˜åœ¨, å¦‚èº«ä½“å’Œå¤§è„‘\nä»£ç è¡¨ç°: æŸä¸ªç±»çš„æˆå‘˜å˜é‡æ˜¯å¦å¤–ä¸€ä¸ªç±»çš„å¯¹è±¡\nç®­å¤´æè¿°: ç»„åˆå…³ç³»ä½¿ç”¨å¸¦å®å¿ƒè±å½¢çš„å®çº¿è¡¨ç¤º, è±å½¢æŒ‡å‘æ•´ä½“\nç¤ºä¾‹å›¾æ ·:\n5. å®ç°å…³ç³» é€šç”¨æè¿°: å®ç°å…³ç³»æ˜¯æ¥å£å’Œå®ç°ç±»ä¹‹é—´çš„å…³ç³»\nä»£ç è¡¨ç°: æ¥å£å’Œå®ç°ç±»\nç®­å¤´æè¿°: å®ç°å…³ç³»ä½¿ç”¨å¸¦ç©ºå¿ƒä¸‰è§’ç®­å¤´çš„è™šçº¿è¡¨ç¤º, ç®­å¤´æŒ‡å‘æ¥å£\nç¤ºä¾‹å›¾æ ·:\n6. æ³›åŒ–å…³ç³» é€šç”¨æè¿°: æ³›åŒ–å…³ç³»æ˜¯çˆ¶å­ç±»ä¹‹é—´çš„ç»§æ‰¿å…³ç³»\nä»£ç è¡¨ç°: æŠ½è±¡çˆ¶å­ä¸å­ç±», ç»§æ‰¿\nç®­å¤´æè¿°: æ³›åŒ–å…³ç³»ä½¿ç”¨å¸¦ç©ºå¿ƒä¸‰è§’ç®­å¤´çš„å®çº¿æ¥è¡¨ç¤º, ç®­å¤´æŒ‡å‘çˆ¶ç±»\nç¤ºä¾‹å›¾æ ·:\næ€»ç»“ ä¾èµ–å…³ç³» \u0026lt; å…³è”å…³ç³» \u0026lt; èšåˆå…³ç³» \u0026lt; ç»„åˆå…³ç³» \u0026lt; å®ç°å…³ç³» = æ³›åŒ–å…³ç³» å…³ç³»åç§° ä»£ç è¡¨ç° ç®­å¤´å½¢å¼ ç®­å¤´æŒ‡å‘ ä¾èµ–å…³ç³» æ–¹æ³•å‚æ•° è™šçº¿ç®­å¤´ æŒ‡å‘è¢«ä¾èµ–çš„ç±»(æ–¹æ³•å‚æ•°çš„ç±») å…³è”å…³ç³» æˆå‘˜å˜é‡ å®çº¿ç®­å¤´ æŒ‡å‘è¢«å…³è”çš„ç±»(æˆå‘˜å˜é‡çš„ç±») èšåˆå…³ç³» æˆå‘˜å˜é‡ å®çº¿ç©ºå¿ƒè±å½¢ æŒ‡å‘æ•´ä½“ ç»„åˆå…³ç³» æˆå‘˜å˜é‡ å®çº¿å®å¿ƒè±å½¢ æŒ‡å‘æ•´ä½“ å®ç°å…³ç³» æ¥å£ä¸å®ç°ç±» è™šçº¿ç©ºå¿ƒä¸‰è§’ æŒ‡å‘æ¥å£ æ³›åŒ–å…³ç³» æŠ½è±¡çˆ¶ç±»ä¸å­ç±» å®çº¿ç©ºå¿ƒä¸‰è§’ æŒ‡å‘çˆ¶ç±» ","permalink":"https://habyss.github.io/posts/tech/uml/","summary":"UMLç±»å›¾å…³ç³» ğŸ’¡ UML å…¨ç§°Unified Modeling Language, ç»Ÿè®¡å»ºæ¨¡è¯­è¨€. UMLç±»å›¾ä¸­æœ‰å…­ç§å…³ç³»ï¼Œä»å¼±åˆ°å¼ºä¾æ¬¡æ˜¯ï¼š ä¾èµ–å…³ç³» \u0026lt; å…³è”å…³ç³» \u0026lt; èšåˆå…³ç³» \u0026lt; ç»„åˆå…³ç³» \u0026lt; å®ç°å…³","title":"UMLç±»å›¾å…³ç³»"},{"content":"@Transactionalå¤±æ•ˆ æ•´åˆshiroä¹‹åï¼ŒUserRealmç±»é‡Œè‡ªåŠ¨æ³¨å…¥çš„serviceä¸­çš„@Transactionalæ³¨è§£å¤±æ•ˆ\nè§£å†³æ–¹æ³• ä½¿ç”¨@Lazyæ³¨è§£\n1 2 3 @Autowired @Lazy private OperationUnitService operationUnitService; åœ¨Realmä¸­ç›´æ¥ä½¿ç”¨mapperï¼Œè€Œä¸æ˜¯service\n1 2 @Autowired private OperationUnitMapper operationUnitMapper; ApplicationContextRegister.getBean()æ–¹æ³•ï¼Œæ‰‹åŠ¨æ³¨å…¥bean\n1 OperationUnitService operationUnitService = ApplicationContextRegister.getBean(OperationUnitService.class) äº§ç”ŸåŸå›  åœ¨shiroä¸­ä¸ºäº†å¼•å…¥æƒé™æ³¨è§£ï¼Œé…ç½®äº†defaultAdvisorAutoProxyCreatorå’ŒauthorizationAttributeSourceAdvisorç±»ï¼Œä»–ä»¬æ˜¯é€šè¿‡AOPæ–¹å¼å¯¹@RequiredPermissionç±»/æ–¹æ³•(æƒé™æ§åˆ¶)è¿›è¡Œå¢å¼º.\nç”Ÿæˆå¯¹åº”çš„ä»£ç†ç±»å¯¹è±¡ï¼Œç”±äºshiroFilterFactoryBeanå®ç°äº†factoryBeanæ¥å£ï¼Œæ‰€ä»¥ä¼šè¢«æå‰åˆå§‹åŒ–ï¼Œæ‰€ä»¥å¼•å‘æ‰€æœ‰ç›¸å…³çš„beanæå‰åˆå§‹åŒ–ï¼Œå¯¼è‡´ä»–ä»¬æ²¡æœ‰è¢«äº‹åŠ¡AOPåŒ…è£¹ç€ï¼Œä»è€Œå¼•å‘äº‹åŠ¡æ— æ•ˆçš„é—®é¢˜\n1 2 3 4 5 6 7 8 9 10 11 /** * å¼€å¯Shiroçš„æ³¨è§£(å¦‚@RequiresRoles,@RequiresPermissions),éœ€å€ŸåŠ©SpringAOPæ‰«æä½¿ç”¨Shiroæ³¨è§£çš„ç±»,å¹¶åœ¨å¿…è¦æ—¶è¿›è¡Œå®‰å…¨é€»è¾‘éªŒè¯ * é…ç½®ä»¥ä¸‹ä¸¤ä¸ªbean(DefaultAdvisorAutoProxyCreator(å¯é€‰)å’ŒAuthorizationAttributeSourceAdvisor)å³å¯å®ç°æ­¤åŠŸèƒ½ */ @Bean @DependsOn({\u0026#34;lifecycleBeanPostProcessor\u0026#34;}) public DefaultAdvisorAutoProxyCreator advisorAutoProxyCreator() { DefaultAdvisorAutoProxyCreator advisorAutoProxyCreator = new DefaultAdvisorAutoProxyCreator(); advisorAutoProxyCreator.setProxyTargetClass(true); return advisorAutoProxyCreator; } å…ƒç´ çš„ \u0026ldquo;proxy-target-class\u0026rdquo; å±æ€§å€¼æ¥æ§åˆ¶æ˜¯åŸºäºæ¥å£çš„è¿˜æ˜¯åŸºäºç±»çš„ä»£ç†è¢«åˆ›å»ºã€‚å¦‚æœ \u0026ldquo;proxy-target-class\u0026rdquo; å±å€¼è¢«è®¾ç½®ä¸º \u0026ldquo;true\u0026rdquo;ï¼Œé‚£ä¹ˆåŸºäºç±»çš„ä»£ç†å°†èµ·ä½œç”¨ï¼ˆè¿™æ—¶éœ€è¦CGLIBåº“cglib.jaråœ¨CLASSPATHä¸­ï¼‰ã€‚å¦‚æœ \u0026ldquo;proxy-target-class\u0026rdquo; å±å€¼è¢«è®¾ç½®ä¸º \u0026ldquo;false\u0026rdquo; æˆ–è€…è¿™ä¸ªå±æ€§è¢«çœç•¥ï¼Œé‚£ä¹ˆæ ‡å‡†çš„JDKåŸºäºæ¥å£çš„ä»£ç†å°†èµ·ä½œç”¨ã€‚\nå·¥å…· å¿«æ·æŸ¥çœ‹äº‹åŠ¡æ˜¯å¦ç”Ÿæ•ˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 public class DebugUtils { private static final boolean transactionDebugging = true; private static final boolean verboseTransactionDebugging = true; public static void showTransactionStatus(String message) { System.out.println(((transactionActive()) ? \u0026#34;[+] \u0026#34; : \u0026#34;[-] \u0026#34;) + message); } // Some guidance from: \u0026lt;http://java.dzone.com/articles/monitoring-declarative-transac?page=0,1\u0026gt; public static boolean transactionActive() { try { ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader(); Class tsmClass = contextClassLoader.loadClass(\u0026#34;org.springframework.transaction.support.TransactionSynchronizationManager\u0026#34;); Boolean isActive = (Boolean) tsmClass.getMethod(\u0026#34;isActualTransactionActive\u0026#34;, null).invoke(null, null); return isActive; } catch (ClassNotFoundException e) { e.printStackTrace(); } catch (IllegalArgumentException e) { e.printStackTrace(); } catch (SecurityException e) { e.printStackTrace(); } catch (IllegalAccessException e) { e.printStackTrace(); } catch (InvocationTargetException e) { e.printStackTrace(); } catch (NoSuchMethodException e) { e.printStackTrace(); } // If we got here it means there was an exception throw new IllegalStateException(\u0026#34;ServerUtils.transactionActive was unable to complete properly\u0026#34;); } public static void transactionRequired(String message) { // Are we debugging transactions? if (!transactionDebugging) { // No, just return return; } // Are we doing verbose transaction debugging? if (verboseTransactionDebugging) { // Yes, show the status before we get to the possibility of throwing an exception showTransactionStatus(message); } // Is there a transaction active? if (!transactionActive()) { // No, throw an exception throw new IllegalStateException(\u0026#34;Transaction required but not active [\u0026#34; + message + \u0026#34;]\u0026#34;); } } } åœ¨éœ€è¦æ£€æµ‹çš„åœ°æ–¹\n1 DebugUtils.transactionRequired(\u0026#34;OperationUnitServiceImpl.testIn\u0026#34;); ","permalink":"https://habyss.github.io/posts/tech/transactional/","summary":"@Transactionalå¤±æ•ˆ æ•´åˆshiroä¹‹åï¼ŒUserRealmç±»é‡Œè‡ªåŠ¨æ³¨å…¥çš„serviceä¸­çš„@Transactionalæ³¨è§£å¤±æ•ˆ è§£","title":"@Transactionalå¤±æ•ˆæ’æŸ¥"},{"content":"$ref-fastjson é—®é¢˜æ’æŸ¥ é—®é¢˜æ’æŸ¥ é¡¹ç›®è¿”å›çš„æ•°æ®ä¸­å‡ºç°$refæ•°æ®\næŸ¥è¯¢å¾—çŸ¥æ˜¯fastjsonçš„ç‰¹æ€§å¾ªç¯å¼•ç”¨ fastjsonæ”¯æŒå¾ªç¯å¼•ç”¨ï¼Œå¹¶ä¸”æ˜¯ç¼ºçœæ‰“å¼€çš„ã€‚\nå½“åºåˆ—åŒ–åçš„JSONä¼ è¾“åˆ°æµè§ˆå™¨æˆ–è€…å…¶ä»–è¯­è¨€ä¸­ï¼Œè¿™äº›jsonè§£æå™¨ä¸æ”¯æŒå¾ªç¯å¼•ç”¨ï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ä½ å¯ä»¥å…³é—­fastjsonçš„å¾ªç¯å¼•ç”¨æ”¯æŒã€‚å…³é—­å¼•ç”¨æ£€æµ‹ï¼Œè¿˜èƒ½å¤Ÿæå‡åºåˆ—åŒ–æ—¶çš„æ€§èƒ½ã€‚\nå…¨å±€é…ç½®å…³é—­\n1 JSON.DEFAULT_GENERATE_FEATURE |= SerializerFeature.DisableCircularReferenceDetect.getMask(); éå…¨å±€å…³é—­\n1 JSON.toJSONString(obj, SerializerFeature.DisableCircularReferenceDetect); é¡¹ç›®ä¸­é…ç½®äº†å…¨å±€é»˜è®¤ä½¿ç”¨fastjson, æ‰€ä»¥å¯¼è‡´é»˜è®¤çš„jacksonä¸ç”Ÿæ•ˆ. $ref-fastjson-è§£å†³æ–¹æ¡ˆ å…¨å±€é…ç½®å…³é—­\néå…¨å±€å…³é—­\nåˆ é™¤å…¨å±€é»˜è®¤fastjson\n","permalink":"https://habyss.github.io/posts/tech/ref-fastjson/","summary":"$ref-fastjson é—®é¢˜æ’æŸ¥ é—®é¢˜æ’æŸ¥ é¡¹ç›®è¿”å›çš„æ•°æ®ä¸­å‡ºç°$refæ•°æ® æŸ¥è¯¢å¾—çŸ¥æ˜¯fastjsonçš„ç‰¹æ€§å¾ªç¯å¼•ç”¨ fastjsonæ”¯æŒå¾ªç¯å¼•ç”¨ï¼Œå¹¶ä¸”æ˜¯ç¼ºçœæ‰“å¼€çš„ã€‚ å½“","title":"$ref-fastjsonæ’æŸ¥"},{"content":"SpringBootä¸­æ—¶é—´æˆ³å’ŒLocalDateTimeç›¸å…³çš„æ¥æ”¶å’Œè½¬æ¢ å‰è¨€ ä¸€èˆ¬æƒ…å†µä¸‹, å‰ç«¯å’Œåç«¯åœ¨æ—¶é—´æ ¼å¼çš„ä¼ é€’ä¸Šéƒ½èµ°çš„æ˜¯æ—¶é—´æˆ³ï¼ˆæ–¹ä¾¿å‰ç«¯è‡ªç”±å®šåˆ¶ï¼‰ æ—¶é—´æ ¼å¼ç”±äºjava8çš„æ–°å¢æ—¶é—´å¤„ç†ç±»æ¯”è¾ƒå¥½ç”¨,è€Œä¸”æ›´åŠ çº¿ç¨‹å®‰å…¨, æ‰€ä»¥å°†é¡¹ç›®ä¸­çš„æ—¶é—´ç›¸å…³æ”¹ä¸ºLocalDateTimeï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„Date å‰ç½®è¦æ±‚ mybatiséœ€è¦3.4.6ä»¥ä¸Š, å¦åˆ™ä¼šä¸æ”¯æŒxmlå’ŒjavaTypeçš„è½¬æ¢ druidéœ€è¦æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬, è¿™é‡Œä½¿ç”¨çš„æ˜¯1.1.21, å¦åˆ™æŸ¥è¯¢ä¼šæŠ¥é”™,ç»“æœé›†result setä¸­æ‰¾ä¸åˆ°å…ƒç´  æ­£æ–‡ è¯·æ±‚æ–¹å¼çš„æƒ…å†µåˆ†ç±»\n@RequestBodyä¸­ä¿®é¥°LocalDateTime å…¶ä»–, æ¯”å¦‚@RequestParamå’Œ@PathVariableä»¥åŠä¸åŠ æ³¨è§£çš„å•å‚æ•°å’Œå¯¹è±¡å‚æ•° æƒ…å†µä¸€. @RequestBodyä¸­çš„LocalDateTime é€šè¿‡@RequestBodyå¾ˆæ˜æ˜¾çš„å°±æ˜¯è¦é€šè¿‡JSONåºåˆ—åŒ–è¿›è¡Œå¤„ç†ï¼ŒSpringé»˜è®¤çš„æ˜¯Jacksonè¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹é»˜è®¤çš„JSONå¤„ç†å™¨è¿›è¡Œæ—¥æœŸç±»å‹çš„æ·»åŠ (å‡å¦‚é»˜è®¤ä¸å¸¦å¯¹åº”åºåˆ—åŒ–å™¨çš„æƒ…å†µä¸‹)\næ­¤æ—¶éœ€è¦ç”¨çš„æ˜¯JsonDeserializerè¿™ä¸ªç±»ï¼Œå¯¹åº”çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 /** * å…¥å‚ æ—¶é—´æˆ³ -\u0026gt; LocalDateTime */ public class CustomDateDeserializer { public static class LocalDateTimeDeserializer extends JsonDeserializer\u0026lt;LocalDateTime\u0026gt; { @Override public LocalDateTime deserialize(JsonParser p, DeserializationContext context) throws IOException { Long timestamp = Long.valueOf(p.getText()); Instant instant = Instant.ofEpochMilli(timestamp); return LocalDateTime.ofInstant(instant, ZoneId.systemDefault()); } } } /** * @author kun.han on 2020/3/4 15:45 * è¿”å›å‚æ•° LocalDateTime -\u0026gt; æ—¶é—´æˆ³ */ public class CustomDateSerializer { public static class LocalDateTimeSerializer extends JsonSerializer\u0026lt;LocalDateTime\u0026gt; { @Override public void serialize(LocalDateTime localDateTime, JsonGenerator jsonGenerator, SerializerProvider serializerProvider) throws IOException { jsonGenerator.writeNumber(localDateTime.toInstant(ZoneOffset.of(\u0026#34;+8\u0026#34;)).toEpochMilli()); } } } æœ‰äº†è¿™ä¸ªäº†ç±»ï¼Œè¿˜éœ€è¦æ·»åŠ åˆ°Springä¸­ï¼ŒSpringåˆ©ç”¨çš„æ˜¯ObjectMapperï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªObjectMapperæ›¿æ¢åŸæœ¬çš„å°±å¯ä»¥äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 @Configuration public class CustomDateConfig implements WebMvcConfigurer { /** * Jsonåºåˆ—åŒ–å’Œååºåˆ—åŒ–è½¬æ¢å™¨ï¼Œç”¨äºè½¬æ¢Postè¯·æ±‚ä½“ä¸­çš„jsonä»¥åŠå°†æˆ‘ä»¬çš„å¯¹è±¡åºåˆ—åŒ–ä¸ºè¿”å›å“åº”çš„json */ @Bean public ObjectMapper objectMapper() { ObjectMapper objectMapper = new ObjectMapper(); //ä¸æ˜¾ç¤ºä¸ºnullçš„å­—æ®µ objectMapper.disable(SerializationFeature.FAIL_ON_EMPTY_BEANS); objectMapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES); // å¿½ç•¥ä¸èƒ½è½¬ç§»çš„å­—ç¬¦ objectMapper.configure(JsonParser.Feature.ALLOW_BACKSLASH_ESCAPING_ANY_CHARACTER, true); // è¿‡æ»¤å¯¹è±¡çš„nullå±æ€§. objectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL); //å¿½ç•¥transient objectMapper.configure(MapperFeature.PROPAGATE_TRANSIENT_MARKER, true); objectMapper.disable(DeserializationFeature.ADJUST_DATES_TO_CONTEXT_TIME_ZONE); //LocalDateTimeç³»åˆ—åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¨¡å—ï¼Œç»§æ‰¿è‡ªjsr310ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¿®æ”¹äº†æ—¥æœŸæ ¼å¼ JavaTimeModule javaTimeModule = new JavaTimeModule(); // LocalDateTime è¿™é‡Œåªéœ€è¦LocalDateTime å¦‚æœéœ€è¦è½¬å…¶ä»–çš„,ç›¸åº”æ”¾å¼€æ³¨é‡Š, å¹¶åœ¨ä¸Šé¢ä¸¤ä¸ªç±»ä¸­é€‚å½“ä¿®æ”¹ javaTimeModule.addSerializer(LocalDateTime.class, new CustomDateSerializer.LocalDateTimeSerializer()); javaTimeModule.addDeserializer(LocalDateTime.class,new CustomDateDeserializer.LocalDateTimeDeserializer()); // // LocalDate // javaTimeModule.addSerializer(LocalDate.class, new CustomDateSerializer.LocalDateSerializer()); // javaTimeModule.addDeserializer(LocalDate.class, new CustomDateDeserializer.LocalDateDeserializer()); // //Dateåºåˆ—åŒ–å’Œååºåˆ—åŒ– // javaTimeModule.addSerializer(Date.class,new CustomDateSerializer.DateSerializer()); // javaTimeModule.addDeserializer(Date.class,new CustomDateDeserializer.DateDeserializer()); objectMapper.registerModule(javaTimeModule); return objectMapper; } } æƒ…å†µäºŒ. å…¶ä»– æ¯”å¦‚@RequestParamå’Œ@PathVariableä»¥åŠä¸åŠ æ³¨è§£çš„å•å‚æ•°å’Œå¯¹è±¡å‚æ•° æ–¹å¼ä¸€: Convert å¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚è¿›è¡Œå®šåˆ¶ï¼Œè¿™é‡Œæˆ‘é€šè¿‡Convertè½¬æ¢LocalDateTimeä¸ºä¾‹ï¼Œè¿›è¡Œè½¬æ¢ï¼š\n1 2 3 4 5 6 7 8 9 public class CustomDateConverter { public static class LocalDateConvert implements Converter\u0026lt;String, LocalDateTime\u0026gt; { @Override public LocalDateTime convert(String timestamp) { return LocalDateTime.ofInstant(Instant.ofEpochMilli(Long.parseLong(timestamp)), ZoneId.systemDefault()); } } } åŒæ ·çš„éœ€è¦åœ¨é…ç½®ç±»ä¸­å¼•ç”¨\n1 2 3 4 5 6 7 8 @Configuration public class CustomDateConfig implements WebMvcConfigurer { @Bean public Converter\u0026lt;String, LocalDateTime\u0026gt; localDateConverter() { //æ­¤å¤„ä¸èƒ½æ›¿æ¢ä¸ºlambdaè¡¨è¾¾å¼ return new CustomDateConverter.LocalDateConvert(); } } æ–¹å¼äºŒ: ControllerAdvice 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /** * requestBodyä¹‹å¤–çš„å…¥å‚ æ—¶é—´æˆ³-\u0026gt;LocalDateTime * * @author hankun */ @ControllerAdvice public class LocalDateTimeAdvice { @InitBinder protected void initBinder(WebDataBinder binder) { // è¿™é‡Œåªéœ€è¦LocalDateTime å¦‚æœéœ€è¦è½¬å…¶ä»–çš„,ç›¸åº”æ·»åŠ /ä¿®æ”¹ binder.registerCustomEditor(LocalDateTime.class, new PropertyEditorSupport() { @Override public void setAsText(String timestamp) throws IllegalArgumentException { if (!StringUtils.hasText(timestamp)) { setValue(null); } else { setValue(LocalDateTime.ofInstant(Instant.ofEpochMilli(Long.parseLong(timestamp)), ZoneId.systemDefault())); } } }); // è¿™é‡Œåªéœ€è¦LocalDateTime å¦‚æœéœ€è¦è½¬å…¶ä»–çš„,ç›¸åº”æ·»åŠ /ä¿®æ”¹ binder.registerCustomEditor(LocalDate.class, new PropertyEditorSupport() { @Override public void setAsText(String timestamp) throws IllegalArgumentException { if (!StringUtils.hasText(timestamp)) { setValue(null); } else { setValue(LocalDate.ofInstant(Instant.ofEpochMilli(Long.parseLong(timestamp)), ZoneId.systemDefault())); } } }); } } ç›¸å…³çŸ¥è¯†ç‚¹ æ—¶é—´å·® ç²¾ç¡®æ—¶é—´å·®:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 long start = 1584328558000L; long now = 1584400558000L; Instant startTime = Instant.ofEpochMilli(start); LocalDateTime startTimeT = LocalDateTime.ofInstant(startTime, ZoneId.systemDefault()); Instant endTime = Instant.ofEpochMilli(now); LocalDateTime entTimeT = LocalDateTime.ofInstant(startTime, ZoneId.systemDefault()); Duration duration = Duration.between(startTimeT, entTimeT); // Duration duration = Duration.between(startTime, entTime); long day = duration.toDays(); long hours = duration.toHours(); long min = duration.toMinutes(); long millis= duration.toMillis(); long nanos = duration.toNanos(); ç²—ç•¥æ—¶é—´å·®, æ¯”å¦‚ä»Šå¤©æ˜å¤©ç®—ä¸€å¤©\n1 2 3 4 5 6 7 8 9 10 11 long start = 1584328558000L; long now = 1584400558000L; Instant startTime = Instant.ofEpochMilli(start); LocalDate startTimeT = LocalDateTime.ofInstant(startTime, ZoneId.systemDefault()).toLocalDate(); Instant endTime = Instant.ofEpochMilli(now); LocalDate entTimeT = LocalDateTime.ofInstant(startTime, ZoneId.systemDefault()).toLocalDate(); Period period = Period.between(startTimeT, entTimeT); int years = period.getYears(); int months = period.getMonths(); int days = period.getDays(); ","permalink":"https://habyss.github.io/posts/tech/springboot_localdatetime/","summary":"SpringBootä¸­æ—¶é—´æˆ³å’ŒLocalDateTimeç›¸å…³çš„æ¥æ”¶å’Œè½¬æ¢ å‰è¨€ ä¸€èˆ¬æƒ…å†µä¸‹, å‰ç«¯å’Œåç«¯åœ¨æ—¶é—´æ ¼å¼çš„ä¼ é€’ä¸Šéƒ½èµ°çš„æ˜¯æ—¶é—´æˆ³ï¼ˆæ–¹ä¾¿å‰ç«¯","title":"SpringBootä¸­æ—¶é—´æˆ³å’ŒLocalDateTimeç›¸å…³çš„æ¥æ”¶å’Œè½¬æ¢"},{"content":"å°é¹¤åŒæ‹¼ æ–¹æ¡ˆä¸€ win + Rï¼Œè¾“å…¥ regeditï¼Œæ‰“å¼€æ³¨å†Œè¡¨\næ‰¾åˆ° è®¡ç®—æœº\\HKEY_CURRENT_USER\\Software\\Microsoft\\InputMethod\\Settings\\CHS é¡¹\næ–°å»ºä¸€ä¸ªåä¸º UserDefinedDoublePinyinScheme0 çš„å­—ç¬¦ä¸²å€¼ï¼Œå€¼ä¸º\n1 å°é¹¤åŒæ‹¼*2*^*iuvdjhcwfg^xmlnpbksqszxkrltvyovt æ–¹æ¡ˆäºŒ æ–°å»ºæ–‡æœ¬æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 Windows Registry Editor Version 5.00 [HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\InputMethod\\Settings\\CHS] \u0026#34;EnableExtraDomainType\u0026#34;=dword:00000001 \u0026#34;EnableSmartSelfLearning\u0026#34;=dword:00000000 \u0026#34;EnableVMode\u0026#34;=dword:00000000 \u0026#34;EnableHap\u0026#34;=dword:00000000 \u0026#34;EnablePeopleName\u0026#34;=dword:00000000 \u0026#34;DoublePinyinScheme\u0026#34;=dword:0000000a \u0026#34;EnableUMode\u0026#34;=dword:00000000 \u0026#34;EnableSmartFuzzyPinyin\u0026#34;=dword:00000000 \u0026#34;UserDefinedDoublePinyinScheme0\u0026#34;=\u0026#34;å°é¹¤åŒæ‹¼*2*^*iuvdjhcwfg^xmlnpbksqszxkrltvyovt\u0026#34; \u0026#34;Enable Dynamic Candidate Ranking\u0026#34;=dword:00000000 \u0026#34;Enable self-learning\u0026#34;=dword:00000000 \u0026#34;Expand Double Pinyin\u0026#34;=dword:00000000 \u0026#34;Enable Double Pinyin\u0026#34;=dword:00000001 \u0026#34;LangBar Force On\u0026#34;=dword:00000000 \u0026#34;PinyinMixEnable\u0026#34;=dword:00000000 \u0026#34;ToolBarEnabled\u0026#34;=dword:00000000 é‡å‘½å.reg, å¹¶è¿è¡Œ\n","permalink":"https://habyss.github.io/posts/tool/%E5%B0%8F%E9%B9%A4%E5%8F%8C%E6%8B%BC/","summary":"å°é¹¤åŒæ‹¼ æ–¹æ¡ˆä¸€ win + Rï¼Œè¾“å…¥ regeditï¼Œæ‰“å¼€æ³¨å†Œè¡¨ æ‰¾åˆ° è®¡ç®—æœº\\HKEY_CURRENT_USER\\Software\\Microsoft\\I","title":"å°é¹¤åŒæ‹¼"},{"content":"Mysql-explain id idç›¸åŒæ—¶, æ‰§è¡Œé¡ºåºç”±ä¸Šè€Œä¸‹ idä¸åŒæ—¶, æ‰§è¡Œé¡ºåºç”±å¤§åˆ°å°, ä¸€èˆ¬ä¸ºå­æŸ¥è¯¢ select_type æŸ¥è¯¢ç±»å‹, å¸¸è§çš„å€¼æœ‰:\nSIMPLE: ç®€å•æŸ¥è¯¢, ä¸åŒ…å«UNIONæˆ–è€…å­æŸ¥è¯¢ PRIMARY: æŸ¥è¯¢ä¸­å¦‚æœåŒ…å«å­æŸ¥è¯¢æˆ–å…¶ä»–éƒ¨åˆ†, åˆ™å¤–å±‚çš„SELECTå°†è¢«æ ‡è®°ä¸ºPRIMARY SUBQUERY: å­æŸ¥è¯¢ä¸­çš„ç¬¬ä¸€ä¸ªSELECT NUION: åœ¨UNIONè¯­å¥ä¸­, UNIONä¹‹åå‡ºç°çš„SELECT DERIVED: åœ¨FROMä¸­å‡ºç°çš„å­æŸ¥è¯¢ UNION RESULT: UNIONæŸ¥è¯¢çš„ç»“æœ table å½“å‰çš„æ•°æ®è¡¨\npartitions æŸ¥è¯¢æ‰€åŒ¹é…è®°å½•çš„åˆ†åŒº, å¯¹äºæœªåˆ†åŒºçš„è¡¨, å€¼ä¸ºNULL\ntype æŸ¥è¯¢æ‰§è¡Œçš„ç±»å‹, æœ€ä¼˜æ’è¡Œ\nsystem \u0026gt; const \u0026gt; eq_ref \u0026gt; ref \u0026gt; fulltext \u0026gt; ref_or_null \u0026gt; index_merge \u0026gt; unique_subquery \u0026gt; index_subquery \u0026gt; range \u0026gt; index \u0026gt; ALL\nsystem: è¡¨ä¸­åªæœ‰ä¸€è¡Œæ•°æ®, æ˜¯constçš„ä¸€ç§ç‰¹ä¾‹ const: è¡¨ä¸­æœ€å¤šåªæœ‰ä¸€è¡ŒåŒ¹é…çš„è®°å½• eq_ref: è¿è¡¨æŸ¥è¯¢æ—¶, å‰ä¸€å¼ è¡¨çš„è¡Œåœ¨å½“å‰è¡¨ä¸­åªæœ‰ä¸€è¡Œä¸ä¹‹å¯¹åº”(é™¤äº†systemä¸constæœ€å¥½çš„è¿è¡¨æ–¹å¼) ref: ä½¿ç”¨æ™®é€šç´¢å¼•ä½œä¸ºæŸ¥è¯¢æ¡ä»¶, æŸ¥è¯¢ç»“æœå¯èƒ½æ‰¾åˆ°å¤šè¡ŒåŒ¹é…çš„è®°å½• fulltext: å…¨æ–‡ç´¢å¼• ref_or_null: ä½¿ç”¨æ™®é€šç´¢å¼•ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ , æŸ¥è¯¢ç»“æœå¯èƒ½æ‰¾åˆ°å¤šè¡ŒåŒ¹é…çš„è®°å½•, è¿˜æŸ¥è¯¢äº†å€¼ä¸ºNULLçš„è¡Œ index_merge: å½“æŸ¥è¯¢æ¡ä»¶ä½¿ç”¨å¤šä¸ªç´¢å¼•æ—¶, index_mergeè¡¨ç¤ºå¼€å¯äº†Index Mergeä¼˜åŒ– unique_subquery: eq_refç±»ä¼¼, åœ¨ä¸€äº›ä½¿ç”¨INçš„å­æŸ¥è¯¢ä¸­, ä½¿ç”¨å”¯ä¸€ç´¢å¼• index_subquery: ä¸unique_subqueryç±»ä¼¼, åœ¨INå­æŸ¥è¯¢ä¸­, ä½¿ç”¨äº†æ™®é€šç´¢å¼• range: å¯¹ç´¢å¼•åˆ—è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ index: æŸ¥è¯¢ä¾¿åˆ©äº†æ•´ä¸ªç´¢å¼•æ ‘, ALL: éå†å…¨è¡¨, å¾ˆå¯èƒ½è¯»ç£ç›˜, é€Ÿåº¦æœ€æ…¢ possible_key å¯èƒ½è¢«ä½¿ç”¨çš„ç´¢å¼•, ä¸ä¸€å®šè¢«æŸ¥è¯¢å®é™…ä½¿ç”¨\nkey æŸ¥è¯¢ä¸­å®é™…ä½¿ç”¨åˆ°çš„ç´¢å¼•, å¦‚æœä¸ºNULL, åˆ™è¡¨ç¤ºä¸ºå»ºç«‹ç´¢å¼•æˆ–ç´¢å¼•å¤±æ•ˆ\nkey_len æŸ¥è¯¢ç´¢å¼•æ—¶ä½¿ç”¨çš„å­—èŠ‚æ•°, åœ¨æ»¡è¶³å‰æçš„éœ€æ±‚ä¸‹, è¶Šå°è¶Šå¥½\nref åœ¨æŸ¥è¯¢ç´¢å¼•æ—¶, é‚£äº›åˆ—æˆ–å¸¸é‡è¢«ç”¨æ¥ä¸ç´¢å¼•å€¼æ¯”è¾ƒ\nrows å¯èƒ½æŸ¥è¯¢æ—¶éœ€è¦éå†çš„è¡Œæ•°\nfiltered ä¼°ç®—ç»è¿‡æŸ¥è¯¢æ¡ä»¶ç­›é€‰å‡ºçš„åˆ—æ•°çš„ç™¾åˆ†æ¯”\nExtra æŸ¥è¯¢æ—¶çš„é¢å¤–ä¿¡æ¯\nå½“åŒ…å«Using filesortæˆ–Using temporary, éœ€è¦ä¼˜åŒ–\nUsing filesort: åœ¨æ’åºæ—¶ä½¿ç”¨äº†å¤–éƒ¨çš„ç´¢å¼•æ’åº, æ²¡æœ‰ä½¿ç”¨è¡¨å†…çš„ç´¢å¼•è¿›è¡Œæ’åº Using temporary: éœ€è¦åˆ›å»ºä¸´æ—¶è¡¨æ¥å­˜å‚¨æŸ¥è¯¢çš„ç»“æœ, å¸¸è§äºORDER BYå’ŒGROUP BY Using index: ä½¿ç”¨äº†ç´¢å¼•è¦†ç›–, æŸ¥è¯¢æ•ˆç‡éå¸¸é«˜ Using where: ä½¿ç”¨äº†WHEREå­å¥è¿›è¡Œæ¡ä»¶è¿‡æ»¤, ä¸€èˆ¬åœ¨æ²¡æœ‰ä½¿ç”¨åˆ°ç´¢å¼•çš„æ—¶å€™å‡ºç° Impossible where: è¡¨ç¤ºwhereå­å¥çš„ç»“æœæ€»æ˜¯falseä¸”æ— æ³•æŸ¥åˆ°ä»»æ„è¡Œ Using join buffer(Block Nested Loop): è¿è¡¨æŸ¥è¯¢æ—¶, å½“è¢«é©±åŠ¨è¡¨æ²¡æœ‰ä½¿ç”¨ç´¢å¼•æ—¶, ä¼šå…ˆå°†é©±åŠ¨è¡¨è¯»åˆ°join bufferä¸­, å†éå†è¢«é©±åŠ¨è¡¨ä¸é©±åŠ¨è¡¨è¿›è¡ŒæŸ¥è¯¢ Using json buffer(Batched Key Access): ä¸Using join buffer(Block Nested Loop)ç±»ä¼¼, ä½¿ç”¨çš„æ˜¯BKAç®—æ³•\u0026ndash; å‰ææ˜¯è¢«é©±åŠ¨è¡¨æœ‰ç´¢å¼•å¯ç”¨ ","permalink":"https://habyss.github.io/posts/tech/mysql_explain/","summary":"Mysql-explain id idç›¸åŒæ—¶, æ‰§è¡Œé¡ºåºç”±ä¸Šè€Œä¸‹ idä¸åŒæ—¶, æ‰§è¡Œé¡ºåºç”±å¤§åˆ°å°, ä¸€èˆ¬ä¸ºå­æŸ¥è¯¢ select_type æŸ¥è¯¢ç±»å‹, å¸¸è§çš„å€¼æœ‰: SIMPLE: ç®€å•æŸ¥è¯¢, ä¸åŒ…å«UNIONæˆ–è€…å­æŸ¥è¯¢ PRIMARY: æŸ¥","title":"Mysql Explain ç®€è§£"},{"content":"Hugo+Github Pages 1. å®‰è£…Scoop winç³»ç»Ÿ, åœ¨hugoå®˜ç½‘ä¸­ä¹Ÿæ¨èäº†ä½¿ç”¨Scoopæ¥è¿›è¡ŒåŒ…ç®¡ç†\næ‰“å¼€PowerShellå¹¶è¿è¡Œ, ä¿è¯å…è®¸æœ¬åœ°è„šæœ¬çš„æ‰§è¡Œ\n1 set-executionpolicy remotesigned -scope currentuser æ‰§è¡Œå®‰è£…å‘½ä»¤\n1 iex (new-object net.webclient).downloadstring(\u0026#39;https://get.scoop.sh\u0026#39;) å®‰è£…æˆåŠŸéªŒè¯\n1 scoop help 2. å®‰è£…Hugo å®‰è£…Hugoçš„extendç‰ˆæœ¬\n1 scoop install hugo-extended å®‰è£…æˆåŠŸéªŒè¯\n1 hugo version 3. åˆ›å»ºBlog hugo new site MyBlog -f yml ä¸‹è½½zipè§£å‹åˆ°themes, å¹¶é‡å‘½åä¸ºPaperMod ä¿®æ”¹config.yml https://shaohanyun.top/posts/env/blog_build2/\nhttps://www.sulvblog.cn/posts/blog/build_hugo/\n","permalink":"https://habyss.github.io/posts/tech/%E6%B5%8B%E8%AF%95/","summary":"Hugo+Github Pages 1. å®‰è£…Scoop winç³»ç»Ÿ, åœ¨hugoå®˜ç½‘ä¸­ä¹Ÿæ¨èäº†ä½¿ç”¨Scoopæ¥è¿›è¡ŒåŒ…ç®¡ç† æ‰“å¼€PowerShellå¹¶è¿è¡Œ, ä¿è¯å…è®¸æœ¬åœ°è„šæœ¬çš„æ‰§è¡Œ 1 set-executionpolicy","title":"æµ‹è¯•"}]