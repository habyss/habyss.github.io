<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>大文件分片上传 | 叶灰灰的小窝</title>
<meta name="keywords" content="分片, 多线程">
<meta name="description" content="简单demo和多线程合并文件优化">
<meta name="author" content="叶灰灰">
<link rel="canonical" href="https://habyss.github.io/posts/tech/big_file_upload/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://habyss.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://habyss.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://habyss.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://habyss.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://habyss.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="大文件分片上传" />
<meta property="og:description" content="简单demo和多线程合并文件优化" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://habyss.github.io/posts/tech/big_file_upload/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-01T15:36:53+08:00" />
<meta property="article:modified_time" content="2022-11-29T15:36:53+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="大文件分片上传"/>
<meta name="twitter:description" content="简单demo和多线程合并文件优化"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://habyss.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "👨🏻‍💻技术",
      "item": "https://habyss.github.io/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "大文件分片上传",
      "item": "https://habyss.github.io/posts/tech/big_file_upload/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "大文件分片上传",
  "name": "大文件分片上传",
  "description": "简单demo和多线程合并文件优化",
  "keywords": [
    "分片", "多线程"
  ],
  "articleBody": "简单demo实现 简单实现, 以大文件的md5作为唯一key\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 @Slf4j @Api(tags = \"大文件上传\") @RestController @RequestMapping(\"dict\") public class BigFileController { public static final String tmpPath = \"E:/data/tempAppfiles/\"; public static final String finalPath = \"E:/data/finalAppfiles/\"; private static final Map\u003cString, Integer\u003e chunkMap = new ConcurrentHashMap\u003c\u003e(); /** * 上传文件 * * @param dto dto * @return {@link String} */ @PostMapping(\"/uploadFile\") public ResponseResult\u003c?\u003e uploadFile(UploadFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); String tmpFileName = tmpPath + md5 + \"/\" + dto.getIndex() + \".tmp\"; // 分片秒传 if (chunkMap.get(tmpFileName) != null) { return ResponseResult.createBySuccess(); } createTmpPath(tmpPath + md5); try { FileCopyUtils.copy(dto.getFile().getBytes(), new File(tmpFileName)); } catch (IOException e) { e.printStackTrace(); throw new ServiceException(\"文件上传失败\"); } chunkMap.put(tmpFileName, dto.getIndex()); return ResponseResult.createBySuccess(); } /** * 合并文件 * * @param dto dto * @return {@link String} */ @PostMapping(\"/mergeFile\") public ResponseResult\u003c?\u003e mergeFile(@RequestBody MergeFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); createTmpPath(finalPath + md5); try (Stream\u003cPath\u003e pathStream = Files.list(Paths.get(tmpPath + md5 + \"/\"));) { byte[] reduce = pathStream .sorted((s1, s2) -\u003e { int n1 = Integer.parseInt(s1.getFileName().toString().split(\"\\\\.\", 0)[0]); int n2 = Integer.parseInt(s2.getFileName().toString().split(\"\\\\.\", 0)[0]); return Integer.compare(n1, n2); }) .map(this::readByteByPath) .filter(Objects::nonNull) .reduce(new byte[]{}, this::addBytes); String s = DigestUtils.md5DigestAsHex(reduce); FileCopyUtils.copy(reduce, new File(finalPath + md5 + \"/\" + dto.getFileName())); deleteDir(tmpPath + md5); } catch (IOException e) { e.printStackTrace(); } return ResponseResult.createBySuccess(); } /** * 删除分片 * */ private void deleteDir(String path) { Path dir = Paths.get(path); try (Stream\u003cPath\u003e pathStream = Files.list(dir)) { pathStream.forEach(p -\u003e { try { Files.delete(p); // 删除分片缓存信息 chunkMap.remove(p.toString()); } catch (IOException e) { e.printStackTrace(); } }); Files.delete(dir); } catch (IOException e) { e.printStackTrace(); } } /** * 读文件 * */ private byte[] readByteByPath(Path i) { try { return Files.readAllBytes(i); } catch (IOException e) { e.printStackTrace(); return null; } } /** * 合并文件 * */ public byte[] addBytes(byte[] data1, byte[] data2) { byte[] data3 = new byte[data1.length + data2.length]; System.arraycopy(data1, 0, data3, 0, data1.length); System.arraycopy(data2, 0, data3, data1.length, data2.length); return data3; } /** * 创建文件夹 * */ private void createTmpPath(String pathString) { Path path = Paths.get(pathString); // 并发 if (Files.exists(path)){ return; } synchronized (this) { if (Files.notExists(path)) { try { Files.createDirectory(path); } catch (IOException e) { e.printStackTrace(); throw new ServiceException(\"创建失败\"); } } } } @Data public static class UploadFileDTO { @ApiModelProperty(\"文件MD5\") private String md5; @ApiModelProperty(\"分片文件序号\") private Integer index; @ApiModelProperty(\"分片文件\") private MultipartFile file; } @Data public static class MergeFileDTO { @ApiModelProperty(\"文件MD5\") private String md5; @ApiModelProperty(\"原文件名 带后缀\") private String fileName; } } demo用作生产时需要优化的点 1. 对接redis和mysql 分片上传的状态, 文件上传的状态, 文件的地址等信息, 存储在数据库中, 或redis缓存, 视情况而定\n2. 对接阿里云/天翼云等云对象存储服务 一般在项目中都是使用的第三方的对象催出服务, 需要对接一下, 一般也都有分片上传的api\n3. 断点续传 当我们把分片信息存储在数据库中的时候, 之后就可以通过md5 key(或自定义唯一key, 但前后端需要沟通统一), 来获取之前的分片上传状态\n4. 校验md5 基于后端不完全信任客户端的思想, 后端需要算出分片或大文件特征(前后端沟通统一特征的规则, eg第一个分片+最后一个分片)的md5, 与前端传的md5是否一致.. 等等之类的校验, 视情况而定\n5. 秒传 需要一个新的接口, 在分片上传之前从数据库获取整个大文件特征对应的md5 对应的文件上传状态\n完全无信息\n就是没有上传过, 需要分片上传\n一部分信息\n上传过一部分, 可做断点续传的前提\n整个大文件已上传\n秒传的前提判断\n6. 并发问题 分片上传一般为并发状态, 需要处理好代码的并发问题\n7. 分片规则 分片的大小规则是否由服务端来控制, 视情况而定\n8. 多线程合并文件 注意点: 文件需要顺序合并, 不能乱序\n思路:\n将文件序号, 和文件提取, 放在Pair中, 并排序\n1 2 3 List\u003cPair\u003cInteger, byte[]\u003e\u003e pairs = pathStream .map(p -\u003e Pair.of(Integer.parseInt(p.getFileName().toString().split(\"\\\\.\", 0)[0]), readByteByPath(p))) .toList(); 利用stream的groupingBy和mapping, 对序号整除5分组, 分成一堆一堆的\n1 2 3 Map\u003cInteger, List\u003cbyte[]\u003e\u003e collect = pairs.stream() .sorted(Comparator.comparingInt(Pair::getKey)) .collect(Collectors.groupingBy(p -\u003e p.getKey() / 5, Collectors.mapping(Pair::getValue, Collectors.toList()))); 使用多线程, 每堆一个线程, 将每一堆合并\n方式一: 并行流\n1 2 3 4 5 pairs = joinPool.submit(() -\u003e collect.entrySet().parallelStream() .map(entry -\u003e Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes))) .toList() ).get(); 方式二: CompletableFuture+自定义线程池\n1 2 3 4 pairs = collect.entrySet().stream() .map(en -\u003e CompletableFuture.supplyAsync(() -\u003e mergeBytes(en), executorService)) .map(CompletableFuture::join) .collect(Collectors.toList()); 判断合并后list的大小, 如果还有很多, 则继续第二步, 否则写入文件(也就是已经合并完了, 只剩下一个)\n1 2 3 4 5 while (pairs.size() \u003e 1) {...} FileCopyUtils.copy(pairs.get(0).getValue(), new File(finalPath + md5 + \"/\" + dto.getFileName())); deleteDir(tmpPath + md5); 方式一: 使用指定线程数的并行流 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 /** * 合并文件 * * @param dto dto * @return {@link String} */ @PostMapping(\"/mergeFile\") public ResponseResult\u003c?\u003e mergeFile(@RequestBody MergeFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); createTmpPath(finalPath + md5); ForkJoinPool joinPool = new ForkJoinPool(5); try (Stream\u003cPath\u003e pathStream = Files.list(Paths.get(tmpPath + md5 + \"/\"));) { List\u003cPair\u003cInteger, byte[]\u003e\u003e pairs = pathStream .map(p -\u003e Pair.of(Integer.parseInt(p.getFileName().toString().split(\"\\\\.\", 0)[0]), readByteByPath(p))) .toList(); while (pairs.size() \u003e 1) { Map\u003cInteger, List\u003cbyte[]\u003e\u003e collect = pairs.stream() .sorted(Comparator.comparingInt(Pair::getKey)) .collect(Collectors.groupingBy(p -\u003e p.getKey() / 5, Collectors.mapping(Pair::getValue, Collectors.toList()))); pairs = joinPool.submit(() -\u003e collect.entrySet().parallelStream() .map(entry -\u003e Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes))) .toList() ).get(); } FileCopyUtils.copy(pairs.get(0).getValue(), new File(finalPath + md5 + \"/\" + dto.getFileName())); deleteDir(tmpPath + md5); } catch (Exception e) { e.printStackTrace(); } return ResponseResult.createBySuccess(); } 指定线程数\n1 ForkJoinPool joinPool = new ForkJoinPool(5); 提交\n1 2 3 4 5 pairs = joinPool.submit(() -\u003e collect.entrySet().parallelStream() .map(entry -\u003e Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes))) .toList() ).get(); 方式二: CompletableFuture+自定义线程池 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @PostMapping(\"/mergeFile\") public ResponseResult\u003c?\u003e mergeFile(@RequestBody MergeFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); createTmpPath(finalPath + md5); ExecutorService executorService = Executors.newFixedThreadPool(5); try (Stream\u003cPath\u003e pathStream = Files.list(Paths.get(tmpPath + md5 + \"/\"));) { List\u003cPair\u003cInteger, byte[]\u003e\u003e pairs = pathStream .map(p -\u003e Pair.of(Integer.parseInt(p.getFileName().toString().split(\"\\\\.\", 0)[0]), readByteByPath(p))) .toList(); while (pairs.size() \u003e 1) { Map\u003cInteger, List\u003cbyte[]\u003e\u003e collect = pairs.stream() .sorted(Comparator.comparingInt(Pair::getKey)) .collect(Collectors.groupingBy(p -\u003e p.getKey() / 5, Collectors.mapping(Pair::getValue, Collectors.toList()))); pairs = collect.entrySet().stream() .map(en -\u003e CompletableFuture.supplyAsync(() -\u003e mergeBytes(en), executorService)) .map(CompletableFuture::join) .collect(Collectors.toList()); } FileCopyUtils.copy(pairs.get(0).getValue(), new File(finalPath + md5 + \"/\" + dto.getFileName())); deleteDir(tmpPath + md5); } catch (Exception e) { e.printStackTrace(); } return ResponseResult.createBySuccess(); } public Pair\u003cInteger, byte[]\u003e mergeBytes(Map.Entry\u003cInteger, List\u003cbyte[]\u003e\u003e entry) { return Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes)); } 自定义线程池, 或使用new Executor(……);\n1 ExecutorService executorService = Executors.newFixedThreadPool(5); 使用CompletableFuture\n1 2 3 4 pairs = collect.entrySet().stream() .map(en -\u003e CompletableFuture.supplyAsync(() -\u003e mergeBytes(en), executorService)) .map(CompletableFuture::join) .collect(Collectors.toList()); 优化点 while中的条件可以改大一点, 也就是实现分情况开启多线程, 当文件数足够多的时候开启多线程, 否则直接主线程合并, 这样可以避免线程切换的开销, 视情况而定.\n",
  "wordCount" : "2055",
  "inLanguage": "zh",
  "datePublished": "2022-12-01T15:36:53+08:00",
  "dateModified": "2022-11-29T15:36:53+08:00",
  "author":[{
    "@type": "Person",
    "name": "叶灰灰"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://habyss.github.io/posts/tech/big_file_upload/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "叶灰灰的小窝",
    "logo": {
      "@type": "ImageObject",
      "url": "https://habyss.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://habyss.github.io/" accesskey="h" title="叶灰灰的小窝 (Alt + H)">叶灰灰的小窝</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://habyss.github.io/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/archives" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://habyss.github.io/">主页</a>&nbsp;»&nbsp;<a href="https://habyss.github.io/posts/">Posts</a>&nbsp;»&nbsp;<a href="https://habyss.github.io/posts/tech/">👨🏻‍💻技术</a></div>
    <h1 class="post-title">
      大文件分片上传
    </h1>
    <div class="post-meta"><span title='2022-12-01 15:36:53 +0800 CST'>2022-12-01</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;叶灰灰

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%ae%80%e5%8d%95demo%e5%ae%9e%e7%8e%b0" aria-label="简单demo实现">简单demo实现</a></li>
                <li>
                    <a href="#demo%e7%94%a8%e4%bd%9c%e7%94%9f%e4%ba%a7%e6%97%b6%e9%9c%80%e8%a6%81%e4%bc%98%e5%8c%96%e7%9a%84%e7%82%b9" aria-label="demo用作生产时需要优化的点">demo用作生产时需要优化的点</a><ul>
                        
                <li>
                    <a href="#1-%e5%af%b9%e6%8e%a5redis%e5%92%8cmysql" aria-label="1. 对接redis和mysql">1. 对接redis和mysql</a></li>
                <li>
                    <a href="#2-%e5%af%b9%e6%8e%a5%e9%98%bf%e9%87%8c%e4%ba%91%e5%a4%a9%e7%bf%bc%e4%ba%91%e7%ad%89%e4%ba%91%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e6%9c%8d%e5%8a%a1" aria-label="2. 对接阿里云/天翼云等云对象存储服务">2. 对接阿里云/天翼云等云对象存储服务</a></li>
                <li>
                    <a href="#3-%e6%96%ad%e7%82%b9%e7%bb%ad%e4%bc%a0" aria-label="3. 断点续传">3. 断点续传</a></li>
                <li>
                    <a href="#4-%e6%a0%a1%e9%aa%8cmd5" aria-label="4. 校验md5">4. 校验md5</a></li>
                <li>
                    <a href="#5-%e7%a7%92%e4%bc%a0" aria-label="5. 秒传">5. 秒传</a></li>
                <li>
                    <a href="#6-%e5%b9%b6%e5%8f%91%e9%97%ae%e9%a2%98" aria-label="6. 并发问题">6. 并发问题</a></li>
                <li>
                    <a href="#7-%e5%88%86%e7%89%87%e8%a7%84%e5%88%99" aria-label="7. 分片规则">7. 分片规则</a></li>
                <li>
                    <a href="#8-%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%90%88%e5%b9%b6%e6%96%87%e4%bb%b6" aria-label="8. 多线程合并文件">8. <strong>多线程合并文件</strong></a><ul>
                        
                <li>
                    <a href="#%e6%96%b9%e5%bc%8f%e4%b8%80-%e4%bd%bf%e7%94%a8%e6%8c%87%e5%ae%9a%e7%ba%bf%e7%a8%8b%e6%95%b0%e7%9a%84%e5%b9%b6%e8%a1%8c%e6%b5%81" aria-label="方式一: 使用指定线程数的并行流">方式一: 使用指定线程数的并行流</a></li>
                <li>
                    <a href="#%e6%96%b9%e5%bc%8f%e4%ba%8c-completablefuture%e8%87%aa%e5%ae%9a%e4%b9%89%e7%ba%bf%e7%a8%8b%e6%b1%a0" aria-label="方式二: CompletableFuture&#43;自定义线程池">方式二: CompletableFuture+自定义线程池</a></li>
                <li>
                    <a href="#%e4%bc%98%e5%8c%96%e7%82%b9" aria-label="优化点">优化点</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="简单demo实现">简单demo实现<a hidden class="anchor" aria-hidden="true" href="#简单demo实现">#</a></h2>
<blockquote>
<p>简单实现, 以大文件的md5作为唯一key</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Api</span><span class="o">(</span><span class="n">tags</span> <span class="o">=</span> <span class="s">&#34;大文件上传&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;dict&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BigFileController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">tmpPath</span> <span class="o">=</span> <span class="s">&#34;E:/data/tempAppfiles/&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">finalPath</span> <span class="o">=</span> <span class="s">&#34;E:/data/finalAppfiles/&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">chunkMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 上传文件
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param dto dto
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return {@link String}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;/uploadFile&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ResponseResult</span><span class="o">&lt;?&gt;</span> <span class="n">uploadFile</span><span class="o">(</span><span class="n">UploadFileDTO</span> <span class="n">dto</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">dto</span><span class="o">.</span><span class="na">getMd5</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">tmpFileName</span> <span class="o">=</span> <span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getIndex</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;.tmp&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 分片秒传
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">chunkMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tmpFileName</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">ResponseResult</span><span class="o">.</span><span class="na">createBySuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">createTmpPath</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">dto</span><span class="o">.</span><span class="na">getFile</span><span class="o">().</span><span class="na">getBytes</span><span class="o">(),</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">tmpFileName</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;文件上传失败&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunkMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tmpFileName</span><span class="o">,</span> <span class="n">dto</span><span class="o">.</span><span class="na">getIndex</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ResponseResult</span><span class="o">.</span><span class="na">createBySuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 合并文件
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param dto dto
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return {@link String}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;/mergeFile&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ResponseResult</span><span class="o">&lt;?&gt;</span> <span class="n">mergeFile</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">MergeFileDTO</span> <span class="n">dto</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">dto</span><span class="o">.</span><span class="na">getMd5</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">createTmpPath</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">pathStream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span><span class="o">));)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">byte</span><span class="o">[]</span> <span class="n">reduce</span> <span class="o">=</span> <span class="n">pathStream</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">sorted</span><span class="o">((</span><span class="n">s1</span><span class="o">,</span> <span class="n">s2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">int</span> <span class="n">n1</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">s1</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">int</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">n1</span><span class="o">,</span> <span class="n">n2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">})</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">readByteByPath</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">Objects</span><span class="o">::</span><span class="n">nonNull</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{},</span> <span class="k">this</span><span class="o">::</span><span class="n">addBytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">DigestUtils</span><span class="o">.</span><span class="na">md5DigestAsHex</span><span class="o">(</span><span class="n">reduce</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">reduce</span><span class="o">,</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getFileName</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">deleteDir</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ResponseResult</span><span class="o">.</span><span class="na">createBySuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 删除分片
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">deleteDir</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Path</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">pathStream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">dir</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">pathStream</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 删除分片缓存信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">chunkMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">            <span class="n">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">dir</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 读文件
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">readByteByPath</span><span class="o">(</span><span class="n">Path</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">     <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 合并文件
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">addBytes</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data1</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">data2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data3</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">data1</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">data2</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">data1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data3</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data1</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">data2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data3</span><span class="o">,</span> <span class="n">data1</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">data2</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">data3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 创建文件夹
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createTmpPath</span><span class="o">(</span><span class="n">String</span> <span class="n">pathString</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">pathString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 并发
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">Files</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">path</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">Files</span><span class="o">.</span><span class="na">notExists</span><span class="o">(</span><span class="n">path</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Files</span><span class="o">.</span><span class="na">createDirectory</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;创建失败&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Data</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UploadFileDTO</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@ApiModelProperty</span><span class="o">(</span><span class="s">&#34;文件MD5&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">md5</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@ApiModelProperty</span><span class="o">(</span><span class="s">&#34;分片文件序号&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Integer</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@ApiModelProperty</span><span class="o">(</span><span class="s">&#34;分片文件&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">MultipartFile</span> <span class="n">file</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Data</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MergeFileDTO</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@ApiModelProperty</span><span class="o">(</span><span class="s">&#34;文件MD5&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">md5</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@ApiModelProperty</span><span class="o">(</span><span class="s">&#34;原文件名 带后缀&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">fileName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="demo用作生产时需要优化的点">demo用作生产时需要优化的点<a hidden class="anchor" aria-hidden="true" href="#demo用作生产时需要优化的点">#</a></h2>
<h3 id="1-对接redis和mysql">1. 对接redis和mysql<a hidden class="anchor" aria-hidden="true" href="#1-对接redis和mysql">#</a></h3>
<p>分片上传的状态, 文件上传的状态, 文件的地址等信息, 存储在数据库中, 或redis缓存, 视情况而定</p>
<h3 id="2-对接阿里云天翼云等云对象存储服务">2. 对接阿里云/天翼云等云对象存储服务<a hidden class="anchor" aria-hidden="true" href="#2-对接阿里云天翼云等云对象存储服务">#</a></h3>
<p>一般在项目中都是使用的第三方的对象催出服务, 需要对接一下, 一般也都有分片上传的api</p>
<h3 id="3-断点续传">3. 断点续传<a hidden class="anchor" aria-hidden="true" href="#3-断点续传">#</a></h3>
<p>当我们把分片信息存储在数据库中的时候, 之后就可以通过md5 key(或自定义唯一key, 但前后端需要沟通统一), 来获取之前的分片上传状态</p>
<h3 id="4-校验md5">4. 校验md5<a hidden class="anchor" aria-hidden="true" href="#4-校验md5">#</a></h3>
<p>基于后端不完全信任客户端的思想, 后端需要算出分片或<strong>大文件特征</strong>(前后端沟通统一特征的规则, eg第一个分片+最后一个分片)的md5, 与前端传的md5是否一致.. 等等之类的校验, 视情况而定</p>
<h3 id="5-秒传">5. 秒传<a hidden class="anchor" aria-hidden="true" href="#5-秒传">#</a></h3>
<p>需要一个新的接口, 在分片上传之前从数据库获取整个大文件特征对应的md5 对应的文件上传状态</p>
<ol>
<li>
<p><strong>完全无信息</strong></p>
<p>就是没有上传过, 需要<strong>分片上传</strong></p>
</li>
<li>
<p><strong>一部分信息</strong></p>
<p>上传过一部分, 可做<strong>断点续传的前提</strong></p>
</li>
<li>
<p><strong>整个大文件已上传</strong></p>
<p><strong>秒传的前提</strong>判断</p>
</li>
</ol>
<h3 id="6-并发问题">6. 并发问题<a hidden class="anchor" aria-hidden="true" href="#6-并发问题">#</a></h3>
<p>分片上传一般为并发状态, 需要处理好代码的并发问题</p>
<h3 id="7-分片规则">7. 分片规则<a hidden class="anchor" aria-hidden="true" href="#7-分片规则">#</a></h3>
<p>分片的大小规则是否由服务端来控制, 视情况而定</p>
<h3 id="8-多线程合并文件">8. <strong>多线程合并文件</strong><a hidden class="anchor" aria-hidden="true" href="#8-多线程合并文件">#</a></h3>
<p>注意点:  文件需要顺序合并, 不能乱序</p>
<p>思路:</p>
<ol>
<li>
<p>将文件序号, 和文件提取, 放在Pair中, 并排序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">            <span class="n">List</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">pathStream</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">]),</span> <span class="n">readByteByPath</span><span class="o">(</span><span class="n">p</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>利用stream的groupingBy和mapping, 对序号整除5分组, 分成一堆一堆的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">collect</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getKey</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="o">/</span> <span class="mi">5</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">mapping</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getValue</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())));</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用多线程, 每堆一个线程, 将每一堆合并</p>
<p>方式一: 并行流</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">                pairs = joinPool.submit(() -&gt;
</span></span><span class="line"><span class="cl">                        collect.entrySet().parallelStream()
</span></span><span class="line"><span class="cl">                                .map(entry -&gt; Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes)))
</span></span><span class="line"><span class="cl">                                .toList()
</span></span><span class="line"><span class="cl">                ).get();
</span></span></code></pre></td></tr></table>
</div>
</div><p>方式二: CompletableFuture+自定义线程池</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">                <span class="n">pairs</span> <span class="o">=</span> <span class="n">collect</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">en</span> <span class="o">-&gt;</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">mergeBytes</span><span class="o">(</span><span class="n">en</span><span class="o">),</span> <span class="n">executorService</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">::</span><span class="n">join</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>判断合并后list的大小, 如果还有很多, 则继续第二步, 否则写入文件(也就是已经合并完了, 只剩下一个)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">while</span> <span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{...}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getValue</span><span class="o">(),</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getFileName</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">deleteDir</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h4 id="方式一-使用指定线程数的并行流">方式一: 使用指定线程数的并行流<a hidden class="anchor" aria-hidden="true" href="#方式一-使用指定线程数的并行流">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 合并文件
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param dto dto
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return {@link String}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;/mergeFile&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ResponseResult</span><span class="o">&lt;?&gt;</span> <span class="n">mergeFile</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">MergeFileDTO</span> <span class="n">dto</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">dto</span><span class="o">.</span><span class="na">getMd5</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">createTmpPath</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ForkJoinPool</span> <span class="n">joinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">pathStream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span><span class="o">));)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">pathStream</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">]),</span> <span class="n">readByteByPath</span><span class="o">(</span><span class="n">p</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">collect</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getKey</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="o">/</span> <span class="mi">5</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">mapping</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getValue</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())));</span>
</span></span><span class="line"><span class="cl">                <span class="n">pairs</span> <span class="o">=</span> <span class="n">joinPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">collect</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">parallelStream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">entry</span> <span class="o">-&gt;</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">reduce</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{},</span> <span class="k">this</span><span class="o">::</span><span class="n">addBytes</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">toList</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">).</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getValue</span><span class="o">(),</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getFileName</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">deleteDir</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ResponseResult</span><span class="o">.</span><span class="na">createBySuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>指定线程数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ForkJoinPool</span> <span class="n">joinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span> 
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>提交</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">                <span class="n">pairs</span> <span class="o">=</span> <span class="n">joinPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">collect</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">parallelStream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">entry</span> <span class="o">-&gt;</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">reduce</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{},</span> <span class="k">this</span><span class="o">::</span><span class="n">addBytes</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">toList</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">).</span><span class="na">get</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="方式二-completablefuture自定义线程池">方式二: CompletableFuture+自定义线程池<a hidden class="anchor" aria-hidden="true" href="#方式二-completablefuture自定义线程池">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;/mergeFile&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ResponseResult</span><span class="o">&lt;?&gt;</span> <span class="n">mergeFile</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">MergeFileDTO</span> <span class="n">dto</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">dto</span><span class="o">.</span><span class="na">getMd5</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">createTmpPath</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">pathStream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span><span class="o">));)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">pathStream</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">]),</span> <span class="n">readByteByPath</span><span class="o">(</span><span class="n">p</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">collect</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getKey</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="o">/</span> <span class="mi">5</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">mapping</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getValue</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())));</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">pairs</span> <span class="o">=</span> <span class="n">collect</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">en</span> <span class="o">-&gt;</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">mergeBytes</span><span class="o">(</span><span class="n">en</span><span class="o">),</span> <span class="n">executorService</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">::</span><span class="n">join</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getValue</span><span class="o">(),</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getFileName</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">deleteDir</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ResponseResult</span><span class="o">.</span><span class="na">createBySuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="nf">mergeBytes</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">reduce</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{},</span> <span class="k">this</span><span class="o">::</span><span class="n">addBytes</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>自定义线程池, 或使用new Executor(&hellip;&hellip;);</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用CompletableFuture</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">                <span class="n">pairs</span> <span class="o">=</span> <span class="n">collect</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">en</span> <span class="o">-&gt;</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">mergeBytes</span><span class="o">(</span><span class="n">en</span><span class="o">),</span> <span class="n">executorService</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">::</span><span class="n">join</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="优化点">优化点<a hidden class="anchor" aria-hidden="true" href="#优化点">#</a></h4>
<p>while中的条件可以改大一点, 也就是实现分情况开启多线程, 当文件数足够多的时候开启多线程, 否则直接主线程合并, 这样可以避免线程切换的开销, 视情况而定.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://habyss.github.io/tags/%E5%88%86%E7%89%87/">分片</a></li>
      <li><a href="https://habyss.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://habyss.github.io/posts/tech/mybatis_plus_typehandler/">
    <span class="title">下一页 »</span>
    <br>
    <span>基于mybatis-plus typeHandler 加解密简单实现</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://habyss.github.io/">叶灰灰的小窝</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
