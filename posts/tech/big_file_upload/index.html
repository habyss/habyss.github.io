<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼  | å¶ç°ç°çš„å°çª</title>
<meta name="keywords" content="åˆ†ç‰‡, å¤šçº¿ç¨‹">
<meta name="description" content="ç®€å•demoå’Œå¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶ä¼˜åŒ–">
<meta name="author" content="å¶ç°ç°">
<link rel="canonical" href="https://habyss.github.io/posts/tech/big_file_upload/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://habyss.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://habyss.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://habyss.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://habyss.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://habyss.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ " />
<meta property="og:description" content="ç®€å•demoå’Œå¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶ä¼˜åŒ–" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://habyss.github.io/posts/tech/big_file_upload/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-01T15:36:53+08:00" />
<meta property="article:modified_time" content="2022-11-29T15:36:53+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ "/>
<meta name="twitter:description" content="ç®€å•demoå’Œå¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶ä¼˜åŒ–"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://habyss.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯",
      "item": "https://habyss.github.io/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ",
      "item": "https://habyss.github.io/posts/tech/big_file_upload/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ",
  "name": "å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ",
  "description": "ç®€å•demoå’Œå¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶ä¼˜åŒ–",
  "keywords": [
    "åˆ†ç‰‡", "å¤šçº¿ç¨‹"
  ],
  "articleBody": "ç®€å•demoå®ç° ç®€å•å®ç°, ä»¥å¤§æ–‡ä»¶çš„md5ä½œä¸ºå”¯ä¸€key\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 @Slf4j @Api(tags = \"å¤§æ–‡ä»¶ä¸Šä¼ \") @RestController @RequestMapping(\"dict\") public class BigFileController { public static final String tmpPath = \"E:/data/tempAppfiles/\"; public static final String finalPath = \"E:/data/finalAppfiles/\"; private static final Map\u003cString, Integer\u003e chunkMap = new ConcurrentHashMap\u003c\u003e(); /** * ä¸Šä¼ æ–‡ä»¶ * * @param dto dto * @return {@link String} */ @PostMapping(\"/uploadFile\") public ResponseResult\u003c?\u003e uploadFile(UploadFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); String tmpFileName = tmpPath + md5 + \"/\" + dto.getIndex() + \".tmp\"; // åˆ†ç‰‡ç§’ä¼  if (chunkMap.get(tmpFileName) != null) { return ResponseResult.createBySuccess(); } createTmpPath(tmpPath + md5); try { FileCopyUtils.copy(dto.getFile().getBytes(), new File(tmpFileName)); } catch (IOException e) { e.printStackTrace(); throw new ServiceException(\"æ–‡ä»¶ä¸Šä¼ å¤±è´¥\"); } chunkMap.put(tmpFileName, dto.getIndex()); return ResponseResult.createBySuccess(); } /** * åˆå¹¶æ–‡ä»¶ * * @param dto dto * @return {@link String} */ @PostMapping(\"/mergeFile\") public ResponseResult\u003c?\u003e mergeFile(@RequestBody MergeFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); createTmpPath(finalPath + md5); try (Stream\u003cPath\u003e pathStream = Files.list(Paths.get(tmpPath + md5 + \"/\"));) { byte[] reduce = pathStream .sorted((s1, s2) -\u003e { int n1 = Integer.parseInt(s1.getFileName().toString().split(\"\\\\.\", 0)[0]); int n2 = Integer.parseInt(s2.getFileName().toString().split(\"\\\\.\", 0)[0]); return Integer.compare(n1, n2); }) .map(this::readByteByPath) .filter(Objects::nonNull) .reduce(new byte[]{}, this::addBytes); String s = DigestUtils.md5DigestAsHex(reduce); FileCopyUtils.copy(reduce, new File(finalPath + md5 + \"/\" + dto.getFileName())); deleteDir(tmpPath + md5); } catch (IOException e) { e.printStackTrace(); } return ResponseResult.createBySuccess(); } /** * åˆ é™¤åˆ†ç‰‡ * */ private void deleteDir(String path) { Path dir = Paths.get(path); try (Stream\u003cPath\u003e pathStream = Files.list(dir)) { pathStream.forEach(p -\u003e { try { Files.delete(p); // åˆ é™¤åˆ†ç‰‡ç¼“å­˜ä¿¡æ¯ chunkMap.remove(p.toString()); } catch (IOException e) { e.printStackTrace(); } }); Files.delete(dir); } catch (IOException e) { e.printStackTrace(); } } /** * è¯»æ–‡ä»¶ * */ private byte[] readByteByPath(Path i) { try { return Files.readAllBytes(i); } catch (IOException e) { e.printStackTrace(); return null; } } /** * åˆå¹¶æ–‡ä»¶ * */ public byte[] addBytes(byte[] data1, byte[] data2) { byte[] data3 = new byte[data1.length + data2.length]; System.arraycopy(data1, 0, data3, 0, data1.length); System.arraycopy(data2, 0, data3, data1.length, data2.length); return data3; } /** * åˆ›å»ºæ–‡ä»¶å¤¹ * */ private void createTmpPath(String pathString) { Path path = Paths.get(pathString); // å¹¶å‘ if (Files.exists(path)){ return; } synchronized (this) { if (Files.notExists(path)) { try { Files.createDirectory(path); } catch (IOException e) { e.printStackTrace(); throw new ServiceException(\"åˆ›å»ºå¤±è´¥\"); } } } } @Data public static class UploadFileDTO { @ApiModelProperty(\"æ–‡ä»¶MD5\") private String md5; @ApiModelProperty(\"åˆ†ç‰‡æ–‡ä»¶åºå·\") private Integer index; @ApiModelProperty(\"åˆ†ç‰‡æ–‡ä»¶\") private MultipartFile file; } @Data public static class MergeFileDTO { @ApiModelProperty(\"æ–‡ä»¶MD5\") private String md5; @ApiModelProperty(\"åŸæ–‡ä»¶å å¸¦åç¼€\") private String fileName; } } demoç”¨ä½œç”Ÿäº§æ—¶éœ€è¦ä¼˜åŒ–çš„ç‚¹ 1. å¯¹æ¥rediså’Œmysql åˆ†ç‰‡ä¸Šä¼ çš„çŠ¶æ€, æ–‡ä»¶ä¸Šä¼ çš„çŠ¶æ€, æ–‡ä»¶çš„åœ°å€ç­‰ä¿¡æ¯, å­˜å‚¨åœ¨æ•°æ®åº“ä¸­, æˆ–redisç¼“å­˜, è§†æƒ…å†µè€Œå®š\n2. å¯¹æ¥é˜¿é‡Œäº‘/å¤©ç¿¼äº‘ç­‰äº‘å¯¹è±¡å­˜å‚¨æœåŠ¡ ä¸€èˆ¬åœ¨é¡¹ç›®ä¸­éƒ½æ˜¯ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹çš„å¯¹è±¡å‚¬å‡ºæœåŠ¡, éœ€è¦å¯¹æ¥ä¸€ä¸‹, ä¸€èˆ¬ä¹Ÿéƒ½æœ‰åˆ†ç‰‡ä¸Šä¼ çš„api\n3. æ–­ç‚¹ç»­ä¼  å½“æˆ‘ä»¬æŠŠåˆ†ç‰‡ä¿¡æ¯å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ—¶å€™, ä¹‹åå°±å¯ä»¥é€šè¿‡md5 key(æˆ–è‡ªå®šä¹‰å”¯ä¸€key, ä½†å‰åç«¯éœ€è¦æ²Ÿé€šç»Ÿä¸€), æ¥è·å–ä¹‹å‰çš„åˆ†ç‰‡ä¸Šä¼ çŠ¶æ€\n4. æ ¡éªŒmd5 åŸºäºåç«¯ä¸å®Œå…¨ä¿¡ä»»å®¢æˆ·ç«¯çš„æ€æƒ³, åç«¯éœ€è¦ç®—å‡ºåˆ†ç‰‡æˆ–å¤§æ–‡ä»¶ç‰¹å¾(å‰åç«¯æ²Ÿé€šç»Ÿä¸€ç‰¹å¾çš„è§„åˆ™, egç¬¬ä¸€ä¸ªåˆ†ç‰‡+æœ€åä¸€ä¸ªåˆ†ç‰‡)çš„md5, ä¸å‰ç«¯ä¼ çš„md5æ˜¯å¦ä¸€è‡´.. ç­‰ç­‰ä¹‹ç±»çš„æ ¡éªŒ, è§†æƒ…å†µè€Œå®š\n5. ç§’ä¼  éœ€è¦ä¸€ä¸ªæ–°çš„æ¥å£, åœ¨åˆ†ç‰‡ä¸Šä¼ ä¹‹å‰ä»æ•°æ®åº“è·å–æ•´ä¸ªå¤§æ–‡ä»¶ç‰¹å¾å¯¹åº”çš„md5 å¯¹åº”çš„æ–‡ä»¶ä¸Šä¼ çŠ¶æ€\nå®Œå…¨æ— ä¿¡æ¯\nå°±æ˜¯æ²¡æœ‰ä¸Šä¼ è¿‡, éœ€è¦åˆ†ç‰‡ä¸Šä¼ \nä¸€éƒ¨åˆ†ä¿¡æ¯\nä¸Šä¼ è¿‡ä¸€éƒ¨åˆ†, å¯åšæ–­ç‚¹ç»­ä¼ çš„å‰æ\næ•´ä¸ªå¤§æ–‡ä»¶å·²ä¸Šä¼ \nç§’ä¼ çš„å‰æåˆ¤æ–­\n6. å¹¶å‘é—®é¢˜ åˆ†ç‰‡ä¸Šä¼ ä¸€èˆ¬ä¸ºå¹¶å‘çŠ¶æ€, éœ€è¦å¤„ç†å¥½ä»£ç çš„å¹¶å‘é—®é¢˜\n7. åˆ†ç‰‡è§„åˆ™ åˆ†ç‰‡çš„å¤§å°è§„åˆ™æ˜¯å¦ç”±æœåŠ¡ç«¯æ¥æ§åˆ¶, è§†æƒ…å†µè€Œå®š\n8. å¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶ æ³¨æ„ç‚¹: æ–‡ä»¶éœ€è¦é¡ºåºåˆå¹¶, ä¸èƒ½ä¹±åº\næ€è·¯:\nå°†æ–‡ä»¶åºå·, å’Œæ–‡ä»¶æå–, æ”¾åœ¨Pairä¸­, å¹¶æ’åº\n1 2 3 List\u003cPair\u003cInteger, byte[]\u003e\u003e pairs = pathStream .map(p -\u003e Pair.of(Integer.parseInt(p.getFileName().toString().split(\"\\\\.\", 0)[0]), readByteByPath(p))) .toList(); åˆ©ç”¨streamçš„groupingByå’Œmapping, å¯¹åºå·æ•´é™¤5åˆ†ç»„, åˆ†æˆä¸€å †ä¸€å †çš„\n1 2 3 Map\u003cInteger, List\u003cbyte[]\u003e\u003e collect = pairs.stream() .sorted(Comparator.comparingInt(Pair::getKey)) .collect(Collectors.groupingBy(p -\u003e p.getKey() / 5, Collectors.mapping(Pair::getValue, Collectors.toList()))); ä½¿ç”¨å¤šçº¿ç¨‹, æ¯å †ä¸€ä¸ªçº¿ç¨‹, å°†æ¯ä¸€å †åˆå¹¶\næ–¹å¼ä¸€: å¹¶è¡Œæµ\n1 2 3 4 5 pairs = joinPool.submit(() -\u003e collect.entrySet().parallelStream() .map(entry -\u003e Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes))) .toList() ).get(); æ–¹å¼äºŒ: CompletableFuture+è‡ªå®šä¹‰çº¿ç¨‹æ± \n1 2 3 4 pairs = collect.entrySet().stream() .map(en -\u003e CompletableFuture.supplyAsync(() -\u003e mergeBytes(en), executorService)) .map(CompletableFuture::join) .collect(Collectors.toList()); åˆ¤æ–­åˆå¹¶ålistçš„å¤§å°, å¦‚æœè¿˜æœ‰å¾ˆå¤š, åˆ™ç»§ç»­ç¬¬äºŒæ­¥, å¦åˆ™å†™å…¥æ–‡ä»¶(ä¹Ÿå°±æ˜¯å·²ç»åˆå¹¶å®Œäº†, åªå‰©ä¸‹ä¸€ä¸ª)\n1 2 3 4 5 while (pairs.size() \u003e 1) {...} FileCopyUtils.copy(pairs.get(0).getValue(), new File(finalPath + md5 + \"/\" + dto.getFileName())); deleteDir(tmpPath + md5); æ–¹å¼ä¸€: ä½¿ç”¨æŒ‡å®šçº¿ç¨‹æ•°çš„å¹¶è¡Œæµ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 /** * åˆå¹¶æ–‡ä»¶ * * @param dto dto * @return {@link String} */ @PostMapping(\"/mergeFile\") public ResponseResult\u003c?\u003e mergeFile(@RequestBody MergeFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); createTmpPath(finalPath + md5); ForkJoinPool joinPool = new ForkJoinPool(5); try (Stream\u003cPath\u003e pathStream = Files.list(Paths.get(tmpPath + md5 + \"/\"));) { List\u003cPair\u003cInteger, byte[]\u003e\u003e pairs = pathStream .map(p -\u003e Pair.of(Integer.parseInt(p.getFileName().toString().split(\"\\\\.\", 0)[0]), readByteByPath(p))) .toList(); while (pairs.size() \u003e 1) { Map\u003cInteger, List\u003cbyte[]\u003e\u003e collect = pairs.stream() .sorted(Comparator.comparingInt(Pair::getKey)) .collect(Collectors.groupingBy(p -\u003e p.getKey() / 5, Collectors.mapping(Pair::getValue, Collectors.toList()))); pairs = joinPool.submit(() -\u003e collect.entrySet().parallelStream() .map(entry -\u003e Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes))) .toList() ).get(); } FileCopyUtils.copy(pairs.get(0).getValue(), new File(finalPath + md5 + \"/\" + dto.getFileName())); deleteDir(tmpPath + md5); } catch (Exception e) { e.printStackTrace(); } return ResponseResult.createBySuccess(); } æŒ‡å®šçº¿ç¨‹æ•°\n1 ForkJoinPool joinPool = new ForkJoinPool(5); æäº¤\n1 2 3 4 5 pairs = joinPool.submit(() -\u003e collect.entrySet().parallelStream() .map(entry -\u003e Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes))) .toList() ).get(); æ–¹å¼äºŒ: CompletableFuture+è‡ªå®šä¹‰çº¿ç¨‹æ±  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @PostMapping(\"/mergeFile\") public ResponseResult\u003c?\u003e mergeFile(@RequestBody MergeFileDTO dto) { String md5 = dto.getMd5().toLowerCase(); createTmpPath(finalPath + md5); ExecutorService executorService = Executors.newFixedThreadPool(5); try (Stream\u003cPath\u003e pathStream = Files.list(Paths.get(tmpPath + md5 + \"/\"));) { List\u003cPair\u003cInteger, byte[]\u003e\u003e pairs = pathStream .map(p -\u003e Pair.of(Integer.parseInt(p.getFileName().toString().split(\"\\\\.\", 0)[0]), readByteByPath(p))) .toList(); while (pairs.size() \u003e 1) { Map\u003cInteger, List\u003cbyte[]\u003e\u003e collect = pairs.stream() .sorted(Comparator.comparingInt(Pair::getKey)) .collect(Collectors.groupingBy(p -\u003e p.getKey() / 5, Collectors.mapping(Pair::getValue, Collectors.toList()))); pairs = collect.entrySet().stream() .map(en -\u003e CompletableFuture.supplyAsync(() -\u003e mergeBytes(en), executorService)) .map(CompletableFuture::join) .collect(Collectors.toList()); } FileCopyUtils.copy(pairs.get(0).getValue(), new File(finalPath + md5 + \"/\" + dto.getFileName())); deleteDir(tmpPath + md5); } catch (Exception e) { e.printStackTrace(); } return ResponseResult.createBySuccess(); } public Pair\u003cInteger, byte[]\u003e mergeBytes(Map.Entry\u003cInteger, List\u003cbyte[]\u003e\u003e entry) { return Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes)); } è‡ªå®šä¹‰çº¿ç¨‹æ± , æˆ–ä½¿ç”¨new Executor(â€¦â€¦);\n1 ExecutorService executorService = Executors.newFixedThreadPool(5); ä½¿ç”¨CompletableFuture\n1 2 3 4 pairs = collect.entrySet().stream() .map(en -\u003e CompletableFuture.supplyAsync(() -\u003e mergeBytes(en), executorService)) .map(CompletableFuture::join) .collect(Collectors.toList()); ä¼˜åŒ–ç‚¹ whileä¸­çš„æ¡ä»¶å¯ä»¥æ”¹å¤§ä¸€ç‚¹, ä¹Ÿå°±æ˜¯å®ç°åˆ†æƒ…å†µå¼€å¯å¤šçº¿ç¨‹, å½“æ–‡ä»¶æ•°è¶³å¤Ÿå¤šçš„æ—¶å€™å¼€å¯å¤šçº¿ç¨‹, å¦åˆ™ç›´æ¥ä¸»çº¿ç¨‹åˆå¹¶, è¿™æ ·å¯ä»¥é¿å…çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€, è§†æƒ…å†µè€Œå®š.\n",
  "wordCount" : "2055",
  "inLanguage": "zh",
  "datePublished": "2022-12-01T15:36:53+08:00",
  "dateModified": "2022-11-29T15:36:53+08:00",
  "author":[{
    "@type": "Person",
    "name": "å¶ç°ç°"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://habyss.github.io/posts/tech/big_file_upload/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "å¶ç°ç°çš„å°çª",
    "logo": {
      "@type": "ImageObject",
      "url": "https://habyss.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://habyss.github.io/" accesskey="h" title="å¶ç°ç°çš„å°çª (Alt + H)">å¶ç°ç°çš„å°çª</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://habyss.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/archives" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://habyss.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://habyss.github.io/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="https://habyss.github.io/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div>
    <h1 class="post-title">
      å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ 
    </h1>
    <div class="post-meta"><span title='2022-12-01 15:36:53 +0800 CST'>2022-12-01</span>&nbsp;Â·&nbsp;5 åˆ†é’Ÿ&nbsp;Â·&nbsp;å¶ç°ç°

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%ae%80%e5%8d%95demo%e5%ae%9e%e7%8e%b0" aria-label="ç®€å•demoå®ç°">ç®€å•demoå®ç°</a></li>
                <li>
                    <a href="#demo%e7%94%a8%e4%bd%9c%e7%94%9f%e4%ba%a7%e6%97%b6%e9%9c%80%e8%a6%81%e4%bc%98%e5%8c%96%e7%9a%84%e7%82%b9" aria-label="demoç”¨ä½œç”Ÿäº§æ—¶éœ€è¦ä¼˜åŒ–çš„ç‚¹">demoç”¨ä½œç”Ÿäº§æ—¶éœ€è¦ä¼˜åŒ–çš„ç‚¹</a><ul>
                        
                <li>
                    <a href="#1-%e5%af%b9%e6%8e%a5redis%e5%92%8cmysql" aria-label="1. å¯¹æ¥rediså’Œmysql">1. å¯¹æ¥rediså’Œmysql</a></li>
                <li>
                    <a href="#2-%e5%af%b9%e6%8e%a5%e9%98%bf%e9%87%8c%e4%ba%91%e5%a4%a9%e7%bf%bc%e4%ba%91%e7%ad%89%e4%ba%91%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e6%9c%8d%e5%8a%a1" aria-label="2. å¯¹æ¥é˜¿é‡Œäº‘/å¤©ç¿¼äº‘ç­‰äº‘å¯¹è±¡å­˜å‚¨æœåŠ¡">2. å¯¹æ¥é˜¿é‡Œäº‘/å¤©ç¿¼äº‘ç­‰äº‘å¯¹è±¡å­˜å‚¨æœåŠ¡</a></li>
                <li>
                    <a href="#3-%e6%96%ad%e7%82%b9%e7%bb%ad%e4%bc%a0" aria-label="3. æ–­ç‚¹ç»­ä¼ ">3. æ–­ç‚¹ç»­ä¼ </a></li>
                <li>
                    <a href="#4-%e6%a0%a1%e9%aa%8cmd5" aria-label="4. æ ¡éªŒmd5">4. æ ¡éªŒmd5</a></li>
                <li>
                    <a href="#5-%e7%a7%92%e4%bc%a0" aria-label="5. ç§’ä¼ ">5. ç§’ä¼ </a></li>
                <li>
                    <a href="#6-%e5%b9%b6%e5%8f%91%e9%97%ae%e9%a2%98" aria-label="6. å¹¶å‘é—®é¢˜">6. å¹¶å‘é—®é¢˜</a></li>
                <li>
                    <a href="#7-%e5%88%86%e7%89%87%e8%a7%84%e5%88%99" aria-label="7. åˆ†ç‰‡è§„åˆ™">7. åˆ†ç‰‡è§„åˆ™</a></li>
                <li>
                    <a href="#8-%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%90%88%e5%b9%b6%e6%96%87%e4%bb%b6" aria-label="8. å¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶">8. <strong>å¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶</strong></a><ul>
                        
                <li>
                    <a href="#%e6%96%b9%e5%bc%8f%e4%b8%80-%e4%bd%bf%e7%94%a8%e6%8c%87%e5%ae%9a%e7%ba%bf%e7%a8%8b%e6%95%b0%e7%9a%84%e5%b9%b6%e8%a1%8c%e6%b5%81" aria-label="æ–¹å¼ä¸€: ä½¿ç”¨æŒ‡å®šçº¿ç¨‹æ•°çš„å¹¶è¡Œæµ">æ–¹å¼ä¸€: ä½¿ç”¨æŒ‡å®šçº¿ç¨‹æ•°çš„å¹¶è¡Œæµ</a></li>
                <li>
                    <a href="#%e6%96%b9%e5%bc%8f%e4%ba%8c-completablefuture%e8%87%aa%e5%ae%9a%e4%b9%89%e7%ba%bf%e7%a8%8b%e6%b1%a0" aria-label="æ–¹å¼äºŒ: CompletableFuture&#43;è‡ªå®šä¹‰çº¿ç¨‹æ± ">æ–¹å¼äºŒ: CompletableFuture+è‡ªå®šä¹‰çº¿ç¨‹æ± </a></li>
                <li>
                    <a href="#%e4%bc%98%e5%8c%96%e7%82%b9" aria-label="ä¼˜åŒ–ç‚¹">ä¼˜åŒ–ç‚¹</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="ç®€å•demoå®ç°">ç®€å•demoå®ç°<a hidden class="anchor" aria-hidden="true" href="#ç®€å•demoå®ç°">#</a></h2>
<blockquote>
<p>ç®€å•å®ç°, ä»¥å¤§æ–‡ä»¶çš„md5ä½œä¸ºå”¯ä¸€key</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Api</span><span class="o">(</span><span class="n">tags</span> <span class="o">=</span> <span class="s">&#34;å¤§æ–‡ä»¶ä¸Šä¼ &#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;dict&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BigFileController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">tmpPath</span> <span class="o">=</span> <span class="s">&#34;E:/data/tempAppfiles/&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">finalPath</span> <span class="o">=</span> <span class="s">&#34;E:/data/finalAppfiles/&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">chunkMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ä¸Šä¼ æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param dto dto
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return {@link String}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;/uploadFile&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ResponseResult</span><span class="o">&lt;?&gt;</span> <span class="n">uploadFile</span><span class="o">(</span><span class="n">UploadFileDTO</span> <span class="n">dto</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">dto</span><span class="o">.</span><span class="na">getMd5</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">tmpFileName</span> <span class="o">=</span> <span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getIndex</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;.tmp&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ†ç‰‡ç§’ä¼ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">chunkMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tmpFileName</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">ResponseResult</span><span class="o">.</span><span class="na">createBySuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">createTmpPath</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">dto</span><span class="o">.</span><span class="na">getFile</span><span class="o">().</span><span class="na">getBytes</span><span class="o">(),</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">tmpFileName</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;æ–‡ä»¶ä¸Šä¼ å¤±è´¥&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunkMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tmpFileName</span><span class="o">,</span> <span class="n">dto</span><span class="o">.</span><span class="na">getIndex</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ResponseResult</span><span class="o">.</span><span class="na">createBySuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * åˆå¹¶æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param dto dto
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return {@link String}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;/mergeFile&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ResponseResult</span><span class="o">&lt;?&gt;</span> <span class="n">mergeFile</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">MergeFileDTO</span> <span class="n">dto</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">dto</span><span class="o">.</span><span class="na">getMd5</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">createTmpPath</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">pathStream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span><span class="o">));)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">byte</span><span class="o">[]</span> <span class="n">reduce</span> <span class="o">=</span> <span class="n">pathStream</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">sorted</span><span class="o">((</span><span class="n">s1</span><span class="o">,</span> <span class="n">s2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">int</span> <span class="n">n1</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">s1</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">int</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">n1</span><span class="o">,</span> <span class="n">n2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">})</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">readByteByPath</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">Objects</span><span class="o">::</span><span class="n">nonNull</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{},</span> <span class="k">this</span><span class="o">::</span><span class="n">addBytes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">DigestUtils</span><span class="o">.</span><span class="na">md5DigestAsHex</span><span class="o">(</span><span class="n">reduce</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">reduce</span><span class="o">,</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getFileName</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">deleteDir</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ResponseResult</span><span class="o">.</span><span class="na">createBySuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * åˆ é™¤åˆ†ç‰‡
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">deleteDir</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Path</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">pathStream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">dir</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">pathStream</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// åˆ é™¤åˆ†ç‰‡ç¼“å­˜ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">chunkMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">});</span>
</span></span><span class="line"><span class="cl">            <span class="n">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">dir</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è¯»æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">readByteByPath</span><span class="o">(</span><span class="n">Path</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">     <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * åˆå¹¶æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">addBytes</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data1</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">data2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data3</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">data1</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">data2</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">data1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data3</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data1</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">data2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data3</span><span class="o">,</span> <span class="n">data1</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">data2</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">data3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * åˆ›å»ºæ–‡ä»¶å¤¹
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createTmpPath</span><span class="o">(</span><span class="n">String</span> <span class="n">pathString</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">pathString</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¹¶å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">Files</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">path</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">Files</span><span class="o">.</span><span class="na">notExists</span><span class="o">(</span><span class="n">path</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Files</span><span class="o">.</span><span class="na">createDirectory</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">ServiceException</span><span class="o">(</span><span class="s">&#34;åˆ›å»ºå¤±è´¥&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Data</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UploadFileDTO</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@ApiModelProperty</span><span class="o">(</span><span class="s">&#34;æ–‡ä»¶MD5&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">md5</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@ApiModelProperty</span><span class="o">(</span><span class="s">&#34;åˆ†ç‰‡æ–‡ä»¶åºå·&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Integer</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@ApiModelProperty</span><span class="o">(</span><span class="s">&#34;åˆ†ç‰‡æ–‡ä»¶&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">MultipartFile</span> <span class="n">file</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Data</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MergeFileDTO</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@ApiModelProperty</span><span class="o">(</span><span class="s">&#34;æ–‡ä»¶MD5&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">md5</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@ApiModelProperty</span><span class="o">(</span><span class="s">&#34;åŸæ–‡ä»¶å å¸¦åç¼€&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">fileName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="demoç”¨ä½œç”Ÿäº§æ—¶éœ€è¦ä¼˜åŒ–çš„ç‚¹">demoç”¨ä½œç”Ÿäº§æ—¶éœ€è¦ä¼˜åŒ–çš„ç‚¹<a hidden class="anchor" aria-hidden="true" href="#demoç”¨ä½œç”Ÿäº§æ—¶éœ€è¦ä¼˜åŒ–çš„ç‚¹">#</a></h2>
<h3 id="1-å¯¹æ¥rediså’Œmysql">1. å¯¹æ¥rediså’Œmysql<a hidden class="anchor" aria-hidden="true" href="#1-å¯¹æ¥rediså’Œmysql">#</a></h3>
<p>åˆ†ç‰‡ä¸Šä¼ çš„çŠ¶æ€, æ–‡ä»¶ä¸Šä¼ çš„çŠ¶æ€, æ–‡ä»¶çš„åœ°å€ç­‰ä¿¡æ¯, å­˜å‚¨åœ¨æ•°æ®åº“ä¸­, æˆ–redisç¼“å­˜, è§†æƒ…å†µè€Œå®š</p>
<h3 id="2-å¯¹æ¥é˜¿é‡Œäº‘å¤©ç¿¼äº‘ç­‰äº‘å¯¹è±¡å­˜å‚¨æœåŠ¡">2. å¯¹æ¥é˜¿é‡Œäº‘/å¤©ç¿¼äº‘ç­‰äº‘å¯¹è±¡å­˜å‚¨æœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#2-å¯¹æ¥é˜¿é‡Œäº‘å¤©ç¿¼äº‘ç­‰äº‘å¯¹è±¡å­˜å‚¨æœåŠ¡">#</a></h3>
<p>ä¸€èˆ¬åœ¨é¡¹ç›®ä¸­éƒ½æ˜¯ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹çš„å¯¹è±¡å‚¬å‡ºæœåŠ¡, éœ€è¦å¯¹æ¥ä¸€ä¸‹, ä¸€èˆ¬ä¹Ÿéƒ½æœ‰åˆ†ç‰‡ä¸Šä¼ çš„api</p>
<h3 id="3-æ–­ç‚¹ç»­ä¼ ">3. æ–­ç‚¹ç»­ä¼ <a hidden class="anchor" aria-hidden="true" href="#3-æ–­ç‚¹ç»­ä¼ ">#</a></h3>
<p>å½“æˆ‘ä»¬æŠŠåˆ†ç‰‡ä¿¡æ¯å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ—¶å€™, ä¹‹åå°±å¯ä»¥é€šè¿‡md5 key(æˆ–è‡ªå®šä¹‰å”¯ä¸€key, ä½†å‰åç«¯éœ€è¦æ²Ÿé€šç»Ÿä¸€), æ¥è·å–ä¹‹å‰çš„åˆ†ç‰‡ä¸Šä¼ çŠ¶æ€</p>
<h3 id="4-æ ¡éªŒmd5">4. æ ¡éªŒmd5<a hidden class="anchor" aria-hidden="true" href="#4-æ ¡éªŒmd5">#</a></h3>
<p>åŸºäºåç«¯ä¸å®Œå…¨ä¿¡ä»»å®¢æˆ·ç«¯çš„æ€æƒ³, åç«¯éœ€è¦ç®—å‡ºåˆ†ç‰‡æˆ–<strong>å¤§æ–‡ä»¶ç‰¹å¾</strong>(å‰åç«¯æ²Ÿé€šç»Ÿä¸€ç‰¹å¾çš„è§„åˆ™, egç¬¬ä¸€ä¸ªåˆ†ç‰‡+æœ€åä¸€ä¸ªåˆ†ç‰‡)çš„md5, ä¸å‰ç«¯ä¼ çš„md5æ˜¯å¦ä¸€è‡´.. ç­‰ç­‰ä¹‹ç±»çš„æ ¡éªŒ, è§†æƒ…å†µè€Œå®š</p>
<h3 id="5-ç§’ä¼ ">5. ç§’ä¼ <a hidden class="anchor" aria-hidden="true" href="#5-ç§’ä¼ ">#</a></h3>
<p>éœ€è¦ä¸€ä¸ªæ–°çš„æ¥å£, åœ¨åˆ†ç‰‡ä¸Šä¼ ä¹‹å‰ä»æ•°æ®åº“è·å–æ•´ä¸ªå¤§æ–‡ä»¶ç‰¹å¾å¯¹åº”çš„md5 å¯¹åº”çš„æ–‡ä»¶ä¸Šä¼ çŠ¶æ€</p>
<ol>
<li>
<p><strong>å®Œå…¨æ— ä¿¡æ¯</strong></p>
<p>å°±æ˜¯æ²¡æœ‰ä¸Šä¼ è¿‡, éœ€è¦<strong>åˆ†ç‰‡ä¸Šä¼ </strong></p>
</li>
<li>
<p><strong>ä¸€éƒ¨åˆ†ä¿¡æ¯</strong></p>
<p>ä¸Šä¼ è¿‡ä¸€éƒ¨åˆ†, å¯åš<strong>æ–­ç‚¹ç»­ä¼ çš„å‰æ</strong></p>
</li>
<li>
<p><strong>æ•´ä¸ªå¤§æ–‡ä»¶å·²ä¸Šä¼ </strong></p>
<p><strong>ç§’ä¼ çš„å‰æ</strong>åˆ¤æ–­</p>
</li>
</ol>
<h3 id="6-å¹¶å‘é—®é¢˜">6. å¹¶å‘é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#6-å¹¶å‘é—®é¢˜">#</a></h3>
<p>åˆ†ç‰‡ä¸Šä¼ ä¸€èˆ¬ä¸ºå¹¶å‘çŠ¶æ€, éœ€è¦å¤„ç†å¥½ä»£ç çš„å¹¶å‘é—®é¢˜</p>
<h3 id="7-åˆ†ç‰‡è§„åˆ™">7. åˆ†ç‰‡è§„åˆ™<a hidden class="anchor" aria-hidden="true" href="#7-åˆ†ç‰‡è§„åˆ™">#</a></h3>
<p>åˆ†ç‰‡çš„å¤§å°è§„åˆ™æ˜¯å¦ç”±æœåŠ¡ç«¯æ¥æ§åˆ¶, è§†æƒ…å†µè€Œå®š</p>
<h3 id="8-å¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶">8. <strong>å¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶</strong><a hidden class="anchor" aria-hidden="true" href="#8-å¤šçº¿ç¨‹åˆå¹¶æ–‡ä»¶">#</a></h3>
<p>æ³¨æ„ç‚¹:  æ–‡ä»¶éœ€è¦é¡ºåºåˆå¹¶, ä¸èƒ½ä¹±åº</p>
<p>æ€è·¯:</p>
<ol>
<li>
<p>å°†æ–‡ä»¶åºå·, å’Œæ–‡ä»¶æå–, æ”¾åœ¨Pairä¸­, å¹¶æ’åº</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">            <span class="n">List</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">pathStream</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">]),</span> <span class="n">readByteByPath</span><span class="o">(</span><span class="n">p</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>åˆ©ç”¨streamçš„groupingByå’Œmapping, å¯¹åºå·æ•´é™¤5åˆ†ç»„, åˆ†æˆä¸€å †ä¸€å †çš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">collect</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getKey</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="o">/</span> <span class="mi">5</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">mapping</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getValue</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())));</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ä½¿ç”¨å¤šçº¿ç¨‹, æ¯å †ä¸€ä¸ªçº¿ç¨‹, å°†æ¯ä¸€å †åˆå¹¶</p>
<p>æ–¹å¼ä¸€: å¹¶è¡Œæµ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">                pairs = joinPool.submit(() -&gt;
</span></span><span class="line"><span class="cl">                        collect.entrySet().parallelStream()
</span></span><span class="line"><span class="cl">                                .map(entry -&gt; Pair.of(entry.getKey(), entry.getValue().stream().reduce(new byte[]{}, this::addBytes)))
</span></span><span class="line"><span class="cl">                                .toList()
</span></span><span class="line"><span class="cl">                ).get();
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ–¹å¼äºŒ: CompletableFuture+è‡ªå®šä¹‰çº¿ç¨‹æ± </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">                <span class="n">pairs</span> <span class="o">=</span> <span class="n">collect</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">en</span> <span class="o">-&gt;</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">mergeBytes</span><span class="o">(</span><span class="n">en</span><span class="o">),</span> <span class="n">executorService</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">::</span><span class="n">join</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>åˆ¤æ–­åˆå¹¶ålistçš„å¤§å°, å¦‚æœè¿˜æœ‰å¾ˆå¤š, åˆ™ç»§ç»­ç¬¬äºŒæ­¥, å¦åˆ™å†™å…¥æ–‡ä»¶(ä¹Ÿå°±æ˜¯å·²ç»åˆå¹¶å®Œäº†, åªå‰©ä¸‹ä¸€ä¸ª)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">while</span> <span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{...}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getValue</span><span class="o">(),</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getFileName</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">deleteDir</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h4 id="æ–¹å¼ä¸€-ä½¿ç”¨æŒ‡å®šçº¿ç¨‹æ•°çš„å¹¶è¡Œæµ">æ–¹å¼ä¸€: ä½¿ç”¨æŒ‡å®šçº¿ç¨‹æ•°çš„å¹¶è¡Œæµ<a hidden class="anchor" aria-hidden="true" href="#æ–¹å¼ä¸€-ä½¿ç”¨æŒ‡å®šçº¿ç¨‹æ•°çš„å¹¶è¡Œæµ">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * åˆå¹¶æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param dto dto
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return {@link String}
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;/mergeFile&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ResponseResult</span><span class="o">&lt;?&gt;</span> <span class="n">mergeFile</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">MergeFileDTO</span> <span class="n">dto</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">dto</span><span class="o">.</span><span class="na">getMd5</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">createTmpPath</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ForkJoinPool</span> <span class="n">joinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">pathStream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span><span class="o">));)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">pathStream</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">]),</span> <span class="n">readByteByPath</span><span class="o">(</span><span class="n">p</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">collect</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getKey</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="o">/</span> <span class="mi">5</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">mapping</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getValue</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())));</span>
</span></span><span class="line"><span class="cl">                <span class="n">pairs</span> <span class="o">=</span> <span class="n">joinPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">collect</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">parallelStream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">entry</span> <span class="o">-&gt;</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">reduce</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{},</span> <span class="k">this</span><span class="o">::</span><span class="n">addBytes</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">toList</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">).</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getValue</span><span class="o">(),</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getFileName</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">deleteDir</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ResponseResult</span><span class="o">.</span><span class="na">createBySuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>æŒ‡å®šçº¿ç¨‹æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ForkJoinPool</span> <span class="n">joinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span> 
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>æäº¤</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">                <span class="n">pairs</span> <span class="o">=</span> <span class="n">joinPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">collect</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">parallelStream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">entry</span> <span class="o">-&gt;</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">reduce</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{},</span> <span class="k">this</span><span class="o">::</span><span class="n">addBytes</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                                <span class="o">.</span><span class="na">toList</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">).</span><span class="na">get</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="æ–¹å¼äºŒ-completablefutureè‡ªå®šä¹‰çº¿ç¨‹æ± ">æ–¹å¼äºŒ: CompletableFuture+è‡ªå®šä¹‰çº¿ç¨‹æ± <a hidden class="anchor" aria-hidden="true" href="#æ–¹å¼äºŒ-completablefutureè‡ªå®šä¹‰çº¿ç¨‹æ± ">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;/mergeFile&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ResponseResult</span><span class="o">&lt;?&gt;</span> <span class="n">mergeFile</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">MergeFileDTO</span> <span class="n">dto</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">dto</span><span class="o">.</span><span class="na">getMd5</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">createTmpPath</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">pathStream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span><span class="o">));)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">pathStream</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">getFileName</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;\\.&#34;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)[</span><span class="mi">0</span><span class="o">]),</span> <span class="n">readByteByPath</span><span class="o">(</span><span class="n">p</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">collect</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getKey</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="o">/</span> <span class="mi">5</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">mapping</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getValue</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())));</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">pairs</span> <span class="o">=</span> <span class="n">collect</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">en</span> <span class="o">-&gt;</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">mergeBytes</span><span class="o">(</span><span class="n">en</span><span class="o">),</span> <span class="n">executorService</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">::</span><span class="n">join</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">FileCopyUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">pairs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getValue</span><span class="o">(),</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">finalPath</span> <span class="o">+</span> <span class="n">md5</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getFileName</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">deleteDir</span><span class="o">(</span><span class="n">tmpPath</span> <span class="o">+</span> <span class="n">md5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ResponseResult</span><span class="o">.</span><span class="na">createBySuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="nf">mergeBytes</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">reduce</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{},</span> <span class="k">this</span><span class="o">::</span><span class="n">addBytes</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>è‡ªå®šä¹‰çº¿ç¨‹æ± , æˆ–ä½¿ç”¨new Executor(&hellip;&hellip;);</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ä½¿ç”¨CompletableFuture</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">                <span class="n">pairs</span> <span class="o">=</span> <span class="n">collect</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">en</span> <span class="o">-&gt;</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">mergeBytes</span><span class="o">(</span><span class="n">en</span><span class="o">),</span> <span class="n">executorService</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">::</span><span class="n">join</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="ä¼˜åŒ–ç‚¹">ä¼˜åŒ–ç‚¹<a hidden class="anchor" aria-hidden="true" href="#ä¼˜åŒ–ç‚¹">#</a></h4>
<p>whileä¸­çš„æ¡ä»¶å¯ä»¥æ”¹å¤§ä¸€ç‚¹, ä¹Ÿå°±æ˜¯å®ç°åˆ†æƒ…å†µå¼€å¯å¤šçº¿ç¨‹, å½“æ–‡ä»¶æ•°è¶³å¤Ÿå¤šçš„æ—¶å€™å¼€å¯å¤šçº¿ç¨‹, å¦åˆ™ç›´æ¥ä¸»çº¿ç¨‹åˆå¹¶, è¿™æ ·å¯ä»¥é¿å…çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€, è§†æƒ…å†µè€Œå®š.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://habyss.github.io/tags/%E5%88%86%E7%89%87/">åˆ†ç‰‡</a></li>
      <li><a href="https://habyss.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">å¤šçº¿ç¨‹</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://habyss.github.io/posts/tech/mybatis_plus_typehandler/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>åŸºäºmybatis-plus typeHandler åŠ è§£å¯†ç®€å•å®ç°</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://habyss.github.io/">å¶ç°ç°çš„å°çª</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
