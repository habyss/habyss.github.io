<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>MySQL补充 | 叶灰灰的小窝</title>
<meta name="keywords" content="">
<meta name="description" content="MySQL 地基基础：事务和锁的面纱 什么是事务，为什么需要事务 在 MySQL 中，事务是由一条或多条 SQL 组成的单位，在这个单位中所有的 SQL 共存亡，有点有福同享，有难同">
<meta name="author" content="叶灰灰">
<link rel="canonical" href="https://habyss.github.io/posts/read/mysql%E5%9C%B0%E5%9F%BA_%E4%BC%98%E5%8C%96/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="apple-touch-icon" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="mask-icon" href="https://habyss.github.io/gif/hwlm.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="MySQL补充" />
<meta property="og:description" content="MySQL 地基基础：事务和锁的面纱 什么是事务，为什么需要事务 在 MySQL 中，事务是由一条或多条 SQL 组成的单位，在这个单位中所有的 SQL 共存亡，有点有福同享，有难同" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://habyss.github.io/posts/read/mysql%E5%9C%B0%E5%9F%BA_%E4%BC%98%E5%8C%96/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-23T15:36:53+08:00" />
<meta property="article:modified_time" content="2022-11-29T15:36:53+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MySQL补充"/>
<meta name="twitter:description" content="MySQL 地基基础：事务和锁的面纱 什么是事务，为什么需要事务 在 MySQL 中，事务是由一条或多条 SQL 组成的单位，在这个单位中所有的 SQL 共存亡，有点有福同享，有难同"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://habyss.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "📕阅读",
      "item": "https://habyss.github.io/posts/read/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "MySQL补充",
      "item": "https://habyss.github.io/posts/read/mysql%E5%9C%B0%E5%9F%BA_%E4%BC%98%E5%8C%96/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MySQL补充",
  "name": "MySQL补充",
  "description": "MySQL 地基基础：事务和锁的面纱 什么是事务，为什么需要事务 在 MySQL 中，事务是由一条或多条 SQL 组成的单位，在这个单位中所有的 SQL 共存亡，有点有福同享，有难同",
  "keywords": [
    
  ],
  "articleBody": "MySQL 地基基础：事务和锁的面纱 什么是事务，为什么需要事务 在 MySQL 中，事务是由一条或多条 SQL 组成的单位，在这个单位中所有的 SQL 共存亡，有点有福同享，有难同当的意思。要么全部成功，事务顺利完成；要么只要有一个 SQL 失败就会导致整个事务失败，所有已经做过的操作回退到原始数据状态。\n用日常细说事务的特性 首先我们先说一下事务的四个特性：ACID。\nA：原子性（atomicity），一个事务要么全都成功，要么全都失败 C：一致性（consistency），在事务的整个生命周期里，查询的数据是一致的，保证数据库不会返回未提交的事务的数据 I：隔离性（isolation），一个事务所做的操作，在最终提交前，对其他事务是不可见的，保证事务与事务之间不会冲突 D：持久性（durability），只要事务提交，数据就不会丢失，即使系统崩溃，事务也已经完成 在日常生活中有很多的事情就能体现为数据库中的事务。比如“转账”，下面我们就具体展开，你就可以很清晰的认识事务的四个特性。\n时间：2020 年 1 月 1 日 地点：某银行 ATM 人物：A 和 B 起因：B 向 A 借 1000 元人民币 经过：A 转账给 B 结果：转账成功或失败 这么一个转账我们想一下底层基本的技术支撑与实现，B 向 A 借钱，A 要转账给 B，首先 A 必须有大于 1000 元的余额，然后从 A 的账户减 1000 元，在 B 的账户里加 1000 元。\n我们定义一个事务：\n1 2 3 4 5 6 7 8 获取 A 账户余额 select balance from account where username='A'; 在 A 账户里减 1000 元 update account set balance=balance-1000 where username='A'; 获取 B 账户余额 select balance from account where username='B'; 在 B 账户里加 1000 元 update account set balance=balance+1000 where username='B'; 好了，一个简单事务基本就这样，我们开始分析分析这个事务是如何保证事务的 ACID 的。\n原子性：这个事务要么全成功，要么全失败。事务成功则 1000 元转账到了 B 账户，事务失败回滚则 1000 元还在 A 账户里，就是说 1000 元不能凭空消失。 一致性：在这个事务中，所有的查询都是一致的，我们先查询 A 账户余额是否大于 1000，如果小于 1000，事务失败回滚；如果获取不到 B 账户余额，事务失败回滚。 隔离性：在这个事务发生的同时，发生了另一个事务（A 通过手机银行将钱全部转移到另外的账户，比如一共有 1500 元），第一个事务转 1000 元，第二个事务转 1500 元，我们仔细想想，如果都成功，那岂不是凭空获取了 1000 元，这是不合理的，每个事务在执行前都应查一下余额是否够本次转账的。这两个事务应该是隔离的，不能有冲突。 持久性：转账成功了（即事务完成），这代表钱已经发生了转移，这个时候发生 ATM 吞卡、ATM 断电、手机银行无法登陆等等一切故障，反正钱已经转走了，钱没有丢（即数据没有丢） MySQL 并发控制技术 并发控制技术可以说是数据库的底层基础技术，并发控制技术可以拆分来看，一是并发，一是控制。并发也就是说大量请求连接到数据库，控制就是数据库要控制好这些连接，保证资源的可用性、安全性，解决资源的挣用的问题。\n那么如何实现并控制呢？主要通过两个方面：\nLock MVCC 先分别简单说一下 Lock 和 MVCC，具体的后面再聊。\nLock，并发连接到数据库，操作有读和读、读和写、写和写，锁来保证并发连接使得数据可以保持一致性。 MVCC（Multiversion Concurrency Control），多版本并发控制，是数据库的多版本，可以提高并发过程中的读和写操作，有效的避免写请求阻塞读请求。 面试再也不怕被问到的 MVCC 前面我们已经大致了解了 MVCC 是什么，以及他做什么事情，现在我们具体看看 MVCC 是如何工作的？\n我们知道数据的一致性，可以通过锁来保证，在并发连接中，锁机制在读和读的并发请求中不会锁数据，但是在读和写的并发请求中，写请求会加锁，读请求会被写请求阻塞，基于此，MVCC 发挥其作用。\nMVCC 控制两类操作：\n快照读：读取的是历史可见版本的数据，无锁 当前读：读取的是当前最新版本的数据，加锁 我们举个例子说一下吧，比如:\n1 2 mysql\u003e create table tab1(id decimal,name varchar(10),address varchar(10),status decimal,primary key(id)); mysql\u003e insert into tab1 values(1,'a','beijing',1); 表中数据为：\nid name address status 1 a beijing 1 现在有一个请求，将数据 a 的地址改为 shanghai，这个数据更新的过程，我们细化一下，将历史数据置为失效，将新的数据插入：\n1 2 mysql\u003e update tab1 set status=0 where name='a'; mysql\u003e insert into tab1 value(2,'a','shanghai',1); 表中数据为：\nid name address status 1 a beijing 0 2 a shanghai 1 MVCC 的原理就类似是这样的，address='beijing' 就是历史数据，更新前保存了下来，address='shanghai' 就是当前数据，新插入数据，这样并发连接来了，既可以读取历史数据，也可以修改当前数据。比如，现在有三个事务：\nT1 -\u003e 要执行 update address T2 -\u003e 要执行 update address T3 -\u003e 要执行 update address T1 先获取了表中这一行数据，执行了 update，未提交；T2 获取表中这一行数据，由于 T1 未提交，address=‘beijing’,这个 beijing 就来源历史数据；T3 也获取表中这一行数据，由于 T1 未提交，address='beijing'，这个 beijing 也来源历史数据。这样是不是好理解了。\n以此类推，如果只对 name='a' 这一行数据有 N 个并发连接要做 M 个操作，这些历史数据都保存在表中，这个表的数据量无法预估，势必会造成压力与瓶颈。多版本数据到底如何保存，这就不是本节考虑的问题了，是数据库 undo 帮你做的工作。这里就不展开了。（后期可能会做 undo 相关的 chat，大家可以关注我）\n简单易懂的实例帮你理解 MySQL 事务隔离级别 事务隔离级别，拆分来看，事务、隔离、级别，故是三个概念的集合，是保证事务之间相互隔离互不影响的，有多个级别。事务在执行过程中可能会出现脏读、不可重复读、幻读，那么 MySQL 的事务隔离级别到底有怎样的表现呢？\n事务隔离级别 脏读 不可重复读 幻读 读未提交(Read-Uncommited) 可能 可能 可能 读提交(Read-Commited) 不可能 可能 可能 可重复读交(Repeatable-Read) 不可能 不可能 可能 序列化(Serializable) 不可能 不可能 不可能 那么到底什么是脏读、不可重复读、幻读呢？\n脏读：一个事务读取了另一个未提交事务操作的数据。 不可重复读：一个事务重新读取前面读取过的数据时，发现该数据已经被修改了或者不见了，其实已被另一个已提交的事务操作了。解决了脏读的问题。 幻读：一个事务，需要更新数据，于是重新提交了一个查询，返回符合查询条件行，发现这些行因为其他提交的事务发生了改变，这些数据像“幻影”一样出现了。解决了不可重复读。 接下来我们用具体实例分析各个事务隔离级别。\n创建测试表 t_account：\n1 2 3 mysql\u003e create table t_account(name varchar(10),balance decimal); mysql\u003e insert into t_account values('A',100); mysql\u003e insert into t_account values('B',0); 读未提交 设置事务隔离级别：\n1 mysql\u003e set global tx_isolation='read-uncommitted'; 查询事务隔离级别：\n1 2 3 4 5 6 7 mysql\u003e SELECT @@tx_isolation; +------------------+ | @@tx_isolation | +------------------+ | READ-UNCOMMITTED | +------------------+ 1 row in set (0.00 sec) 当前事务可以读取另一个未提交事务操作的数据。\n环境：用户 A 有 100 元钱，给用户 A 增加 100 元，然后用户 A 转账给用户 B。\n事务 1 事务 2 begin; begin; update t_account set balance=balance+100 where name=‘A’; #给用户 A 增加 100 元 select balance from t_account where name=‘A’; #转账前查询用户 A 余额为 200 元 rollback; #决定不给用户 A 增加 100 元了，事务回滚 update t_account set balance=balance-200 where name=‘A’; #用户 A 继续给用户 B 转账，用户 A 减 200 元 update t_account set balance=balance+200 where name=‘B’; #用户 A 继续给用户 B 转账，用户加加 200 元 commit; #提交事务 现在我们查询一下用户 A 和用户 B 的余额：\n1 2 3 4 5 6 7 8 mysql\u003e select * from t_account; +------+---------+ | name | balance | +------+---------+ | A | -100 | | B | 200 | +------+---------+ 2 rows in set (0.00 sec) 问题来了，这个结果不符合预期，用户 A 竟然是 -100 元，用户 B 增加了 200 元，这是因为事务 2 读取了事务 1 未提交的数据。\n读提交 设置事务隔离级别：\n1 mysql\u003e set global tx_isolation='read-committed'; 查询事务隔离级别：\n1 2 3 4 5 6 7 mysql\u003e SELECT @@tx_isolation; +------------------+ | @@tx_isolation | +------------------+ | READ-COMMITTED | +------------------+ 1 row in set (0.00 sec) 当前事务只能读取另一个提交事务操作的数据。\n环境：用户 A 有 100 元钱，给用户 A 增加 100 元。\n事务 1 事务 2 begin; begin; update t_account set balance=balance+100 where name=‘A’; #给用 A 增加 100 元 select * from t_account where name=‘A’; #事务 2 查用户的余额，因事务 1 未提交，仍为 100 元 commit; select * from t_account where name=‘A’; #事务 2 查用户的余额，事务 1 已提交，变为 200 元 一个事务重新读取前面读取过的数据时，发现该数据已经被修改了，其实已被另一个已提交的事务操作了。\n可重复读 设置事务隔离级别：\n1 mysql\u003e set global tx_isolation='repeatable-read'; 查询事务隔离级别：\n1 2 3 4 5 6 7 mysql\u003e SELECT @@tx_isolation; +------------------+ | @@tx_isolation | +------------------+ | REPEATABLE-READ | +------------------+ 1 row in set (0.00 sec) 当前事务读取通过第一次读取建立的快照是一致的，即使另外一个事务提交了该数据。除非自己这个事务可以读取在自身事务中修改的数据。\n可重复读隔离级别是 MySQL 的默认隔离级别。\n环境：用户 A 有 100 元钱，给用户 A 增加 100 元。\n事务 1 事务 2 begin; begin; select * from t_account where name=‘A’; #事务 2 查用户的余额，为 100 元 update t_account set balance=balance+100 where name=‘A’; #给用 A 增加 100 元 select * from t_account where name=‘A’; #事务 2 查用户的余额，因事务 1 未提交，仍为 100 元 commit; select * from t_account where name=‘A’; #事务 2 查用户的余额，事务 1 已提交，仍为 100 元 这就能看出来，事务 2 开启后读取了用户 A 的余额，即使事务 1 修改了数据，不管提交与否，事务 2 读取的数据一直是之前第一次读取的数据。继续操作。\n事务 1 事务 2 commit; select * from t_account where name=‘A’; ###事务 2 查用户的余额，为 200 元 为什么现在变成了 200 元了，因为事务 2 已经 commit，再次 select 是一个新的事务，读取数据当然又变为第一次获取数据（此时的数据是最新的数据）。\n思考一下：上述这个举例是可重复读的 select 相关验证，如果是 DML 操作，会不会是同样的结果呢？\n思考三分钟……\n答案是：其他事物即使查询不到的数据，DML 操作也可能会影响那些提交的数据。好，让我验证一下。\nupdate 操作：\n事务 1 事务 2 begin; begin; select * from t_account; #有一行数据，用户 A，余额 100 元 insert into t_account values(‘B’,100); #增加用户 B，余额 100 元 commit; select * from t_account where name=‘B’; #无返回行，查询不到用户 B update t_account set balance=balance+100 where name=‘B’; #神奇，更新成功了 select * from t_account; #用户 A 余额 100，用户 B 余额 200 select * from t_account; #用户 A 余额 100，用户 B 余额 100 commit; select * from t_account; #用户 A 余额 100，用户 B 余额 200 delete 操作：\n事务 1 事务 2 begin; begin; select * from t_account; #有 2 行数据，用户 A 余额 100 元，用户 B 余额 200 insert into t_account values(‘C’,100); #增加用户 C，余额 100 元 commit; select * from t_account where name=‘C’; #无返回行，查询不到用户 C delete from t_account where name=‘C’; #神奇，删除成功了 select * from t_account; #用户 A 余额 100，用户 B 余额 200 select * from t_account; #用户 A 余额 100，用户 B 余额 200，用户 C 余额 100 commit; select * from t_account; #户 A 余额 100，用户 B 余额 200 通过这两个例子你是不是了解了一个事务的 update 和 delete 操作了另外一个事务提交的数据，会使得这些数据在当前事务变得可见。就像幻影一下出现了！\n序列化 设置事务隔离级别：\n1 mysql\u003e set global tx_isolation='serializable'; 查询事务隔离级别：\n1 2 3 4 5 6 7 mysql\u003e SELECT @@tx_isolation; +------------------+ | @@tx_isolation | +------------------+ | SERIALIZABLE | +------------------+ 1 row in set (0.00 sec) 当前事务 select 和 DML 操作的数据都会加行锁，其他事务访问同样的数据需要等锁释放。\n环境：用户 A 有 100 元钱，给用户 A 增加 100 元。\n事务 1 事务 2 begin; begin; select * from t_account where name=‘A’; #查询用户余额 update t_account set balance=balance+100 where name=‘A’; #给用户 A 增加 100 元，执行一直处于等待 commit; update 成功返回 select * from t_account where name=‘A’; #用户 A 余额为 100，因为事务 2 还未提交，获取的是 undo 中的历史版本数据 begin; select * from t_account where name=‘A’; #新开一个事务，由于事务 2 还未提交，此查询锁等 commit; select * from t_account where name=‘A’; #用户 A 余额 200 好了，实例讲解到此结束，是否已经帮你理解了 MySQL 事务隔离级别。\n另外，结合前面说的 MVCC，Read-Committed 和 Repeatable-Read，支持 MVCC；Read-Uncommitted 由于可以读取未提交的数据，不支持 MVCC；Serializable 会对所有读取的数据加行锁，不支持 MVCC。\nMySQL 锁机制（机智） 锁是可以协调并发连接访问 MySQL 数据库资源的一种技术，可以保证数据的一致性。锁有两个阶段：加锁和解锁，InnoDB 引擎的锁主要有两类。\n共享锁（S）\n允许一个事务读取数据，阻塞其他事务想要获取相同数据。共享锁之间不互斥，读和读操作可以并行。代码展示：\n1 select * from table where ... lock in share mode 排它锁（X）\n持有排他锁的事务可以更新数据，阻塞其他事务获取数据的排他锁和共享锁。排它锁之间互斥，读和写、写和写操作不可以并行。代码展示：\n1 select * from table where ... for update; 从 MySQL 数据库的内外区分锁，有两种锁。\n内部锁\nMySQL 在数据库内部自动管理，协调并发连接的资源争用。内部锁再具体来看分为：\n行锁：会话事务将访问的行数据加锁 表锁：会话事务将访问的表整体加锁 外部锁\n会话层使用特殊的手段显示获取锁，阻塞其他会话对数据的操作。我们通过外部操作命令实现外部锁，比如使用 lock table 和 unlock tables。\n我们举个例子来描述一下这个过程吧，比如有事务 1 和事务 2，事务 1 锁定了一行数据，加了一个 S 锁；事务 2 想要对整个表加锁，需要判断这个表是否被加了表锁，表中的每一行是否有行锁。仔细想想这个过程是很快呢？还是非常的慢？如果表很小无所谓了，如果表是海量级数据，那糟了，事务 2 势必耗费很多资源。\n如何解决事务 2 这种检索资源消耗的问题呢？事务意向锁帮你先获取意向，先一步问问情况，然后再获取我们想要的 S 和 X 锁，具体分为：\n意向共享锁（IS）\n事务 1 说：我要加一个行锁，我有这个意向，你们其他人有没有意见，如果没有我就先拿这个 IS 锁了。\n意向排它锁（IX）\n事务 2 说：我要加一个表锁，这个可是排他锁，我拿了你们就等我用完再说吧，我有这个意向，你们其他人有没有意见，如果没有我就先拿这个 IX 锁了。\n前面这个举例，其过程升级优化为：\n事务 1 先申请获取 IS 锁，成功后，获取 S 锁 事务 2 发现表中有 IS 锁了，事务 2 获取表锁会被阻塞 那么这四个锁之间兼容性如何呢？\nX S IX IS X 冲突 冲突 冲突 冲突 S 冲突 兼容 冲突 兼容 IX 冲突 冲突 兼容 兼容 IS 冲突 兼容 兼容 兼容 聊几个经典死锁案例 在实际应用中经常发生数据库死锁的情况，那么什么是死锁呢？说白了就是事务 1 锁事务 2，事务 2 锁事务 1，这两个事务都在等着对方释放锁资源，陷入了死循环。\n接下来我们介绍几个经典死锁案例，MySQL 默认级别使用的是 REPEATABLE-READ。\n场景 1：insert 死锁 创建一个测试表：\n1 mysql\u003e create table t_insert(id decimal,no decimal,primary key(id),unique key(no)); session1：\n1 2 mysql\u003e begin; mysql\u003e insert into t_insert values(1,101); session2：\n1 2 mysql\u003e begin; mysql\u003e insert into t_insert values(2,101); 此时会话一直等待无响应。\nsession1：\n1 mysql\u003e insert into t_insert values(3,100); 结果如下。\n此时 session2 立马报出来死锁：\n1 ERROR 1213 (40001): ==Deadlock== found when trying to get lock; try restarting transaction 数据库中 insert 作为最简单的 SQL，为什么会导致死锁呢？\nsession1 在插入(1,101) 的时候会加一个 X 锁；session2 插入(2,101)，no 字段有着唯一性，故 session2 在插入时数据库会做 duplicate 冲突检测，由于事务冲突先加 S 锁；然后 session1 又插入了 (3,100)，此时 session1 会加 insert intention X 锁（插入意向锁），之前 session1 已经有了 X 锁，故进入等待队列，结局就是 session1 和 session2 都在等待，陷入了僵局，MySQL 很机智，牺牲一方事务解决这个尴尬的局面，所以 session2 被干掉了，报错死锁。\n场景 2：自增列死锁 自增列死锁问题和场景 1 的类似，比如将场景 1 的主键属性改为自增长属性，主键自增仍唯一，场景模拟类似，加锁的过程也类似，产生死锁的过程也类似，这里就不详细模拟了。\n场景 3：rollback 死锁 创建一个测试表：\n1 mysql\u003e create table t_rollback(id decimal,no decimal,primary key(id),unique key(no)); session1：\n1 2 mysql\u003e begin; mysql\u003e insert into t_rollback values(1,100); session2：\n1 2 mysql\u003e begin; mysql\u003e insert into t_rollback values(2,100); 此时会话一直等待无响应。\nsession3\n1 2 mysql\u003e begin; mysql\u003e insert into t_rollback values(3,100); 此时会话一直等待无响应。\nsession1\n1 mysql\u003e rollback; 结果如下： 此时 session1 执行了 rollback 成功返回，session2 的 insert 返回成功，session3 立马报出来死锁。\n1 ERROR 1213 (40001): ==Deadlock== found when trying to get lock; try restarting transaction 为什么我回滚了事务，还要报死锁，难道我需要全部回滚吗？\nsession1 在插入 (1,100) 的时候会加一个 X 锁；session2 插入 (2,100)，no 字段有着唯一性，故 session2 在插入时数据库会做 duplicate 冲突检测，由于事务冲突先加 S 锁；session3 插入 (3,100)，no 字段有着唯一性，故 session3 在插入时数据库会做 duplicate 冲突检测，由于事务冲突先加 S 锁；session1 回滚，session2 申请 insert intention X 锁，等 session3;session3 申请 insert intention X 锁，等 session2，结局就是 session2 和 session3 都在等待，陷入了僵局，MySQL 很机智，牺牲一方事务解决这个尴尬的局面，所以 session3 被干掉了，报错死锁。\n场景 4：commit 死锁 创建一个测试表：\n1 2 mysql\u003e create table t_commit(id decimal,no decimal,primary key(id),unique key(no)); mysql\u003e insert into t_commit values(1,100); session1：\n1 2 mysql\u003e begin; mysql\u003e delete from t_commit where id=1; session2：\n1 2 mysql\u003e begin; mysql\u003e insert into t_commit values(1,100); 此时会话一直等待无响应。\nsession3：\n1 2 mysql\u003e begin; mysql\u003e insert into t_commit values(1,100); 此时会话一直等待无响应。\nsession1：\n1 mysql\u003e commit; 结果如下：此时 session1 执行了 commit 成功返回，session3 的 insert 返回成功，session2 立马报出来死锁。\n1 ERROR 1213 (40001): ==Deadlock== found when trying to get lock; try restarting transaction 为什么我提交了事务，还要报死锁，难道我需要全部提交吗？\n这个产生死锁的过程和场景 3rollback 死锁类似，大家可以和之前的 rollback 死锁产生过程对应来看。\n小技巧——事务保存点帮你读档重闯关 玩游戏你是不是有过存档、读档的经历，过某一个比较难的关卡，先存档，过不了，就读档重新过。数据库中我们也可以如此，MySQL 事务保存点可以回滚到事务的某时间点，并且不用中止事务。下面举例说明一下。\n用户 B 和用户 C 向用户 A 借钱，用户 A 转账给用户 B 和用户 C，转账的过程中发生了用户 C 账户不存在，那么我们也要把转给用户 B 的钱也取消吗？我们可以不取消，使用一个保存点即可。\n查询用户 A 有 1000 元：\n1 mysql\u003e select balance from t_account where name='A'; 转账 100 元给用户 B：\n1 2 mysql\u003e update t_account set balance=balance-100 where name='A'; mysql\u003e update t_account set balance=balance+100 where name='B'; 设置事务保存点\n1 mysql\u003e savepoint T_A_TO_B; 转账 200 元给用户 C：\n1 2 3 4 mysql\u003e update t_account set balance=balance-200 where name='A'; mysql\u003e update t_account set balance=balance+200 where name='C'; Query OK, 0 rows affected (0.00 sec) Rows matched: 0 Changed: 0 Warnings: 0 发现转账给 C 返回有 0 条受影响的行，转账给 C 未成功，此时用户 A 已经少了 200 元了，先退 200 元再排查吧，转账给用户 B 的不需要重新操作了。\n1 2 mysql\u003e rollback to T_A_TO_B; mysql\u003e commit； 根据提示 0 条受影响的行，也就是说用户 C 不存在呀，我们查询一下个用户信息：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 mysql\u003e select * from t_account where name='A'; +------+---------+ | name | balance | +------+---------+ | A | 900 | +------+---------+ 1 row in set (0.00 sec) mysql\u003e select * from t_account where name='B'; +------+---------+ | name | balance | +------+---------+ | B | 200 | +------+---------+ 1 row in set (0.00 sec) mysql\u003e select * from t_account where name='C'; Empty set (0.00 sec) 结果：用户 A 成功转 100 元给用户 B，用户 C 果然不存才，设置了保存点，帮我们省了很多工作，中途不用取消全部操作。\n小技巧——一个死锁的具体分析方法 前面我们学习了事务、锁，以及介绍了几个经典死锁案例，当遇到死锁，我们怎样具体分析呢？\n分析死锁，我们就需要看死锁的日志信息，通过日志具体找到死锁的原因及执行的语句。\n首先，我们用前面的场景 1 模拟一个死锁。\n然后，执行如下命令获取死锁信息：\n1 mysql\u003e show engine innodb status; 在打印的日志中，先看事务 1 的日志：\n1 2 3 4 5 6 7 8 9 10 11 12 *** (1) TRANSACTION: TRANSACTION 2179, ACTIVE 8 sec inserting mysql tables in use 1, locked 1 LOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s), undo log entries 1 MySQL thread id 32, OS thread handle 140317789804288, query id 823 localhost root update insert into t_insert values(2,101) *** (1) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 37 page no 4 n bits 72 index no of table `test`.`t_insert` trx id 2179 lock mode S waiting Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0 0: len 5; hex 8000000065; asc e;; 1: len 5; hex 8000000001; asc ;; TRANSACTION 2179, ACTIVE ==8 sec== inserting 事务 1 持续了 8 秒：\n1 2 3 4 5 6 mysql ==tables in use 1==, locked 1 涉及一张表 LOCK WAIT 2 lock struct(s) 有两个锁 insert into t_insert values(2,101) 这是 SQL 语句 WAITING FOR THIS LOCK TO BE GRANTED 唯一行锁处于等待 RECORD LOCKS space id 37 page no 4 n bits 72 index no 加锁的是索引字段 no lock mode S waiting 锁等待为 S 锁 事务 2 的日志：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 *** (2) TRANSACTION: TRANSACTION 2178, ACTIVE 17 sec inserting mysql tables in use 1, locked 1 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 2 MySQL thread id 33, OS thread handle 140317663659776, query id 824 localhost root update insert into t_insert values(3,100) *** (2) HOLDS THE LOCK(S): RECORD LOCKS space id 37 page no 4 n bits 72 index no of table `test`.`t_insert` trx id 2178 lock_mode X locks rec but not gap Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0 0: len 5; hex 8000000065; asc e;; 1: len 5; hex 8000000001; asc ;; *** (2) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 37 page no 4 n bits 72 index no of table `test`.`t_insert` trx id 2178 lock_mode X locks gap before rec insert intention waiting Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0 0: len 5; hex 8000000065; asc e;; 1: len 5; hex 8000000001; asc ;; HOLDS THE LOCK(S) 持有锁的内容 lock_mode X locks 持有锁的锁等待内容是一个 x 锁 WAITING FOR THIS LOCK TO BE GRANTED 等待锁的内容 lock_mode X locks gap before rec insert intention waiting 等待锁的锁等待内容也是一个 x 锁 通过这些日志，我们发现日志中的事务 1，持有 S 锁，S 锁的出现是因为需要检查数据唯一性，我们的 no 字段确实有唯一索引，这一点也正好验证了。日志中的事务 1，持有一个 X 锁，又等待一个 X 锁。所以场景 1 中的两个事务都在锁等，造成了死锁。\n小技巧——换种思路提高事务能力 在数据中如果是单一事务，那没的说，一个一个的事务来执行，毫无压力。现实是不允许这样的，肯定是有大量的并发连接，并发事务在所难免。如果高并发的环境中，事务处理效率肯定大幅下降，这个时候我们有没有方法提高并发事务能力呢？\n我们解决技术处理问题的限制，这次我们换一种思路来提高事务能力。比如：\n合理的在线、离线数据库\n比如我们的系统数据量日益增加，还有一些业务需要查询大量的数据，我们可以改造系统为在线、离线数据库，在线表提供高效事务能力，离线表提供数据查询服务，互不影响。\n提高 delete 操作效率的思考\n如果你对表有大量数据的 delete 操作，比如定期的按日、月、年删除数据，可以设计表为日表、月表、年表亦或是相对应的分区表，这样清理数据会由大事务降低为小事务。\nMySQL 地基基础：数据库字符集 字符集简介 字符是各种文字和符号的总称，而字符集是多个字符的集合。\n字符集分类与特点 字符包含有国家文字、标点符号、图形符号、数字等内容，字符集是多个字符的集合，字符集种类非常多，每种字符集包含的字符个数是不相同的。比如说，国家文字不同，就会使用各自国家通用字符集，这样是不是好理解一些。\n常见字符集分类\nASCII（American Standard Code for Information Interchange，美国信息互换标准编码）：是基于罗马字母表的一套电脑编码系统，一个字节表示一个字符。 LATIN1：ASCII 字符集的扩充，仍然使用一个字节表示一个字符。 GB2312（信息交换用汉字编码字符集·基本集）：中国国家标准的简体中文字符集，基本满足了汉字的计算机处理需要，分区表示，双字节表示一个字符。 GB18030（信息交换用汉字编码字符集基本集的扩充）：是 GB2312 的扩充，更全面，兼容 Unicode 3.0 和 GB2312。 UTF-8（Unicode Tranformation Format）：是 Unicode 的其中一个使用方式，支持所有国家字符集，使用 1-4 个字节表示一个字符。 字符集有很多，这里不一一列举。想要获取全部支持字符集，可以在库中查看，详见下文。\n字符集特点\n不同的编码方式，最终解释为不同的机器语言（二进制） 不同的表示方式，使用 1 个或者多个字节表示一个字符 MySQL 与字符集之间亲密关系 首先我们想一下，数据库是做什么的？数据库是存放数据的环境。这些数据库是如何保存的？拍拍脑袋一想，肯定不是原封不动的存放的，数据库不同于我们的大脑，它的思维能力甚至不如阿猫阿狗，它只能读懂 0 和 1，那么数据库存储的数据，其实就是一串串的 0 和 1 的组合，那么按照什么规则定义这些 0 和 1 呢？重点来了，数据库需要在字符集中找到对应的数据编码，然后存储的是这些编码。\nMySQL 字符集包括字符集（character）和校对规则（collation），字符集用来定义存储字符串的方式，校队规则定义比较字符串的方式。字符集和校对规则是一对多的关系，每个字符集至少对应一个校对规则。后面我们在具体说说校对规则。\nMySQL 在底层存储上有四个级别的字符集设置，分别是：服务器级、数据库级、表级、列级。字符集优先级是：列字符集 \u003e 表字符集 \u003e 数据库字符集 \u003e 服务器字符集，其中最常用的是表级和数据库级字符集。列级字符集最优先，但是一般不单独设置，使其继承表级字符集。\n获取所有数据库字符集：\n1 2 3 mysql\u003e show character set; 或者 mysql\u003e select * from information_schema.character_sets; 获取所有数据库校对规则：\n1 2 3 mysql\u003e show collation; 或者 mysql\u003e select * from information_schema.collations; 字符集编码原理 在客户端和服务器端之期间的数据请求与反馈，会经历一系列的转换，从而保证数据的正确无误无乱码，下面具体说一下这个请求的过程。\n\\1. MySQL client 发送请求（字符集为 character_set_client） character_set_client 就是客户端字符集。\n\\2. MySQL Server 收到请求，将请求数据从 character_set_client 转换为 character_set_connection 通常情况下 character_set_connection 字符集同 character_set_client 字符集一致。\n\\3. MySQL Server 将请求数据从 character_set_connection 转换为内部操作字符集。\n何为内部操作字符集，其实就是前面说的列字符集、表字符集、数据库字符集、服务器字符集这四个。这一步操作会使用每个数据字段的 CHARACTER SET 设定值：\n如果 CHARACTER SET 不存在，使用表字符集 如果表字符集不存在，使用数据库字符集 如果数据库字符集不存在，使用服务器字符集 \\4. MySQL Server 将操作结果从内部操作字符集转换为 character_set_results character_set_results 就是结果内容的字符集。\n字符集与校对规则分析 前面我们已经说了说字符集和校对规则的关系。接下来我们具体分析分析它们。\n查看数据库字符集：\n1 mysql\u003e show variables like 'character%'; 参数解释：\ncharacter_set_client：客户端使用的字符集 character_set_connection：客户端和服务端连接层字符集 character_set_database：默认数据库字符集 ，如没有默认数据库，会用 character_set_server 指定的字符集，建议由系统自动管理 character_set_filesystem：把 os 上文件名转化成此字符集，把 character_set_client 转换 character_set_filesystem， 默认 binary 是不做任何转换 character_set_results：结果字符集 character_set_server：数据库服务器字符集 character_set_system：操作系统字符集，无需设置，总是 utf8 DDL 字符集选择：\n建库操作，未指定数据库字符集，继承数据库服务器字符集 建表操作，未指定表字符集，继承当前库字符集 新增字段，未指定列字符集，继承表字符集 修改字段，未指定列字符集，继承表字符集 DML 字符集选择：\n插入、更新数据，由 character_set_client 转换为 character_set_connection 再转换为表字符集 查看字符集校对规则：\n1 mysql\u003e show variables like 'collation%'; 参数说明：\ncollation_connection：当前连接的字符集校对规则 collation_database：当前数据库默认校对规则 collation_server：当前数据库服务器默认校对规则 字符集和校对规则：\n每个字符集至少有一个校对规则 每个字符集有一个默认的校对规则 每个校对规则只能属于一个字符集 校对规则命名\n字符集名称_语言_后缀，其中后缀有三种写法：\n_ci：不区分大小写 _cs：区分大小写 _bin：二进制 如何更改 MySQL 字符集 更改数据库字符集：\n1 alter database db1 default character set utf8; 更改数据库表的字符集：\n1 alter table tab1 default character set utf8; 把表默认的字符集和所有字符列改为新的字符集（例如 utf8）：\n1 alter table tab1 convert to character set utf8; 前面的操作转换了字符集之间的列类型。如果有一列使用一种字符集（如 latin1），但是存储的值实际上使用了其它的字符集（如 utf8），这种情况不是你想要的，进行如下操作就可以解决你的问题。\n1 2 alter table tab1 change 字段 1 字段 2 类型； alter table tab1 change 字段 2 字段 2 类型 character set utf8; 字符集最佳实践 MySQL 数据库字符集和校对规则有 4 个级别：服务器级、数据库级、表级、字段级，下面我们重点讲解及用实例操作来实践。\n服务器级设置字符集 方式一\n在 MySQL 配置文件 my.cnf 中进行配置设置：\n1 2 [mysqld] default-character-set=gbk 方式二\n在启动 MySQL 时设置：\n1 mysqld --default-character-set=gbk 方式三\n在源码编译时指定，如果未指定，默认使用 latin1：\n1 ./configure --with-charcter=gbk 数据库级设置字符集 创建数据库时指定字符集（create database … ） 修改数据库时修改字符集（alter database …） 注：对于已经存在的数据修改字符集无效。\n表级设置字符集 创建表时指定字符集（create table …） 修改表时修改字符集（alter table …） 注：对于已经存在的数据修改字符集无效。\n列级设置字符集 创建表时指定列字符集（create table …） 修改表时修改列字符集（alter table …） 注：对于已经存在的数据修改字符集无效。\n细心的朋友应该已经注意到了，以上这种修改是不适用于已经存在的数据的，如果表中已经存在数据了，那么我们怎样修改字符集呢？不要着急，后面会一步一步的教你如何实现。\n首先我们先实例说一下如何设置字符集。\n1. 为数据库设置字符集和校对规则\n设置数据库字符集：\n1 create database db1 default character set utf8; 设置数据库校对规则：\n1 create database db1 default character set utf8 collate utf8_bin; 说明：\n如果指定了字符集和校对规则，则使用指定的 如果指定了字符集未指定校对规则，则使用指定字符集和默认校对规则 如果未指定字符集和校对规则，则使用服务器字符集和校对规则 2. 为表设置字符集和校对规则\n设置表字符集：\n1 create table tab1(column1 varchar(5)) default character set utf8; 设置表校对规则：\n1 create table tab1(column1 varchar(5)) default character set utf8 collate utf8_bin; 说明：\n如果指定了字符集和校对规则，则使用指定的 如果指定了字符集未指定校对规则，则使用指定字符集和默认校对规则 如果未指定字符集和校对规则，则使用数据库字符集和校对规则 3. 为列设置字符集和校对规则\n设置列字符集：\n1 create table tab1(column1 varchar(5) character SET utf8); 设置列校对规则：\n1 create table tab1(column1 varchar(5) character set utf8 collate utf8_bin); 说明：\n如果指定了字符集和校对规则，则使用指定的 如果指定了字符集未指定校对规则，则使用指定字符集和默认校对规则 如果未指定字符集和校对规则，则使用表字符集和校对规则 4. 如何处理带数据的字符集\n当表中已经存在数据，直接更改字符集，不会更改既有的数据字符集，我们需要先将数据导出，调整字符集再导入。\n第一步：导出表结构\n1 mysqldump -uroot -p --default-character-set=gbk -d db1\u003e createtab.sql 第二步：修改表字符集\n编辑修改 createtab.sql 文件，将表结构定义中的字符集改为新的字符集。\n第三步：导出所有数据\n1 mysqldump -uroot -p --quick --no-create-info --extended-insert --default-character-set=latin1 db1\u003e data.sql 第四步：修改数据字符集\n编辑修改 data.sql，将 set names latin1 修改成 set names gbk。\n第五步：创建数据库\n1 create database db1 default charset gbk; 第六步：创建表\n1 mysql -uroot -p db1 \u003c createtab.sql 第七步：导入数据\n1 mysql -uroot -p db1 \u003c data.sql MySQL 性能优化：碎片整理 MySQL 碎片是什么 MySQL 碎片就是 MySQL 数据文件中一些不连续的空白空间，这些空间无法再被全部利用，久而久之越来多，越来越零碎，从而造成物理存储和逻辑存储的位置顺序不一致，这就是碎片。\n碎片是如何产生的 delete 操作\n在 MySQL 中删除数据，在存储中就会产生空白的空间，当有新数据插入时，MySQL 会试着在这些空白空间中保存新数据，但是呢总是用不满这些空白空间。所以日积月累，亦或是一下有大量的 delete 操作，一下就会有大量的空白空间，慢慢的会大到比表的数据使用的空间还大。\nupdate 操作\n在 MySQL 中更新数据，在可变长度的字段（比如 varchar）中更新数据，innodb 表存储数据的单位是页，update 操作会造成页分裂，分裂以后存储变的不连续，不规则，从而产生碎片。比如说原始字段长度 varchar(100)，我们大量的更新数据长度位为 50，这样的话，有 50 的空间被空白了，新入库的数据不能完全利用剩余的 50，这就会产生碎片。\n碎片到底产生了什么影响 MySQL 既然产生了碎片，你可能比较豪横说磁盘空间够大，浪费空间也没事，但是这些碎片也会产生性能问题，碎片会有什么影响呢？\n空间浪费\n空间浪费不用多说，碎片占用了大量可用空间。\n读写性能下降\n由于存在大量碎片，数据从连续规则的存储方式变为随机分散的存储方式，磁盘 IO 会变的繁忙，数据库读写性能就会下降。\n找一找有哪些碎片 现在我们有一个测试库 employees，在找碎片清理碎片前我们先查询一下表的数据，记录一下时间，以便后边做对比。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 mysql\u003e select count(*) from current_dept_emp; +----------+ | count(*) | +----------+ | 300024 | +----------+ 1 row in set (1.17 sec) mysql\u003e select count(*) from departments; +----------+ | count(*) | +----------+ | 9 | +----------+ 1 row in set (0.00 sec) mysql\u003e select count(*) from dept_emp; +----------+ | count(*) | +----------+ | 331603 | +----------+ 1 row in set (0.08 sec) mysql\u003e select count(*) from dept_emp_latest_date; +----------+ | count(*) | +----------+ | 300024 | +----------+ 1 row in set (0.49 sec) mysql\u003e select count(*) from dept_manager; +----------+ | count(*) | +----------+ | 24 | +----------+ 1 row in set (0.00 sec) mysql\u003e select count(*) from employees; +----------+ | count(*) | +----------+ | 300024 | +----------+ 1 row in set (0.09 sec) mysql\u003e select count(*) from salaries; +----------+ | count(*) | +----------+ | 2844047 | +----------+ 1 row in set (0.60 sec) mysql\u003e select count(*) from titles; +----------+ | count(*) | +----------+ | 443308 | +----------+ 1 row in set (0.11 sec) 接下来我们开始看看都有哪些碎片吧。这里介绍两种方式查看表碎片。\n1. 通过表状态信息查看\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 show table status like '%table_name%'; mysql\u003e show table status like 'salaries'\\G; *************************** 1. row *************************** Name: salaries Engine: InnoDB Version: 10 Row_format: Dynamic Rows: 2838918 Avg_row_length: 31 Data_length: 90832896 Max_data_length: 0 Index_length: 0 Data_free: 4194304 Auto_increment: NULL Create_time: 2021-01-14 14:33:47 Update_time: 2021-01-14 14:34:42 Check_time: NULL Collation: utf8_bin Checksum: NULL Create_options: Comment: 1 row in set (0.00 sec) datalength 表数据大小 indexlength 表索引大小 data_free 碎片大小\n根据返回信息，我们知道碎片大小为 4194304（单位 B）\n2. 通过数据库视图信息查看\n查询 information_schema.tables 的 data_free 列的值：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 mysql\u003e select t.table_schema, t.table_name, t.table_rows, t.data_length, t.index_length, concat(round(t.data_free/1024/1024,2),'m') as data_free from information_schema.tables t where t.table_schema = 'employees'; +--------------+----------------------+------------+-------------+--------------+-----------+ | TABLE_SCHEMA | TABLE_NAME | TABLE_ROWS | DATA_LENGTH | INDEX_LENGTH | DATA_FREE | +--------------+----------------------+------------+-------------+--------------+-----------+ | employees | current_dept_emp | NULL | NULL | NULL | NULL | | employees | departments | 9 | 16384 | 16384 | 0.00M | | employees | dept_emp | 331143 | 12075008 | 5783552 | 4.00M | | employees | dept_emp_latest_date | NULL | NULL | NULL | NULL | | employees | dept_manager | 24 | 16384 | 16384 | 0.00M | | employees | employees | 299069 | 15220736 | 0 | 4.00M | | employees | salaries | 2838426 | 100270080 | 0 | 4.00M | | employees | titles | 442902 | 20512768 | 0 | 4.00M | +--------------+----------------------+------------+-------------+--------------+-----------+ 8 rows in set (0.01 sec) 根据结果显示，data_free 列数据就是我们要查询的表的碎片大小内容，是 4M。\n如何清理碎片 找到表碎片了，我们如何清理呢？有两种方法。\n1. 分析表\n命令：\n1 optimize table table_name; 这个方法主要针对 MyISAM 引擎表使用，因为 MyISAM 表的数据和索引是分离的，optimize 表可以整理数据文件，重新排列索引。\n注意：optimize 会锁表，时间长短依据表数据量的大小。\n2. 重建表引擎\n命令：\n1 alter table table_name engine = innodb; 这个方法主要针对 InnoDB 引擎表使用，该操作会重建表的存储引擎，重组数据和索引的存储。\n刚才我们查到表 salaries 有 4M 的碎片，我们清理一下 salaries 表碎片：\n1 mysql\u003e alter table salaries engine = innodb; 查询一下该表的碎片是否被清理：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 mysql\u003e select t.table_schema, t.table_name, t.table_rows, t.data_length, t.index_length, concat(round(t.data_free/1024/1024,2),'m') as data_free from information_schema.tables t where t.table_schema = 'employees' and table_name='salaries'; +--------------+------------+------------+-------------+--------------+-----------+ | table_schema | table_name | table_rows | data_length | index_length | data_free | +--------------+------------+------------+-------------+--------------+-----------+ | employees | salaries | 2838426 | 114950144 | 0 | 2.00m | +--------------+------------+------------+-------------+--------------+-----------+ 1 row in set (0.00 sec) 碎片从原来的 4M 清理到现在的 2M。\n我们看看查询表是否提高了速度：\n1 2 3 4 5 6 7 mysql\u003e select count(*) from salaries; +----------+ | count(*) | +----------+ | 2844047 | +----------+ 1 row in set (0.16 sec) 速度还是提高了不少，清理碎片后提高了查询速度。\n总结一下：清理表的碎片可以提高 MySQL 性能，在日常工作中我们可以定期执行表碎片整理，从而提高 MySQL 性能。\nMySQL 故障诊断：一个 ALTER TALBE 执行了很久，你慌不慌？ 先了解下 MySQL 数据字典 当我们对一张大表执行了一个 ALTER TABLE 操作，执行了很久，也不知道是否执行完成，进程在那挂着，此时的你，干瞪眼，进度看不到，进程不敢杀，就问你慌不慌？\n在具体解决这个慌乱之前，我们先了解下 MySQL 的数据字典。\n数据字典我们用一句话来概括，就是数据的数据，用于查询数据库中数据的信息内容。\nMySQL 在 5.7 开始，对数据字典的使用有了很大的改进，使用上更加的方便，提供的能力也更高。performance_schema 可以查询事务信息、获取元数据锁、跟踪事件、统计内存使用情况等等。\n到这里你是不是发现了什么？\nperformance_schema 这个是什么，是不是用它来让我们解除慌张？\n有关 MySQL 数据字典，可以看我的另外一个 Chat：\n[MySQL 地基基础：数据字典](./MySQL 地基基础：数据字典.md)\n使用一些重要的重要功能 既然了解到 MySQL 数据字典可以帮助我们，那它是如何实现呢？\n我们先看看官网是如何解释的\nhttps://dev.mysql.com/doc/refman/5.7/en/monitor-alter-table-performance-schema.html\nYou can monitor ALTER TABLE progress for InnoDB tables using Performance Schema.\nThere are seven stage events that represent different phases of ALTER TABLE. Each stage event reports a running total of WOR_COMPLETED and WORK_ESTIMATED for the overall ALTER TABLE operation as it progresses through its different phases. WORK_ESTIMATED is calculated using a formula that takes into account all of the work that ALTER TABLE performs, and may be revised during ALTER TABLE processing. WORK_COMPLETED and WORK_ESTIMATED values are an abstract representation of all of the work performed by ALTER TABLE.\n大意就是我们可以在 Performance Schema 看到 ALTER TABLE 的进度，包括执行的时间，大概剩余的时间。\n想要使用这个能力，我们需要开启几个功能。\nEnable the stage/innodb/alter% instruments\n1 2 3 4 5 mysql\u003e UPDATE performance_schema.setup_instruments -\u003e SET ENABLED = 'YES' -\u003e WHERE NAME LIKE 'stage/innodb/alter%'; Query OK, 0 rows affected (0.01 sec) Rows matched: 7 Changed: 0 Warnings: 0 Enable the stage event consumer tables\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 mysql\u003e UPDATE performance_schema.setup_consumers -\u003e SET ENABLED = 'YES' -\u003e WHERE NAME ='events_stages_current'; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql\u003e UPDATE performance_schema.setup_consumers -\u003e SET ENABLED = 'YES' -\u003e WHERE NAME ='events_stages_history'; Query OK, 1 row affected (0.01 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql\u003e UPDATE performance_schema.setup_consumers -\u003e SET ENABLED = 'YES' -\u003e WHERE NAME ='events_stages_history_long'; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 功能开启了，接下来我们进行直观的验证环节。\n直观的观察事件执行进度 首先，我们有一张大表（你可以用 SysBench 建一个，或者其他各种途径都可以），这里我已经有一张大表 sbtest.sbtest1，表结构如下：\n1 2 3 4 5 6 7 8 9 10 mysql\u003e desc sbtest.sbtest1; +-------+-----------+------+-----+---------+----------------+ | Field | Type | Null | Key | Default | Extra | +-------+-----------+------+-----+---------+----------------+ | id | int(11) | NO | PRI | NULL | auto_increment | | k | int(11) | NO | MUL | 0 | | | c | char(120) | NO | | | | | pad | char(60) | NO | | | | +-------+-----------+------+-----+---------+----------------+ 4 rows in set (0.00 sec) 数据量 500W：\n1 2 3 4 5 6 7 mysql\u003e select count(*) from sbtest.sbtest1; +----------+ | count(*) | +----------+ | 5000000 | +----------+ 1 row in set (0.67 sec) 新增一个字段：\n1 mysql\u003e alter table sbtest.sbtest1 add d char(20); 重头戏来了，查看一下进度：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 mysql\u003e select * from performance_schema.events_stages_current\\G; *************************** 1. row *************************** THREAD_ID: 28 EVENT_ID: 14 END_EVENT_ID: NULL EVENT_NAME: stage/innodb/alter table (read PK and internal sort) SOURCE: TIMER_START: 159726265417733000 TIMER_END: 159819571346680000 TIMER_WAIT: 93305928947000 WORK_COMPLETED: 118256 WORK_ESTIMATED: 302958 NESTING_EVENT_ID: 13 NESTING_EVENT_TYPE: STATEMENT 1 row in set (0.00 sec) ...... mysql\u003e select * from performance_schema.events_stages_current\\G; *************************** 1. row *************************** THREAD_ID: 28 EVENT_ID: 14 END_EVENT_ID: NULL EVENT_NAME: stage/innodb/alter table (read PK and internal sort) SOURCE: TIMER_START: 159726265417733000 TIMER_END: 159910492100061000 TIMER_WAIT: 184226682328000 WORK_COMPLETED: 230688 WORK_ESTIMATED: 302958 NESTING_EVENT_ID: 13 NESTING_EVENT_TYPE: STATEMENT 1 row in set (0.01 sec) 多执行几次，发现数据是有变化的，这些内容代表了什么呢？\nTHREAD_ID：线程 ID EVENT_ID：事件 ID END_EVENT_ID：结束事件 ID EVENT_NAME：事件名称，说明了当前执行的事件 SOURCE：源码位置 TIMER_START：事件开始时间（皮秒） TIMER_END：事件结束时间（皮秒，如果没有执行完成，时间就是当前之间） TIMER_WAIT：事件等待事件（皮秒） WORK_COMPLETED：任务完成情况 WORK_ESTIMATED：任务估算情况 NESTING_EVENT_ID：事件对应的父事件 ID NESTING_EVENT_TYPE：父事件类型（STATEMENT、STAGE、WAIT） 收下这个常用的 SQL 查看事件任务完成情况： 1 2 3 4 5 6 7 mysql\u003e SELECT pt.INFO, ec.THREAD_ID, ec.EVENT_NAME, ec.WORK_COMPLETED, ec.WORK_ESTIMATED, pt.STATE FROM performance_schema.events_stages_current ec left join performance_schema.threads th on ec.thread_id = th.thread_id left join information_schema.PROCESSLIST pt on th.PROCESSLIST_ID = pt.ID where pt.INFO like 'ALTER%'; +-------------------------------------------+-----------+------------------------------------------------------+----------------+----------------+----------------+ | INFO | THREAD_ID | EVENT_NAME | WORK_COMPLETED | WORK_ESTIMATED | STATE | +-------------------------------------------+-----------+------------------------------------------------------+----------------+----------------+----------------+ | alter table sbtest.sbtest1 add d char(20) | 28 | stage/innodb/alter table (read PK and internal sort) | 201496 | 308223 | altering table | +-------------------------------------------+-----------+------------------------------------------------------+----------------+----------------+----------------+ 1 row in set (0.25 sec) 查看任务完成事件： 1 2 3 4 5 6 7 mysql\u003e select stmt.sql_text as sql_text, concat(work_completed, '/' , work_estimated) as progress, (stage.timer_end - stmt.timer_start) / 1e12 as current_seconds, (stage.timer_end - stmt.timer_start) / 1e12 * (work_estimated-work_completed) / work_completed as remaining_seconds from performance_schema.events_stages_current stage, performance_schema.events_statements_current stmt where stage.thread_id = stmt.thread_id and stage.nesting_event_id = stmt.event_id; +-------------------------------------------+---------------+-----------------+--------------------+ | sql_text | progress | current_seconds | remaining_seconds | +-------------------------------------------+---------------+-----------------+--------------------+ | alter table sbtest.sbtest1 add d char(20) | 135192/308223 | 102.461512532 | 131.13954949201502 | +-------------------------------------------+---------------+-----------------+--------------------+ 1 row in set (0.00 sec) 总结 这样我们通过 MySQL 的这个数据字典就可以很直观地看到 ALTER 的执行情况了，当你看到这样的执行进度，是不是就不那么慌了。\nMySQL 故障诊断：教你快速定位加锁的 SQL 为什么会加锁 锁是可以协调并发连接访问 MySQL 数据库资源的一种技术，可以保证数据的一致性。\n有关 MySQL 锁的具体内容，可以详看我的另外一个 Chat，其中有一部分介绍的是“MySQL 锁机制（机智）”：\n[MySQL 地基基础：事务和锁的面纱](MySQL 地基基础：事务和锁的面纱.md)\n数据库锁有什么威力 在实际应用中你肯定遇到过锁问题，这个锁的威力很大，那出现了数据库锁，会造成什么影响呢？\n锁等待\n一个连接申请了锁资源，其他连接要申请资源，无法获取，等待资源释放。\n死锁\n你锁我，我也锁你，大家一起锁着吧。\n快速定位加锁的 SQL 既然出现了锁，我们就要管理一下这个锁，找一找是什么 SQL 持有这个锁，早点发现锁，提前干预，下面我们看看如何快速定位加锁的 SQL。\n首先我们创建一个测试表：\n1 2 3 4 5 6 7 8 9 10 11 mysql\u003e create table t1(id decimal,v_name varchar(10)); mysql\u003e insert into t1 values(1,'a'),(2,'b'),(3,'c'); mysql\u003e select * from t1; +------+--------+ | id | v_name | +------+--------+ | 1 | a | | 2 | b | | 3 | c | +------+--------+ 3 rows in set (0.00 sec) 会话 1，开启事务，更新 id=1 的数据：\n1 2 mysql\u003e begin; mysql\u003e update t1 set v_name='aa' where id=1; 会话 2，开启另一个事务，删除 id=1 的数据：\n1 2 mysql\u003e begin; mysql\u003e delete from t1 where id=1; 此时会话 2 被锁定，出现锁等待。\n我们再开一个会话 3，查查当前的 processlist，看看是否能发现什么？\n1 2 3 4 5 6 7 8 mysql\u003e show processlist; +----+------+-----------+------+---------+------+----------+---------------------------+ | Id | User | Host | db | Command | Time | State | Info | +----+------+-----------+------+---------+------+----------+---------------------------+ | 38 | root | localhost | test | Sleep | 5 | | NULL | | 41 | root | localhost | test | Query | 2 | updating | delete from t1 where id=1 | | 42 | root | localhost | NULL | Query | 0 | starting | show processlist | +----+------+-----------+------+---------+------+----------+---------------------------+ 我们可以看到 delete 这个 SQL 的进程在执行中，并没有发现其他有价值的内容，那锁在哪里了。接下来的步骤带你一步步的定位出加锁的 SQL。\n定位锁等待\n1 2 3 4 5 6 7 mysql\u003e select * from information_schema.innodb_lock_waits; +-------------------+-------------------+-----------------+------------------+ | requesting_trx_id | requested_lock_id | blocking_trx_id | blocking_lock_id | +-------------------+-------------------+-----------------+------------------+ | 2207 | 2207:28:3:7 | 2206 | 2206:28:3:7 | +-------------------+-------------------+-----------------+------------------+ 1 row in set, 1 warning (0.00 sec) 结果显示有一个锁等待。\n定位锁\n1 2 3 4 5 6 7 8 mysql\u003e select * from information_schema.innodb_locks; +-------------+-------------+-----------+-----------+-------------+-----------------+------------+-----------+----------+----------------+ | lock_id | lock_trx_id | lock_mode | lock_type | lock_table | lock_index | lock_space | lock_page | lock_rec | lock_data | +-------------+-------------+-----------+-----------+-------------+-----------------+------------+-----------+----------+----------------+ | 2207:28:3:7 | 2207 | X | RECORD | `test`.`t1` | GEN_CLUST_INDEX | 28 | 3 | 7 | 0x000000000211 | | 2206:28:3:7 | 2206 | X | RECORD | `test`.`t1` | GEN_CLUST_INDEX | 28 | 3 | 7 | 0x000000000211 | +-------------+-------------+-----------+-----------+-------------+-----------------+------------+-----------+----------+----------------+ 2 rows in set, 1 warning (0.00 sec) 结果显示有两个锁相关内容。\n定位事务\n1 2 3 4 5 6 7 8 mysql\u003e select trx_id,trx_started,trx_requested_lock_id,trx_query,trx_mysql_thread_id from information_schema.innodb_trx; +--------+---------------------+-----------------------+---------------------------+---------------------+ | trx_id | trx_started | trx_requested_lock_id | trx_query | trx_mysql_thread_id | +--------+---------------------+-----------------------+---------------------------+---------------------+ | 2207 | 2021-01-18 15:18:11 | 2207:28:3:7 | delete from t1 where id=1 | 41 | | 2206 | 2021-01-18 15:18:08 | NULL | NULL | 38 | +--------+---------------------+-----------------------+---------------------------+---------------------+ 2 rows in set (0.01 sec) 结果有两个事务，MySQL 事务线程 id 为 38 和 41，很直观的看到 41 是我们的 delete 事务，被 38 锁定。\n定位线程\n1 2 3 4 5 6 7 mysql\u003e select * from performance_schema.threads where processlist_id=38; +-----------+---------------------------+------------+----------------+------------------+------------------+----------------+---------------------+------------------+-------------------+------------------+------------------+------+--------------+---------+-----------------+--------------+ | THREAD_ID | NAME | TYPE | PROCESSLIST_ID | PROCESSLIST_USER | PROCESSLIST_HOST | PROCESSLIST_DB | PROCESSLIST_COMMAND | PROCESSLIST_TIME | PROCESSLIST_STATE | PROCESSLIST_INFO | PARENT_THREAD_ID | ROLE | INSTRUMENTED | HISTORY | CONNECTION_TYPE | THREAD_OS_ID | +-----------+---------------------------+------------+----------------+------------------+------------------+----------------+---------------------+------------------+-------------------+------------------+------------------+------+--------------+---------+-----------------+--------------+ | 63 | thread/sql/one_connection | FOREGROUND | 38 | root | localhost | test | Sleep | 35 | NULL | NULL | NULL | NULL | YES | YES | Socket | 15070 | +-----------+---------------------------+------------+----------------+------------------+------------------+----------------+---------------------+------------------+-------------------+------------------+------------------+------+--------------+---------+-----------------+--------------+ 1 row in set (0.00 sec) 结果找到 MySQL 事务线程 38 对应的服务器线程 63。\n定位加锁 SQL\n1 2 3 4 5 6 7 mysql\u003e select * from performance_schema.events_statements_current where thread_id=63; +-----------+----------+--------------+----------------------+--------------------------+---------------------+---------------------+------------+-----------+--------------------------------------+----------------------------------+----------------------------------------------+----------------+-------------+---------------+-------------+-----------------------+-------------+-------------------+------------------------------------------+--------+----------+---------------+-----------+---------------+-------------------------+--------------------+------------------+------------------------+--------------+--------------------+-------------+-------------------+------------+-----------+-----------+---------------+--------------------+------------------+--------------------+---------------------+ | THREAD_ID | EVENT_ID | END_EVENT_ID | EVENT_NAME | SOURCE | TIMER_START | TIMER_END | TIMER_WAIT | LOCK_TIME | SQL_TEXT | DIGEST | DIGEST_TEXT | CURRENT_SCHEMA | OBJECT_TYPE | OBJECT_SCHEMA | OBJECT_NAME | OBJECT_INSTANCE_BEGIN | MYSQL_ERRNO | RETURNED_SQLSTATE | MESSAGE_TEXT | ERRORS | WARNINGS | ROWS_AFFECTED | ROWS_SENT | ROWS_EXAMINED | CREATED_TMP_DISK_TABLES | CREATED_TMP_TABLES | SELECT_FULL_JOIN | SELECT_FULL_RANGE_JOIN | SELECT_RANGE | SELECT_RANGE_CHECK | SELECT_SCAN | SORT_MERGE_PASSES | SORT_RANGE | SORT_ROWS | SORT_SCAN | NO_INDEX_USED | NO_GOOD_INDEX_USED | NESTING_EVENT_ID | NESTING_EVENT_TYPE | NESTING_EVENT_LEVEL | +-----------+----------+--------------+----------------------+--------------------------+---------------------+---------------------+------------+-----------+--------------------------------------+----------------------------------+----------------------------------------------+----------------+-------------+---------------+-------------+-----------------------+-------------+-------------------+------------------------------------------+--------+----------+---------------+-----------+---------------+-------------------------+--------------------+------------------+------------------------+--------------+--------------------+-------------+-------------------+------------+-----------+-----------+---------------+--------------------+------------------+--------------------+---------------------+ | 63 | 32 | 32 | statement/sql/update | socket_connection.cc:101 | 2757904906303653000 | 2757904906543381000 | 239728000 | 145000000 | update t1 set v_name='aa' where id=1 | 356a053ffb5eae2a35981b05090faa01 | UPDATE `t1` SET `v_name` = ? WHERE `id` = ? | test | NULL | NULL | NULL | NULL | 0 | 00000 | Rows matched: 1 Changed: 0 Warnings: 0 | 0 | 0 | 0 | 0 | 3 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | NULL | NULL | 0 | +-----------+----------+--------------+----------------------+--------------------------+---------------------+---------------------+------------+-----------+--------------------------------------+----------------------------------+----------------------------------------------+----------------+-------------+---------------+-------------+-----------------------+-------------+-------------------+------------------------------------------+--------+----------+---------------+-----------+---------------+-------------------------+--------------------+------------------+------------------------+--------------+--------------------+-------------+-------------------+------------+-----------+-----------+---------------+--------------------+------------------+--------------------+---------------------+ 1 row in set (0.00 sec) 结果中我们找到了加锁的 update 的 SQL 语句。\n总结\n在 MySQL 数据库中出现了锁，不要着急，我们通过这个方法可以快速定位加锁的 SQL，你学会了吗？\nMySQL优化：优化 select count() 业务反馈，开发崩溃 某天，项目中业务人员反馈系统中某功能查询非常的慢，几乎等待了几十秒才有反应。于是联系了开发，开发人员调取日志，排查应用，定位 SQL，其实只是一个 select count(*)，这可急坏了开发人员，非常困惑，最简答的一个统计 SQL，为什么查询这么慢！不知道到如何优化与处理。\n一个效果显著的简单操作\n在我知道这个问题，询问了开发人员哪张表后，做了一定分析后，增加索引，无需开发做任何修改，性能得到大幅提升。为什么一个索引会有如此的性能提升，我先卖个关子，后面一一道来。\n问题复现，优化处理 首先我们造一个 500W 数据量的表，别结构如下：\n1 2 3 4 5 6 7 8 9 10 mysql\u003e show create table sbtest1\\G; *************************** 1. row *************************** Table: sbtest1 Create Table: CREATE TABLE `sbtest1` ( `id` int(11) NOT NULL AUTO_INCREMENT, `k` int(11) NOT NULL DEFAULT '0', `c` char(120) NOT NULL DEFAULT '', `pad` char(60) NOT NULL DEFAULT '', PRIMARY KEY (`id`) ) ENGINE=InnoDB AUTO_INCREMENT=5000001 DEFAULT CHARSET=latin1 直接来 count(*) 一下，看看执行时间吧。\n1 2 3 4 5 6 7 mysql\u003e select count(*) from sbtest1; +----------+ | count(*) | +----------+ | 5000000 | +----------+ 1 row in set (2.42 sec) 执行时间 2.42 秒。\n现在看看执行计划：\n1 2 3 4 5 6 7 mysql\u003e explain select count(*) from sbtest1; +----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+ | 1 | SIMPLE | sbtest1 | NULL | index | NULL | PRIMARY | 4 | NULL | 4808163 | 100.00 | Using index | +----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+ 1 row in set, 1 warning (0.00 sec) 结果显示：走 PRIMARY 索引。\n是不是有疑惑了，查询走了主键索引，看着没什么问题呀，500W 的数据 2 秒执行完，还可以。那你就错了，我这里只是一个简单的测试表，这才几个字段，测试表造的数据又是多么的简单，倘若在真实生产环境，这 500W 的数据可不是 2 秒就能返回结果的。\n稍等片刻，我来优化…… …… …… ……\n1 2 3 4 5 6 7 mysql\u003e select count(*) from sbtest1; +----------+ | count(*) | +----------+ | 5000000 | +----------+ 1 row in set (0.68 sec) 执行时间明显缩短，我到底做了怎样的操作，为什么执行效率大幅提高，想知道其中的奥妙吗？干货即将送达。\n扒一扒 count(*) 的原理 为了解开这其中的疑惑，首先我们不得不说一下 MySQL 的 count(*) 原理。\n在 MySQL 中存在两种索引：\n聚簇索引：MySQL 中的每个 InnoDB 存储引擎的表，都有一个特殊索引来保存每行记录，这个索引就是聚簇索引。通常情况下其实就是主键。聚簇索引保存的是行记录和 b-tree 索引，这个索引所占用的空间大小和行记录总数差不多大。 二级索引：另外一类索引就是二级索引，它保存的只是本身索引列和主键列。占用的空间明显小很多了。 介绍完 MySQL 的两种索引，我们继续说 MySQL 的 count(*) 执行过程。\n在 MySQL 的 InnoDB 存储引擎中，count(*) 会从内存中读取数据到缓冲区中，如果内存中没有，会提前一步在磁盘中把数据读取到内存中，然后在缓存区中完成记录数的统计。MySQL 会先通过 ken_len 最小的那个二级索引计算，如果没有二级索引就通过主键计算，如果连主键都没有那就要通过全表扫描来完成计算了。\n主键索引也就是聚簇索引，会把行记录和 b-tree 索引都读取出来，所占用的空间大小和行记录总数差不多大；二级索引保存的只是本身索引列和主键列，占用的空间会小的多，当然读取出来就节省了很多时间。\n我举个通俗易懂的例子吧，比如学校给你一个任务，让你统计一下高三年级一共有多少学生？利用上面说的两种索引来统计。\n聚簇索引：从学号 1，一个一个数到 600，有 600 人。 二级索引：直接看学号 600，那不就是 600 人吗！ 通过这些就不难说明了，上述演示的过程，第一次是通过主键来计算统计数据量，而第二次其实我做的也是创建了一个二级索引，通过二级索引来计算统计，速度快了很多，我们可以看看其对应的执行过程。\n1 2 3 4 5 6 7 mysql\u003e explain select count(*) from sbtest1; +----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+ | 1 | SIMPLE | sbtest1 | NULL | index | NULL | k_1 | 4 | NULL | 4808163 | 100.00 | Using index | +----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+ 1 row in set, 1 warning (0.01 sec) 执行过程 key 这一列内容为：k_1，这个就是二级索引的索引名称。\n显而易见的验证 验证聚簇索引 查询 MySQL 缓存区，确保缓冲区中不存在测试表的缓存：\n1 2 mysql\u003e select * from sys.innodb_buffer_stats_by_table where object_schema = 'sbtest'; Empty set (0.05 sec) 执行 select count(*)：\n1 2 3 4 5 6 7 mysql\u003e select count(*) from sbtest1; +----------+ | count(*) | +----------+ | 5000000 | +----------+ 1 row in set (2.42 sec) 再次查看 MySQL 缓存区，查询测试表的缓存：\n1 2 3 4 5 6 7 mysql\u003e select * from sys.innodb_buffer_stats_by_table where object_schema = 'sbtest'; +---------------+-------------+------------+------------+-------+--------------+-----------+-------------+ | object_schema | object_name | allocated | data | pages | pages_hashed | pages_old | rows_cached | +---------------+-------------+------------+------------+-------+--------------+-----------+-------------+ | sbtest | sbtest1 | 125.84 MiB | 115.46 MiB | 8054 | 0 | 3021 | 588845 | +---------------+-------------+------------+------------+-------+--------------+-----------+-------------+ 1 row in set (0.13 sec) 结果显示：缓存了 100M+ 的数据。\n查看执行计划：\n1 2 3 4 5 6 7 mysql\u003e explain select count(*) from sbtest1; +----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+ | 1 | SIMPLE | sbtest1 | NULL | index | NULL | PRIMARY | 4 | NULL | 4808163 | 100.00 | Using index | +----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+ 1 row in set, 1 warning (0.00 sec) 结果显示 select count(*) 走的是主键索引。\n验证二级索引 创建一个二级索引：\n1 2 3 mysql\u003e create index k_1 on sbtest1(k); Query OK, 0 rows affected (53.61 sec) Records: 0 Duplicates: 0 Warnings: 0 为了验证本次过程，我们重启一下 MySQL，目的是清空 MySQL 的缓存。\n1 2 3 ...... MySQL 重启完成 ...... 查询 MySQL 缓存区，确保缓冲区中不存在测试表的缓存：\n1 2 mysql\u003e select * from sys.innodb_buffer_stats_by_table where object_schema = 'sbtest'; Empty set (0.05 sec) 执行 select count(*)：\n1 2 3 4 5 6 7 mysql\u003e select count(*) from sbtest1; +----------+ | count(*) | +----------+ | 5000000 | +----------+ 1 row in set (0.73 sec) 再次查看 MySQL 缓存区，查询测试表的缓存：\n1 2 3 4 5 6 7 mysql\u003e select * from sys.innodb_buffer_stats_by_table where object_schema = 'sbtest'; +---------------+-------------+-----------+-----------+-------+--------------+-----------+-------------+ | object_schema | object_name | allocated | data | pages | pages_hashed | pages_old | rows_cached | +---------------+-------------+-----------+-----------+-------+--------------+-----------+-------------+ | sbtest | sbtest1 | 65.09 MiB | 62.06 MiB | 4166 | 0 | 1459 | 2501935 | +---------------+-------------+-----------+-----------+-------+--------------+-----------+-------------+ 1 row in set (0.08 sec) 结果显示：缓存了 60M+ 的数据。\n查看执行计划：\n1 2 3 4 5 6 7 mysql\u003e explain select count(*) from sbtest1; +----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+ | 1 | SIMPLE | sbtest1 | NULL | index | NULL | k_1 | 4 | NULL | 4808163 | 100.00 | Using index | +----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+ 1 row in set, 1 warning (0.01 sec) 结果显示 select count(*) 走的是二级索引 k_1。\n更加直观看一下两种索引占用的空间大小 首先我们查看一下 MySQL 的 innodb_page_size 的大小：\n1 2 3 4 5 6 7 mysql\u003e show variables like 'Innodb_page_size'; +------------------+-------+ | Variable_name | Value | +------------------+-------+ | innodb_page_size | 16384 | +------------------+-------+ 1 row in set (0.01 sec) 大小是 16K。\n统计一下聚簇索引和二级索引占用的空间大小：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 mysql\u003e select -\u003e sum(stat_value) pages, -\u003e index_name index_name, -\u003e (round((sum(stat_value) * @@innodb_page_size)/1024/1024)) as MB -\u003e from mysql.innodb_index_stats -\u003e where table_name = 'sbtest1' AND database_name = 'sbtest' AND stat_description = 'Number of pages in the index' -\u003e group by index_name; +-------+------------+------+ | pages | index_name | MB | +-------+------------+------+ | 67456 | PRIMARY | 1054 | | 4774 | k_1 | 75 | +-------+------------+------+ 2 rows in set (0.01 sec) 这样结果太明显了，主键索引占用了几乎 1 个 G 的空间，而 k_1 这个二级索引值占用了 75M 的空间。\n总结与思考 MySQL 的 select count(*) 在底层实现统计的过程中通过二级索引优于主键索引优于全表扫描，这是因为二级索引只缓存主键列和索引列，主键索引几乎缓存了所有的行记录，前者势必比后者缓存的内容少的多，当然计算的效率肯定要快的多。\n我们再思考一下，假如数据量不是 500W，而二级索引占用的空间都 1G、10G，甚至几十 G 了，速度也就不可接受了，怎么办？\n这个时候我们不能局限于二级索引了，而可考虑：\n单纯的统计，我们可以考虑用 MyISAM 引擎，它自带计数器，当然了，局限性就不一一列举了，此方案了解即可吧。 数据仓库等其他可接入的系统来完成此工作。 缓存中间件也不失一个好的建议。 做一个类似触发器计数的功能？ MySQL 8.0 的并行查询，嗯，好功能。 历史数据迁移，就不让你查询那么多数据了，这个有点霸道了，可以换着说法，根据业务需求，历史数据迁移，只保留某些数据（按规则）。 分库分表，不多说什么，还是物理上的优化。 服务器硬件资源提升，比如 SSD 硬盘等（治标不治本）。 其他（肯定不止以上 8 种，如果你还有其他想法，请尊留言）。 好了，至此我们基本学习完 select count(*)相关内容了，内容比较多，当然也有不足之处，欢迎朋友们指正补充。\nMySQL共享锁、排他锁、悲观锁、乐观锁 一、相关名词\n|–表级锁（锁定整个表）\n|–页级锁（锁定一页）\n|–行级锁（锁定一行）\n|–共享锁（S锁，MyISAM 叫做读锁）\n|–排他锁（X锁，MyISAM 叫做写锁）\n|–间隙锁（NEXT-KEY锁）\n|–悲观锁（抽象性，不真实存在这个锁）\n|–乐观锁（抽象性，不真实存在这个锁）\n二、InnoDB与MyISAM\nMysql 在5.5之前默认使用 MyISAM 存储引擎，之后使用 InnoDB 。查看当前存储引擎：\n1 show variables like '%storage_engine%'; MyISAM 操作数据都是使用的表锁，你更新一条记录就要锁整个表，导致性能较低，并发不高。当然同时它也不会存在死锁问题。\n而 InnoDB 与 MyISAM 的最大不同有两点：一是 InnoDB 支持事务；二是 InnoDB 采用了行级锁。也就是你需要修改哪行，就可以只锁定哪行。\n在 Mysql 中，行级锁并不是直接锁记录，而是锁索引。索引分为主键索引和非主键索引两种，如果一条sql 语句操作了主键索引，Mysql 就会锁定这条主键索引；如果一条语句操作了非主键索引，MySQL会先锁定该非主键索引，再锁定相关的主键索引。\nInnoDB 行锁是通过给索引项加锁实现的，如果没有索引，InnoDB 会通过隐藏的聚簇索引来对记录加锁。也就是说：如果不通过索引条件检索数据，那么InnoDB将对表中所有数据加锁，实际效果跟表锁一样。因为没有了索引，找到某一条记录就得扫描全表，要扫描全表，就得锁定表。\n三、共享锁与排他锁\n1.首先说明：数据库的增删改操作默认都会加排他锁，而查询不会加任何锁。\nmysql InnoDB引擎默认的修改数据语句，update,delete,insert都会自动给涉及到的数据加上排他锁，select语句默认不会加任何锁类型，如果加排他锁可以使用select …for update语句，加共享锁可以使用select … lock in share mode语句。所以加过排他锁的数据行在其他事务种是不能修改数据的，也不能通过for update和lock in share mode锁的方式查询数据，但可以直接通过select …from…查询数据，因为普通查询没有任何锁机制。\n|–共享锁：对某一资源加共享锁，自身可以读该资源，其他人也可以读该资源（也可以再继续加共享锁，即 共享锁可多个共存），但无法修改。要想修改就必须等所有共享锁都释放完之后。语法为：\n1 select * from table lock in share mode |–排他锁：对某一资源加排他锁，自身可以进行增删改查，其他人无法进行任何操作。语法为：\n1 select * from table for update 2.下面援引例子说明 （援自：http://blog.csdn.net/samjustin1/article/details/52210125）：\n这里用T1代表一个数据库执行请求，T2代表另一个请求，也可以理解为T1为一个线程，T2 为另一个线程。\n例1：\nT1: select * from table lock in share mode（假设查询会花很长时间，下面的例子也都这么假设）\nT2: update table set column1=‘hello’\n过程：\nT1运行（并加共享锁)\nT2运行\nif T1还没执行完\nT2等……\nelse 锁被释放\nT2执行\nend if\nT2 之所以要等，是因为 T2 在执行 update 前，试图对 table 表加一个排他锁，而数据库规定同一资源上不能同时共存共享锁和排他锁。所以 T2 必须等 T1 执行完，释放了共享锁，才能加上排他锁，然后才能开始执行 update 语句。\n例2：\nT1: select * from table lock in share mode\nT2: select * from table lock in share mode\n这里T2不用等待T1执行完，而是可以马上执行。\n分析：\nT1运行，则 table 被加锁，比如叫lockA，T2运行，再对 table 加一个共享锁，比如叫lockB，两个锁是可以同时存在于同一资源上的（比如同一个表上）。这被称为共享锁与共享锁兼容。这意味着共享锁不阻止其它人同时读资源，但阻止其它人修改资源。\n例3：\nT1: select * from table lock in share mode\nT2: select * from table lock in share mode\nT3: update table set column1=‘hello’\nT2 不用等 T1 运行完就能运行，T3 却要等 T1 和 T2 都运行完才能运行。因为 T3 必须等 T1 和 T2 的共享锁全部释放才能进行加排他锁然后执行 update 操作。\n例4 （死锁的发生）：\nT1:begin tran\n1 2 3 select * from table lock in share mode update table set column1='hello' T2:begin tran\n1 2 3 select * from table lock in share mode update table set column1='world' 假设 T1 和 T2 同时达到 select，T1 对 table 加共享锁，T2 也对 table 加共享锁，当 T1 的 select 执行完，准备执行 update 时，根据锁机制，T1 的共享锁需要升级到排他锁才能执行接下来的 update。在升级排他锁前，必须等 table 上的其它共享锁（T2）释放，同理，T2 也在等 T1 的共享锁释放。于是死锁产生了。\n例5：\nT1:begin tran\n1 *update table set column1='hello' where id=10* T2:begin tran\n1 *update table set column1='world' where id=20* 这种语句虽然最为常见，很多人觉得它有机会产生死锁，但实际上要看情况\n|–如果id是主键（默认有主键索引），那么T1会一下子找到该条记录(id=10的记录），然后对该条记录加排他锁，T2，同样，一下子通过索引定位到记录，然后对id=20的记录加排他锁，这样T1和T2各更新各的，互不影响。T2也不需要等。\n|–如果id是普通的一列，没有索引。那么当T1对id=10这一行加排他锁后，T2为了找到id=20，需要对全表扫描。但因为T1已经为一条记录加了排他锁，导致T2的全表扫描进行不下去（其实是因为T1加了排他锁，数据库默认会为该表加意向锁，T2要扫描全表，就得等该意向锁释放，也就是T1执行完成），就导致T2等待。\n死锁怎么解决呢？一种办法是，如下：\n例6：\nT1:begin tran\n1 2 3 select * from table for update update table set column1='hello' T2:begin tran\n1 2 3 select * from table for update update table set column1='world' 这样，当 T1 的 select 执行时，直接对表加上了排他锁，T2 在执行 select 时，就需要等 T1 事物完全执行完才能执行。排除了死锁发生。但当第三个 user 过来想执行一个查询语句时，也因为排他锁的存在而不得不等待，第四个、第五个 user 也会因此而等待。在大并发情况下，让大家等待显得性能就太友好了。\n所以，有些数据库这里引入了更新锁（如Mssql，注意：Mysql不存在更新锁）。\n例7：\nT1:begin tran\n1 2 3 select * from table [加更新锁操作] update table set column1='hello' T2:begin tran\n1 2 3 select * from table [加更新锁操作] update table set column1='world' 更新锁其实就可以看成排他锁的一种变形，只是它也允许其他人读（并且还允许加共享锁）。但不允许其他操作，除非我释放了更新锁。T1 执行 select，加更新锁。T2 运行，准备加更新锁，但发现已经有一个更新锁在那儿了，只好等。当后来有 user3、user4…需要查询 table 表中的数据时，并不会因为 T1 的 select 在执行就被阻塞，照样能查询，相比起例6，这提高了效率。\n后面还有意向锁和计划锁：\n计划锁，和程序员关系不大，就没去了解。 意向锁（innodb特有）分意向共享锁和意向排他锁。 意向共享锁：表示事务获取行共享锁时，必须先得获取该表的意向共享锁； 意向排他锁：表示事务获取行排他锁时，必须先得获取该表的意向排他锁； 我们知道，如果要对整个表加锁，需保证该表内目前不存在任何锁。\n因此，如果需要对整个表加锁，那么就可以根据：检查意向锁是否被占用，来知道表内目前是否存在共享锁或排他锁了。而不需要再一行行地去检查每一行是否被加锁。\n四、乐观锁与悲观锁\n首先说明，乐观锁和悲观锁都是针对读（select）来说的。\n案例：\n某商品，用户购买后库存数应-1，而某两个或多个用户同时购买，此时三个执行程序均同时读得库存为“n”，之后进行了一些操作，最后将均执行update table set 库存数=n-1，那么，很显然这是错误的。\n解决：\n使用悲观锁（其实说白了也就是排他锁）\n|– 程序A在查询库存数时使用排他锁（select * from table where id=10 for update）\n|– 然后进行后续的操作，包括更新库存数，最后提交事务。\n|– 程序B在查询库存数时，如果A还未释放排他锁，它将等待……\n|– 程序C同B…… 使用乐观锁（靠表设计和代码来实现）\n|– 一般是在该商品表添加version版本字段或者timestamp时间戳字段\n|– 程序A查询后，执行更新变成了： update table set num=num-1 where id=10 and version=23\n这样，保证了修改的数据是和它查询出来的数据是一致的（其他执行程序肯定未进行修改）。当然，如果更新失败，表示在更新操作之前，有其他执行程序已经更新了该库存数，那么就可以尝试重试来保证更新成功。为了尽可能避免更新失败，可以合理调整重试次数（阿里巴巴开发手册规定重试次数不低于三次）。 总结：对于以上，可以看得出来乐观锁和悲观锁的区别：\n悲观锁实际使用了排他锁来实现（select **** for update）。文章开头说到，innodb加行锁的前提是：必须是通过索引条件来检索数据，否则会切换为表锁。\n因此，悲观锁在未通过索引条件检索数据时，会锁定整张表。导致其他程序不允许“加锁的查询操作”，影响吞吐。故如果在查询居多的情况下，推荐使用乐观锁。\n“加锁的查询操作”：加过排他锁的数据行在其他事务中是不能修改的，也不能通过for update或lock in share mode的加锁方式查询，但可以直接通过select …from…查询数据，因为普通查询没有任何锁机制。 乐观锁更新有可能会失败，甚至是更新几次都失败，这是有风险的。所以如果写入居多，对吞吐要求不高，可使用悲观锁。 也就是一句话：读用乐观锁，写用悲观锁。\n间隙锁\n1.什么叫间隙锁 当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但不存在的记录，叫做“间隙(GAP)”，InnoDB也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁(NEXT-KEY)锁。\n2.间隙锁的产生 上面的文字很抽象，现在举个栗子，介绍间隙锁是怎么产生的：\n假设有以下表t_student：（其中id为PK，name为非唯一索引）\r这个时候我们发出一条这样的加锁sql语句：\nselect id,name from t_student where id \u003e 0 and id \u003c 5 for update;\n这时候，我们命中的数据为以下着色部分：\n细心的朋友可能就会发现，这里缺少了条id为2的记录，我们的重点就在这里。\nselect … for update这条语句，是会对数据记录加锁的，这里因为命中了索引，加的是行锁。从数据记录来看，这里排它锁锁住数据是id为1、3和4的这3条数据。\n但是，看看前面我们的介绍——对于键值在条件范围内但不存在的记录，叫做“间隙(GAP)”，InnoDB也会对这个“间隙”加锁。\n好了，我们这里，键值在条件范围但是不存在的记录，就是id为2的记录，这里会对id为2数据加上间隙锁。假设这时候如果有id=2的记录insert进来了，是要等到这个事务结束以后才会执行的\n3.间隙锁的作用 总的来说，有2个作用：防止幻读和防止数据误删/改\n(1)防止幻读 关于幻读的概念可以参考这篇文章 https://blog.csdn.net/mweibiao/article/details/80805031 ，这里就不多做解释了\n假设有下面场景\r如果没有间隙锁，事务A在T1和T4读到的结果是不一样的，有了间隙锁，读的就是一样的了\n(2)防止数据误删/改 这个作用比较重要，假设以下场景：\n这种情况下，如果没有间隙锁，会出现的问题是：id为2的记录，刚加进去，就被删除了，这种情况有时候对业务，是致命性的打击。加了间隙锁之后，由于insert语句要等待事务A执行完之后释放锁，避免了这种情况\n4.使用间隙锁的隐患 最大的隐患就是性能问题\n前面提到，假设这时候如果有id=2的记录insert进来了，是要等到这个事务结束以后才会执行的，假设是这种场景\r这种情况，对插入的性能就有很大影响了，必须等到事务结束才能进行插入，性能大打折扣\n更有甚者，如果间隙锁出现死锁的情况下，会更隐晦，更难定位\n怎样避免死锁 1、以固定的顺序访问表和行。比如两个更新数据的事务，事务A 更新数据的顺序 为1，2；事务B更新数据的顺序为2，1。这样更可能会造成死锁。\n2、大事务拆小。大事务更倾向于死锁，如果业务允许，将大事务拆小。\n3、在同一个事务中，尽可能做到一次锁定所需要的所有资源，减少死锁概率。\n4、降低隔离级别。如果业务允许，将隔离级别调低也是较好的选择，比如将隔离级别从RR调整为RC，可以避免掉很多因为gap锁造成的死锁。\n5、为表添加合理的索引。可以看到如果不走索引将会为表的每一行记录添加上锁，死锁的概率大大增大。\n",
  "wordCount" : "23396",
  "inLanguage": "zh",
  "datePublished": "2022-08-23T15:36:53+08:00",
  "dateModified": "2022-11-29T15:36:53+08:00",
  "author":[{
    "@type": "Person",
    "name": "叶灰灰"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://habyss.github.io/posts/read/mysql%E5%9C%B0%E5%9F%BA_%E4%BC%98%E5%8C%96/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "叶灰灰的小窝",
    "logo": {
      "@type": "ImageObject",
      "url": "https://habyss.github.io/gif/hwlm.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://habyss.github.io/" accesskey="h" title="叶灰灰的小窝 (Alt + H)">叶灰灰的小窝</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://habyss.github.io/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/archives" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://habyss.github.io/">主页</a>&nbsp;»&nbsp;<a href="https://habyss.github.io/posts/">Posts</a>&nbsp;»&nbsp;<a href="https://habyss.github.io/posts/read/">📕阅读</a></div>
    <h1 class="post-title">
      MySQL补充
    </h1>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#mysql-%e5%9c%b0%e5%9f%ba%e5%9f%ba%e7%a1%80%e4%ba%8b%e5%8a%a1%e5%92%8c%e9%94%81%e7%9a%84%e9%9d%a2%e7%ba%b1" aria-label="MySQL 地基基础：事务和锁的面纱">MySQL 地基基础：事务和锁的面纱</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e4%ba%8b%e5%8a%a1%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e4%ba%8b%e5%8a%a1" aria-label="什么是事务，为什么需要事务">什么是事务，为什么需要事务</a></li>
                <li>
                    <a href="#%e7%94%a8%e6%97%a5%e5%b8%b8%e7%bb%86%e8%af%b4%e4%ba%8b%e5%8a%a1%e7%9a%84%e7%89%b9%e6%80%a7" aria-label="用日常细说事务的特性">用日常细说事务的特性</a></li>
                <li>
                    <a href="#mysql-%e5%b9%b6%e5%8f%91%e6%8e%a7%e5%88%b6%e6%8a%80%e6%9c%af" aria-label="MySQL 并发控制技术">MySQL 并发控制技术</a></li>
                <li>
                    <a href="#%e9%9d%a2%e8%af%95%e5%86%8d%e4%b9%9f%e4%b8%8d%e6%80%95%e8%a2%ab%e9%97%ae%e5%88%b0%e7%9a%84-mvcc" aria-label="面试再也不怕被问到的 MVCC">面试再也不怕被问到的 MVCC</a></li>
                <li>
                    <a href="#%e7%ae%80%e5%8d%95%e6%98%93%e6%87%82%e7%9a%84%e5%ae%9e%e4%be%8b%e5%b8%ae%e4%bd%a0%e7%90%86%e8%a7%a3-mysql-%e4%ba%8b%e5%8a%a1%e9%9a%94%e7%a6%bb%e7%ba%a7%e5%88%ab" aria-label="简单易懂的实例帮你理解 MySQL 事务隔离级别">简单易懂的实例帮你理解 MySQL 事务隔离级别</a><ul>
                        
                <li>
                    <a href="#%e8%af%bb%e6%9c%aa%e6%8f%90%e4%ba%a4" aria-label="读未提交">读未提交</a></li>
                <li>
                    <a href="#%e8%af%bb%e6%8f%90%e4%ba%a4" aria-label="读提交">读提交</a></li>
                <li>
                    <a href="#%e5%8f%af%e9%87%8d%e5%a4%8d%e8%af%bb" aria-label="可重复读">可重复读</a></li>
                <li>
                    <a href="#%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="序列化">序列化</a></li></ul>
                </li>
                <li>
                    <a href="#mysql-%e9%94%81%e6%9c%ba%e5%88%b6%e6%9c%ba%e6%99%ba" aria-label="MySQL 锁机制（机智）">MySQL 锁机制（机智）</a></li>
                <li>
                    <a href="#%e8%81%8a%e5%87%a0%e4%b8%aa%e7%bb%8f%e5%85%b8%e6%ad%bb%e9%94%81%e6%a1%88%e4%be%8b" aria-label="聊几个经典死锁案例">聊几个经典死锁案例</a><ul>
                        
                <li>
                    <a href="#%e5%9c%ba%e6%99%af-1insert-%e6%ad%bb%e9%94%81" aria-label="场景 1：insert 死锁">场景 1：insert 死锁</a></li>
                <li>
                    <a href="#%e5%9c%ba%e6%99%af-2%e8%87%aa%e5%a2%9e%e5%88%97%e6%ad%bb%e9%94%81" aria-label="场景 2：自增列死锁">场景 2：自增列死锁</a></li>
                <li>
                    <a href="#%e5%9c%ba%e6%99%af-3rollback-%e6%ad%bb%e9%94%81" aria-label="场景 3：rollback 死锁">场景 3：rollback 死锁</a></li>
                <li>
                    <a href="#%e5%9c%ba%e6%99%af-4commit-%e6%ad%bb%e9%94%81" aria-label="场景 4：commit 死锁">场景 4：commit 死锁</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b0%8f%e6%8a%80%e5%b7%a7%e4%ba%8b%e5%8a%a1%e4%bf%9d%e5%ad%98%e7%82%b9%e5%b8%ae%e4%bd%a0%e8%af%bb%e6%a1%a3%e9%87%8d%e9%97%af%e5%85%b3" aria-label="小技巧——事务保存点帮你读档重闯关">小技巧——事务保存点帮你读档重闯关</a></li>
                <li>
                    <a href="#%e5%b0%8f%e6%8a%80%e5%b7%a7%e4%b8%80%e4%b8%aa%e6%ad%bb%e9%94%81%e7%9a%84%e5%85%b7%e4%bd%93%e5%88%86%e6%9e%90%e6%96%b9%e6%b3%95" aria-label="小技巧——一个死锁的具体分析方法">小技巧——一个死锁的具体分析方法</a></li>
                <li>
                    <a href="#%e5%b0%8f%e6%8a%80%e5%b7%a7%e6%8d%a2%e7%a7%8d%e6%80%9d%e8%b7%af%e6%8f%90%e9%ab%98%e4%ba%8b%e5%8a%a1%e8%83%bd%e5%8a%9b" aria-label="小技巧——换种思路提高事务能力">小技巧——换种思路提高事务能力</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#mysql-%e5%9c%b0%e5%9f%ba%e5%9f%ba%e7%a1%80%e6%95%b0%e6%8d%ae%e5%ba%93%e5%ad%97%e7%ac%a6%e9%9b%86" aria-label="MySQL 地基基础：数据库字符集">MySQL 地基基础：数据库字符集</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e5%ad%97%e7%ac%a6%e9%9b%86%e7%ae%80%e4%bb%8b" aria-label="字符集简介">字符集简介</a></li>
                <li>
                    <a href="#%e5%ad%97%e7%ac%a6%e9%9b%86%e5%88%86%e7%b1%bb%e4%b8%8e%e7%89%b9%e7%82%b9" aria-label="字符集分类与特点">字符集分类与特点</a></li>
                <li>
                    <a href="#mysql-%e4%b8%8e%e5%ad%97%e7%ac%a6%e9%9b%86%e4%b9%8b%e9%97%b4%e4%ba%b2%e5%af%86%e5%85%b3%e7%b3%bb" aria-label="MySQL 与字符集之间亲密关系">MySQL 与字符集之间亲密关系</a></li>
                <li>
                    <a href="#%e5%ad%97%e7%ac%a6%e9%9b%86%e7%bc%96%e7%a0%81%e5%8e%9f%e7%90%86" aria-label="字符集编码原理">字符集编码原理</a></li>
                <li>
                    <a href="#%e5%ad%97%e7%ac%a6%e9%9b%86%e4%b8%8e%e6%a0%a1%e5%af%b9%e8%a7%84%e5%88%99%e5%88%86%e6%9e%90" aria-label="字符集与校对规则分析">字符集与校对规则分析</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e6%9b%b4%e6%94%b9-mysql-%e5%ad%97%e7%ac%a6%e9%9b%86" aria-label="如何更改 MySQL 字符集">如何更改 MySQL 字符集</a></li>
                <li>
                    <a href="#%e5%ad%97%e7%ac%a6%e9%9b%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" aria-label="字符集最佳实践">字符集最佳实践</a><ul>
                        
                <li>
                    <a href="#%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%ba%a7%e8%ae%be%e7%bd%ae%e5%ad%97%e7%ac%a6%e9%9b%86" aria-label="服务器级设置字符集">服务器级设置字符集</a></li>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e5%ba%93%e7%ba%a7%e8%ae%be%e7%bd%ae%e5%ad%97%e7%ac%a6%e9%9b%86" aria-label="数据库级设置字符集">数据库级设置字符集</a></li>
                <li>
                    <a href="#%e8%a1%a8%e7%ba%a7%e8%ae%be%e7%bd%ae%e5%ad%97%e7%ac%a6%e9%9b%86" aria-label="表级设置字符集">表级设置字符集</a></li>
                <li>
                    <a href="#%e5%88%97%e7%ba%a7%e8%ae%be%e7%bd%ae%e5%ad%97%e7%ac%a6%e9%9b%86" aria-label="列级设置字符集">列级设置字符集</a></li></ul>
                </li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#mysql-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e7%a2%8e%e7%89%87%e6%95%b4%e7%90%86" aria-label="MySQL 性能优化：碎片整理">MySQL 性能优化：碎片整理</a><ul>
                        <ul>
                        
                <li>
                    <a href="#mysql-%e7%a2%8e%e7%89%87%e6%98%af%e4%bb%80%e4%b9%88" aria-label="MySQL 碎片是什么">MySQL 碎片是什么</a></li>
                <li>
                    <a href="#%e7%a2%8e%e7%89%87%e6%98%af%e5%a6%82%e4%bd%95%e4%ba%a7%e7%94%9f%e7%9a%84" aria-label="碎片是如何产生的">碎片是如何产生的</a></li>
                <li>
                    <a href="#%e7%a2%8e%e7%89%87%e5%88%b0%e5%ba%95%e4%ba%a7%e7%94%9f%e4%ba%86%e4%bb%80%e4%b9%88%e5%bd%b1%e5%93%8d" aria-label="碎片到底产生了什么影响">碎片到底产生了什么影响</a></li>
                <li>
                    <a href="#%e6%89%be%e4%b8%80%e6%89%be%e6%9c%89%e5%93%aa%e4%ba%9b%e7%a2%8e%e7%89%87" aria-label="找一找有哪些碎片">找一找有哪些碎片</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e6%b8%85%e7%90%86%e7%a2%8e%e7%89%87" aria-label="如何清理碎片">如何清理碎片</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#mysql-%e6%95%85%e9%9a%9c%e8%af%8a%e6%96%ad%e4%b8%80%e4%b8%aa-alter-talbe-%e6%89%a7%e8%a1%8c%e4%ba%86%e5%be%88%e4%b9%85%e4%bd%a0%e6%85%8c%e4%b8%8d%e6%85%8c" aria-label="MySQL 故障诊断：一个 ALTER TALBE 执行了很久，你慌不慌？">MySQL 故障诊断：一个 ALTER TALBE 执行了很久，你慌不慌？</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e5%85%88%e4%ba%86%e8%a7%a3%e4%b8%8b-mysql-%e6%95%b0%e6%8d%ae%e5%ad%97%e5%85%b8" aria-label="先了解下 MySQL 数据字典">先了解下 MySQL 数据字典</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e4%b8%80%e4%ba%9b%e9%87%8d%e8%a6%81%e7%9a%84%e9%87%8d%e8%a6%81%e5%8a%9f%e8%83%bd" aria-label="使用一些重要的重要功能">使用一些重要的重要功能</a></li>
                <li>
                    <a href="#%e7%9b%b4%e8%a7%82%e7%9a%84%e8%a7%82%e5%af%9f%e4%ba%8b%e4%bb%b6%e6%89%a7%e8%a1%8c%e8%bf%9b%e5%ba%a6" aria-label="直观的观察事件执行进度">直观的观察事件执行进度</a></li>
                <li>
                    <a href="#%e6%94%b6%e4%b8%8b%e8%bf%99%e4%b8%aa%e5%b8%b8%e7%94%a8%e7%9a%84-sql" aria-label="收下这个常用的 SQL">收下这个常用的 SQL</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#mysql-%e6%95%85%e9%9a%9c%e8%af%8a%e6%96%ad%e6%95%99%e4%bd%a0%e5%bf%ab%e9%80%9f%e5%ae%9a%e4%bd%8d%e5%8a%a0%e9%94%81%e7%9a%84-sql" aria-label="MySQL 故障诊断：教你快速定位加锁的 SQL">MySQL 故障诊断：教你快速定位加锁的 SQL</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%bc%9a%e5%8a%a0%e9%94%81" aria-label="为什么会加锁">为什么会加锁</a></li>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e5%ba%93%e9%94%81%e6%9c%89%e4%bb%80%e4%b9%88%e5%a8%81%e5%8a%9b" aria-label="数据库锁有什么威力">数据库锁有什么威力</a></li>
                <li>
                    <a href="#%e5%bf%ab%e9%80%9f%e5%ae%9a%e4%bd%8d%e5%8a%a0%e9%94%81%e7%9a%84-sql" aria-label="快速定位加锁的 SQL">快速定位加锁的 SQL</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#mysql%e4%bc%98%e5%8c%96%e4%bc%98%e5%8c%96-select-count" aria-label="MySQL优化：优化 select count()">MySQL优化：优化 select count()</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e4%b8%9a%e5%8a%a1%e5%8f%8d%e9%a6%88%e5%bc%80%e5%8f%91%e5%b4%a9%e6%ba%83" aria-label="业务反馈，开发崩溃">业务反馈，开发崩溃</a></li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98%e5%a4%8d%e7%8e%b0%e4%bc%98%e5%8c%96%e5%a4%84%e7%90%86" aria-label="问题复现，优化处理">问题复现，优化处理</a></li>
                <li>
                    <a href="#%e6%89%92%e4%b8%80%e6%89%92-count-%e7%9a%84%e5%8e%9f%e7%90%86" aria-label="扒一扒 count(*) 的原理">扒一扒 count(*) 的原理</a></li>
                <li>
                    <a href="#%e6%98%be%e8%80%8c%e6%98%93%e8%a7%81%e7%9a%84%e9%aa%8c%e8%af%81" aria-label="显而易见的验证">显而易见的验证</a><ul>
                        
                <li>
                    <a href="#%e9%aa%8c%e8%af%81%e8%81%9a%e7%b0%87%e7%b4%a2%e5%bc%95" aria-label="验证聚簇索引">验证聚簇索引</a></li>
                <li>
                    <a href="#%e9%aa%8c%e8%af%81%e4%ba%8c%e7%ba%a7%e7%b4%a2%e5%bc%95" aria-label="验证二级索引">验证二级索引</a></li>
                <li>
                    <a href="#%e6%9b%b4%e5%8a%a0%e7%9b%b4%e8%a7%82%e7%9c%8b%e4%b8%80%e4%b8%8b%e4%b8%a4%e7%a7%8d%e7%b4%a2%e5%bc%95%e5%8d%a0%e7%94%a8%e7%9a%84%e7%a9%ba%e9%97%b4%e5%a4%a7%e5%b0%8f" aria-label="更加直观看一下两种索引占用的空间大小">更加直观看一下两种索引占用的空间大小</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93%e4%b8%8e%e6%80%9d%e8%80%83" aria-label="总结与思考">总结与思考</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#mysql%e5%85%b1%e4%ba%ab%e9%94%81%e6%8e%92%e4%bb%96%e9%94%81%e6%82%b2%e8%a7%82%e9%94%81%e4%b9%90%e8%a7%82%e9%94%81" aria-label="MySQL共享锁、排他锁、悲观锁、乐观锁">MySQL共享锁、排他锁、悲观锁、乐观锁</a><ul>
                        
                <li>
                    <a href="#2%e9%98%b2%e6%ad%a2%e6%95%b0%e6%8d%ae%e8%af%af%e5%88%a0%e6%94%b9" aria-label="　(2)防止数据误删/改">　　<strong>(2)防止数据误删/改</strong></a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="mysql-地基基础事务和锁的面纱">MySQL 地基基础：事务和锁的面纱<a hidden class="anchor" aria-hidden="true" href="#mysql-地基基础事务和锁的面纱">#</a></h1>
<h3 id="什么是事务为什么需要事务">什么是事务，为什么需要事务<a hidden class="anchor" aria-hidden="true" href="#什么是事务为什么需要事务">#</a></h3>
<p>在 MySQL 中，事务是由一条或多条 SQL 组成的单位，在这个单位中所有的 SQL 共存亡，有点有福同享，有难同当的意思。要么全部成功，事务顺利完成；要么只要有一个 SQL 失败就会导致整个事务失败，所有已经做过的操作回退到原始数据状态。</p>
<h3 id="用日常细说事务的特性">用日常细说事务的特性<a hidden class="anchor" aria-hidden="true" href="#用日常细说事务的特性">#</a></h3>
<p>首先我们先说一下事务的四个特性：ACID。</p>
<ul>
<li>A：原子性（atomicity），一个事务要么全都成功，要么全都失败</li>
<li>C：一致性（consistency），在事务的整个生命周期里，查询的数据是一致的，保证数据库不会返回未提交的事务的数据</li>
<li>I：隔离性（isolation），一个事务所做的操作，在最终提交前，对其他事务是不可见的，保证事务与事务之间不会冲突</li>
<li>D：持久性（durability），只要事务提交，数据就不会丢失，即使系统崩溃，事务也已经完成</li>
</ul>
<p>在日常生活中有很多的事情就能体现为数据库中的事务。比如“转账”，下面我们就具体展开，你就可以很清晰的认识事务的四个特性。</p>
<ul>
<li>时间：2020 年 1 月 1 日</li>
<li>地点：某银行 ATM</li>
<li>人物：A 和 B</li>
<li>起因：B 向 A 借 1000 元人民币</li>
<li>经过：A 转账给 B</li>
<li>结果：转账成功或失败</li>
</ul>
<p>这么一个转账我们想一下底层基本的技术支撑与实现，B 向 A 借钱，A 要转账给 B，首先 A 必须有大于 1000 元的余额，然后从 A 的账户减 1000 元，在 B 的账户里加 1000 元。</p>
<p>我们定义一个事务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">获取</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="err">账户余额</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">在</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="err">账户里减</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="err">元</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">update</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">balance</span><span class="o">=</span><span class="n">balance</span><span class="o">-</span><span class="mi">1000</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">获取</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="err">账户余额</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">在</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="err">账户里加</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="err">元</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">update</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">balance</span><span class="o">=</span><span class="n">balance</span><span class="o">+</span><span class="mi">1000</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>好了，一个简单事务基本就这样，我们开始分析分析这个事务是如何保证事务的 ACID 的。</p>
<ul>
<li><strong>原子性</strong>：这个事务要么全成功，要么全失败。事务成功则 1000 元转账到了 B 账户，事务失败回滚则 1000 元还在 A 账户里，就是说 1000 元不能凭空消失。</li>
<li><strong>一致性</strong>：在这个事务中，所有的查询都是一致的，我们先查询 A 账户余额是否大于 1000，如果小于 1000，事务失败回滚；如果获取不到 B 账户余额，事务失败回滚。</li>
<li><strong>隔离性</strong>：在这个事务发生的同时，发生了另一个事务（A 通过手机银行将钱全部转移到另外的账户，比如一共有 1500 元），第一个事务转 1000 元，第二个事务转 1500 元，我们仔细想想，如果都成功，那岂不是凭空获取了 1000 元，这是不合理的，每个事务在执行前都应查一下余额是否够本次转账的。这两个事务应该是隔离的，不能有冲突。</li>
<li><strong>持久性</strong>：转账成功了（即事务完成），这代表钱已经发生了转移，这个时候发生 ATM 吞卡、ATM 断电、手机银行无法登陆等等一切故障，反正钱已经转走了，钱没有丢（即数据没有丢）</li>
</ul>
<h3 id="mysql-并发控制技术">MySQL 并发控制技术<a hidden class="anchor" aria-hidden="true" href="#mysql-并发控制技术">#</a></h3>
<p>并发控制技术可以说是数据库的底层基础技术，并发控制技术可以拆分来看，一是并发，一是控制。并发也就是说大量请求连接到数据库，控制就是数据库要控制好这些连接，保证资源的可用性、安全性，解决资源的挣用的问题。</p>
<p>那么如何实现并控制呢？主要通过两个方面：</p>
<ul>
<li>Lock</li>
<li>MVCC</li>
</ul>
<p>先分别简单说一下 Lock 和 MVCC，具体的后面再聊。</p>
<ul>
<li>Lock，并发连接到数据库，操作有读和读、读和写、写和写，锁来保证并发连接使得数据可以保持一致性。</li>
<li>MVCC（Multiversion Concurrency Control），多版本并发控制，是数据库的多版本，可以提高并发过程中的读和写操作，有效的避免写请求阻塞读请求。</li>
</ul>
<h3 id="面试再也不怕被问到的-mvcc">面试再也不怕被问到的 MVCC<a hidden class="anchor" aria-hidden="true" href="#面试再也不怕被问到的-mvcc">#</a></h3>
<p>前面我们已经大致了解了 MVCC 是什么，以及他做什么事情，现在我们具体看看 MVCC 是如何工作的？</p>
<p>我们知道数据的一致性，可以通过锁来保证，在并发连接中，锁机制在读和读的并发请求中不会锁数据，但是在读和写的并发请求中，写请求会加锁，读请求会被写请求阻塞，基于此，MVCC 发挥其作用。</p>
<p>MVCC 控制两类操作：</p>
<ul>
<li>快照读：读取的是历史可见版本的数据，无锁</li>
<li>当前读：读取的是当前最新版本的数据，加锁</li>
</ul>
<p>我们举个例子说一下吧，比如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">tab1</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">decimal</span><span class="p">,</span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">address</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">status</span><span class="w"> </span><span class="nb">decimal</span><span class="p">,</span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">id</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">tab1</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;beijing&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>表中数据为：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">name</th>
<th style="text-align:left">address</th>
<th style="text-align:left">status</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">a</td>
<td style="text-align:left">beijing</td>
<td style="text-align:left">1</td>
</tr>
</tbody>
</table>
<p>现在有一个请求，将数据 a 的地址改为 shanghai，这个数据更新的过程，我们细化一下，将历史数据置为失效，将新的数据插入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="n">tab1</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">tab1</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;shanghai&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>表中数据为：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">name</th>
<th style="text-align:left">address</th>
<th style="text-align:left">status</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">a</td>
<td style="text-align:left">beijing</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">a</td>
<td style="text-align:left">shanghai</td>
<td style="text-align:left">1</td>
</tr>
</tbody>
</table>
<p>MVCC 的原理就类似是这样的，<code>address='beijing'</code> 就是历史数据，更新前保存了下来，<code>address='shanghai'</code> 就是当前数据，新插入数据，这样并发连接来了，既可以读取历史数据，也可以修改当前数据。比如，现在有三个事务：</p>
<ul>
<li>T1 -&gt; 要执行 update address</li>
<li>T2 -&gt; 要执行 update address</li>
<li>T3 -&gt; 要执行 update address</li>
</ul>
<p>T1 先获取了表中这一行数据，执行了 update，未提交；T2 获取表中这一行数据，由于 T1 未提交，address=&lsquo;beijing&rsquo;,这个 beijing 就来源历史数据；T3 也获取表中这一行数据，由于 T1 未提交，<code>address='beijing'</code>，这个 beijing 也来源历史数据。这样是不是好理解了。</p>
<p>以此类推，如果只对 <code>name='a'</code> 这一行数据有 N 个并发连接要做 M 个操作，这些历史数据都保存在表中，这个表的数据量无法预估，势必会造成压力与瓶颈。多版本数据到底如何保存，这就不是本节考虑的问题了，是数据库 undo 帮你做的工作。这里就不展开了。（后期可能会做 undo 相关的 chat，大家可以关注我）</p>
<h3 id="简单易懂的实例帮你理解-mysql-事务隔离级别">简单易懂的实例帮你理解 MySQL 事务隔离级别<a hidden class="anchor" aria-hidden="true" href="#简单易懂的实例帮你理解-mysql-事务隔离级别">#</a></h3>
<p>事务隔离级别，拆分来看，事务、隔离、级别，故是三个概念的集合，是保证事务之间相互隔离互不影响的，有多个级别。事务在执行过程中可能会出现脏读、不可重复读、幻读，那么 MySQL 的事务隔离级别到底有怎样的表现呢？</p>
<table>
<thead>
<tr>
<th style="text-align:left">事务隔离级别</th>
<th style="text-align:left">脏读</th>
<th style="text-align:left">不可重复读</th>
<th style="text-align:left">幻读</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">读未提交(Read-Uncommited)</td>
<td style="text-align:left">可能</td>
<td style="text-align:left">可能</td>
<td style="text-align:left">可能</td>
</tr>
<tr>
<td style="text-align:left">读提交(Read-Commited)</td>
<td style="text-align:left">不可能</td>
<td style="text-align:left">可能</td>
<td style="text-align:left">可能</td>
</tr>
<tr>
<td style="text-align:left">可重复读交(Repeatable-Read)</td>
<td style="text-align:left">不可能</td>
<td style="text-align:left">不可能</td>
<td style="text-align:left">可能</td>
</tr>
<tr>
<td style="text-align:left">序列化(Serializable)</td>
<td style="text-align:left">不可能</td>
<td style="text-align:left">不可能</td>
<td style="text-align:left">不可能</td>
</tr>
</tbody>
</table>
<p>那么到底什么是脏读、不可重复读、幻读呢？</p>
<ul>
<li><strong>脏读</strong>：一个事务读取了另一个未提交事务操作的数据。</li>
<li><strong>不可重复读</strong>：一个事务重新读取前面读取过的数据时，发现该数据已经被修改了或者不见了，其实已被另一个已提交的事务操作了。解决了脏读的问题。</li>
<li><strong>幻读</strong>：一个事务，需要更新数据，于是重新提交了一个查询，返回符合查询条件行，发现这些行因为其他提交的事务发生了改变，这些数据像“幻影”一样出现了。解决了不可重复读。</li>
</ul>
<p>接下来我们用具体实例分析各个事务隔离级别。</p>
<p>创建测试表 t_account：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">t_account</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">balance</span><span class="w"> </span><span class="nb">decimal</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t_account</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t_account</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="读未提交">读未提交<a hidden class="anchor" aria-hidden="true" href="#读未提交">#</a></h4>
<p>设置事务隔离级别：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">mysql</span><span class="p">&gt;</span> <span class="k">set</span> <span class="n">global</span> <span class="n">tx_isolation</span><span class="p">=</span><span class="err">&#39;</span><span class="n">read</span><span class="p">-</span><span class="n">uncommitted</span><span class="err">&#39;</span><span class="p">;</span>          
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询事务隔离级别：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@@</span><span class="n">tx_isolation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="o">@@</span><span class="n">tx_isolation</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">READ</span><span class="o">-</span><span class="k">UNCOMMITTED</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>当前事务可以读取另一个未提交事务操作的数据。</strong></p>
<p>环境：用户 A 有 100 元钱，给用户 A 增加 100 元，然后用户 A 转账给用户 B。</p>
<table>
<thead>
<tr>
<th style="text-align:left">事务 1</th>
<th style="text-align:left">事务 2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">begin;</td>
<td style="text-align:left">begin;</td>
</tr>
<tr>
<td style="text-align:left">update t_account set balance=balance+100 where name=&lsquo;A&rsquo;; #给用户 A 增加 100 元</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">select balance from t_account where name=&lsquo;A&rsquo;; #转账前查询用户 A 余额为 200 元</td>
</tr>
<tr>
<td style="text-align:left">rollback; #决定不给用户 A 增加 100 元了，事务回滚</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">update t_account set balance=balance-200 where name=&lsquo;A&rsquo;; #用户 A 继续给用户 B 转账，用户 A 减 200 元</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">update t_account set balance=balance+200 where name=&lsquo;B&rsquo;; #用户 A 继续给用户 B 转账，用户加加 200 元</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">commit; #提交事务</td>
</tr>
</tbody>
</table>
<p>现在我们查询一下用户 A 和用户 B 的余额：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t_account</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">A</span><span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="o">-</span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">B</span><span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="mi">200</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>问题来了，这个结果不符合预期，用户 A 竟然是 -100 元，用户 B 增加了 200 元，这是因为事务 2 读取了事务 1 未提交的数据。</p>
<h4 id="读提交">读提交<a hidden class="anchor" aria-hidden="true" href="#读提交">#</a></h4>
<p>设置事务隔离级别：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">mysql</span><span class="p">&gt;</span> <span class="k">set</span> <span class="n">global</span> <span class="n">tx_isolation</span><span class="p">=</span><span class="err">&#39;</span><span class="n">read</span><span class="p">-</span><span class="n">committed</span><span class="err">&#39;</span><span class="p">;</span>          
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询事务隔离级别：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@@</span><span class="n">tx_isolation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="o">@@</span><span class="n">tx_isolation</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">READ</span><span class="o">-</span><span class="k">COMMITTED</span><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>当前事务只能读取另一个提交事务操作的数据。</strong></p>
<p>环境：用户 A 有 100 元钱，给用户 A 增加 100 元。</p>
<table>
<thead>
<tr>
<th style="text-align:left">事务 1</th>
<th style="text-align:left">事务 2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">begin;</td>
<td style="text-align:left">begin;</td>
</tr>
<tr>
<td style="text-align:left">update t_account set balance=balance+100 where name=&lsquo;A&rsquo;; #给用 A 增加 100 元</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">select * from t_account where name=&lsquo;A&rsquo;; #事务 2 查用户的余额，因事务 1 未提交，仍为 100 元</td>
</tr>
<tr>
<td style="text-align:left">commit;</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">select * from t_account where name=&lsquo;A&rsquo;; #事务 2 查用户的余额，事务 1 已提交，变为 200 元</td>
</tr>
</tbody>
</table>
<p>一个事务重新读取前面读取过的数据时，发现该数据已经被修改了，其实已被另一个已提交的事务操作了。</p>
<h4 id="可重复读">可重复读<a hidden class="anchor" aria-hidden="true" href="#可重复读">#</a></h4>
<p>设置事务隔离级别：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">mysql</span><span class="p">&gt;</span> <span class="k">set</span> <span class="n">global</span> <span class="n">tx_isolation</span><span class="p">=</span><span class="err">&#39;</span><span class="n">repeatable</span><span class="p">-</span><span class="n">read</span><span class="err">&#39;</span><span class="p">;</span>          
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询事务隔离级别：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@@</span><span class="n">tx_isolation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="o">@@</span><span class="n">tx_isolation</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">REPEATABLE</span><span class="o">-</span><span class="k">READ</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>当前事务读取通过第一次读取建立的快照是一致的，即使另外一个事务提交了该数据。除非自己这个事务可以读取在自身事务中修改的数据。</strong></p>
<p>可重复读隔离级别是 MySQL 的默认隔离级别。</p>
<p>环境：用户 A 有 100 元钱，给用户 A 增加 100 元。</p>
<table>
<thead>
<tr>
<th style="text-align:left">事务 1</th>
<th style="text-align:left">事务 2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">begin;</td>
<td style="text-align:left">begin;</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">select * from t_account where name=&lsquo;A&rsquo;; #事务 2 查用户的余额，为 100 元</td>
</tr>
<tr>
<td style="text-align:left">update t_account set balance=balance+100 where name=&lsquo;A&rsquo;; #给用 A 增加 100 元</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">select * from t_account where name=&lsquo;A&rsquo;; #事务 2 查用户的余额，因事务 1 未提交，仍为 100 元</td>
</tr>
<tr>
<td style="text-align:left">commit;</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">select * from t_account where name=&lsquo;A&rsquo;; #事务 2 查用户的余额，事务 1 已提交，仍为 100 元</td>
</tr>
</tbody>
</table>
<p>这就能看出来，事务 2 开启后读取了用户 A 的余额，即使事务 1 修改了数据，不管提交与否，事务 2 读取的数据一直是之前第一次读取的数据。继续操作。</p>
<table>
<thead>
<tr>
<th style="text-align:left">事务 1</th>
<th style="text-align:left">事务 2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">commit;</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">select * from t_account where name=&lsquo;A&rsquo;; ###事务 2 查用户的余额，为 200 元</td>
</tr>
</tbody>
</table>
<p>为什么现在变成了 200 元了，因为事务 2 已经 commit，再次 select 是一个新的事务，读取数据当然又变为第一次获取数据（此时的数据是最新的数据）。</p>
<p>思考一下：上述这个举例是可重复读的 select 相关验证，如果是 DML 操作，会不会是同样的结果呢？</p>
<p>思考三分钟&hellip;&hellip;</p>
<p>答案是：其他事物即使查询不到的数据，DML 操作也可能会影响那些提交的数据。好，让我验证一下。</p>
<p>update 操作：</p>
<table>
<thead>
<tr>
<th style="text-align:left">事务 1</th>
<th style="text-align:left">事务 2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">begin;</td>
<td style="text-align:left">begin;</td>
</tr>
<tr>
<td style="text-align:left">select * from t_account; #有一行数据，用户 A，余额 100 元</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">insert into t_account values(&lsquo;B&rsquo;,100); #增加用户 B，余额 100 元</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">commit;</td>
</tr>
<tr>
<td style="text-align:left">select * from t_account where name=&lsquo;B&rsquo;; #无返回行，查询不到用户 B</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">update t_account set balance=balance+100 where name=&lsquo;B&rsquo;; #神奇，更新成功了</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">select * from t_account; #用户 A 余额 100，用户 B 余额 200</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">select * from t_account; #用户 A 余额 100，用户 B 余额 100</td>
</tr>
<tr>
<td style="text-align:left">commit;</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">select * from t_account; #用户 A 余额 100，用户 B 余额 200</td>
</tr>
</tbody>
</table>
<p>delete 操作：</p>
<table>
<thead>
<tr>
<th style="text-align:left">事务 1</th>
<th style="text-align:left">事务 2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">begin;</td>
<td style="text-align:left">begin;</td>
</tr>
<tr>
<td style="text-align:left">select * from t_account; #有 2 行数据，用户 A 余额 100 元，用户 B 余额 200</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">insert into t_account values(&lsquo;C&rsquo;,100); #增加用户 C，余额 100 元</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">commit;</td>
</tr>
<tr>
<td style="text-align:left">select * from t_account where name=&lsquo;C&rsquo;; #无返回行，查询不到用户 C</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">delete from t_account where name=&lsquo;C&rsquo;; #神奇，删除成功了</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">select * from t_account; #用户 A 余额 100，用户 B 余额 200</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">select * from t_account; #用户 A 余额 100，用户 B 余额 200，用户 C 余额 100</td>
</tr>
<tr>
<td style="text-align:left">commit;</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">select * from t_account; #户 A 余额 100，用户 B 余额 200</td>
</tr>
</tbody>
</table>
<p>通过这两个例子你是不是了解了一个事务的 update 和 delete 操作了另外一个事务提交的数据，会使得这些数据在当前事务变得可见。就像幻影一下出现了！</p>
<h4 id="序列化">序列化<a hidden class="anchor" aria-hidden="true" href="#序列化">#</a></h4>
<p>设置事务隔离级别：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">mysql</span><span class="p">&gt;</span> <span class="k">set</span> <span class="n">global</span> <span class="n">tx_isolation</span><span class="p">=</span><span class="err">&#39;</span><span class="n">serializable</span><span class="err">&#39;</span><span class="p">;</span>          
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询事务隔离级别：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@@</span><span class="n">tx_isolation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="o">@@</span><span class="n">tx_isolation</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">SERIALIZABLE</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>当前事务 select 和 DML 操作的数据都会加行锁，其他事务访问同样的数据需要等锁释放。</strong></p>
<p>环境：用户 A 有 100 元钱，给用户 A 增加 100 元。</p>
<table>
<thead>
<tr>
<th style="text-align:left">事务 1</th>
<th style="text-align:left">事务 2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">begin;</td>
<td style="text-align:left">begin;</td>
</tr>
<tr>
<td style="text-align:left">select * from t_account where name=&lsquo;A&rsquo;; #查询用户余额</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">update t_account set balance=balance+100 where name=&lsquo;A&rsquo;; #给用户 A 增加 100 元，执行一直处于等待</td>
</tr>
<tr>
<td style="text-align:left">commit;</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">update 成功返回</td>
</tr>
<tr>
<td style="text-align:left">select * from t_account where name=&lsquo;A&rsquo;; #用户 A 余额为 100，因为事务 2 还未提交，获取的是 undo 中的历史版本数据</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">begin;</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">select * from t_account where name=&lsquo;A&rsquo;; #新开一个事务，由于事务 2 还未提交，此查询锁等</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">commit;</td>
</tr>
<tr>
<td style="text-align:left">select * from t_account where name=&lsquo;A&rsquo;; #用户 A 余额 200</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<p>好了，实例讲解到此结束，是否已经帮你理解了 MySQL 事务隔离级别。</p>
<p>另外，结合前面说的 MVCC，Read-Committed 和 Repeatable-Read，支持 MVCC；Read-Uncommitted 由于可以读取未提交的数据，不支持 MVCC；Serializable 会对所有读取的数据加行锁，不支持 MVCC。</p>
<h3 id="mysql-锁机制机智">MySQL 锁机制（机智）<a hidden class="anchor" aria-hidden="true" href="#mysql-锁机制机智">#</a></h3>
<p>锁是可以协调并发连接访问 MySQL 数据库资源的一种技术，可以保证数据的一致性。锁有两个阶段：加锁和解锁，InnoDB 引擎的锁主要有两类。</p>
<p><strong>共享锁（S）</strong></p>
<p>允许一个事务读取数据，阻塞其他事务想要获取相同数据。共享锁之间不互斥，读和读操作可以并行。代码展示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">select</span> <span class="p">*</span> <span class="k">from</span> <span class="n">table</span> <span class="k">where</span> <span class="p">...</span> <span class="k">lock</span> <span class="k">in</span> <span class="n">share</span> <span class="n">mode</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>排它锁（X）</strong></p>
<p>持有排他锁的事务可以更新数据，阻塞其他事务获取数据的排他锁和共享锁。排它锁之间互斥，读和写、写和写操作不可以并行。代码展示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">update</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>从 MySQL 数据库的内外区分锁，有两种锁。</p>
<p><strong>内部锁</strong></p>
<p>MySQL 在数据库内部自动管理，协调并发连接的资源争用。内部锁再具体来看分为：</p>
<ul>
<li>行锁：会话事务将访问的行数据加锁</li>
<li>表锁：会话事务将访问的表整体加锁</li>
</ul>
<p><strong>外部锁</strong></p>
<p>会话层使用特殊的手段显示获取锁，阻塞其他会话对数据的操作。我们通过外部操作命令实现外部锁，比如使用 lock table 和 unlock tables。</p>
<p>我们举个例子来描述一下这个过程吧，比如有事务 1 和事务 2，事务 1 锁定了一行数据，加了一个 S 锁；事务 2 想要对整个表加锁，需要判断这个表是否被加了表锁，表中的每一行是否有行锁。仔细想想这个过程是很快呢？还是非常的慢？如果表很小无所谓了，如果表是海量级数据，那糟了，事务 2 势必耗费很多资源。</p>
<p>如何解决事务 2 这种检索资源消耗的问题呢？事务意向锁帮你先获取意向，先一步问问情况，然后再获取我们想要的 S 和 X 锁，具体分为：</p>
<p><strong>意向共享锁（IS）</strong></p>
<p>事务 1 说：我要加一个行锁，我有这个意向，你们其他人有没有意见，如果没有我就先拿这个 IS 锁了。</p>
<p><strong>意向排它锁（IX）</strong></p>
<p>事务 2 说：我要加一个表锁，这个可是排他锁，我拿了你们就等我用完再说吧，我有这个意向，你们其他人有没有意见，如果没有我就先拿这个 IX 锁了。</p>
<p>前面这个举例，其过程升级优化为：</p>
<ul>
<li>事务 1 先申请获取 IS 锁，成功后，获取 S 锁</li>
<li>事务 2 发现表中有 IS 锁了，事务 2 获取表锁会被阻塞</li>
</ul>
<p>那么这四个锁之间兼容性如何呢？</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">X</th>
<th style="text-align:left">S</th>
<th style="text-align:left">IX</th>
<th style="text-align:left">IS</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">X</td>
<td style="text-align:left">冲突</td>
<td style="text-align:left">冲突</td>
<td style="text-align:left">冲突</td>
<td style="text-align:left">冲突</td>
</tr>
<tr>
<td style="text-align:left">S</td>
<td style="text-align:left">冲突</td>
<td style="text-align:left">兼容</td>
<td style="text-align:left">冲突</td>
<td style="text-align:left">兼容</td>
</tr>
<tr>
<td style="text-align:left">IX</td>
<td style="text-align:left">冲突</td>
<td style="text-align:left">冲突</td>
<td style="text-align:left">兼容</td>
<td style="text-align:left">兼容</td>
</tr>
<tr>
<td style="text-align:left">IS</td>
<td style="text-align:left">冲突</td>
<td style="text-align:left">兼容</td>
<td style="text-align:left">兼容</td>
<td style="text-align:left">兼容</td>
</tr>
</tbody>
</table>
<h3 id="聊几个经典死锁案例">聊几个经典死锁案例<a hidden class="anchor" aria-hidden="true" href="#聊几个经典死锁案例">#</a></h3>
<p>在实际应用中经常发生数据库死锁的情况，那么什么是死锁呢？说白了就是事务 1 锁事务 2，事务 2 锁事务 1，这两个事务都在等着对方释放锁资源，陷入了死循环。</p>
<p>接下来我们介绍几个经典死锁案例，MySQL 默认级别使用的是 REPEATABLE-READ。</p>
<h4 id="场景-1insert-死锁">场景 1：insert 死锁<a hidden class="anchor" aria-hidden="true" href="#场景-1insert-死锁">#</a></h4>
<p>创建一个测试表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">t_insert</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">decimal</span><span class="p">,</span><span class="k">no</span><span class="w"> </span><span class="nb">decimal</span><span class="p">,</span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="k">unique</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="k">no</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>session1：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">begin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t_insert</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">101</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>session2：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">begin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t_insert</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">101</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此时会话一直等待无响应。</p>
<p>session1：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t_insert</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果如下。</p>
<p>此时 session2 立马报出来死锁：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vbnet" data-lang="vbnet"><span class="line"><span class="cl"><span class="k">ERROR</span> <span class="n">1213</span> <span class="p">(</span><span class="n">40001</span><span class="p">):</span> <span class="o">==</span><span class="n">Deadlock</span><span class="o">==</span> <span class="n">found</span> <span class="k">when</span> <span class="n">trying</span> <span class="k">to</span> <span class="k">get</span> <span class="n">lock</span><span class="err">;</span> <span class="k">try</span> <span class="n">restarting</span> <span class="n">transaction</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>数据库中 insert 作为最简单的 SQL，为什么会导致死锁呢？</p>
<p>session1 在插入(1,101) 的时候会加一个 X 锁；session2 插入(2,101)，no 字段有着唯一性，故 session2 在插入时数据库会做 duplicate 冲突检测，由于事务冲突先加 S 锁；然后 session1 又插入了 (3,100)，此时 session1 会加 insert intention X 锁（插入意向锁），之前 session1 已经有了 X 锁，故进入等待队列，结局就是 session1 和 session2 都在等待，陷入了僵局，MySQL 很机智，牺牲一方事务解决这个尴尬的局面，所以 session2 被干掉了，报错死锁。</p>
<h4 id="场景-2自增列死锁">场景 2：自增列死锁<a hidden class="anchor" aria-hidden="true" href="#场景-2自增列死锁">#</a></h4>
<p>自增列死锁问题和场景 1 的类似，比如将场景 1 的主键属性改为自增长属性，主键自增仍唯一，场景模拟类似，加锁的过程也类似，产生死锁的过程也类似，这里就不详细模拟了。</p>
<h4 id="场景-3rollback-死锁">场景 3：rollback 死锁<a hidden class="anchor" aria-hidden="true" href="#场景-3rollback-死锁">#</a></h4>
<p>创建一个测试表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">t_rollback</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">decimal</span><span class="p">,</span><span class="k">no</span><span class="w"> </span><span class="nb">decimal</span><span class="p">,</span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="k">unique</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="k">no</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>session1：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">begin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t_rollback</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>session2：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">begin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t_rollback</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此时会话一直等待无响应。</p>
<p>session3</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">begin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t_rollback</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此时会话一直等待无响应。</p>
<p>session1</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; rollback<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>结果如下： 此时 session1 执行了 rollback 成功返回，session2 的 insert 返回成功，session3 立马报出来死锁。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vbnet" data-lang="vbnet"><span class="line"><span class="cl"><span class="k">ERROR</span> <span class="n">1213</span> <span class="p">(</span><span class="n">40001</span><span class="p">):</span> <span class="o">==</span><span class="n">Deadlock</span><span class="o">==</span> <span class="n">found</span> <span class="k">when</span> <span class="n">trying</span> <span class="k">to</span> <span class="k">get</span> <span class="n">lock</span><span class="err">;</span> <span class="k">try</span> <span class="n">restarting</span> <span class="n">transaction</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>为什么我回滚了事务，还要报死锁，难道我需要全部回滚吗？</p>
<p>session1 在插入 (1,100) 的时候会加一个 X 锁；session2 插入 (2,100)，no 字段有着唯一性，故 session2 在插入时数据库会做 duplicate 冲突检测，由于事务冲突先加 S 锁；session3 插入 (3,100)，no 字段有着唯一性，故 session3 在插入时数据库会做 duplicate 冲突检测，由于事务冲突先加 S 锁；session1 回滚，session2 申请 insert intention X 锁，等 session3;session3 申请 insert intention X 锁，等 session2，结局就是 session2 和 session3 都在等待，陷入了僵局，MySQL 很机智，牺牲一方事务解决这个尴尬的局面，所以 session3 被干掉了，报错死锁。</p>
<h4 id="场景-4commit-死锁">场景 4：commit 死锁<a hidden class="anchor" aria-hidden="true" href="#场景-4commit-死锁">#</a></h4>
<p>创建一个测试表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">t_commit</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">decimal</span><span class="p">,</span><span class="k">no</span><span class="w"> </span><span class="nb">decimal</span><span class="p">,</span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="k">unique</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="k">no</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t_commit</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>session1：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; begin<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; delete from t_commit where <span class="nv">id</span><span class="o">=</span>1<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>session2：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">begin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t_commit</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此时会话一直等待无响应。</p>
<p>session3：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">begin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t_commit</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此时会话一直等待无响应。</p>
<p>session1：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; commit<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>结果如下：此时 session1 执行了 commit 成功返回，session3 的 insert 返回成功，session2 立马报出来死锁。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vbnet" data-lang="vbnet"><span class="line"><span class="cl"><span class="k">ERROR</span> <span class="n">1213</span> <span class="p">(</span><span class="n">40001</span><span class="p">):</span> <span class="o">==</span><span class="n">Deadlock</span><span class="o">==</span> <span class="n">found</span> <span class="k">when</span> <span class="n">trying</span> <span class="k">to</span> <span class="k">get</span> <span class="n">lock</span><span class="err">;</span> <span class="k">try</span> <span class="n">restarting</span> <span class="n">transaction</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>为什么我提交了事务，还要报死锁，难道我需要全部提交吗？</p>
<p>这个产生死锁的过程和场景 3rollback 死锁类似，大家可以和之前的 rollback 死锁产生过程对应来看。</p>
<h3 id="小技巧事务保存点帮你读档重闯关">小技巧——事务保存点帮你读档重闯关<a hidden class="anchor" aria-hidden="true" href="#小技巧事务保存点帮你读档重闯关">#</a></h3>
<p>玩游戏你是不是有过存档、读档的经历，过某一个比较难的关卡，先存档，过不了，就读档重新过。数据库中我们也可以如此，MySQL 事务保存点可以回滚到事务的某时间点，并且不用中止事务。下面举例说明一下。</p>
<p>用户 B 和用户 C 向用户 A 借钱，用户 A 转账给用户 B 和用户 C，转账的过程中发生了用户 C 账户不存在，那么我们也要把转给用户 B 的钱也取消吗？我们可以不取消，使用一个保存点即可。</p>
<p>查询用户 A 有 1000 元：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">mysql</span><span class="p">&gt;</span> <span class="k">select</span> <span class="n">balance</span> <span class="k">from</span> <span class="n">t_account</span> <span class="k">where</span> <span class="n">name</span><span class="p">=</span><span class="sc">&#39;A&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>转账 100 元给用户 B：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; update t_account <span class="nb">set</span> <span class="nv">balance</span><span class="o">=</span>balance-100 where <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; update t_account <span class="nb">set</span> <span class="nv">balance</span><span class="o">=</span>balance+100 where <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>设置事务保存点</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; savepoint T_A_TO_B<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>转账 200 元给用户 C：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="n">t_account</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">balance</span><span class="o">=</span><span class="n">balance</span><span class="o">-</span><span class="mi">200</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="n">t_account</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">balance</span><span class="o">=</span><span class="n">balance</span><span class="o">+</span><span class="mi">200</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Rows</span><span class="w"> </span><span class="n">matched</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Changed</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>发现转账给 C 返回有 0 条受影响的行，转账给 C 未成功，此时用户 A 已经少了 200 元了，先退 200 元再排查吧，转账给用户 B 的不需要重新操作了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; rollback to T_A_TO_B<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; commit；
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据提示 0 条受影响的行，也就是说用户 C 不存在呀，我们查询一下个用户信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t_account</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">A</span><span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="mi">900</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t_account</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">B</span><span class="w">    </span><span class="o">|</span><span class="w">     </span><span class="mi">200</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t_account</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Empty</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果：用户 A 成功转 100 元给用户 B，用户 C 果然不存才，设置了保存点，帮我们省了很多工作，中途不用取消全部操作。</p>
<h3 id="小技巧一个死锁的具体分析方法">小技巧——一个死锁的具体分析方法<a hidden class="anchor" aria-hidden="true" href="#小技巧一个死锁的具体分析方法">#</a></h3>
<p>前面我们学习了事务、锁，以及介绍了几个经典死锁案例，当遇到死锁，我们怎样具体分析呢？</p>
<p>分析死锁，我们就需要看死锁的日志信息，通过日志具体找到死锁的原因及执行的语句。</p>
<p>首先，我们用前面的场景 1 模拟一个死锁。</p>
<p>然后，执行如下命令获取死锁信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">engine</span> <span class="n">innodb</span> <span class="n">status</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在打印的日志中，先看事务 1 的日志：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="o">***</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">TRANSACTION:</span>
</span></span><span class="line"><span class="cl"><span class="n">TRANSACTION</span> <span class="mi">2179</span><span class="p">,</span> <span class="n">ACTIVE</span> <span class="mi">8</span> <span class="n">sec</span> <span class="n">inserting</span>
</span></span><span class="line"><span class="cl"><span class="n">mysql</span> <span class="n">tables</span> <span class="n">in</span> <span class="k">use</span> <span class="mi">1</span><span class="p">,</span> <span class="n">locked</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">LOCK</span> <span class="n">WAIT</span> <span class="mi">2</span> <span class="n">lock</span> <span class="n">struct</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">heap</span> <span class="n">size</span> <span class="mi">1136</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">lock</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">undo</span> <span class="nb">log</span> <span class="n">entries</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">MySQL</span> <span class="n">thread</span> <span class="n">id</span> <span class="mi">32</span><span class="p">,</span> <span class="n">OS</span> <span class="n">thread</span> <span class="n">handle</span> <span class="mi">140317789804288</span><span class="p">,</span> <span class="n">query</span> <span class="n">id</span> <span class="mi">823</span> <span class="n">localhost</span> <span class="n">root</span> <span class="n">update</span>
</span></span><span class="line"><span class="cl"><span class="n">insert</span> <span class="n">into</span> <span class="n">t_insert</span> <span class="nb">values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">101</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">***</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">WAITING</span> <span class="n">FOR</span> <span class="n">THIS</span> <span class="n">LOCK</span> <span class="n">TO</span> <span class="n">BE</span> <span class="n">GRANTED:</span>
</span></span><span class="line"><span class="cl"><span class="n">RECORD</span> <span class="n">LOCKS</span> <span class="n">space</span> <span class="n">id</span> <span class="mi">37</span> <span class="n">page</span> <span class="k">no</span> <span class="mi">4</span> <span class="n">n</span> <span class="n">bits</span> <span class="mi">72</span> <span class="nb">index</span> <span class="k">no</span> <span class="nn">of</span> <span class="n">table</span> <span class="sb">`test`</span><span class="o">.</span><span class="sb">`t_insert`</span> <span class="n">trx</span> <span class="n">id</span> <span class="mi">2179</span> <span class="n">lock</span> <span class="n">mode</span> <span class="n">S</span> <span class="n">waiting</span>
</span></span><span class="line"><span class="cl"><span class="n">Record</span> <span class="n">lock</span><span class="p">,</span> <span class="n">heap</span> <span class="k">no</span> <span class="mi">2</span> <span class="n">PHYSICAL</span> <span class="n">RECORD:</span> <span class="n">n_fields</span> <span class="mi">2</span><span class="p">;</span> <span class="n">compact</span> <span class="nb">format</span><span class="p">;</span> <span class="n">info</span> <span class="n">bits</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="mi">0</span><span class="p">:</span> <span class="n">len</span> <span class="mi">5</span><span class="p">;</span> <span class="nb">hex</span> <span class="mi">8000000065</span><span class="p">;</span> <span class="n">asc</span>     <span class="n">e</span><span class="p">;;</span>
</span></span><span class="line"><span class="cl"> <span class="mi">1</span><span class="p">:</span> <span class="n">len</span> <span class="mi">5</span><span class="p">;</span> <span class="nb">hex</span> <span class="mi">8000000001</span><span class="p">;</span> <span class="n">asc</span>      <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="n">TRANSACTION</span> <span class="mi">2179</span><span class="p">,</span> <span class="n">ACTIVE</span> <span class="o">==</span><span class="mi">8</span> <span class="n">sec</span><span class="o">==</span> <span class="n">inserting</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>事务 1 持续了 8 秒：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="n">mysql</span> <span class="o">==</span><span class="n">tables</span> <span class="n">in</span> <span class="k">use</span> <span class="mi">1</span><span class="o">==</span><span class="p">,</span> <span class="n">locked</span> <span class="mi">1</span>  <span class="err">涉及一张表</span>  
</span></span><span class="line"><span class="cl"><span class="n">LOCK</span> <span class="n">WAIT</span> <span class="mi">2</span> <span class="n">lock</span> <span class="n">struct</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="err">有两个锁</span>  
</span></span><span class="line"><span class="cl"><span class="n">insert</span> <span class="n">into</span> <span class="n">t_insert</span> <span class="nb">values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">101</span><span class="p">)</span> <span class="err">这是</span> <span class="n">SQL</span> <span class="err">语句</span>  
</span></span><span class="line"><span class="cl"><span class="n">WAITING</span> <span class="n">FOR</span> <span class="n">THIS</span> <span class="n">LOCK</span> <span class="n">TO</span> <span class="n">BE</span> <span class="n">GRANTED</span> <span class="err">唯一行锁处于等待</span>  
</span></span><span class="line"><span class="cl"><span class="n">RECORD</span> <span class="n">LOCKS</span> <span class="n">space</span> <span class="n">id</span> <span class="mi">37</span> <span class="n">page</span> <span class="k">no</span> <span class="mi">4</span> <span class="n">n</span> <span class="n">bits</span> <span class="mi">72</span> <span class="nb">index</span> <span class="k">no</span> <span class="err">加锁的是索引字段</span> <span class="k">no</span>  
</span></span><span class="line"><span class="cl"><span class="nn">lock</span> <span class="n">mode</span> <span class="n">S</span> <span class="n">waiting</span> <span class="err">锁等待为</span> <span class="n">S</span> <span class="err">锁</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>事务 2 的日志：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="o">***</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">TRANSACTION:</span>
</span></span><span class="line"><span class="cl"><span class="n">TRANSACTION</span> <span class="mi">2178</span><span class="p">,</span> <span class="n">ACTIVE</span> <span class="mi">17</span> <span class="n">sec</span> <span class="n">inserting</span>
</span></span><span class="line"><span class="cl"><span class="n">mysql</span> <span class="n">tables</span> <span class="n">in</span> <span class="k">use</span> <span class="mi">1</span><span class="p">,</span> <span class="n">locked</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span> <span class="n">lock</span> <span class="n">struct</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">heap</span> <span class="n">size</span> <span class="mi">1136</span><span class="p">,</span> <span class="mi">2</span> <span class="n">row</span> <span class="n">lock</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">undo</span> <span class="nb">log</span> <span class="n">entries</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">MySQL</span> <span class="n">thread</span> <span class="n">id</span> <span class="mi">33</span><span class="p">,</span> <span class="n">OS</span> <span class="n">thread</span> <span class="n">handle</span> <span class="mi">140317663659776</span><span class="p">,</span> <span class="n">query</span> <span class="n">id</span> <span class="mi">824</span> <span class="n">localhost</span> <span class="n">root</span> <span class="n">update</span>
</span></span><span class="line"><span class="cl"><span class="n">insert</span> <span class="n">into</span> <span class="n">t_insert</span> <span class="nb">values</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">***</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">HOLDS</span> <span class="n">THE</span> <span class="n">LOCK</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="n">RECORD</span> <span class="n">LOCKS</span> <span class="n">space</span> <span class="n">id</span> <span class="mi">37</span> <span class="n">page</span> <span class="k">no</span> <span class="mi">4</span> <span class="n">n</span> <span class="n">bits</span> <span class="mi">72</span> <span class="nb">index</span> <span class="k">no</span> <span class="nn">of</span> <span class="n">table</span> <span class="sb">`test`</span><span class="o">.</span><span class="sb">`t_insert`</span> <span class="n">trx</span> <span class="n">id</span> <span class="mi">2178</span> <span class="n">lock_mode</span> <span class="n">X</span> <span class="n">locks</span> <span class="n">rec</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">gap</span>
</span></span><span class="line"><span class="cl"><span class="n">Record</span> <span class="n">lock</span><span class="p">,</span> <span class="n">heap</span> <span class="k">no</span> <span class="mi">2</span> <span class="n">PHYSICAL</span> <span class="n">RECORD:</span> <span class="n">n_fields</span> <span class="mi">2</span><span class="p">;</span> <span class="n">compact</span> <span class="nb">format</span><span class="p">;</span> <span class="n">info</span> <span class="n">bits</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="mi">0</span><span class="p">:</span> <span class="n">len</span> <span class="mi">5</span><span class="p">;</span> <span class="nb">hex</span> <span class="mi">8000000065</span><span class="p">;</span> <span class="n">asc</span>     <span class="n">e</span><span class="p">;;</span>
</span></span><span class="line"><span class="cl"> <span class="mi">1</span><span class="p">:</span> <span class="n">len</span> <span class="mi">5</span><span class="p">;</span> <span class="nb">hex</span> <span class="mi">8000000001</span><span class="p">;</span> <span class="n">asc</span>      <span class="p">;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">***</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">WAITING</span> <span class="n">FOR</span> <span class="n">THIS</span> <span class="n">LOCK</span> <span class="n">TO</span> <span class="n">BE</span> <span class="n">GRANTED:</span>
</span></span><span class="line"><span class="cl"><span class="n">RECORD</span> <span class="n">LOCKS</span> <span class="n">space</span> <span class="n">id</span> <span class="mi">37</span> <span class="n">page</span> <span class="k">no</span> <span class="mi">4</span> <span class="n">n</span> <span class="n">bits</span> <span class="mi">72</span> <span class="nb">index</span> <span class="k">no</span> <span class="nn">of</span> <span class="n">table</span> <span class="sb">`test`</span><span class="o">.</span><span class="sb">`t_insert`</span> <span class="n">trx</span> <span class="n">id</span> <span class="mi">2178</span> <span class="n">lock_mode</span> <span class="n">X</span> <span class="n">locks</span> <span class="n">gap</span> <span class="n">before</span> <span class="n">rec</span> <span class="n">insert</span> <span class="n">intention</span> <span class="n">waiting</span>
</span></span><span class="line"><span class="cl"><span class="n">Record</span> <span class="n">lock</span><span class="p">,</span> <span class="n">heap</span> <span class="k">no</span> <span class="mi">2</span> <span class="n">PHYSICAL</span> <span class="n">RECORD:</span> <span class="n">n_fields</span> <span class="mi">2</span><span class="p">;</span> <span class="n">compact</span> <span class="nb">format</span><span class="p">;</span> <span class="n">info</span> <span class="n">bits</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="mi">0</span><span class="p">:</span> <span class="n">len</span> <span class="mi">5</span><span class="p">;</span> <span class="nb">hex</span> <span class="mi">8000000065</span><span class="p">;</span> <span class="n">asc</span>     <span class="n">e</span><span class="p">;;</span>
</span></span><span class="line"><span class="cl"> <span class="mi">1</span><span class="p">:</span> <span class="n">len</span> <span class="mi">5</span><span class="p">;</span> <span class="nb">hex</span> <span class="mi">8000000001</span><span class="p">;</span> <span class="n">asc</span>      <span class="p">;;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>HOLDS THE LOCK(S)</code> 持有锁的内容</li>
<li><code>lock_mode X locks</code> 持有锁的锁等待内容是一个 x 锁</li>
<li><code>WAITING FOR THIS LOCK TO BE GRANTED</code> 等待锁的内容</li>
<li><code>lock_mode X locks gap before rec insert intention waiting</code> 等待锁的锁等待内容也是一个 x 锁</li>
</ul>
<p>通过这些日志，我们发现日志中的事务 1，持有 S 锁，S 锁的出现是因为需要检查数据唯一性，我们的 no 字段确实有唯一索引，这一点也正好验证了。日志中的事务 1，持有一个 X 锁，又等待一个 X 锁。所以场景 1 中的两个事务都在锁等，造成了死锁。</p>
<h3 id="小技巧换种思路提高事务能力">小技巧——换种思路提高事务能力<a hidden class="anchor" aria-hidden="true" href="#小技巧换种思路提高事务能力">#</a></h3>
<p>在数据中如果是单一事务，那没的说，一个一个的事务来执行，毫无压力。现实是不允许这样的，肯定是有大量的并发连接，并发事务在所难免。如果高并发的环境中，事务处理效率肯定大幅下降，这个时候我们有没有方法提高并发事务能力呢？</p>
<p>我们解决技术处理问题的限制，这次我们换一种思路来提高事务能力。比如：</p>
<p><strong>合理的在线、离线数据库</strong></p>
<p>比如我们的系统数据量日益增加，还有一些业务需要查询大量的数据，我们可以改造系统为在线、离线数据库，在线表提供高效事务能力，离线表提供数据查询服务，互不影响。</p>
<p><strong>提高 delete 操作效率的思考</strong></p>
<p>如果你对表有大量数据的 delete 操作，比如定期的按日、月、年删除数据，可以设计表为日表、月表、年表亦或是相对应的分区表，这样清理数据会由大事务降低为小事务。</p>
<h1 id="mysql-地基基础数据库字符集">MySQL 地基基础：数据库字符集<a hidden class="anchor" aria-hidden="true" href="#mysql-地基基础数据库字符集">#</a></h1>
<h3 id="字符集简介">字符集简介<a hidden class="anchor" aria-hidden="true" href="#字符集简介">#</a></h3>
<p>字符是各种文字和符号的总称，而字符集是多个字符的集合。</p>
<h3 id="字符集分类与特点">字符集分类与特点<a hidden class="anchor" aria-hidden="true" href="#字符集分类与特点">#</a></h3>
<p>字符包含有国家文字、标点符号、图形符号、数字等内容，字符集是多个字符的集合，字符集种类非常多，每种字符集包含的字符个数是不相同的。比如说，国家文字不同，就会使用各自国家通用字符集，这样是不是好理解一些。</p>
<p><strong>常见字符集分类</strong></p>
<ul>
<li>ASCII（American Standard Code for Information Interchange，美国信息互换标准编码）：是基于罗马字母表的一套电脑编码系统，一个字节表示一个字符。</li>
<li>LATIN1：ASCII 字符集的扩充，仍然使用一个字节表示一个字符。</li>
<li>GB2312（信息交换用汉字编码字符集·基本集）：中国国家标准的简体中文字符集，基本满足了汉字的计算机处理需要，分区表示，双字节表示一个字符。</li>
<li>GB18030（信息交换用汉字编码字符集基本集的扩充）：是 GB2312 的扩充，更全面，兼容 Unicode 3.0 和 GB2312。</li>
<li>UTF-8（Unicode Tranformation Format）：是 Unicode 的其中一个使用方式，支持所有国家字符集，使用 1-4 个字节表示一个字符。</li>
</ul>
<p>字符集有很多，这里不一一列举。想要获取全部支持字符集，可以在库中查看，详见下文。</p>
<p><strong>字符集特点</strong></p>
<ul>
<li>不同的编码方式，最终解释为不同的机器语言（二进制）</li>
<li>不同的表示方式，使用 1 个或者多个字节表示一个字符</li>
</ul>
<h3 id="mysql-与字符集之间亲密关系">MySQL 与字符集之间亲密关系<a hidden class="anchor" aria-hidden="true" href="#mysql-与字符集之间亲密关系">#</a></h3>
<p>首先我们想一下，数据库是做什么的？数据库是存放数据的环境。这些数据库是如何保存的？拍拍脑袋一想，肯定不是原封不动的存放的，数据库不同于我们的大脑，它的思维能力甚至不如阿猫阿狗，它只能读懂 0 和 1，那么数据库存储的数据，其实就是一串串的 0 和 1 的组合，那么按照什么规则定义这些 0 和 1 呢？重点来了，数据库需要在字符集中找到对应的数据编码，然后存储的是这些编码。</p>
<p>MySQL 字符集包括字符集（character）和校对规则（collation），字符集用来定义存储字符串的方式，校队规则定义比较字符串的方式。字符集和校对规则是一对多的关系，每个字符集至少对应一个校对规则。后面我们在具体说说校对规则。</p>
<p>MySQL 在底层存储上有四个级别的字符集设置，分别是：服务器级、数据库级、表级、列级。字符集优先级是：列字符集 &gt; 表字符集 &gt; 数据库字符集 &gt; 服务器字符集，其中最常用的是表级和数据库级字符集。列级字符集最优先，但是一般不单独设置，使其继承表级字符集。</p>
<p>获取所有数据库字符集：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">或者</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">character_sets</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>获取所有数据库校对规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="k">collation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">或者</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">collations</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="字符集编码原理">字符集编码原理<a hidden class="anchor" aria-hidden="true" href="#字符集编码原理">#</a></h3>
<p>在客户端和服务器端之期间的数据请求与反馈，会经历一系列的转换，从而保证数据的正确无误无乱码，下面具体说一下这个请求的过程。</p>
<p>\1. MySQL client 发送请求（字符集为 character_set_client） character_set_client 就是客户端字符集。</p>
<p>\2. MySQL Server 收到请求，将请求数据从 character_set_client 转换为 character_set_connection 通常情况下 character_set_connection 字符集同 character_set_client 字符集一致。</p>
<p>\3. MySQL Server 将请求数据从 character_set_connection 转换为内部操作字符集。</p>
<p>何为内部操作字符集，其实就是前面说的列字符集、表字符集、数据库字符集、服务器字符集这四个。这一步操作会使用每个数据字段的 CHARACTER SET 设定值：</p>
<ul>
<li>如果 CHARACTER SET 不存在，使用表字符集</li>
<li>如果表字符集不存在，使用数据库字符集</li>
<li>如果数据库字符集不存在，使用服务器字符集</li>
</ul>
<p>\4. MySQL Server 将操作结果从内部操作字符集转换为 character_set_results character_set_results 就是结果内容的字符集。</p>
<h3 id="字符集与校对规则分析">字符集与校对规则分析<a hidden class="anchor" aria-hidden="true" href="#字符集与校对规则分析">#</a></h3>
<p>前面我们已经说了说字符集和校对规则的关系。接下来我们具体分析分析它们。</p>
<p>查看数据库字符集：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;character%&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/8d9f1a10-436e-11eb-8894-3bfce9c9c7d8" alt="在这里插入图片描述"  />
</p>
<p>参数解释：</p>
<ul>
<li>character_set_client：客户端使用的字符集</li>
<li>character_set_connection：客户端和服务端连接层字符集</li>
<li>character_set_database：默认数据库字符集 ，如没有默认数据库，会用 character_set_server 指定的字符集，建议由系统自动管理</li>
<li>character_set_filesystem：把 os 上文件名转化成此字符集，把 character_set_client 转换 character_set_filesystem， 默认 binary 是不做任何转换</li>
<li>character_set_results：结果字符集</li>
<li>character_set_server：数据库服务器字符集</li>
<li>character_set_system：操作系统字符集，无需设置，总是 utf8</li>
</ul>
<p>DDL 字符集选择：</p>
<ul>
<li>建库操作，未指定数据库字符集，继承数据库服务器字符集</li>
<li>建表操作，未指定表字符集，继承当前库字符集</li>
<li>新增字段，未指定列字符集，继承表字符集</li>
<li>修改字段，未指定列字符集，继承表字符集</li>
</ul>
<p>DML 字符集选择：</p>
<ul>
<li>插入、更新数据，由 character_set_client 转换为 character_set_connection 再转换为表字符集</li>
</ul>
<p>查看字符集校对规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;collation%&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/0404e580-4370-11eb-b1e3-0b8acb9b8f06" alt="在这里插入图片描述"  />
</p>
<p>参数说明：</p>
<ul>
<li>collation_connection：当前连接的字符集校对规则</li>
<li>collation_database：当前数据库默认校对规则</li>
<li>collation_server：当前数据库服务器默认校对规则</li>
</ul>
<p>字符集和校对规则：</p>
<ul>
<li>每个字符集至少有一个校对规则</li>
<li>每个字符集有一个默认的校对规则</li>
<li>每个校对规则只能属于一个字符集</li>
</ul>
<p><strong>校对规则命名</strong></p>
<p>字符集名称_语言_后缀，其中后缀有三种写法：</p>
<ul>
<li>_ci：不区分大小写</li>
<li>_cs：区分大小写</li>
<li>_bin：二进制</li>
</ul>
<h3 id="如何更改-mysql-字符集">如何更改 MySQL 字符集<a hidden class="anchor" aria-hidden="true" href="#如何更改-mysql-字符集">#</a></h3>
<p>更改数据库字符集：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">alter</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">db1</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>更改数据库表的字符集：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">tab1</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>把表默认的字符集和所有字符列改为新的字符集（例如 utf8）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">tab1</span><span class="w"> </span><span class="k">convert</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>前面的操作转换了字符集之间的列类型。如果有一列使用一种字符集（如 latin1），但是存储的值实际上使用了其它的字符集（如 utf8），这种情况不是你想要的，进行如下操作就可以解决你的问题。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">tab1</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="err">字段</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">字段</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">类型；</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">tab1</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="err">字段</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">字段</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">类型</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="字符集最佳实践">字符集最佳实践<a hidden class="anchor" aria-hidden="true" href="#字符集最佳实践">#</a></h3>
<p>MySQL 数据库字符集和校对规则有 4 个级别：服务器级、数据库级、表级、字段级，下面我们重点讲解及用实例操作来实践。</p>
<h4 id="服务器级设置字符集">服务器级设置字符集<a hidden class="anchor" aria-hidden="true" href="#服务器级设置字符集">#</a></h4>
<p><strong>方式一</strong></p>
<p>在 MySQL 配置文件 my.cnf 中进行配置设置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="na">[mysqld]</span>
</span></span><span class="line"><span class="cl"><span class="k">default</span><span class="p">-</span><span class="n">character</span><span class="p">-</span><span class="k">set</span><span class="p">=</span><span class="n">gbk</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>方式二</strong></p>
<p>在启动 MySQL 时设置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">mysqld</span> <span class="o">--</span><span class="k">default</span><span class="o">-</span><span class="n">character</span><span class="o">-</span><span class="n">set</span><span class="o">=</span><span class="n">gbk</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>方式三</strong></p>
<p>在源码编译时指定，如果未指定，默认使用 latin1：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./configure --with-charcter<span class="o">=</span>gbk
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="数据库级设置字符集">数据库级设置字符集<a hidden class="anchor" aria-hidden="true" href="#数据库级设置字符集">#</a></h4>
<ul>
<li>创建数据库时指定字符集（create database &hellip; ）</li>
<li>修改数据库时修改字符集（alter database &hellip;）</li>
</ul>
<p>注：对于已经存在的数据修改字符集无效。</p>
<h4 id="表级设置字符集">表级设置字符集<a hidden class="anchor" aria-hidden="true" href="#表级设置字符集">#</a></h4>
<ul>
<li>创建表时指定字符集（create table &hellip;）</li>
<li>修改表时修改字符集（alter table &hellip;）</li>
</ul>
<p>注：对于已经存在的数据修改字符集无效。</p>
<h4 id="列级设置字符集">列级设置字符集<a hidden class="anchor" aria-hidden="true" href="#列级设置字符集">#</a></h4>
<ul>
<li>创建表时指定列字符集（create table &hellip;）</li>
<li>修改表时修改列字符集（alter table &hellip;）</li>
</ul>
<p>注：对于已经存在的数据修改字符集无效。</p>
<p>细心的朋友应该已经注意到了，以上这种修改是不适用于已经存在的数据的，如果表中已经存在数据了，那么我们怎样修改字符集呢？不要着急，后面会一步一步的教你如何实现。</p>
<p>首先我们先实例说一下如何设置字符集。</p>
<p><strong>1. 为数据库设置字符集和校对规则</strong></p>
<p>设置数据库字符集：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">db1</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>设置数据库校对规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">db1</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">utf8</span><span class="w"> </span><span class="k">collate</span><span class="w"> </span><span class="n">utf8_bin</span><span class="p">;</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>说明：</p>
<ul>
<li>如果指定了字符集和校对规则，则使用指定的</li>
<li>如果指定了字符集未指定校对规则，则使用指定字符集和默认校对规则</li>
<li>如果未指定字符集和校对规则，则使用服务器字符集和校对规则</li>
</ul>
<p><strong>2. 为表设置字符集和校对规则</strong></p>
<p>设置表字符集：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">tab1</span><span class="p">(</span><span class="n">column1</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">utf8</span><span class="p">;</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>设置表校对规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">tab1</span><span class="p">(</span><span class="n">column1</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">utf8</span><span class="w"> </span><span class="k">collate</span><span class="w"> </span><span class="n">utf8_bin</span><span class="p">;</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>说明：</p>
<ul>
<li>如果指定了字符集和校对规则，则使用指定的</li>
<li>如果指定了字符集未指定校对规则，则使用指定字符集和默认校对规则</li>
<li>如果未指定字符集和校对规则，则使用数据库字符集和校对规则</li>
</ul>
<p><strong>3. 为列设置字符集和校对规则</strong></p>
<p>设置列字符集：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">tab1</span><span class="p">(</span><span class="n">column1</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">utf8</span><span class="p">);</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>设置列校对规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">tab1</span><span class="p">(</span><span class="n">column1</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="nb">character</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">utf8</span><span class="w"> </span><span class="k">collate</span><span class="w"> </span><span class="n">utf8_bin</span><span class="p">);</span><span class="w"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>说明：</p>
<ul>
<li>如果指定了字符集和校对规则，则使用指定的</li>
<li>如果指定了字符集未指定校对规则，则使用指定字符集和默认校对规则</li>
<li>如果未指定字符集和校对规则，则使用表字符集和校对规则</li>
</ul>
<p><strong>4. 如何处理带数据的字符集</strong></p>
<p>当表中已经存在数据，直接更改字符集，不会更改既有的数据字符集，我们需要先将数据导出，调整字符集再导入。</p>
<p><strong>第一步：导出表结构</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">mysqldump</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">p</span> <span class="o">--</span><span class="k">default</span><span class="o">-</span><span class="n">character</span><span class="o">-</span><span class="n">set</span><span class="o">=</span><span class="n">gbk</span> <span class="o">-</span><span class="n">d</span> <span class="n">db1</span><span class="o">&gt;</span> <span class="n">createtab</span><span class="p">.</span><span class="n">sql</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>第二步：修改表字符集</strong></p>
<p>编辑修改 createtab.sql 文件，将表结构定义中的字符集改为新的字符集。</p>
<p><strong>第三步：导出所有数据</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">mysqldump</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">p</span> <span class="o">--</span><span class="n">quick</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">create</span><span class="o">-</span><span class="n">info</span> <span class="o">--</span><span class="n">extended</span><span class="o">-</span><span class="n">insert</span> <span class="o">--</span><span class="k">default</span><span class="o">-</span><span class="n">character</span><span class="o">-</span><span class="n">set</span><span class="o">=</span><span class="n">latin1</span> <span class="n">db1</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">.</span><span class="n">sql</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>第四步：修改数据字符集</strong></p>
<p>编辑修改 data.sql，将 set names latin1 修改成 set names gbk。</p>
<p><strong>第五步：创建数据库</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">db1</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">charset</span><span class="w"> </span><span class="n">gbk</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>第六步：创建表</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="nt">mysql</span> <span class="nt">-uroot</span> <span class="nt">-p</span> <span class="nt">db1</span> <span class="o">&lt;</span> <span class="nt">createtab</span><span class="p">.</span><span class="nc">sql</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>第七步：导入数据</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="nt">mysql</span> <span class="nt">-uroot</span> <span class="nt">-p</span> <span class="nt">db1</span> <span class="o">&lt;</span> <span class="nt">data</span><span class="p">.</span><span class="nc">sql</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="mysql-性能优化碎片整理">MySQL 性能优化：碎片整理<a hidden class="anchor" aria-hidden="true" href="#mysql-性能优化碎片整理">#</a></h1>
<h3 id="mysql-碎片是什么">MySQL 碎片是什么<a hidden class="anchor" aria-hidden="true" href="#mysql-碎片是什么">#</a></h3>
<p>MySQL 碎片就是 MySQL 数据文件中一些不连续的空白空间，这些空间无法再被全部利用，久而久之越来多，越来越零碎，从而造成物理存储和逻辑存储的位置顺序不一致，这就是碎片。</p>
<h3 id="碎片是如何产生的">碎片是如何产生的<a hidden class="anchor" aria-hidden="true" href="#碎片是如何产生的">#</a></h3>
<p><strong>delete 操作</strong></p>
<p>在 MySQL 中删除数据，在存储中就会产生空白的空间，当有新数据插入时，MySQL 会试着在这些空白空间中保存新数据，但是呢总是用不满这些空白空间。所以日积月累，亦或是一下有大量的 delete 操作，一下就会有大量的空白空间，慢慢的会大到比表的数据使用的空间还大。</p>
<p><strong>update 操作</strong></p>
<p>在 MySQL 中更新数据，在可变长度的字段（比如 varchar）中更新数据，innodb 表存储数据的单位是页，update 操作会造成页分裂，分裂以后存储变的不连续，不规则，从而产生碎片。比如说原始字段长度 varchar(100)，我们大量的更新数据长度位为 50，这样的话，有 50 的空间被空白了，新入库的数据不能完全利用剩余的 50，这就会产生碎片。</p>
<h3 id="碎片到底产生了什么影响">碎片到底产生了什么影响<a hidden class="anchor" aria-hidden="true" href="#碎片到底产生了什么影响">#</a></h3>
<p>MySQL 既然产生了碎片，你可能比较豪横说磁盘空间够大，浪费空间也没事，但是这些碎片也会产生性能问题，碎片会有什么影响呢？</p>
<p><strong>空间浪费</strong></p>
<p>空间浪费不用多说，碎片占用了大量可用空间。</p>
<p><strong>读写性能下降</strong></p>
<p>由于存在大量碎片，数据从连续规则的存储方式变为随机分散的存储方式，磁盘 IO 会变的繁忙，数据库读写性能就会下降。</p>
<h3 id="找一找有哪些碎片">找一找有哪些碎片<a hidden class="anchor" aria-hidden="true" href="#找一找有哪些碎片">#</a></h3>
<p>现在我们有一个测试库 employees，在找碎片清理碎片前我们先查询一下表的数据，记录一下时间，以便后边做对比。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">current_dept_emp</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">   </span><span class="mi">300024</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">17</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">departments</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">        </span><span class="mi">9</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">dept_emp</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">   </span><span class="mi">331603</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">08</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">dept_emp_latest_date</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">   </span><span class="mi">300024</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">49</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">dept_manager</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">       </span><span class="mi">24</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">   </span><span class="mi">300024</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">09</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">salaries</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">2844047</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">60</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">titles</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">   </span><span class="mi">443308</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>接下来我们开始看看都有哪些碎片吧。这里介绍两种方式查看表碎片。</p>
<p><strong>1. 通过表状态信息查看</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">show table status like &#39;%table_name%&#39;;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">mysql&gt; show table status like &#39;salaries&#39;\G; </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">***************************</span><span class="w"> </span><span class="m">1</span><span class="l">. row ***************************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l">salaries</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">Engine</span><span class="p">:</span><span class="w"> </span><span class="l">InnoDB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">Row_format</span><span class="p">:</span><span class="w"> </span><span class="l">Dynamic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="nt">Rows</span><span class="p">:</span><span class="w"> </span><span class="m">2838918</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">Avg_row_length</span><span class="p">:</span><span class="w"> </span><span class="m">31</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Data_length</span><span class="p">:</span><span class="w"> </span><span class="m">90832896</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Max_data_length</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">Index_length</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">Data_free</span><span class="p">:</span><span class="w"> </span><span class="m">4194304</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">Auto_increment</span><span class="p">:</span><span class="w"> </span><span class="l">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Create_time</span><span class="p">:</span><span class="w"> </span><span class="ld">2021-01-14 14:33:47</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Update_time</span><span class="p">:</span><span class="w"> </span><span class="ld">2021-01-14 14:34:42</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">Check_time</span><span class="p">:</span><span class="w"> </span><span class="l">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">Collation</span><span class="p">:</span><span class="w"> </span><span class="l">utf8_bin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">Checksum</span><span class="p">:</span><span class="w"> </span><span class="l">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">Create_options</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Comment</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="m">1</span><span class="w"> </span><span class="l">row in set (0.00 sec)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>data<em>length 表数据大小 index</em>length 表索引大小 data_free 碎片大小</p>
<p>根据返回信息，我们知道碎片大小为 4194304（单位 B）</p>
<p><strong>2. 通过数据库视图信息查看</strong></p>
<p>查询 information_schema.tables 的 data_free 列的值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">t</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">t</span><span class="p">.</span><span class="k">table_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">t</span><span class="p">.</span><span class="n">table_rows</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">t</span><span class="p">.</span><span class="n">data_length</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">t</span><span class="p">.</span><span class="n">index_length</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">concat</span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">data_free</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s1">&#39;m&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">data_free</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">table_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;employees&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------+----------------------+------------+-------------+--------------+-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">TABLE_SCHEMA</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">TABLE_NAME</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="n">TABLE_ROWS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">DATA_LENGTH</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">INDEX_LENGTH</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">DATA_FREE</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------+----------------------+------------+-------------+--------------+-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">employees</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">current_dept_emp</span><span class="w">     </span><span class="o">|</span><span class="w">       </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">employees</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">departments</span><span class="w">          </span><span class="o">|</span><span class="w">          </span><span class="mi">9</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">16384</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">16384</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">employees</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">dept_emp</span><span class="w">             </span><span class="o">|</span><span class="w">     </span><span class="mi">331143</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">12075008</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">5783552</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">employees</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">dept_emp_latest_date</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">employees</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">dept_manager</span><span class="w">         </span><span class="o">|</span><span class="w">         </span><span class="mi">24</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">16384</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">16384</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">employees</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">employees</span><span class="w">            </span><span class="o">|</span><span class="w">     </span><span class="mi">299069</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">15220736</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">employees</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">salaries</span><span class="w">             </span><span class="o">|</span><span class="w">    </span><span class="mi">2838426</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">100270080</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">employees</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">titles</span><span class="w">               </span><span class="o">|</span><span class="w">     </span><span class="mi">442902</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">20512768</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="p">.</span><span class="mi">00</span><span class="n">M</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------+----------------------+------------+-------------+--------------+-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">8</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>根据结果显示，data_free 列数据就是我们要查询的表的碎片大小内容，是 4M。</p>
<h3 id="如何清理碎片">如何清理碎片<a hidden class="anchor" aria-hidden="true" href="#如何清理碎片">#</a></h3>
<p>找到表碎片了，我们如何清理呢？有两种方法。</p>
<p><strong>1. 分析表</strong></p>
<p>命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="nt">optimize</span> <span class="nt">table</span> <span class="nt">table_name</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个方法主要针对 MyISAM 引擎表使用，因为 MyISAM 表的数据和索引是分离的，optimize 表可以整理数据文件，重新排列索引。</p>
<p>注意：optimize 会锁表，时间长短依据表数据量的大小。</p>
<p><strong>2. 重建表引擎</strong></p>
<p>命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">innodb</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个方法主要针对 InnoDB 引擎表使用，该操作会重建表的存储引擎，重组数据和索引的存储。</p>
<p>刚才我们查到表 salaries 有 4M 的碎片，我们清理一下 salaries 表碎片：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">salaries</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">innodb</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>查询一下该表的碎片是否被清理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">t</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">t</span><span class="p">.</span><span class="k">table_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">t</span><span class="p">.</span><span class="n">table_rows</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">t</span><span class="p">.</span><span class="n">data_length</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">t</span><span class="p">.</span><span class="n">index_length</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">concat</span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">data_free</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s1">&#39;m&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">data_free</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">table_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;employees&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">table_name</span><span class="o">=</span><span class="s1">&#39;salaries&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------+------------+------------+-------------+--------------+-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">table_schema</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">table_rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data_length</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">index_length</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data_free</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------+------------+------------+-------------+--------------+-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">employees</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">salaries</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="mi">2838426</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">114950144</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="mi">00</span><span class="n">m</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------+------------+------------+-------------+--------------+-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>碎片从原来的 4M 清理到现在的 2M。</p>
<p>我们看看查询表是否提高了速度：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">salaries</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">2844047</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">16</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>速度还是提高了不少，清理碎片后提高了查询速度。</p>
<p><strong>总结一下</strong>：清理表的碎片可以提高 MySQL 性能，在日常工作中我们可以定期执行表碎片整理，从而提高 MySQL 性能。</p>
<h1 id="mysql-故障诊断一个-alter-talbe-执行了很久你慌不慌">MySQL 故障诊断：一个 ALTER TALBE 执行了很久，你慌不慌？<a hidden class="anchor" aria-hidden="true" href="#mysql-故障诊断一个-alter-talbe-执行了很久你慌不慌">#</a></h1>
<h3 id="先了解下-mysql-数据字典">先了解下 MySQL 数据字典<a hidden class="anchor" aria-hidden="true" href="#先了解下-mysql-数据字典">#</a></h3>
<p>当我们对一张大表执行了一个 ALTER TABLE 操作，执行了很久，也不知道是否执行完成，进程在那挂着，此时的你，干瞪眼，进度看不到，进程不敢杀，就问你慌不慌？</p>
<p>在具体解决这个慌乱之前，我们先了解下 MySQL 的数据字典。</p>
<p>数据字典我们用一句话来概括，就是数据的数据，用于查询数据库中数据的信息内容。</p>
<p>MySQL 在 5.7 开始，对数据字典的使用有了很大的改进，使用上更加的方便，提供的能力也更高。performance_schema 可以查询事务信息、获取元数据锁、跟踪事件、统计内存使用情况等等。</p>
<p>到这里你是不是发现了什么？</p>
<p>performance_schema 这个是什么，是不是用它来让我们解除慌张？</p>
<p>有关 MySQL 数据字典，可以看我的另外一个 Chat：</p>
<blockquote>
<p>[MySQL 地基基础：数据字典](./MySQL 地基基础：数据字典.md)</p>
</blockquote>
<h3 id="使用一些重要的重要功能">使用一些重要的重要功能<a hidden class="anchor" aria-hidden="true" href="#使用一些重要的重要功能">#</a></h3>
<p>既然了解到 MySQL 数据字典可以帮助我们，那它是如何实现呢？</p>
<p>我们先看看官网是如何解释的</p>
<blockquote>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/monitor-alter-table-performance-schema.html">https://dev.mysql.com/doc/refman/5.7/en/monitor-alter-table-performance-schema.html</a></p>
<p>You can monitor ALTER TABLE progress for InnoDB tables using Performance Schema.</p>
<p>There are seven stage events that represent different phases of ALTER TABLE. Each stage event reports a running total of WOR_COMPLETED and WORK_ESTIMATED for the overall ALTER TABLE operation as it progresses through its different phases. WORK_ESTIMATED is calculated using a formula that takes into account all of the work that ALTER TABLE performs, and may be revised during ALTER TABLE processing. WORK_COMPLETED and WORK_ESTIMATED values are an abstract representation of all of the work performed by ALTER TABLE.</p>
</blockquote>
<p>大意就是我们可以在 Performance Schema 看到 ALTER TABLE 的进度，包括执行的时间，大概剩余的时间。</p>
<p>想要使用这个能力，我们需要开启几个功能。</p>
<p><strong>Enable the stage/innodb/alter% instruments</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">setup_instruments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ENABLED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;YES&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">NAME</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;stage/innodb/alter%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Rows</span><span class="w"> </span><span class="n">matched</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="w">  </span><span class="n">Changed</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Enable the stage event consumer tables</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">setup_consumers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ENABLED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;YES&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">NAME</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;events_stages_current&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Rows</span><span class="w"> </span><span class="n">matched</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">Changed</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">setup_consumers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ENABLED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;YES&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">NAME</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;events_stages_history&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Rows</span><span class="w"> </span><span class="n">matched</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">Changed</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">setup_consumers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ENABLED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;YES&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">NAME</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;events_stages_history_long&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Rows</span><span class="w"> </span><span class="n">matched</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">Changed</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>功能开启了，接下来我们进行直观的验证环节。</p>
<h3 id="直观的观察事件执行进度">直观的观察事件执行进度<a hidden class="anchor" aria-hidden="true" href="#直观的观察事件执行进度">#</a></h3>
<p>首先，我们有一张大表（你可以用 SysBench 建一个，或者其他各种途径都可以），这里我已经有一张大表 sbtest.sbtest1，表结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="n">sbtest</span><span class="p">.</span><span class="n">sbtest1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------+-----------+------+-----+---------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Field</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Type</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">Null</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Key</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Default</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------+-----------+------+-----+---------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">PRI</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">k</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">MUL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">c</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">pad</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------+-----------+------+-----+---------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">4</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>数据量 500W：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w">  </span><span class="n">sbtest</span><span class="p">.</span><span class="n">sbtest1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">5000000</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">67</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>新增一个字段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">sbtest</span><span class="p">.</span><span class="n">sbtest1</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>重头戏来了，查看一下进度：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">mysql&gt; select * from performance_schema.events_stages_current\G;
</span></span><span class="line"><span class="cl"><span class="ge">**</span>************************* 1. row <span class="ge">**</span>*************************
</span></span><span class="line"><span class="cl">         THREAD_ID: 28
</span></span><span class="line"><span class="cl">          EVENT_ID: 14
</span></span><span class="line"><span class="cl">      END_EVENT_ID: NULL
</span></span><span class="line"><span class="cl">        EVENT_NAME: stage/innodb/alter table (read PK and internal sort)
</span></span><span class="line"><span class="cl">            SOURCE: 
</span></span><span class="line"><span class="cl">       TIMER_START: 159726265417733000
</span></span><span class="line"><span class="cl">         TIMER_END: 159819571346680000
</span></span><span class="line"><span class="cl">        TIMER_WAIT: 93305928947000
</span></span><span class="line"><span class="cl">    WORK_COMPLETED: 118256
</span></span><span class="line"><span class="cl">    WORK_ESTIMATED: 302958
</span></span><span class="line"><span class="cl">  NESTING_EVENT_ID: 13
</span></span><span class="line"><span class="cl">NESTING_EVENT_TYPE: STATEMENT
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; select * from performance_schema.events_stages_current\G;
</span></span><span class="line"><span class="cl"><span class="ge">**</span>************************* 1. row <span class="ge">**</span>*************************
</span></span><span class="line"><span class="cl">         THREAD_ID: 28
</span></span><span class="line"><span class="cl">          EVENT_ID: 14
</span></span><span class="line"><span class="cl">      END_EVENT_ID: NULL
</span></span><span class="line"><span class="cl">        EVENT_NAME: stage/innodb/alter table (read PK and internal sort)
</span></span><span class="line"><span class="cl">            SOURCE: 
</span></span><span class="line"><span class="cl">       TIMER_START: 159726265417733000
</span></span><span class="line"><span class="cl">         TIMER_END: 159910492100061000
</span></span><span class="line"><span class="cl">        TIMER_WAIT: 184226682328000
</span></span><span class="line"><span class="cl">    WORK_COMPLETED: 230688
</span></span><span class="line"><span class="cl">    WORK_ESTIMATED: 302958
</span></span><span class="line"><span class="cl">  NESTING_EVENT_ID: 13
</span></span><span class="line"><span class="cl">NESTING_EVENT_TYPE: STATEMENT
</span></span><span class="line"><span class="cl">1 row in set (0.01 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><p>多执行几次，发现数据是有变化的，这些内容代表了什么呢？</p>
<ul>
<li>THREAD_ID：线程 ID</li>
<li>EVENT_ID：事件 ID</li>
<li>END_EVENT_ID：结束事件 ID</li>
<li>EVENT_NAME：事件名称，说明了当前执行的事件</li>
<li>SOURCE：源码位置</li>
<li>TIMER_START：事件开始时间（皮秒）</li>
<li>TIMER_END：事件结束时间（皮秒，如果没有执行完成，时间就是当前之间）</li>
<li>TIMER_WAIT：事件等待事件（皮秒）</li>
<li>WORK_COMPLETED：任务完成情况</li>
<li>WORK_ESTIMATED：任务估算情况</li>
<li>NESTING_EVENT_ID：事件对应的父事件 ID</li>
<li>NESTING_EVENT_TYPE：父事件类型（STATEMENT、STAGE、WAIT）</li>
</ul>
<h3 id="收下这个常用的-sql">收下这个常用的 SQL<a hidden class="anchor" aria-hidden="true" href="#收下这个常用的-sql">#</a></h3>
<ol>
<li>查看事件任务完成情况：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">pt</span><span class="p">.</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="n">ec</span><span class="p">.</span><span class="n">THREAD_ID</span><span class="p">,</span><span class="w"> </span><span class="n">ec</span><span class="p">.</span><span class="n">EVENT_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">ec</span><span class="p">.</span><span class="n">WORK_COMPLETED</span><span class="p">,</span><span class="w"> </span><span class="n">ec</span><span class="p">.</span><span class="n">WORK_ESTIMATED</span><span class="p">,</span><span class="w"> </span><span class="n">pt</span><span class="p">.</span><span class="k">STATE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">events_stages_current</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">threads</span><span class="w"> </span><span class="n">th</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">ec</span><span class="p">.</span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">th</span><span class="p">.</span><span class="n">thread_id</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">PROCESSLIST</span><span class="w"> </span><span class="n">pt</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">th</span><span class="p">.</span><span class="n">PROCESSLIST_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">pt</span><span class="p">.</span><span class="n">INFO</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;ALTER%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------------------+-----------+------------------------------------------------------+----------------+----------------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">INFO</span><span class="w">                                      </span><span class="o">|</span><span class="w"> </span><span class="n">THREAD_ID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">EVENT_NAME</span><span class="w">                                           </span><span class="o">|</span><span class="w"> </span><span class="n">WORK_COMPLETED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">WORK_ESTIMATED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">STATE</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------------------+-----------+------------------------------------------------------+----------------+----------------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">sbtest</span><span class="p">.</span><span class="n">sbtest1</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">28</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">stage</span><span class="o">/</span><span class="n">innodb</span><span class="o">/</span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="p">(</span><span class="k">read</span><span class="w"> </span><span class="n">PK</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="n">sort</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">201496</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">308223</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">altering</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------------------+-----------+------------------------------------------------------+----------------+----------------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>查看任务完成事件：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">stmt</span><span class="p">.</span><span class="n">sql_text</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">sql_text</span><span class="p">,</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">work_completed</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">work_estimated</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">progress</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="n">timer_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">stmt</span><span class="p">.</span><span class="n">timer_start</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1</span><span class="n">e12</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">current_seconds</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="n">timer_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">stmt</span><span class="p">.</span><span class="n">timer_start</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1</span><span class="n">e12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">work_estimated</span><span class="o">-</span><span class="n">work_completed</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">work_completed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">remaining_seconds</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">events_stages_current</span><span class="w"> </span><span class="n">stage</span><span class="p">,</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">events_statements_current</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stmt</span><span class="p">.</span><span class="n">thread_id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="n">nesting_event_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stmt</span><span class="p">.</span><span class="n">event_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------------------+---------------+-----------------+--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">sql_text</span><span class="w">                                  </span><span class="o">|</span><span class="w"> </span><span class="n">progress</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">current_seconds</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">remaining_seconds</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------------------+---------------+-----------------+--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">sbtest</span><span class="p">.</span><span class="n">sbtest1</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">135192</span><span class="o">/</span><span class="mi">308223</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">102</span><span class="p">.</span><span class="mi">461512532</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">131</span><span class="p">.</span><span class="mi">13954949201502</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------------------+---------------+-----------------+--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h3>
<p>这样我们通过 MySQL 的这个数据字典就可以很直观地看到 ALTER 的执行情况了，当你看到这样的执行进度，是不是就不那么慌了。</p>
<h1 id="mysql-故障诊断教你快速定位加锁的-sql">MySQL 故障诊断：教你快速定位加锁的 SQL<a hidden class="anchor" aria-hidden="true" href="#mysql-故障诊断教你快速定位加锁的-sql">#</a></h1>
<h3 id="为什么会加锁">为什么会加锁<a hidden class="anchor" aria-hidden="true" href="#为什么会加锁">#</a></h3>
<p>锁是可以协调并发连接访问 MySQL 数据库资源的一种技术，可以保证数据的一致性。</p>
<p>有关 MySQL 锁的具体内容，可以详看我的另外一个 Chat，其中有一部分介绍的是“MySQL 锁机制（机智）”：</p>
<blockquote>
<p>[MySQL 地基基础：事务和锁的面纱](MySQL 地基基础：事务和锁的面纱.md)</p>
</blockquote>
<h3 id="数据库锁有什么威力">数据库锁有什么威力<a hidden class="anchor" aria-hidden="true" href="#数据库锁有什么威力">#</a></h3>
<p>在实际应用中你肯定遇到过锁问题，这个锁的威力很大，那出现了数据库锁，会造成什么影响呢？</p>
<p><strong>锁等待</strong></p>
<p>一个连接申请了锁资源，其他连接要申请资源，无法获取，等待资源释放。</p>
<p><strong>死锁</strong></p>
<p>你锁我，我也锁你，大家一起锁着吧。</p>
<h3 id="快速定位加锁的-sql">快速定位加锁的 SQL<a hidden class="anchor" aria-hidden="true" href="#快速定位加锁的-sql">#</a></h3>
<p>既然出现了锁，我们就要管理一下这个锁，找一找是什么 SQL 持有这个锁，早点发现锁，提前干预，下面我们看看如何快速定位加锁的 SQL。</p>
<p>首先我们创建一个测试表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">t1</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">decimal</span><span class="p">,</span><span class="n">v_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+--------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">v_name</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+--------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">a</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">    </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">b</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">c</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+--------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>会话 1，开启事务，更新 id=1 的数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; begin<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; update t1 <span class="nb">set</span> <span class="nv">v_name</span><span class="o">=</span><span class="s1">&#39;aa&#39;</span> where <span class="nv">id</span><span class="o">=</span>1<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>会话 2，开启另一个事务，删除 id=1 的数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; begin<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; delete from t1 where <span class="nv">id</span><span class="o">=</span>1<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此时会话 2 被锁定，出现锁等待。</p>
<p>我们再开一个会话 3，查查当前的 processlist，看看是否能发现什么？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">processlist</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+------+-----------+------+---------+------+----------+---------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">User</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Host</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">db</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">State</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Info</span><span class="w">                      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+------+-----------+------+---------+------+----------+---------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">38</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sleep</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">                      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">41</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">updating</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">processlist</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+------+-----------+------+---------+------+----------+---------------------------+
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看到 delete 这个 SQL 的进程在执行中，并没有发现其他有价值的内容，那锁在哪里了。接下来的步骤带你一步步的定位出加锁的 SQL。</p>
<p><strong>定位锁等待</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">innodb_lock_waits</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------+-------------------+-----------------+------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">requesting_trx_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">requested_lock_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">blocking_trx_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">blocking_lock_id</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------+-------------------+-----------------+------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">2207</span><span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="mi">2207</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">2206</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">2206</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------------+-------------------+-----------------+------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果显示有一个锁等待。</p>
<p><strong>定位锁</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">innodb_locks</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------+-------------+-----------+-----------+-------------+-----------------+------------+-----------+----------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">lock_id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">lock_trx_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">lock_mode</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">lock_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">lock_table</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">lock_index</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">lock_space</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">lock_page</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">lock_rec</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">lock_data</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------+-------------+-----------+-----------+-------------+-----------------+------------+-----------+----------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">2207</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2207</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">X</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">RECORD</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">t1</span><span class="o">`</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GEN_CLUST_INDEX</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">28</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="n">x000000000211</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">2206</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2206</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">X</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">RECORD</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">`</span><span class="n">test</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">t1</span><span class="o">`</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GEN_CLUST_INDEX</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">28</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="n">x000000000211</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------------+-------------+-----------+-----------+-------------+-----------------+------------+-----------+----------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果显示有两个锁相关内容。</p>
<p><strong>定位事务</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">trx_id</span><span class="p">,</span><span class="n">trx_started</span><span class="p">,</span><span class="n">trx_requested_lock_id</span><span class="p">,</span><span class="n">trx_query</span><span class="p">,</span><span class="n">trx_mysql_thread_id</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">innodb_trx</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------+---------------------+-----------------------+---------------------------+---------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">trx_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">trx_started</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">trx_requested_lock_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">trx_query</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="n">trx_mysql_thread_id</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------+---------------------+-----------------------+---------------------------+---------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">2207</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2021</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">11</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2207</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">                  </span><span class="mi">41</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">2206</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2021</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">08</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">                      </span><span class="o">|</span><span class="w">                  </span><span class="mi">38</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------+---------------------+-----------------------+---------------------------+---------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果有两个事务，MySQL 事务线程 id 为 38 和 41，很直观的看到 41 是我们的 delete 事务，被 38 锁定。</p>
<p><strong>定位线程</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">threads</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">processlist_id</span><span class="o">=</span><span class="mi">38</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------+---------------------------+------------+----------------+------------------+------------------+----------------+---------------------+------------------+-------------------+------------------+------------------+------+--------------+---------+-----------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">THREAD_ID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NAME</span><span class="w">                      </span><span class="o">|</span><span class="w"> </span><span class="k">TYPE</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">PROCESSLIST_ID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROCESSLIST_USER</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROCESSLIST_HOST</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROCESSLIST_DB</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROCESSLIST_COMMAND</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROCESSLIST_TIME</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROCESSLIST_STATE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROCESSLIST_INFO</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PARENT_THREAD_ID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">INSTRUMENTED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">HISTORY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CONNECTION_TYPE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">THREAD_OS_ID</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------+---------------------------+------------+----------------+------------------+------------------+----------------+---------------------+------------------+-------------------+------------------+------------------+------+--------------+---------+-----------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">        </span><span class="mi">63</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">thread</span><span class="o">/</span><span class="k">sql</span><span class="o">/</span><span class="n">one_connection</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">FOREGROUND</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">38</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">root</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="n">localhost</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="n">Sleep</span><span class="w">               </span><span class="o">|</span><span class="w">               </span><span class="mi">35</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">             </span><span class="o">|</span><span class="w">             </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">Socket</span><span class="w">          </span><span class="o">|</span><span class="w">        </span><span class="mi">15070</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------+---------------------------+------------+----------------+------------------+------------------+----------------+---------------------+------------------+-------------------+------------------+------------------+------+--------------+---------+-----------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果找到 MySQL 事务线程 38 对应的服务器线程 63。</p>
<p><strong>定位加锁 SQL</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">events_statements_current</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">thread_id</span><span class="o">=</span><span class="mi">63</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------+----------+--------------+----------------------+--------------------------+---------------------+---------------------+------------+-----------+--------------------------------------+----------------------------------+----------------------------------------------+----------------+-------------+---------------+-------------+-----------------------+-------------+-------------------+------------------------------------------+--------+----------+---------------+-----------+---------------+-------------------------+--------------------+------------------+------------------------+--------------+--------------------+-------------+-------------------+------------+-----------+-----------+---------------+--------------------+------------------+--------------------+---------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">THREAD_ID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">EVENT_ID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">END_EVENT_ID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">EVENT_NAME</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="k">SOURCE</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">TIMER_START</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">TIMER_END</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="n">TIMER_WAIT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LOCK_TIME</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SQL_TEXT</span><span class="w">                             </span><span class="o">|</span><span class="w"> </span><span class="n">DIGEST</span><span class="w">                           </span><span class="o">|</span><span class="w"> </span><span class="n">DIGEST_TEXT</span><span class="w">                                  </span><span class="o">|</span><span class="w"> </span><span class="n">CURRENT_SCHEMA</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">OBJECT_TYPE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">OBJECT_SCHEMA</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">OBJECT_NAME</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">OBJECT_INSTANCE_BEGIN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MYSQL_ERRNO</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">RETURNED_SQLSTATE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">MESSAGE_TEXT</span><span class="w">                             </span><span class="o">|</span><span class="w"> </span><span class="n">ERRORS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">WARNINGS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ROWS_AFFECTED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ROWS_SENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ROWS_EXAMINED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CREATED_TMP_DISK_TABLES</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CREATED_TMP_TABLES</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SELECT_FULL_JOIN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SELECT_FULL_RANGE_JOIN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SELECT_RANGE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SELECT_RANGE_CHECK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SELECT_SCAN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SORT_MERGE_PASSES</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SORT_RANGE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SORT_ROWS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SORT_SCAN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NO_INDEX_USED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NO_GOOD_INDEX_USED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NESTING_EVENT_ID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NESTING_EVENT_TYPE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NESTING_EVENT_LEVEL</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------+----------+--------------+----------------------+--------------------------+---------------------+---------------------+------------+-----------+--------------------------------------+----------------------------------+----------------------------------------------+----------------+-------------+---------------+-------------+-----------------------+-------------+-------------------+------------------------------------------+--------+----------+---------------+-----------+---------------+-------------------------+--------------------+------------------+------------------------+--------------+--------------------+-------------+-------------------+------------+-----------+-----------+---------------+--------------------+------------------+--------------------+---------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">        </span><span class="mi">63</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">statement</span><span class="o">/</span><span class="k">sql</span><span class="o">/</span><span class="k">update</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">socket_connection</span><span class="p">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">101</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2757904906303653000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2757904906543381000</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">239728000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">145000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">v_name</span><span class="o">=</span><span class="s1">&#39;aa&#39;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">356</span><span class="n">a053ffb5eae2a35981b05090faa01</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="o">`</span><span class="n">t1</span><span class="o">`</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">`</span><span class="n">v_name</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">        </span><span class="o">|</span><span class="w">                  </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">00000</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="k">Rows</span><span class="w"> </span><span class="n">matched</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">Changed</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">                       </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">                  </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">                </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">                      </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">                  </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">                 </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">          </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">                  </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">               </span><span class="o">|</span><span class="w">                   </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------+----------+--------------+----------------------+--------------------------+---------------------+---------------------+------------+-----------+--------------------------------------+----------------------------------+----------------------------------------------+----------------+-------------+---------------+-------------+-----------------------+-------------+-------------------+------------------------------------------+--------+----------+---------------+-----------+---------------+-------------------------+--------------------+------------------+------------------------+--------------+--------------------+-------------+-------------------+------------+-----------+-----------+---------------+--------------------+------------------+--------------------+---------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果中我们找到了加锁的 update 的 SQL 语句。</p>
<p><strong>总结</strong></p>
<p>在 MySQL 数据库中出现了锁，不要着急，我们通过这个方法可以快速定位加锁的 SQL，你学会了吗？</p>
<h1 id="mysql优化优化-select-count">MySQL优化：优化 select count()<a hidden class="anchor" aria-hidden="true" href="#mysql优化优化-select-count">#</a></h1>
<h3 id="业务反馈开发崩溃">业务反馈，开发崩溃<a hidden class="anchor" aria-hidden="true" href="#业务反馈开发崩溃">#</a></h3>
<p>某天，项目中业务人员反馈系统中某功能查询非常的慢，几乎等待了几十秒才有反应。于是联系了开发，开发人员调取日志，排查应用，定位 SQL，其实只是一个 <code>select count(*)</code>，这可急坏了开发人员，非常困惑，最简答的一个统计 SQL，为什么查询这么慢！不知道到如何优化与处理。</p>
<p><strong>一个效果显著的简单操作</strong></p>
<p>在我知道这个问题，询问了开发人员哪张表后，做了一定分析后，<strong>增加索引</strong>，无需开发做任何修改，性能得到大幅提升。为什么一个索引会有如此的性能提升，我先卖个关子，后面一一道来。</p>
<h3 id="问题复现优化处理">问题复现，优化处理<a hidden class="anchor" aria-hidden="true" href="#问题复现优化处理">#</a></h3>
<p>首先我们造一个 500W 数据量的表，别结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">sbtest1</span><span class="err">\</span><span class="k">G</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">***************************</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="n">sbtest1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Create</span><span class="w"> </span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">sbtest1</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">k</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="k">pad</span><span class="o">`</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">5000001</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>直接来 count(*) 一下，看看执行时间吧。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sbtest1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">5000000</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">42</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>执行时间 2.42 秒。</p>
<p>现在看看执行计划：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sbtest1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">sbtest1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4808163</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>结果显示：走 PRIMARY 索引。</strong></p>
<p>是不是有疑惑了，查询走了主键索引，看着没什么问题呀，500W 的数据 2 秒执行完，还可以。那你就错了，我这里只是一个简单的测试表，这才几个字段，测试表造的数据又是多么的简单，倘若在真实生产环境，这 500W 的数据可不是 2 秒就能返回结果的。</p>
<p>稍等片刻，我来优化…… …… …… ……</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sbtest1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">5000000</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">68</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>执行时间明显缩短，我到底做了怎样的操作，为什么执行效率大幅提高，想知道其中的奥妙吗？干货即将送达。</p>
<h3 id="扒一扒-count-的原理">扒一扒 count(*) 的原理<a hidden class="anchor" aria-hidden="true" href="#扒一扒-count-的原理">#</a></h3>
<p>为了解开这其中的疑惑，首先我们不得不说一下 MySQL 的 count(*) 原理。</p>
<p>在 MySQL 中存在两种索引：</p>
<ul>
<li><strong>聚簇索引</strong>：MySQL 中的每个 InnoDB 存储引擎的表，都有一个特殊索引来保存每行记录，这个索引就是聚簇索引。通常情况下其实就是主键。聚簇索引保存的是行记录和 b-tree 索引，这个索引所占用的空间大小和行记录总数差不多大。</li>
<li><strong>二级索引</strong>：另外一类索引就是二级索引，它保存的只是本身索引列和主键列。占用的空间明显小很多了。</li>
</ul>
<p>介绍完 MySQL 的两种索引，我们继续说 MySQL 的 count(*) 执行过程。</p>
<p>在 MySQL 的 InnoDB 存储引擎中，count(*) 会从内存中读取数据到缓冲区中，如果内存中没有，会提前一步在磁盘中把数据读取到内存中，然后在缓存区中完成记录数的统计。MySQL 会先通过 ken_len 最小的那个二级索引计算，如果没有二级索引就通过主键计算，如果连主键都没有那就要通过全表扫描来完成计算了。</p>
<p>主键索引也就是聚簇索引，会把行记录和 b-tree 索引都读取出来，所占用的空间大小和行记录总数差不多大；二级索引保存的只是本身索引列和主键列，占用的空间会小的多，当然读取出来就节省了很多时间。</p>
<p>我举个通俗易懂的例子吧，比如学校给你一个任务，让你统计一下高三年级一共有多少学生？利用上面说的两种索引来统计。</p>
<ul>
<li>聚簇索引：从学号 1，一个一个数到 600，有 600 人。</li>
<li>二级索引：直接看学号 600，那不就是 600 人吗！</li>
</ul>
<p>通过这些就不难说明了，上述演示的过程，第一次是通过主键来计算统计数据量，而第二次其实我做的也是创建了一个二级索引，通过二级索引来计算统计，速度快了很多，我们可以看看其对应的执行过程。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sbtest1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">sbtest1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">k_1</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4808163</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>执行过程 key 这一列内容为：k_1，这个就是二级索引的索引名称。</p>
<h3 id="显而易见的验证">显而易见的验证<a hidden class="anchor" aria-hidden="true" href="#显而易见的验证">#</a></h3>
<h4 id="验证聚簇索引">验证聚簇索引<a hidden class="anchor" aria-hidden="true" href="#验证聚簇索引">#</a></h4>
<p>查询 MySQL 缓存区，确保缓冲区中不存在测试表的缓存：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">innodb_buffer_stats_by_table</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">object_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;sbtest&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Empty</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">05</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>执行 <code>select count(*)</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sbtest1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">5000000</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">42</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>再次查看 MySQL 缓存区，查询测试表的缓存：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">innodb_buffer_stats_by_table</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">object_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;sbtest&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">---------------+-------------+------------+------------+-------+--------------+-----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">object_schema</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">object_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">allocated</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">data</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">pages_hashed</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">pages_old</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rows_cached</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">---------------+-------------+------------+------------+-------+--------------+-----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">sbtest</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">sbtest1</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">125</span><span class="p">.</span><span class="mi">84</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">115</span><span class="p">.</span><span class="mi">46</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">8054</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">3021</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">588845</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">---------------+-------------+------------+------------+-------+--------------+-----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">13</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果显示：缓存了 100M+ 的数据。</p>
<p>查看执行计划：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sbtest1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">sbtest1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4808163</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果显示 <code>select count(*)</code> 走的是主键索引。</p>
<h4 id="验证二级索引">验证二级索引<a hidden class="anchor" aria-hidden="true" href="#验证二级索引">#</a></h4>
<p>创建一个二级索引：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scss" data-lang="scss"><span class="line"><span class="cl"><span class="nt">mysql</span><span class="o">&gt;</span> <span class="nt">create</span> <span class="nt">index</span> <span class="nt">k_1</span> <span class="nt">on</span> <span class="nt">sbtest1</span><span class="o">(</span><span class="nt">k</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nt">Query</span> <span class="nt">OK</span><span class="o">,</span> <span class="nt">0</span> <span class="nt">rows</span> <span class="nt">affected</span> <span class="o">(</span><span class="nt">53</span><span class="nc">.61</span> <span class="nt">sec</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nt">Records</span><span class="nd">:</span> <span class="nt">0</span>  <span class="nt">Duplicates</span><span class="nd">:</span> <span class="nt">0</span>  <span class="nt">Warnings</span><span class="nd">:</span> <span class="nt">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>为了验证本次过程，我们重启一下 MySQL，目的是清空 MySQL 的缓存。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">......  
</span></span><span class="line"><span class="cl">MySQL 重启完成  
</span></span><span class="line"><span class="cl">......  
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询 MySQL 缓存区，确保缓冲区中不存在测试表的缓存：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">innodb_buffer_stats_by_table</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">object_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;sbtest&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Empty</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">05</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>执行 <code>select count(*)</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sbtest1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">5000000</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">73</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>再次查看 MySQL 缓存区，查询测试表的缓存：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">innodb_buffer_stats_by_table</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">object_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;sbtest&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">---------------+-------------+-----------+-----------+-------+--------------+-----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">object_schema</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">object_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">allocated</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">data</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">pages_hashed</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">pages_old</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rows_cached</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">---------------+-------------+-----------+-----------+-------+--------------+-----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">sbtest</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">sbtest1</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">65</span><span class="p">.</span><span class="mi">09</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">62</span><span class="p">.</span><span class="mi">06</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">4166</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">1459</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">2501935</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">---------------+-------------+-----------+-----------+-------+--------------+-----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">08</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果显示：缓存了 60M+ 的数据。</p>
<p>查看执行计划：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sbtest1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">sbtest1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">k_1</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4808163</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+---------+------------+-------+---------------+------+---------+------+---------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果显示 <code>select count(*)</code> 走的是二级索引 k_1。</p>
<h4 id="更加直观看一下两种索引占用的空间大小">更加直观看一下两种索引占用的空间大小<a hidden class="anchor" aria-hidden="true" href="#更加直观看一下两种索引占用的空间大小">#</a></h4>
<p>首先我们查看一下 MySQL 的 innodb_page_size 的大小：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;Innodb_page_size&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Variable_name</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">innodb_page_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">16384</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>大小是 16K。</p>
<p>统计一下聚簇索引和二级索引占用的空间大小：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="k">sum</span><span class="p">(</span><span class="n">stat_value</span><span class="p">)</span><span class="w"> </span><span class="n">pages</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="n">index_name</span><span class="w"> </span><span class="n">index_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="p">(</span><span class="n">round</span><span class="p">((</span><span class="k">sum</span><span class="p">(</span><span class="n">stat_value</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">@@</span><span class="n">innodb_page_size</span><span class="p">)</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">MB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="k">from</span><span class="w"> </span><span class="n">mysql</span><span class="p">.</span><span class="n">innodb_index_stats</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="k">where</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;sbtest1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">database_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;sbtest&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">stat_description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Number of pages in the index&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">index_name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------+------------+------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">index_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MB</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------+------------+------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">67456</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">1054</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">4774</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">k_1</span><span class="w">        </span><span class="o">|</span><span class="w">   </span><span class="mi">75</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-------+------------+------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这样结果太明显了，主键索引占用了几乎 1 个 G 的空间，而 k_1 这个二级索引值占用了 75M 的空间。</p>
<h3 id="总结与思考">总结与思考<a hidden class="anchor" aria-hidden="true" href="#总结与思考">#</a></h3>
<p>MySQL 的 <code>select count(*)</code> 在底层实现统计的过程中通过二级索引优于主键索引优于全表扫描，这是因为二级索引只缓存主键列和索引列，主键索引几乎缓存了所有的行记录，前者势必比后者缓存的内容少的多，当然计算的效率肯定要快的多。</p>
<p>我们再思考一下，假如数据量不是 500W，而二级索引占用的空间都 1G、10G，甚至几十 G 了，速度也就不可接受了，怎么办？</p>
<p>这个时候我们不能局限于二级索引了，而可考虑：</p>
<ol>
<li>单纯的统计，我们可以考虑用 MyISAM 引擎，它自带计数器，当然了，局限性就不一一列举了，此方案了解即可吧。</li>
<li>数据仓库等其他可接入的系统来完成此工作。</li>
<li>缓存中间件也不失一个好的建议。</li>
<li>做一个类似触发器计数的功能？</li>
<li>MySQL 8.0 的并行查询，嗯，好功能。</li>
<li>历史数据迁移，就不让你查询那么多数据了，这个有点霸道了，可以换着说法，根据业务需求，历史数据迁移，只保留某些数据（按规则）。</li>
<li>分库分表，不多说什么，还是物理上的优化。</li>
<li>服务器硬件资源提升，比如 SSD 硬盘等（治标不治本）。</li>
<li>其他（肯定不止以上 8 种，如果你还有其他想法，请尊留言）。</li>
</ol>
<p>好了，至此我们基本学习完 select count(*)相关内容了，内容比较多，当然也有不足之处，欢迎朋友们指正补充。</p>
<h1 id="mysql共享锁排他锁悲观锁乐观锁">MySQL共享锁、排他锁、悲观锁、乐观锁<a hidden class="anchor" aria-hidden="true" href="#mysql共享锁排他锁悲观锁乐观锁">#</a></h1>
<p><strong>一、相关名词</strong></p>
<p>　　|&ndash;表级锁（锁定整个表）</p>
<p>　　|&ndash;页级锁（锁定一页）</p>
<p>　　|&ndash;行级锁（锁定一行）</p>
<p>　　|&ndash;共享锁（S锁，MyISAM 叫做读锁）</p>
<p>　　|&ndash;排他锁（X锁，MyISAM 叫做写锁）</p>
<p>　　|&ndash;间隙锁（NEXT-KEY锁）</p>
<p>　　|&ndash;悲观锁（抽象性，不真实存在这个锁）</p>
<p>　　|&ndash;乐观锁（抽象性，不真实存在这个锁）</p>
<p><strong>二、InnoDB与MyISAM</strong></p>
<p>　　Mysql 在5.5之前默认使用 MyISAM 存储引擎，之后使用 InnoDB 。查看当前存储引擎：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%storage_engine%&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>　　MyISAM 操作数据都是使用的表锁，你更新一条记录就要锁整个表，导致性能较低，并发不高。当然同时它也不会存在死锁问题。</p>
<p>　　而 InnoDB 与 MyISAM 的最大不同有两点：<strong>一是 InnoDB 支持事务；二是 InnoDB 采用了行级锁</strong>。也就是你需要修改哪行，就可以只锁定哪行。</p>
<p>　　在 Mysql 中，行级锁并不是直接锁记录，而是锁索引。索引分为主键索引和非主键索引两种，如果一条sql 语句操作了主键索引，Mysql 就会锁定这条主键索引；如果一条语句操作了非主键索引，MySQL会先锁定该非主键索引，再锁定相关的主键索引。</p>
<p>　　InnoDB 行锁是通过给索引项加锁实现的，如果没有索引，InnoDB 会通过隐藏的聚簇索引来对记录加锁。也就是说：如果不通过索引条件检索数据，那么InnoDB将对表中所有数据加锁，实际效果跟表锁一样。因为没有了索引，找到某一条记录就得扫描全表，要扫描全表，就得锁定表。</p>
<p><strong>三、共享锁与排他锁</strong></p>
<p>　1.首先说明：数据库的<strong>增删改</strong>操作默认都会加<strong>排他锁</strong>，而查询不会加任何锁。</p>
<p>　　mysql InnoDB引擎默认的修改数据语句，<strong>update</strong>,<strong>delete</strong>,<strong>insert</strong>都会自动给涉及到的数据加上<strong>排他锁</strong>，<strong>select</strong>语句默认不会加任何锁类型，如果加排他锁可以使用select &hellip;for update语句，加共享锁可以使用select &hellip; lock in share mode语句。所以加过排他锁的数据行在其他事务种是不能修改数据的，也不能通过for update和lock in share mode锁的方式查询数据，但可以直接通过select &hellip;from&hellip;查询数据，因为普通查询没有任何锁机制。</p>
<p>　　<strong>|&ndash;共享锁</strong>：对某一资源加共享锁，自身可以读该资源，其他人也可以读该资源（也可以再继续加共享锁，即 共享锁可多个共存），但无法修改。要想修改就必须等所有共享锁都释放完之后。语法为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">select</span> <span class="p">*</span> <span class="k">from</span> <span class="n">table</span> <span class="k">lock</span> <span class="k">in</span> <span class="n">share</span> <span class="n">mode</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>　　<strong>|&ndash;排他锁</strong>：对某一资源加排他锁，自身可以进行增删改查，其他人无法进行任何操作。语法为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">update</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>　2.下面援引例子说明 （援自：http://blog.csdn.net/samjustin1/article/details/52210125）：</p>
<p>　　<em>这里用T1代表一个数据库执行请求，T2代表另一个请求，也可以理解为T1为一个线程，T2 为另一个线程。</em></p>
<hr>
<p>例1：</p>
<p>　　T1: <em>select * from table lock in share mode</em>（假设查询会花很长时间，下面的例子也都这么假设）</p>
<p>　　T2: <em>update table set column1=&lsquo;hello&rsquo;</em></p>
<p>　　过程：</p>
<p>　　　　T1运行（并加共享锁)</p>
<p>　　　　T2运行</p>
<p>　　　　if T1还没执行完</p>
<p>　　　　T2等&hellip;&hellip;</p>
<p>　　　　else 锁被释放</p>
<p>　　　　T2执行</p>
<p>　　　　end if</p>
<p>　　T2 之所以要等，是因为 T2 在执行 update 前，试图对 table 表加一个排他锁，而数据库规定同一资源上不能同时共存共享锁和排他锁。所以 T2 必须等 T1 执行完，释放了共享锁，才能加上排他锁，然后才能开始执行 update 语句。</p>
<hr>
<p>例2：</p>
<p>　　T1: select * from table lock in share mode</p>
<p>　　T2: select * from table lock in share mode</p>
<p>　这里T2不用等待T1执行完，而是可以马上执行。</p>
<p>分析：</p>
<p>　　T1运行，则 table 被加锁，比如叫lockA，T2运行，再对 table 加一个共享锁，比如叫lockB，两个锁是可以同时存在于同一资源上的（比如同一个表上）。这被称为共享锁与共享锁兼容。这意味着共享锁不阻止其它人同时读资源，但阻止其它人修改资源。</p>
<hr>
<p>例3：</p>
<p>　　T1: <em>select * from table lock in share mode</em></p>
<p>　　T2: <em>select * from table lock in share mode</em></p>
<p>　　T3: <em>update table set column1=&lsquo;hello&rsquo;</em></p>
<p>　T2 不用等 T1 运行完就能运行，T3 却要等 T1 和 T2 都运行完才能运行。因为 T3 必须等 T1 和 T2 的共享锁全部释放才能进行加排他锁然后执行 update 操作。</p>
<hr>
<p>例4 （死锁的发生）：</p>
<p>　　T1:begin tran</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="err">　　</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">lock</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">share</span><span class="w"> </span><span class="k">mode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="err">　　</span><span class="k">update</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">column1</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>　　T2:begin tran</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="err">　　</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">lock</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">share</span><span class="w"> </span><span class="k">mode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="err">　　</span><span class="k">update</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">column1</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>　　假设 T1 和 T2 同时达到 select，T1 对 table 加共享锁，T2 也对 table 加共享锁，当 T1 的 select 执行完，准备执行 update 时，根据锁机制，T1 的共享锁需要升级到排他锁才能执行接下来的 update。在升级排他锁前，必须等 table 上的其它共享锁（T2）释放，同理，T2 也在等 T1 的共享锁释放。于是死锁产生了。</p>
<hr>
<p>例5：</p>
<p>　　T1:<em>begin tran</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="err">　　</span><span class="o">*</span><span class="k">update</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">column1</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>　　T2:<em>begin tran</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="err">　　</span><span class="o">*</span><span class="k">update</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">column1</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">20</span><span class="o">*</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>　这种语句虽然最为常见，很多人觉得它有机会产生死锁，但实际上要看情况</p>
<p>　　|&ndash;如果id是主键（默认有主键索引），那么T1会一下子找到该条记录(id=10的记录），然后对该条记录加排他锁，T2，同样，一下子通过索引定位到记录，然后对id=20的记录加排他锁，这样T1和T2各更新各的，互不影响。T2也不需要等。</p>
<p>　　|&ndash;如果id是普通的一列，没有索引。那么当T1对id=10这一行加排他锁后，T2为了找到id=20，需要对全表扫描。但因为T1已经为一条记录加了排他锁，导致T2的全表扫描进行不下去（其实是因为T1加了排他锁，数据库默认会为该表加意向锁，T2要扫描全表，就得等该意向锁释放，也就是T1执行完成），就导致T2等待。</p>
<p>死锁怎么解决呢？一种办法是，如下：</p>
<hr>
<p>例6：</p>
<p>　　T1:begin tran</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="err">　　</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">update</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="err">　　</span><span class="k">update</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">column1</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>　　T2:begin tran</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="err">　　</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">update</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="err">　　</span><span class="k">update</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">column1</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>　　这样，当 T1 的 select 执行时，直接对表加上了排他锁，T2 在执行 select 时，就需要等 T1 事物完全执行完才能执行。排除了死锁发生。但当第三个 user 过来想执行一个查询语句时，也因为排他锁的存在而不得不等待，第四个、第五个 user 也会因此而等待。在大并发情况下，让大家等待显得性能就太友好了。</p>
<p>　　所以，有些数据库这里引入了更新锁（如Mssql，注意：Mysql不存在更新锁）。</p>
<hr>
<p>例7：</p>
<p>T1:begin tran</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="p">[</span><span class="err">加更新锁操作</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">column1</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>T2:begin tran</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="p">[</span><span class="err">加更新锁操作</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">column1</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>　　更新锁其实就可以看成排他锁的一种变形，只是它也允许其他人读（并且还允许加共享锁）。但不允许其他操作，除非我释放了更新锁。T1 执行 select，加更新锁。T2 运行，准备加更新锁，但发现已经有一个更新锁在那儿了，只好等。当后来有 user3、user4&hellip;需要查询 table 表中的数据时，并不会因为 T1 的 select 在执行就被阻塞，照样能查询，相比起例6，这提高了效率。</p>
<p>后面还有意向锁和计划锁：</p>
<p>　　计划锁，和程序员关系不大，就没去了解。 　　意向锁（innodb特有）分意向共享锁和意向排他锁。 　　意向共享锁：表示事务获取行共享锁时，必须先得获取该表的意向共享锁； 　　意向排他锁：表示事务获取行排他锁时，必须先得获取该表的意向排他锁； 　我们知道，如果要对整个表加锁，需保证该表内目前不存在任何锁。</p>
<p>　　因此，如果需要对整个表加锁，那么就可以根据：检查意向锁是否被占用，来知道表内目前是否存在共享锁或排他锁了。而不需要再一行行地去检查每一行是否被加锁。</p>
<p><strong>四、乐观锁与悲观锁</strong></p>
<p>　　首先说明，乐观锁和悲观锁都是针对读（select）来说的。</p>
<p>　案例：</p>
<p>　　某商品，用户购买后库存数应-1，而某两个或多个用户同时购买，此时三个执行程序均同时读得库存为“n”，之后进行了一些操作，最后将均执行update table set 库存数=n-1，那么，很显然这是错误的。</p>
<p>解决：</p>
<p>　使用悲观锁（其实说白了也就是排他锁）</p>
<p>　　|&ndash; 程序A在查询库存数时使用排他锁（select * from table where id=10 for update）</p>
<p>　　|&ndash; 然后进行后续的操作，包括更新库存数，最后提交事务。</p>
<p>　　|&ndash; 程序B在查询库存数时，如果A还未释放排他锁，它将等待……</p>
<p>　　|&ndash; 程序C同B…… 　使用乐观锁（靠表设计和代码来实现）</p>
<p>　　|&ndash; 一般是在该商品表添加version版本字段或者timestamp时间戳字段</p>
<p>　　|&ndash; 程序A查询后，执行更新变成了： 　　 update table set num=num-1 where id=10 and version=23</p>
<p>　　这样，保证了修改的数据是和它查询出来的数据是一致的（其他执行程序肯定未进行修改）。当然，如果更新失败，表示在更新操作之前，有其他执行程序已经更新了该库存数，那么就可以尝试重试来保证更新成功。为了尽可能避免更新失败，可以合理调整重试次数（阿里巴巴开发手册规定重试次数不低于三次）。 总结：对于以上，可以看得出来乐观锁和悲观锁的区别：</p>
<p>　　悲观锁实际使用了排他锁来实现（select **** for update）。文章开头说到，innodb加行锁的前提是：必须是通过索引条件来检索数据，否则会切换为表锁。</p>
<p>　　因此，悲观锁在未通过索引条件检索数据时，会锁定整张表。导致其他程序不允许“加锁的查询操作”，影响吞吐。故如果在查询居多的情况下，推荐使用乐观锁。</p>
<p>　　“加锁的查询操作”：加过排他锁的数据行在其他事务中是不能修改的，也不能通过for update或lock in share mode的加锁方式查询，但可以直接通过select &hellip;from&hellip;查询数据，因为普通查询没有任何锁机制。 　　乐观锁更新有可能会失败，甚至是更新几次都失败，这是有风险的。所以如果写入居多，对吞吐要求不高，可使用悲观锁。 　　　也就是一句话：<strong>读用乐观锁，写用悲观锁</strong>。</p>
<p><strong>间隙锁</strong></p>
<p>　1.什么叫间隙锁 　　当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但不存在的记录，叫做“间隙(GAP)”，InnoDB也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁(NEXT-KEY)锁。</p>
<p>　2.间隙锁的产生 　　上面的文字很抽象，现在举个栗子，介绍间隙锁是怎么产生的：</p>
<p>假设有以下表t_student：（其中id为PK，name为非唯一索引）<img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/885859-20190527125247723-58890562.png" alt="img"  />
</p>
<p>　这个时候我们发出一条这样的加锁sql语句：</p>
<p>　　select id,name from t_student where id &gt; 0 and id &lt; 5 for update;</p>
<p>　这时候，我们命中的数据为以下着色部分：</p>
<p><img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/885859-20190527125330686-1497088025.png" alt="img"  />
</p>
<p>　　细心的朋友可能就会发现，这里缺少了条id为2的记录，我们的重点就在这里。</p>
<p>　　select &hellip; for update这条语句，是会对数据记录加锁的，这里因为命中了索引，加的是行锁。从数据记录来看，这里排它锁锁住数据是id为1、3和4的这3条数据。</p>
<p>　　但是，看看前面我们的介绍——对于键值在条件范围内但不存在的记录，叫做“间隙(GAP)”，InnoDB也会对这个“间隙”加锁。</p>
<p>　　好了，我们这里，键值在条件范围但是不存在的记录，就是id为2的记录，这里会对id为2数据加上间隙锁。假设这时候如果有id=2的记录insert进来了，是要等到这个事务结束以后才会执行的</p>
<p>　3.间隙锁的作用 　　　总的来说，有2个作用：防止幻读和防止数据误删/改</p>
<p>　　<strong>(1)防止幻读</strong> 　　　关于幻读的概念可以参考这篇文章 <a href="https://blog.csdn.net/mweibiao/article/details/80805031">https://blog.csdn.net/mweibiao/article/details/80805031</a> ，这里就不多做解释了</p>
<p>　假设有下面场景<img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/885859-20190527125408804-835307905.png" alt="img"  />
</p>
<p>　　如果没有间隙锁，事务A在T1和T4读到的结果是不一样的，有了间隙锁，读的就是一样的了</p>
<h2 id="2防止数据误删改">　　<strong>(2)防止数据误删/改</strong><a hidden class="anchor" aria-hidden="true" href="#2防止数据误删改">#</a></h2>
<p>　　　这个作用比较重要，假设以下场景：</p>
<p><img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/885859-20190527125440315-640227902.png" alt="img"  />
</p>
<p>　　这种情况下，如果没有间隙锁，会出现的问题是：id为2的记录，刚加进去，就被删除了，这种情况有时候对业务，是致命性的打击。加了间隙锁之后，由于insert语句要等待事务A执行完之后释放锁，避免了这种情况</p>
<p>　4.使用间隙锁的隐患 　最大的隐患就是性能问题</p>
<p>　　前面提到，假设这时候如果有id=2的记录insert进来了，是要等到这个事务结束以后才会执行的，假设是这种场景<img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/885859-20190527125543446-1953494613.png" alt="img"  />
</p>
<p>　　这种情况，对插入的性能就有很大影响了，必须等到事务结束才能进行插入，性能大打折扣</p>
<p>　　更有甚者，如果间隙锁出现死锁的情况下，会更隐晦，更难定位</p>
<p><strong>怎样避免死锁</strong> 　</p>
<p>　　1、以固定的顺序访问表和行。比如两个更新数据的事务，事务A 更新数据的顺序 为1，2；事务B更新数据的顺序为2，1。这样更可能会造成死锁。</p>
<p>　　2、大事务拆小。大事务更倾向于死锁，如果业务允许，将大事务拆小。</p>
<p>　　3、在同一个事务中，尽可能做到一次锁定所需要的所有资源，减少死锁概率。</p>
<p>　　4、降低隔离级别。如果业务允许，将隔离级别调低也是较好的选择，比如将隔离级别从RR调整为RC，可以避免掉很多因为gap锁造成的死锁。</p>
<p>　　5、为表添加合理的索引。可以看到如果不走索引将会为表的每一行记录添加上锁，死锁的概率大大增大。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://habyss.github.io/posts/read/mysql%E4%BA%BF%E7%BA%A7%E5%88%AB%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/">
    <span class="title">« 上一页</span>
    <br>
    <span>MySQL 亿级别数据迁移实战代码分享</span>
  </a>
  <a class="next" href="https://habyss.github.io/posts/read/mysql%E5%AE%9E%E6%88%9845%E8%AE%B2/">
    <span class="title">下一页 »</span>
    <br>
    <span>MySQL实战45讲</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://habyss.github.io/">叶灰灰的小窝</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
