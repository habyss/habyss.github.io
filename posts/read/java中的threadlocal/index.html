<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Javaä¸­çš„ThreadLocal | å¶ç°ç°çš„å°çª</title>
<meta name="keywords" content="">
<meta name="description" content="Javaä¸­çš„ThreadLocal å‰è¨€ é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°ThreadLocalçš„ç›¸å…³çŸ¥è¯†ï¼Œæ²¡æœ‰å›ç­”å¥½ï¼ˆå¥¶å¥¶çš„ï¼Œç°åœ¨æ„Ÿè§‰é—®å•¥éƒ½èƒ½è¢«é—®å€’ï¼‰ï¼Œæ‰€ä»¥æˆ‘">
<meta name="author" content="å¶ç°ç°">
<link rel="canonical" href="https://habyss.github.io/posts/read/java%E4%B8%AD%E7%9A%84threadlocal/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="apple-touch-icon" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="mask-icon" href="https://habyss.github.io/gif/hwlm.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Javaä¸­çš„ThreadLocal" />
<meta property="og:description" content="Javaä¸­çš„ThreadLocal å‰è¨€ é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°ThreadLocalçš„ç›¸å…³çŸ¥è¯†ï¼Œæ²¡æœ‰å›ç­”å¥½ï¼ˆå¥¶å¥¶çš„ï¼Œç°åœ¨æ„Ÿè§‰é—®å•¥éƒ½èƒ½è¢«é—®å€’ï¼‰ï¼Œæ‰€ä»¥æˆ‘" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://habyss.github.io/posts/read/java%E4%B8%AD%E7%9A%84threadlocal/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-11-01T15:36:53+08:00" />
<meta property="article:modified_time" content="2022-11-29T15:36:53+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Javaä¸­çš„ThreadLocal"/>
<meta name="twitter:description" content="Javaä¸­çš„ThreadLocal å‰è¨€ é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°ThreadLocalçš„ç›¸å…³çŸ¥è¯†ï¼Œæ²¡æœ‰å›ç­”å¥½ï¼ˆå¥¶å¥¶çš„ï¼Œç°åœ¨æ„Ÿè§‰é—®å•¥éƒ½èƒ½è¢«é—®å€’ï¼‰ï¼Œæ‰€ä»¥æˆ‘"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://habyss.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“•é˜…è¯»",
      "item": "https://habyss.github.io/posts/read/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Javaä¸­çš„ThreadLocal",
      "item": "https://habyss.github.io/posts/read/java%E4%B8%AD%E7%9A%84threadlocal/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Javaä¸­çš„ThreadLocal",
  "name": "Javaä¸­çš„ThreadLocal",
  "description": "Javaä¸­çš„ThreadLocal å‰è¨€ é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°ThreadLocalçš„ç›¸å…³çŸ¥è¯†ï¼Œæ²¡æœ‰å›ç­”å¥½ï¼ˆå¥¶å¥¶çš„ï¼Œç°åœ¨æ„Ÿè§‰é—®å•¥éƒ½èƒ½è¢«é—®å€’ï¼‰ï¼Œæ‰€ä»¥æˆ‘",
  "keywords": [
    
  ],
  "articleBody": "Javaä¸­çš„ThreadLocal å‰è¨€ é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°ThreadLocalçš„ç›¸å…³çŸ¥è¯†ï¼Œæ²¡æœ‰å›ç­”å¥½ï¼ˆå¥¶å¥¶çš„ï¼Œç°åœ¨æ„Ÿè§‰é—®å•¥éƒ½èƒ½è¢«é—®å€’ï¼‰ï¼Œæ‰€ä»¥æˆ‘å†³å®šå…ˆè§£å†³è¿™å‡ æ¬¡é¢è¯•ä¸­éƒ½é‡åˆ°çš„é«˜é¢‘é—®é¢˜ï¼ŒæŠŠè¿™å‡ ä¸ªç¡¬éª¨å¤´éƒ½èƒ½ç†è§£çš„é€å½»çš„è¯´å‡ºæ¥äº†ï¼Œæ„Ÿè§‰æœ€èµ·ç ä¸èƒ½æ€»æ˜¯ä¸€è½®æ¸¸ã€‚\nThreadLocalä»‹ç» ThreadLocalæ˜¯JDK1.2å¼€å§‹å°±æä¾›çš„ä¸€ä¸ªç”¨æ¥å­˜å‚¨çº¿ç¨‹æœ¬åœ°å˜é‡çš„ç±»ã€‚ThreadLocalä¸­çš„å˜é‡æ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­ç‹¬ç«‹å­˜åœ¨çš„ï¼Œå½“å¤šä¸ªçº¿ç¨‹è®¿é—®ThreadLocalä¸­çš„å˜é‡çš„æ—¶å€™ï¼Œå…¶å®éƒ½æ˜¯è®¿é—®çš„è‡ªå·±å½“å‰çº¿ç¨‹çš„å†…å­˜ä¸­çš„å˜é‡ï¼Œä»è€Œä¿è¯çš„å˜é‡çš„çº¿ç¨‹å®‰å…¨ã€‚\næˆ‘ä»¬ä¸€èˆ¬åœ¨ä½¿ç”¨ThreadLocalçš„æ—¶å€™éƒ½æ˜¯ä¸ºäº†è§£å†³çº¿ç¨‹ä¸­å­˜åœ¨çš„å˜é‡ç«äº‰é—®é¢˜ã€‚å…¶å®è§£å†³è¿™ç±»é—®é¢˜ï¼Œé€šå¸¸å¤§å®¶ä¹Ÿä¼šæƒ³åˆ°ä½¿ç”¨synchronizedæ¥åŠ é”è§£å†³ã€‚\nä¾‹å¦‚åœ¨è§£å†³SimpleDateFormatçš„çº¿ç¨‹å®‰å…¨çš„æ—¶å€™ã€‚SimpleDateFormatæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒé‡Œé¢æ— è®ºçš„æ˜¯format()æ–¹æ³•è¿˜æ˜¯parse()æ–¹æ³•ï¼Œéƒ½æœ‰ä½¿ç”¨å®ƒè‡ªå·±å†…éƒ¨çš„ä¸€ä¸ªCalendarç±»çš„å¯¹è±¡ï¼Œformatæ–¹æ³•æ˜¯è®¾ç½®æ—¶é—´ï¼Œparse()æ–¹æ³•é‡Œé¢æ˜¯å…ˆè°ƒç”¨Calendarçš„clear()æ–¹æ³•ï¼Œç„¶ååˆè°ƒç”¨äº†Calendarçš„set()æ–¹æ³•ï¼ˆèµ‹å€¼ï¼‰ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åˆšè°ƒç”¨äº†set()è¿›è¡Œèµ‹å€¼ï¼Œè¿™ä¸ªæ—¶å€™åˆæ¥äº†ä¸€ä¸ªçº¿ç¨‹ç›´æ¥è°ƒç”¨äº†clear()æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªparse()æ–¹æ³•æ‰§è¡Œçš„ç»“æœå°±ä¼šæœ‰é—®é¢˜çš„ã€‚ è§£å†³åŠæ³•ä¸€ å°†ä½¿ç”¨SimpleDateformatçš„æ–¹æ³•åŠ ä¸Šsynchronizedï¼Œè¿™æ ·è™½ç„¶ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œä½†å´é™ä½äº†æ•ˆç‡ï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½ä½¿ç”¨æ ¼å¼åŒ–æ—¶é—´çš„æ–¹æ³•ã€‚\n1 2 3 4 5 private static SimpleDateFormat simpleDateFormat = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\"); public static synchronized String formatDate(Date date){ return simpleDateFormat.format(date); } è§£å†³åŠæ³•äºŒ å°†SimpleDateFormatçš„å¯¹è±¡ï¼Œæ”¾åˆ°ThreadLocalé‡Œé¢ï¼Œè¿™æ ·æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„æ ¼å¼å¯¹è±¡çš„å‰¯æœ¬äº†ã€‚äº’ä¸å¹²æ‰°ï¼Œä»è€Œä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚\n1 2 3 4 5 private static final ThreadLocal\u003cSimpleDateFormat\u003e simpleDateFormatThreadLocal = ThreadLocal.withInitial(() -\u003e new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\")); public static String formatDate(Date date){ return simpleDateFormatThreadLocal.get().format(date); } ThreadLocalçš„åŸç† æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ThreadLocalæ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚\n1 2 3 4 5 6 ThreadLocal\u003cInteger\u003e threadLocal99 = new ThreadLocal\u003cInteger\u003e(); threadLocal99.set(3); int num = threadLocal99.get(); System.out.println(\"æ•°å­—:\"+num); threadLocal99.remove(); System.out.println(\"æ•°å­—Empty:\"+threadLocal99.get()); è¿è¡Œç»“æœï¼š\n1 2 æ•°å­—:3 æ•°å­—Empty:null ä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯å°†å˜é‡æ”¾åˆ°ThreadLocalé‡Œé¢ï¼Œåœ¨çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å°±å¯ä»¥å–åˆ°ï¼Œå½“æ‰§è¡Œå®Œæˆååœ¨removeæ‰å°±å¯ä»¥äº†ï¼Œåªè¦æ²¡æœ‰è°ƒç”¨remove()å½“å‰çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­éƒ½æ˜¯å¯ä»¥æ‹¿åˆ°å˜é‡æ•°æ®çš„ã€‚ å› ä¸ºæ˜¯æ”¾åˆ°äº†å½“å‰æ‰§è¡Œçš„çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥ThreadLocalä¸­çš„å˜é‡å€¼åªèƒ½å½“å‰çº¿ç¨‹æ¥ä½¿ç”¨ï¼Œä»è€Œä¿è¯çš„äº†çº¿ç¨‹å®‰å…¨ï¼ˆå½“å‰çº¿ç¨‹çš„å­çº¿ç¨‹å…¶å®ä¹Ÿæ˜¯å¯ä»¥è·å–åˆ°çš„ï¼‰ã€‚\næ¥çœ‹ä¸€ä¸‹ThreadLocalçš„set()æ–¹æ³•æºç \n1 2 3 4 5 6 7 8 9 10 11 public void set(T value) { // è·å–å½“å‰çº¿ç¨‹ Thread t = Thread.currentThread(); // è·å–ThreadLocalMap ThreadLocal.ThreadLocalMap map = getMap(t); // ThreadLocalMap å¯¹è±¡æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™ç›´æ¥å°†æ•°æ®æ”¾å…¥åˆ°ThreadLocalMapä¸­ if (map != null) map.set(this, value); else createMap(t, value); // ThreadLocalMapå¯¹è±¡ä¸ºç©ºï¼Œåˆ™å…ˆåˆ›å»ºå¯¹è±¡ï¼Œå†èµ‹å€¼ã€‚ } æˆ‘ä»¬çœ‹åˆ°å˜é‡éƒ½æ˜¯å­˜æ”¾åœ¨äº†ThreadLocalMapè¿™ä¸ªå˜é‡ä¸­çš„ã€‚é‚£ä¹ˆThreadLocalMapåˆæ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 ThreadLocalMap getMap(Thread t) { return t.threadLocals; } public class Thread implements Runnable { ... ... /* ThreadLocal values pertaining to this thread. This map is maintained * by the ThreadLocal class. */ ThreadLocal.ThreadLocalMap threadLocals = null; ... ... } é€šè¿‡ä¸Šé¢çš„æºç ï¼Œæˆ‘ä»¬å‘ç°ThreadLocalMapå˜é‡æ˜¯å½“å‰æ‰§è¡Œçº¿ç¨‹ä¸­çš„ä¸€ä¸ªå˜é‡ï¼Œæ‰€ä»¥è¯´ï¼ŒThreadLocalä¸­å­˜æ”¾çš„æ•°æ®å…¶å®éƒ½æ˜¯æ”¾åˆ°äº†å½“å‰æ‰§è¡Œçº¿ç¨‹ä¸­çš„ä¸€ä¸ªå˜é‡é‡Œé¢äº†ã€‚ä¹Ÿå°±æ˜¯å­˜å‚¨åœ¨äº†å½“å‰çš„çº¿ç¨‹å¯¹è±¡é‡Œäº†ï¼Œåˆ«çš„çº¿ç¨‹é‡Œé¢æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡äº†ï¼Œæ‹¿ä¸åˆ°å…¶ä»–çº¿ç¨‹å¯¹è±¡ä¸­çš„æ•°æ®ï¼Œæ‰€ä»¥æ•°æ®è‡ªç„¶å°±éš”ç¦»å¼€äº†ã€‚\né‚£ä¹ˆThreadLocalMapæ˜¯æ€ä¹ˆå­˜å‚¨æ•°æ®çš„å‘¢ï¼Ÿ ThreadLocalMap æ˜¯ThreadLocalç±»é‡Œçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œè™½ç„¶ç±»çš„åå­—ä¸Šå¸¦ç€Mapä½†å´æ²¡æœ‰å®ç°Mapæ¥å£ï¼Œåªæ˜¯ç»“æ„å’ŒMapç±»ä¼¼è€Œå·²ã€‚\rThreadLocalMapå†…éƒ¨å…¶å®æ˜¯ä¸€ä¸ªEntryæ•°ç»„ï¼ŒEntryæ˜¯ThreadLocalMapä¸­çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œç»§æ‰¿è‡ªWeakReferenceï¼Œå¹¶å°†ThreadLocalç±»å‹çš„å¯¹è±¡è®¾ç½®ä¸ºäº†Entryçš„Keyï¼Œä»¥åŠå¯¹Keyè®¾ç½®æˆå¼±å¼•ç”¨ã€‚ ThreadLocalMapçš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œå°±å¤§æ¦‚æ˜¯è¿™æ ·çš„key,valueç»„æˆçš„Entryçš„æ•°ç»„é›†åˆã€‚\rå’ŒçœŸæ­£çš„Mapè¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼Œæ²¡æœ‰é“¾è¡¨äº†ï¼Œè¿™æ ·åœ¨è§£å†³keyçš„hashå†²çªçš„æ—¶å€™æªæ–½è‚¯å®šå°±å’ŒHashMapä¸ä¸€æ ·äº†ã€‚ ä¸€ä¸ªçº¿ç¨‹ä¸­æ˜¯å¯ä»¥åˆ›å»ºå¤šä¸ªThreadLocalå¯¹è±¡çš„ï¼Œå¤šä¸ªThreadLocalå¯¹è±¡å°±ä¼šå­˜æ”¾å¤šä¸ªæ•°æ®ï¼Œé‚£ä¹ˆåœ¨ThreadLocalMapä¸­å°±ä¼šä»¥æ•°ç»„çš„å½¢å¼å­˜æ”¾è¿™äº›æ•°æ®ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„ThreadLocalMapçš„set()æ–¹æ³•çš„æºç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 /** * Set the value associated with key. * @param key the thread local object * @param value the value to be set */ private void set(ThreadLocal\u003c?\u003e key, Object value) { // We don't use a fast path as with get() because it is at // least as common to use set() to create new entries as // it is to replace existing ones, in which case, a fast // path would fail more often than not. Entry[] tab = table; int len = tab.length; // å®šä½åœ¨æ•°ç»„ä¸­çš„ä½ç½® int i = key.threadLocalHashCode \u0026 (len-1); for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) { ThreadLocal\u003c?\u003e k = e.get(); // å¦‚æœå½“å‰ä½ç½®ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å½“å‰ä½ç½®çš„keyå’Œä¼ è¿‡æ¥çš„keyç›¸ç­‰ï¼Œé‚£ä¹ˆå°±ä¼šè¦†ç›–å½“å‰ä½ç½®çš„æ•°æ® if (k == key) { e.value = value; return; } // å¦‚æœå½“å‰ä½ç½®ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªEntryå¯¹è±¡ï¼Œæ”¾åˆ°å½“å‰ä½ç½®ã€‚ if (k == null) { replaceStaleEntry(key, value, i); return; } } // å¦‚æœå½“å‰ä½ç½®ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å½“å‰ä½ç½®çš„keyä¹Ÿä¸ç­‰äºè¦èµ‹å€¼çš„key ï¼Œé‚£ä¹ˆå°†å»æ‰¾ä¸‹ä¸€ä¸ªç©ºä½ç½®ï¼Œç›´æ¥å°†æ•°æ®æ”¾åˆ°ä¸‹ä¸€ä¸ªç©ºä½ç½®å¤„ã€‚ tab[i] = new Entry(key, value); int sz = ++size; if (!cleanSomeSlots(i, sz) \u0026\u0026 sz \u003e= threshold) rehash(); } æˆ‘ä»¬ä»set()æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¤„ç†é€»è¾‘æœ‰å››æ­¥ã€‚\nç¬¬ä¸€æ­¥å…ˆæ ¹æ®Threadlocalå¯¹è±¡çš„hashcodeå’Œæ•°ç»„é•¿åº¦åšä¸è¿ç®—è·å–æ•°æ®åº”è¯¥æ”¾åœ¨å½“å‰æ•°ç»„ä¸­çš„ä½ç½®ã€‚ ç¬¬äºŒæ­¥å°±æ˜¯åˆ¤æ–­å½“å‰ä½ç½®æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºçš„è¯å°±ç›´æ¥åˆå§‹åŒ–ä¸€ä¸ªEntryå¯¹è±¡ï¼Œæ”¾åˆ°å½“å‰ä½ç½®ã€‚ ç¬¬ä¸‰æ­¥å¦‚æœå½“å‰ä½ç½®ä¸ä¸ºç©ºï¼Œè€Œå½“å‰ä½ç½®çš„Entryä¸­çš„keyå’Œä¼ è¿‡æ¥çš„keyä¸€æ ·ï¼Œé‚£ä¹ˆç›´æ¥è¦†ç›–æ‰å½“å‰ä½ç½®çš„æ•°æ®ã€‚ ç¬¬å››æ­¥å¦‚æœå½“å‰ä½ç½®ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å½“å‰ä½ç½®çš„Entryä¸­çš„keyå’Œä¼ è¿‡æ¥çš„key ä¹Ÿä¸ä¸€æ ·ï¼Œé‚£ä¹ˆå°±ä¼šå»æ‰¾ä¸‹ä¸€ä¸ªç©ºä½ç½®ï¼Œç„¶åå°†æ•°æ®å­˜æ”¾åˆ°ç©ºä½ç½®ï¼ˆæ•°ç»„è¶…è¿‡é•¿åº¦åï¼Œä¼šæ‰§è¡Œæ‰©å®¹çš„ï¼‰ï¼› åœ¨getçš„æ—¶å€™ä¹Ÿæ˜¯ç±»ä¼¼çš„é€»è¾‘ï¼Œå…ˆé€šè¿‡ä¼ å…¥çš„ThreadLocalçš„hashcodeè·å–åœ¨Entryæ•°ç»„ä¸­çš„ä½ç½®ï¼Œç„¶åæ‹¿å½“å‰ä½ç½®çš„Entryçš„Keyå’Œä¼ å…¥çš„ThreadLocalå¯¹æ¯”ï¼Œç›¸ç­‰çš„è¯ï¼Œç›´æ¥æŠŠæ•°æ®è¿”å›ï¼Œå¦‚æœä¸ç›¸ç­‰å°±å»åˆ¤æ–­å’Œæ•°ç»„ä¸­çš„ä¸‹ä¸€ä¸ªå€¼çš„keyæ˜¯å¦ç›¸ç­‰ã€‚ã€‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 private Entry getEntry(ThreadLocal\u003c?\u003e key) { int i = key.threadLocalHashCode \u0026 (table.length - 1); Entry e = table[i]; if (e != null \u0026\u0026 e.get() == key) return e; else return getEntryAfterMiss(key, i, e); } /** * Version of getEntry method for use when key is not found in * its direct hash slot. * * @param key the thread local object * @param i the table index for key's hash code * @param e the entry at table[i] * @return the entry associated with key, or null if no such */ private Entry getEntryAfterMiss(ThreadLocal\u003c?\u003e key, int i, Entry e) { Entry[] tab = table; int len = tab.length; while (e != null) { ThreadLocal\u003c?\u003e k = e.get(); if (k == key) return e; if (k == null) expungeStaleEntry(i); else i = nextIndex(i, len); e = tab[i]; } return null; } æˆ‘ä»¬ä¸Šæ–‡ä¸€ç›´è¯´ï¼ŒThreadLocalæ˜¯ä¿å­˜åœ¨å•ä¸ªçº¿ç¨‹ä¸­çš„æ•°æ®ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ•°æ®ï¼Œä½†æ˜¯å®é™…ThreadLocalé‡Œé¢çš„çœŸæ­£çš„å¯¹è±¡æ•°æ®ï¼Œå…¶å®æ˜¯ä¿å­˜åœ¨å †é‡Œé¢çš„ï¼Œè€Œçº¿ç¨‹é‡Œé¢åªæ˜¯å­˜å‚¨äº†å¯¹è±¡çš„å¼•ç”¨è€Œå·²ã€‚ å¹¶ä¸”æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™é€šå¸¸éœ€è¦åœ¨ä¸Šä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•çš„ä¸Šä¸‹æ–‡å…±äº«ThreadLocalä¸­çš„å˜é‡ã€‚ ä¾‹å¦‚æˆ‘çš„ä¸»çº¿ç¨‹æ˜¯åœ¨æŸä¸ªæ–¹æ³•ä¸­æ‰§è¡Œä»£ç å‘¢ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•ä¸­æœ‰ä¸€æ®µä»£ç æ—¶æ–°åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨è¿™ä¸ªçº¿ç¨‹é‡Œé¢è¿˜ä½¿ç”¨äº†æˆ‘è¿™ä¸ªæ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•é‡Œé¢çš„å®šä¹‰çš„ThreadLocalé‡Œé¢çš„å˜é‡ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå°±æ˜¯éœ€è¦ä»æ–°çº¿ç¨‹é‡Œé¢è°ƒç”¨å¤–é¢çº¿ç¨‹çš„æ•°æ®ï¼Œè¿™ä¸ªå°±éœ€è¦çº¿ç¨‹é—´å…±äº«äº†ã€‚è¿™ç§å­çˆ¶çº¿ç¨‹å…±äº«æ•°æ®çš„æƒ…å†µï¼ŒThreadLocalä¹Ÿæ˜¯æ”¯æŒçš„ã€‚ ä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 ThreadLocal threadLocalMain = new InheritableThreadLocal(); threadLocalMain.set(\"ä¸»çº¿ç¨‹å˜é‡\"); Thread t = new Thread() { @Override public void run() { super.run(); System.out.println( \"ç°åœ¨è·å–çš„å˜é‡æ˜¯ =\" + threadLocalMain.get()); } }; t.start(); è¿è¡Œç»“æœï¼š\n1 ç°åœ¨è·å–çš„å˜é‡æ˜¯ =ä¸»çº¿ç¨‹å˜é‡ ä¸Šé¢è¿™æ ·çš„ä»£ç å°±èƒ½å®ç°å­çˆ¶çº¿ç¨‹å…±äº«æ•°æ®çš„æƒ…å†µï¼Œé‡ç‚¹æ˜¯ä½¿ç”¨InheritableThreadLocalæ¥å®ç°çš„å…±äº«ã€‚ é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆå®ç°æ•°æ®å…±äº«çš„å‘¢ï¼Ÿ åœ¨Threadç±»çš„init()æ–¹æ³•ä¸­æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š\n1 2 if (inheritThreadLocals \u0026\u0026 parent.inheritableThreadLocals != null) this.inheritableThreadLocals =ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼Œåœ¨åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰çº¿ç¨‹çš„inheritThreadLocalså˜é‡å’Œçˆ¶çº¿ç¨‹çš„inheritThreadLocalså˜é‡éƒ½ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œä¼šå°†çˆ¶çº¿ç¨‹çš„inheritThreadLocalså˜é‡ä¸­çš„æ•°æ®ï¼Œèµ‹ç»™å½“å‰çº¿ç¨‹ä¸­çš„inheritThreadLocalså˜é‡ã€‚\nThreadLocalçš„å†…å­˜æ³„æ¼é—®é¢˜ ä¸Šæ–‡æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ï¼ŒThreadLocalä¸­çš„ThreadLocalMapé‡Œé¢çš„Entryå¯¹è±¡æ˜¯ç»§æ‰¿è‡ªWeakReferenceç±»çš„ï¼Œè¯´æ˜Entryçš„keyæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ã€‚\nå¼±å¼•ç”¨æ˜¯ç”¨æ¥æè¿°é‚£äº›éå¿…é¡»çš„å¯¹è±¡ï¼Œå¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œåªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¸ºæ­¢ã€‚å½“åƒåœ¾æ”¶é›†å™¨å¼€å§‹å·¥ä½œï¼Œæ— è®ºå½“å‰å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰åªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚\nè¿™ä¸ªå¼±å¼•ç”¨è¿˜æ˜¯ThreadLocalå¯¹è±¡æœ¬èº«ï¼Œæ‰€ä»¥ä¸€èˆ¬åœ¨çº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼ŒThreadLocalå¯¹è±¡å°±ä¼šå˜æˆnulläº†ï¼Œè€Œä¸ºnullçš„å¼±å¼•ç”¨å¯¹è±¡ï¼Œåœ¨ä¸‹ä¸€æ¬¡GCçš„æ—¶å€™å°±ä¼šè¢«æ¸…é™¤æ‰ï¼Œè¿™æ ·Entryçš„Keyçš„å†…å­˜ç©ºé—´å°±è¢«é‡Šæ”¾å‡ºæ¥äº†ï¼Œä½†æ˜¯Entryçš„valueè¿˜åœ¨å ç”¨çš„å†…å­˜ï¼Œå¦‚æœçº¿ç¨‹æ˜¯è¢«å¤ç”¨çš„ï¼ˆä¾‹å¦‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼‰ï¼Œåé¢ä¹Ÿä¸ä½¿ç”¨ThreadLocalå­˜å–æ•°æ®äº†ï¼Œé‚£ä¹ˆè¿™é‡Œé¢çš„valueå€¼ä¼šä¸€ç›´å­˜åœ¨ï¼Œæœ€ç»ˆå°±å¯¼è‡´äº†å†…å­˜æ³„æ¼ã€‚\né˜²æ­¢å†…å­˜æ³„æ¼çš„åŠæ³•å°±æ˜¯åœ¨æ¯æ¬¡ä½¿ç”¨å®ŒThreadLocalçš„æ—¶å€™éƒ½å»æ‰§è¡Œä»¥ä¸‹remove()æ–¹æ³•ï¼Œå°±å¯ä»¥æŠŠkeyå’Œvalueçš„ç©ºé—´éƒ½é‡Šæ”¾äº†ã€‚\né‚£æ—¢ç„¶å®¹æ˜“äº§ç”Ÿå†…å­˜æ³„æ¼ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è®¾ç½®æˆå¼±å¼•ç”¨çš„å‘¢ï¼Ÿ å¦‚æœæ­£å¸¸æƒ…å†µä¸‹åº”è¯¥æ˜¯å¼ºå¼•ç”¨ï¼Œä½†æ˜¯å¼ºå¼•ç”¨åªè¦å¼•ç”¨å…³ç³»è¿˜åœ¨å°±ä¸€ç›´ä¸ä¼šè¢«å›æ”¶ï¼Œæ‰€ä»¥å¦‚æœçº¿ç¨‹è¢«å¤ç”¨äº†ï¼Œé‚£ä¹ˆEntryä¸­çš„Keyå’ŒValueéƒ½ä¸ä¼šè¢«å›æ”¶ï¼Œè¿™æ ·å°±é€ æˆäº†Keyå’ŒValueéƒ½ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼äº†ï¼›\nä½†æ˜¯è®¾ç½®æˆå¼±å¼•ç”¨ï¼Œå½“ThreadLocalå¯¹è±¡ï¼Œæ²¡æœ‰è¢«å¼ºå¼•ç”¨åï¼Œå°±ä¼šè¢«å›æ”¶ï¼Œå›æ”¶åï¼ŒEntryä¸­çš„keyå°±ä¼šè¢«è®¾ç½®æˆnulläº†ï¼Œå¦‚æœThreadè¢«é‡å¤ä½¿ç”¨ï¼Œåªè¦è¿˜ä¼šç”¨ThreadLocalå­˜å‚¨æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨ThreadLocalçš„ï¼Œsetã€getç­‰æ–¹æ³•ï¼Œåœ¨è°ƒç”¨setã€getã€ç­‰æ–¹æ³•çš„æ—¶å€™ï¼Œæ˜¯ä¼šæ‰«æEntryä¸­keyä¸ºnullçš„æ•°æ®çš„ã€‚ å½“å‘ç°Entryä¸­ï¼Œæœ‰keyä¸ºnullçš„æ•°æ®æ—¶ï¼Œä¼šå°†valueä¹Ÿè®¾ç½®ä¸ºnullï¼Œè¿™æ ·å°±å°†valueçš„å€¼ä¹Ÿè¿›è¡Œäº†å›æ”¶ï¼Œèƒ½è¿›ä¸€æ­¥é˜²æ­¢å†…å­˜æ³„æ¼äº†ï¼Œå¹¶ä¸”åœ¨è¿›è¡Œrehashçš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å…ˆæ¸…é™¤æ‰keyæ˜¯nullçš„æ•°æ®åï¼Œå¦‚æœç©ºé—´è¿˜ä¸å¤Ÿï¼Œæ‰è¿›è¡Œæ‰©å®¹çš„ã€‚\nä½†æ˜¯è™½ç„¶å°†keyè®¾ç½®äº†å¼±å¼•ç”¨ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹è¢«é‡å¤åˆ©ç”¨ï¼Œæ‰§è¡Œå®Œä»»åŠ¡åï¼Œå†ä¹Ÿä¸ä½¿ç”¨ThreadLocaläº†ï¼Œé‚£ä¹ˆæœ€åvalueå€¼ä¼šä¸€ç›´å­˜åœ¨ï¼Œæœ€ç»ˆä¹Ÿæ˜¯ä¼šå¯¼è‡´å†…å­˜æ³„æ¼çš„ï¼Œæ‰€ä»¥ä½¿ç”¨ThreadLocalçš„æ—¶å€™ï¼Œæœ€åä¸€å®šè¦æ‰§è¡Œremove()æ–¹æ³•ã€‚\n",
  "wordCount" : "4526",
  "inLanguage": "zh",
  "datePublished": "2018-11-01T15:36:53+08:00",
  "dateModified": "2022-11-29T15:36:53+08:00",
  "author":[{
    "@type": "Person",
    "name": "å¶ç°ç°"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://habyss.github.io/posts/read/java%E4%B8%AD%E7%9A%84threadlocal/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "å¶ç°ç°çš„å°çª",
    "logo": {
      "@type": "ImageObject",
      "url": "https://habyss.github.io/gif/hwlm.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://habyss.github.io/" accesskey="h" title="å¶ç°ç°çš„å°çª (Alt + H)">å¶ç°ç°çš„å°çª</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://habyss.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/archives" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://habyss.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://habyss.github.io/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="https://habyss.github.io/posts/read/">ğŸ“•é˜…è¯»</a></div>
    <h1 class="post-title">
      Javaä¸­çš„ThreadLocal
    </h1>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#java%e4%b8%ad%e7%9a%84threadlocal" aria-label="Javaä¸­çš„ThreadLocal">Javaä¸­çš„ThreadLocal</a><ul>
                        
                <li>
                    <a href="#%e5%89%8d%e8%a8%80" aria-label="å‰è¨€">å‰è¨€</a><ul>
                        
                <li>
                    <a href="#threadlocal%e4%bb%8b%e7%bb%8d" aria-label="ThreadLocalä»‹ç»">ThreadLocalä»‹ç»</a></li>
                <li>
                    <a href="#threadlocal%e7%9a%84%e5%8e%9f%e7%90%86" aria-label="ThreadLocalçš„åŸç†">ThreadLocalçš„åŸç†</a></li>
                <li>
                    <a href="#threadlocal%e7%9a%84%e5%86%85%e5%ad%98%e6%b3%84%e6%bc%8f%e9%97%ae%e9%a2%98" aria-label="ThreadLocalçš„å†…å­˜æ³„æ¼é—®é¢˜">ThreadLocalçš„å†…å­˜æ³„æ¼é—®é¢˜</a></li>
                <li>
                    <a href="#%e9%82%a3%e6%97%a2%e7%84%b6%e5%ae%b9%e6%98%93%e4%ba%a7%e7%94%9f%e5%86%85%e5%ad%98%e6%b3%84%e6%bc%8f%e4%b8%ba%e4%bb%80%e4%b9%88%e8%bf%98%e8%a6%81%e8%ae%be%e7%bd%ae%e6%88%90%e5%bc%b1%e5%bc%95%e7%94%a8%e7%9a%84%e5%91%a2" aria-label="é‚£æ—¢ç„¶å®¹æ˜“äº§ç”Ÿå†…å­˜æ³„æ¼ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è®¾ç½®æˆå¼±å¼•ç”¨çš„å‘¢ï¼Ÿ">é‚£æ—¢ç„¶å®¹æ˜“äº§ç”Ÿå†…å­˜æ³„æ¼ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è®¾ç½®æˆå¼±å¼•ç”¨çš„å‘¢ï¼Ÿ</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="javaä¸­çš„threadlocal">Javaä¸­çš„ThreadLocal<a hidden class="anchor" aria-hidden="true" href="#javaä¸­çš„threadlocal">#</a></h1>
<h2 id="å‰è¨€">å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#å‰è¨€">#</a></h2>
<p>é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°ThreadLocalçš„ç›¸å…³çŸ¥è¯†ï¼Œæ²¡æœ‰å›ç­”å¥½ï¼ˆå¥¶å¥¶çš„ï¼Œç°åœ¨æ„Ÿè§‰é—®å•¥éƒ½èƒ½è¢«é—®å€’ï¼‰ï¼Œæ‰€ä»¥æˆ‘å†³å®šå…ˆè§£å†³è¿™å‡ æ¬¡é¢è¯•ä¸­éƒ½é‡åˆ°çš„é«˜é¢‘é—®é¢˜ï¼ŒæŠŠè¿™å‡ ä¸ªç¡¬éª¨å¤´éƒ½èƒ½ç†è§£çš„é€å½»çš„è¯´å‡ºæ¥äº†ï¼Œæ„Ÿè§‰æœ€èµ·ç ä¸èƒ½æ€»æ˜¯ä¸€è½®æ¸¸ã€‚</p>
<h3 id="threadlocalä»‹ç»">ThreadLocalä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#threadlocalä»‹ç»">#</a></h3>
<p>ThreadLocalæ˜¯JDK1.2å¼€å§‹å°±æä¾›çš„ä¸€ä¸ªç”¨æ¥å­˜å‚¨çº¿ç¨‹æœ¬åœ°å˜é‡çš„ç±»ã€‚ThreadLocalä¸­çš„å˜é‡æ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­ç‹¬ç«‹å­˜åœ¨çš„ï¼Œå½“å¤šä¸ªçº¿ç¨‹è®¿é—®ThreadLocalä¸­çš„å˜é‡çš„æ—¶å€™ï¼Œå…¶å®éƒ½æ˜¯è®¿é—®çš„è‡ªå·±å½“å‰çº¿ç¨‹çš„å†…å­˜ä¸­çš„å˜é‡ï¼Œä»è€Œä¿è¯çš„å˜é‡çš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>æˆ‘ä»¬ä¸€èˆ¬åœ¨ä½¿ç”¨ThreadLocalçš„æ—¶å€™éƒ½æ˜¯ä¸ºäº†è§£å†³çº¿ç¨‹ä¸­å­˜åœ¨çš„å˜é‡ç«äº‰é—®é¢˜ã€‚å…¶å®è§£å†³è¿™ç±»é—®é¢˜ï¼Œé€šå¸¸å¤§å®¶ä¹Ÿä¼šæƒ³åˆ°ä½¿ç”¨synchronizedæ¥åŠ é”è§£å†³ã€‚</p>
<p>ä¾‹å¦‚åœ¨è§£å†³SimpleDateFormatçš„çº¿ç¨‹å®‰å…¨çš„æ—¶å€™ã€‚SimpleDateFormatæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒé‡Œé¢æ— è®ºçš„æ˜¯format()æ–¹æ³•è¿˜æ˜¯parse()æ–¹æ³•ï¼Œéƒ½æœ‰ä½¿ç”¨å®ƒè‡ªå·±å†…éƒ¨çš„ä¸€ä¸ªCalendarç±»çš„å¯¹è±¡ï¼Œformatæ–¹æ³•æ˜¯è®¾ç½®æ—¶é—´ï¼Œparse()æ–¹æ³•é‡Œé¢æ˜¯å…ˆè°ƒç”¨Calendarçš„clear()æ–¹æ³•ï¼Œç„¶ååˆè°ƒç”¨äº†Calendarçš„set()æ–¹æ³•ï¼ˆèµ‹å€¼ï¼‰ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åˆšè°ƒç”¨äº†set()è¿›è¡Œèµ‹å€¼ï¼Œè¿™ä¸ªæ—¶å€™åˆæ¥äº†ä¸€ä¸ªçº¿ç¨‹ç›´æ¥è°ƒç”¨äº†clear()æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªparse()æ–¹æ³•æ‰§è¡Œçš„ç»“æœå°±ä¼šæœ‰é—®é¢˜çš„ã€‚ <strong>è§£å†³åŠæ³•ä¸€</strong> å°†ä½¿ç”¨SimpleDateformatçš„æ–¹æ³•åŠ ä¸Šsynchronizedï¼Œè¿™æ ·è™½ç„¶ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œä½†å´é™ä½äº†æ•ˆç‡ï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½ä½¿ç”¨æ ¼å¼åŒ–æ—¶é—´çš„æ–¹æ³•ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">SimpleDateFormat</span> <span class="n">simpleDateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">String</span> <span class="nf">formatDate</span><span class="o">(</span><span class="n">Date</span> <span class="n">date</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">simpleDateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è§£å†³åŠæ³•äºŒ</strong> å°†SimpleDateFormatçš„å¯¹è±¡ï¼Œæ”¾åˆ°ThreadLocalé‡Œé¢ï¼Œè¿™æ ·æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„æ ¼å¼å¯¹è±¡çš„å‰¯æœ¬äº†ã€‚äº’ä¸å¹²æ‰°ï¼Œä»è€Œä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">SimpleDateFormat</span><span class="o">&gt;</span> <span class="n">simpleDateFormatThreadLocal</span> <span class="o">=</span> <span class="n">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">formatDate</span><span class="o">(</span><span class="n">Date</span> <span class="n">date</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">simpleDateFormatThreadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="threadlocalçš„åŸç†">ThreadLocalçš„åŸç†<a hidden class="anchor" aria-hidden="true" href="#threadlocalçš„åŸç†">#</a></h3>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ThreadLocalæ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">threadLocal99</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">threadLocal99</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">threadLocal99</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ•°å­—:&#34;</span><span class="o">+</span><span class="n">num</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">threadLocal99</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;æ•°å­—Empty:&#34;</span><span class="o">+</span><span class="n">threadLocal99</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="err">æ•°å­—</span><span class="o">:</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="err">æ•°å­—</span><span class="n">Empty</span><span class="o">:</span><span class="kc">null</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯å°†å˜é‡æ”¾åˆ°ThreadLocalé‡Œé¢ï¼Œåœ¨çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å°±å¯ä»¥å–åˆ°ï¼Œå½“æ‰§è¡Œå®Œæˆååœ¨removeæ‰å°±å¯ä»¥äº†ï¼Œåªè¦æ²¡æœ‰è°ƒç”¨remove()å½“å‰çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­éƒ½æ˜¯å¯ä»¥æ‹¿åˆ°å˜é‡æ•°æ®çš„ã€‚ å› ä¸ºæ˜¯æ”¾åˆ°äº†å½“å‰æ‰§è¡Œçš„çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥ThreadLocalä¸­çš„å˜é‡å€¼åªèƒ½å½“å‰çº¿ç¨‹æ¥ä½¿ç”¨ï¼Œä»è€Œä¿è¯çš„äº†çº¿ç¨‹å®‰å…¨ï¼ˆå½“å‰çº¿ç¨‹çš„å­çº¿ç¨‹å…¶å®ä¹Ÿæ˜¯å¯ä»¥è·å–åˆ°çš„ï¼‰ã€‚</p>
<p>æ¥çœ‹ä¸€ä¸‹ThreadLocalçš„set()æ–¹æ³•æºç </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// è·å–å½“å‰çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// è·å–ThreadLocalMap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">ThreadLocal</span><span class="o">.</span><span class="na">ThreadLocalMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getMap</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// ThreadLocalMap å¯¹è±¡æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™ç›´æ¥å°†æ•°æ®æ”¾å…¥åˆ°ThreadLocalMapä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">       <span class="n">map</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">else</span>
</span></span><span class="line"><span class="cl">       <span class="n">createMap</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span> <span class="c1">// ThreadLocalMapå¯¹è±¡ä¸ºç©ºï¼Œåˆ™å…ˆåˆ›å»ºå¯¹è±¡ï¼Œå†èµ‹å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬çœ‹åˆ°å˜é‡éƒ½æ˜¯å­˜æ”¾åœ¨äº†ThreadLocalMapè¿™ä¸ªå˜é‡ä¸­çš„ã€‚é‚£ä¹ˆThreadLocalMapåˆæ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ThreadLocalMap</span> <span class="nf">getMap</span><span class="o">(</span><span class="n">Thread</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">threadLocals</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Thread</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* ThreadLocal values pertaining to this thread. This map is maintained
</span></span></span><span class="line"><span class="cl"><span class="cm">     * by the ThreadLocal class. */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ThreadLocal</span><span class="o">.</span><span class="na">ThreadLocalMap</span> <span class="n">threadLocals</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡ä¸Šé¢çš„æºç ï¼Œæˆ‘ä»¬å‘ç°ThreadLocalMapå˜é‡æ˜¯å½“å‰æ‰§è¡Œçº¿ç¨‹ä¸­çš„ä¸€ä¸ªå˜é‡ï¼Œæ‰€ä»¥è¯´ï¼ŒThreadLocalä¸­å­˜æ”¾çš„æ•°æ®å…¶å®éƒ½æ˜¯æ”¾åˆ°äº†å½“å‰æ‰§è¡Œçº¿ç¨‹ä¸­çš„ä¸€ä¸ªå˜é‡é‡Œé¢äº†ã€‚ä¹Ÿå°±æ˜¯å­˜å‚¨åœ¨äº†å½“å‰çš„çº¿ç¨‹å¯¹è±¡é‡Œäº†ï¼Œåˆ«çš„çº¿ç¨‹é‡Œé¢æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡äº†ï¼Œæ‹¿ä¸åˆ°å…¶ä»–çº¿ç¨‹å¯¹è±¡ä¸­çš„æ•°æ®ï¼Œæ‰€ä»¥æ•°æ®è‡ªç„¶å°±éš”ç¦»å¼€äº†ã€‚</p>
<p><strong>é‚£ä¹ˆThreadLocalMapæ˜¯æ€ä¹ˆå­˜å‚¨æ•°æ®çš„å‘¢ï¼Ÿ</strong> ThreadLocalMap æ˜¯ThreadLocalç±»é‡Œçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œè™½ç„¶ç±»çš„åå­—ä¸Šå¸¦ç€Mapä½†å´æ²¡æœ‰å®ç°Mapæ¥å£ï¼Œåªæ˜¯ç»“æ„å’ŒMapç±»ä¼¼è€Œå·²ã€‚<img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/20200909231451433.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
ThreadLocalMapå†…éƒ¨å…¶å®æ˜¯ä¸€ä¸ªEntryæ•°ç»„ï¼ŒEntryæ˜¯ThreadLocalMapä¸­çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œç»§æ‰¿è‡ªWeakReferenceï¼Œå¹¶å°†ThreadLocalç±»å‹çš„å¯¹è±¡è®¾ç½®ä¸ºäº†Entryçš„Keyï¼Œä»¥åŠå¯¹Keyè®¾ç½®æˆå¼±å¼•ç”¨ã€‚ ThreadLocalMapçš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œå°±å¤§æ¦‚æ˜¯è¿™æ ·çš„key,valueç»„æˆçš„Entryçš„æ•°ç»„é›†åˆã€‚<img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/2020090923454535.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
å’ŒçœŸæ­£çš„Mapè¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼Œæ²¡æœ‰é“¾è¡¨äº†ï¼Œè¿™æ ·åœ¨è§£å†³keyçš„hashå†²çªçš„æ—¶å€™æªæ–½è‚¯å®šå°±å’ŒHashMapä¸ä¸€æ ·äº†ã€‚ ä¸€ä¸ªçº¿ç¨‹ä¸­æ˜¯å¯ä»¥åˆ›å»ºå¤šä¸ªThreadLocalå¯¹è±¡çš„ï¼Œå¤šä¸ªThreadLocalå¯¹è±¡å°±ä¼šå­˜æ”¾å¤šä¸ªæ•°æ®ï¼Œé‚£ä¹ˆåœ¨ThreadLocalMapä¸­å°±ä¼šä»¥æ•°ç»„çš„å½¢å¼å­˜æ”¾è¿™äº›æ•°æ®ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„ThreadLocalMapçš„set()æ–¹æ³•çš„æºç </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Set the value associated with key.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param key the thread local object
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param value the value to be set
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">ThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// We don&#39;t use a fast path as with get() because it is at
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// least as common to use set() to create new entries as
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// it is to replace existing ones, in which case, a fast
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// path would fail more often than not.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">Entry</span><span class="o">[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å®šä½åœ¨æ•°ç»„ä¸­çš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">threadLocalHashCode</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">         <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">e</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span> <span class="o">=</span> <span class="n">nextIndex</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">len</span><span class="o">)])</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœå½“å‰ä½ç½®ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å½“å‰ä½ç½®çš„keyå’Œä¼ è¿‡æ¥çš„keyç›¸ç­‰ï¼Œé‚£ä¹ˆå°±ä¼šè¦†ç›–å½“å‰ä½ç½®çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœå½“å‰ä½ç½®ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªEntryå¯¹è±¡ï¼Œæ”¾åˆ°å½“å‰ä½ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">replaceStaleEntry</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå½“å‰ä½ç½®ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å½“å‰ä½ç½®çš„keyä¹Ÿä¸ç­‰äºè¦èµ‹å€¼çš„key ï¼Œé‚£ä¹ˆå°†å»æ‰¾ä¸‹ä¸€ä¸ªç©ºä½ç½®ï¼Œç›´æ¥å°†æ•°æ®æ”¾åˆ°ä¸‹ä¸€ä¸ªç©ºä½ç½®å¤„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Entry</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="o">++</span><span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">cleanSomeSlots</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">sz</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">sz</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">rehash</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ä»set()æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¤„ç†é€»è¾‘æœ‰å››æ­¥ã€‚</p>
<ul>
<li>ç¬¬ä¸€æ­¥å…ˆæ ¹æ®Threadlocalå¯¹è±¡çš„hashcodeå’Œæ•°ç»„é•¿åº¦åšä¸è¿ç®—è·å–æ•°æ®åº”è¯¥æ”¾åœ¨å½“å‰æ•°ç»„ä¸­çš„ä½ç½®ã€‚</li>
<li>ç¬¬äºŒæ­¥å°±æ˜¯åˆ¤æ–­å½“å‰ä½ç½®æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºçš„è¯å°±ç›´æ¥åˆå§‹åŒ–ä¸€ä¸ªEntryå¯¹è±¡ï¼Œæ”¾åˆ°å½“å‰ä½ç½®ã€‚</li>
<li>ç¬¬ä¸‰æ­¥å¦‚æœå½“å‰ä½ç½®ä¸ä¸ºç©ºï¼Œè€Œå½“å‰ä½ç½®çš„Entryä¸­çš„keyå’Œä¼ è¿‡æ¥çš„keyä¸€æ ·ï¼Œé‚£ä¹ˆç›´æ¥è¦†ç›–æ‰å½“å‰ä½ç½®çš„æ•°æ®ã€‚</li>
<li>ç¬¬å››æ­¥å¦‚æœå½“å‰ä½ç½®ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å½“å‰ä½ç½®çš„Entryä¸­çš„keyå’Œä¼ è¿‡æ¥çš„key ä¹Ÿä¸ä¸€æ ·ï¼Œé‚£ä¹ˆå°±ä¼šå»æ‰¾ä¸‹ä¸€ä¸ªç©ºä½ç½®ï¼Œç„¶åå°†æ•°æ®å­˜æ”¾åˆ°ç©ºä½ç½®ï¼ˆ<strong>æ•°ç»„è¶…è¿‡é•¿åº¦åï¼Œä¼šæ‰§è¡Œæ‰©å®¹çš„</strong>ï¼‰ï¼›</li>
</ul>
<p>åœ¨getçš„æ—¶å€™ä¹Ÿæ˜¯ç±»ä¼¼çš„é€»è¾‘ï¼Œå…ˆé€šè¿‡ä¼ å…¥çš„ThreadLocalçš„hashcodeè·å–åœ¨Entryæ•°ç»„ä¸­çš„ä½ç½®ï¼Œç„¶åæ‹¿å½“å‰ä½ç½®çš„Entryçš„Keyå’Œä¼ å…¥çš„ThreadLocalå¯¹æ¯”ï¼Œç›¸ç­‰çš„è¯ï¼Œç›´æ¥æŠŠæ•°æ®è¿”å›ï¼Œå¦‚æœä¸ç›¸ç­‰å°±å»åˆ¤æ–­å’Œæ•°ç»„ä¸­çš„ä¸‹ä¸€ä¸ªå€¼çš„keyæ˜¯å¦ç›¸ç­‰ã€‚ã€‚ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Entry</span> <span class="nf">getEntry</span><span class="o">(</span><span class="n">ThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">threadLocalHashCode</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">table</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Entry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">table</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="n">key</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">getEntryAfterMiss</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Version of getEntry method for use when key is not found in
</span></span></span><span class="line"><span class="cl"><span class="cm"> * its direct hash slot.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param  key the thread local object
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param  i the table index for key&#39;s hash code
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param  e the entry at table[i]
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return the entry associated with key, or null if no such
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Entry</span> <span class="nf">getEntryAfterMiss</span><span class="o">(</span><span class="n">ThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">Entry</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Entry</span><span class="o">[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">expungeStaleEntry</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span> <span class="o">=</span> <span class="n">nextIndex</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ä¸Šæ–‡ä¸€ç›´è¯´ï¼ŒThreadLocalæ˜¯ä¿å­˜åœ¨å•ä¸ªçº¿ç¨‹ä¸­çš„æ•°æ®ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ•°æ®ï¼Œä½†æ˜¯å®é™…ThreadLocalé‡Œé¢çš„çœŸæ­£çš„å¯¹è±¡æ•°æ®ï¼Œå…¶å®æ˜¯ä¿å­˜åœ¨å †é‡Œé¢çš„ï¼Œè€Œçº¿ç¨‹é‡Œé¢åªæ˜¯å­˜å‚¨äº†å¯¹è±¡çš„å¼•ç”¨è€Œå·²ã€‚ å¹¶ä¸”æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™é€šå¸¸éœ€è¦åœ¨ä¸Šä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•çš„ä¸Šä¸‹æ–‡å…±äº«ThreadLocalä¸­çš„å˜é‡ã€‚ ä¾‹å¦‚æˆ‘çš„ä¸»çº¿ç¨‹æ˜¯åœ¨æŸä¸ªæ–¹æ³•ä¸­æ‰§è¡Œä»£ç å‘¢ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•ä¸­æœ‰ä¸€æ®µä»£ç æ—¶æ–°åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨è¿™ä¸ªçº¿ç¨‹é‡Œé¢è¿˜ä½¿ç”¨äº†æˆ‘è¿™ä¸ªæ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•é‡Œé¢çš„å®šä¹‰çš„ThreadLocalé‡Œé¢çš„å˜é‡ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå°±æ˜¯éœ€è¦ä»æ–°çº¿ç¨‹é‡Œé¢è°ƒç”¨å¤–é¢çº¿ç¨‹çš„æ•°æ®ï¼Œè¿™ä¸ªå°±éœ€è¦çº¿ç¨‹é—´å…±äº«äº†ã€‚è¿™ç§å­çˆ¶çº¿ç¨‹å…±äº«æ•°æ®çš„æƒ…å†µï¼ŒThreadLocalä¹Ÿæ˜¯æ”¯æŒçš„ã€‚ ä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="n">ThreadLocal</span> <span class="n">threadLocalMain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InheritableThreadLocal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"> <span class="n">threadLocalMain</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;ä¸»çº¿ç¨‹å˜é‡&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">     <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="kd">super</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">&#34;ç°åœ¨è·å–çš„å˜é‡æ˜¯ =&#34;</span> <span class="o">+</span> <span class="n">threadLocalMain</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">     <span class="o">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">};</span>
</span></span><span class="line"><span class="cl"> <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="err">ç°åœ¨è·å–çš„å˜é‡æ˜¯</span> <span class="o">=</span><span class="err">ä¸»çº¿ç¨‹å˜é‡</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢è¿™æ ·çš„ä»£ç å°±èƒ½å®ç°å­çˆ¶çº¿ç¨‹å…±äº«æ•°æ®çš„æƒ…å†µï¼Œé‡ç‚¹æ˜¯ä½¿ç”¨InheritableThreadLocalæ¥å®ç°çš„å…±äº«ã€‚ é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆå®ç°æ•°æ®å…±äº«çš„å‘¢ï¼Ÿ åœ¨Threadç±»çš„init()æ–¹æ³•ä¸­æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">inheritThreadLocals</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">.</span><span class="na">inheritableThreadLocals</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">inheritableThreadLocals</span> <span class="o">=</span><span class="n">ThreadLocal</span><span class="o">.</span><span class="na">createInheritedMap</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">inheritableThreadLocals</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼Œåœ¨åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰çº¿ç¨‹çš„inheritThreadLocalså˜é‡å’Œçˆ¶çº¿ç¨‹çš„inheritThreadLocalså˜é‡éƒ½ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œä¼šå°†çˆ¶çº¿ç¨‹çš„inheritThreadLocalså˜é‡ä¸­çš„æ•°æ®ï¼Œèµ‹ç»™å½“å‰çº¿ç¨‹ä¸­çš„inheritThreadLocalså˜é‡ã€‚</p>
<h3 id="threadlocalçš„å†…å­˜æ³„æ¼é—®é¢˜">ThreadLocalçš„å†…å­˜æ³„æ¼é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#threadlocalçš„å†…å­˜æ³„æ¼é—®é¢˜">#</a></h3>
<p>ä¸Šæ–‡æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ï¼ŒThreadLocalä¸­çš„ThreadLocalMapé‡Œé¢çš„Entryå¯¹è±¡æ˜¯ç»§æ‰¿è‡ªWeakReferenceç±»çš„ï¼Œè¯´æ˜Entryçš„keyæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ã€‚</p>
<p><img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/20200910083829900.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<blockquote>
<p>å¼±å¼•ç”¨æ˜¯ç”¨æ¥æè¿°é‚£äº›éå¿…é¡»çš„å¯¹è±¡ï¼Œå¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œåªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¸ºæ­¢ã€‚å½“åƒåœ¾æ”¶é›†å™¨å¼€å§‹å·¥ä½œï¼Œæ— è®ºå½“å‰å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰åªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚</p>
</blockquote>
<p><strong>è¿™ä¸ªå¼±å¼•ç”¨è¿˜æ˜¯ThreadLocalå¯¹è±¡æœ¬èº«ï¼Œæ‰€ä»¥ä¸€èˆ¬åœ¨çº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼ŒThreadLocalå¯¹è±¡å°±ä¼šå˜æˆnulläº†ï¼Œè€Œä¸ºnullçš„å¼±å¼•ç”¨å¯¹è±¡ï¼Œåœ¨ä¸‹ä¸€æ¬¡GCçš„æ—¶å€™å°±ä¼šè¢«æ¸…é™¤æ‰ï¼Œè¿™æ ·Entryçš„Keyçš„å†…å­˜ç©ºé—´å°±è¢«é‡Šæ”¾å‡ºæ¥äº†ï¼Œä½†æ˜¯Entryçš„valueè¿˜åœ¨å ç”¨çš„å†…å­˜ï¼Œå¦‚æœçº¿ç¨‹æ˜¯è¢«å¤ç”¨çš„ï¼ˆä¾‹å¦‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼‰ï¼Œåé¢ä¹Ÿä¸ä½¿ç”¨ThreadLocalå­˜å–æ•°æ®äº†ï¼Œé‚£ä¹ˆè¿™é‡Œé¢çš„valueå€¼ä¼šä¸€ç›´å­˜åœ¨ï¼Œæœ€ç»ˆå°±å¯¼è‡´äº†å†…å­˜æ³„æ¼ã€‚</strong></p>
<p><strong>é˜²æ­¢å†…å­˜æ³„æ¼çš„åŠæ³•å°±æ˜¯åœ¨æ¯æ¬¡ä½¿ç”¨å®ŒThreadLocalçš„æ—¶å€™éƒ½å»æ‰§è¡Œä»¥ä¸‹remove()æ–¹æ³•ï¼Œå°±å¯ä»¥æŠŠkeyå’Œvalueçš„ç©ºé—´éƒ½é‡Šæ”¾äº†ã€‚</strong></p>
<h3 id="é‚£æ—¢ç„¶å®¹æ˜“äº§ç”Ÿå†…å­˜æ³„æ¼ä¸ºä»€ä¹ˆè¿˜è¦è®¾ç½®æˆå¼±å¼•ç”¨çš„å‘¢">é‚£æ—¢ç„¶å®¹æ˜“äº§ç”Ÿå†…å­˜æ³„æ¼ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è®¾ç½®æˆå¼±å¼•ç”¨çš„å‘¢ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#é‚£æ—¢ç„¶å®¹æ˜“äº§ç”Ÿå†…å­˜æ³„æ¼ä¸ºä»€ä¹ˆè¿˜è¦è®¾ç½®æˆå¼±å¼•ç”¨çš„å‘¢">#</a></h3>
<p>å¦‚æœæ­£å¸¸æƒ…å†µä¸‹åº”è¯¥æ˜¯å¼ºå¼•ç”¨ï¼Œä½†æ˜¯å¼ºå¼•ç”¨åªè¦å¼•ç”¨å…³ç³»è¿˜åœ¨å°±ä¸€ç›´ä¸ä¼šè¢«å›æ”¶ï¼Œæ‰€ä»¥å¦‚æœçº¿ç¨‹è¢«å¤ç”¨äº†ï¼Œé‚£ä¹ˆEntryä¸­çš„Keyå’ŒValueéƒ½ä¸ä¼šè¢«å›æ”¶ï¼Œè¿™æ ·å°±é€ æˆäº†Keyå’ŒValueéƒ½ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼äº†ï¼›</p>
<p>ä½†æ˜¯è®¾ç½®æˆå¼±å¼•ç”¨ï¼Œå½“ThreadLocalå¯¹è±¡ï¼Œæ²¡æœ‰è¢«å¼ºå¼•ç”¨åï¼Œå°±ä¼šè¢«å›æ”¶ï¼Œå›æ”¶åï¼ŒEntryä¸­çš„keyå°±ä¼šè¢«è®¾ç½®æˆnulläº†ï¼Œå¦‚æœThreadè¢«é‡å¤ä½¿ç”¨ï¼Œåªè¦è¿˜ä¼šç”¨ThreadLocalå­˜å‚¨æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨ThreadLocalçš„ï¼Œsetã€getç­‰æ–¹æ³•ï¼Œåœ¨è°ƒç”¨setã€getã€ç­‰æ–¹æ³•çš„æ—¶å€™ï¼Œæ˜¯ä¼šæ‰«æEntryä¸­keyä¸ºnullçš„æ•°æ®çš„ã€‚ å½“å‘ç°Entryä¸­ï¼Œæœ‰keyä¸ºnullçš„æ•°æ®æ—¶ï¼Œä¼šå°†valueä¹Ÿè®¾ç½®ä¸ºnullï¼Œè¿™æ ·å°±å°†valueçš„å€¼ä¹Ÿè¿›è¡Œäº†å›æ”¶ï¼Œèƒ½è¿›ä¸€æ­¥é˜²æ­¢å†…å­˜æ³„æ¼äº†ï¼Œå¹¶ä¸”åœ¨è¿›è¡Œrehashçš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å…ˆæ¸…é™¤æ‰keyæ˜¯nullçš„æ•°æ®åï¼Œå¦‚æœç©ºé—´è¿˜ä¸å¤Ÿï¼Œæ‰è¿›è¡Œæ‰©å®¹çš„ã€‚</p>
<p>ä½†æ˜¯è™½ç„¶å°†keyè®¾ç½®äº†å¼±å¼•ç”¨ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹è¢«é‡å¤åˆ©ç”¨ï¼Œæ‰§è¡Œå®Œä»»åŠ¡åï¼Œå†ä¹Ÿä¸ä½¿ç”¨ThreadLocaläº†ï¼Œé‚£ä¹ˆæœ€åvalueå€¼ä¼šä¸€ç›´å­˜åœ¨ï¼Œæœ€ç»ˆä¹Ÿæ˜¯ä¼šå¯¼è‡´å†…å­˜æ³„æ¼çš„ï¼Œæ‰€ä»¥ä½¿ç”¨ThreadLocalçš„æ—¶å€™ï¼Œæœ€åä¸€å®šè¦æ‰§è¡Œremove()æ–¹æ³•ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://habyss.github.io/posts/read/java%E5%9F%BA%E7%A1%8036%E8%AE%B2/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>JavaåŸºç¡€36è®²</span>
  </a>
  <a class="next" href="https://habyss.github.io/posts/read/linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Linuxæ€§èƒ½ä¼˜åŒ–</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://habyss.github.io/">å¶ç°ç°çš„å°çª</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
