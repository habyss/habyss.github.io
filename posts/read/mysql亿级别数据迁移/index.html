<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº« | å¶ç°ç°çš„å°çª</title>
<meta name="keywords" content="">
<meta name="description" content="MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº« xä¸šåŠ¡èƒŒæ™¯ æŸä¸€é¡¹æŠ€æœ¯çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³é—®é¢˜çš„ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥è¦å­¦ä¹ æŸä¸ªæŠ€æœ¯ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªæŠ€æœ¯è§£å†³äº†æˆ‘ä»¬å·¥ä½œä¸­é‡åˆ°çš„ç—›ç‚¹ã€‚">
<meta name="author" content="å¶ç°ç°">
<link rel="canonical" href="https://habyss.github.io/posts/read/mysql%E4%BA%BF%E7%BA%A7%E5%88%AB%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="apple-touch-icon" href="https://habyss.github.io/gif/hwlm.gif">
<link rel="mask-icon" href="https://habyss.github.io/gif/hwlm.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº«" />
<meta property="og:description" content="MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº« xä¸šåŠ¡èƒŒæ™¯ æŸä¸€é¡¹æŠ€æœ¯çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³é—®é¢˜çš„ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥è¦å­¦ä¹ æŸä¸ªæŠ€æœ¯ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªæŠ€æœ¯è§£å†³äº†æˆ‘ä»¬å·¥ä½œä¸­é‡åˆ°çš„ç—›ç‚¹ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://habyss.github.io/posts/read/mysql%E4%BA%BF%E7%BA%A7%E5%88%AB%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-23T15:36:53+08:00" />
<meta property="article:modified_time" content="2022-11-29T15:36:53+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº«"/>
<meta name="twitter:description" content="MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº« xä¸šåŠ¡èƒŒæ™¯ æŸä¸€é¡¹æŠ€æœ¯çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³é—®é¢˜çš„ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥è¦å­¦ä¹ æŸä¸ªæŠ€æœ¯ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªæŠ€æœ¯è§£å†³äº†æˆ‘ä»¬å·¥ä½œä¸­é‡åˆ°çš„ç—›ç‚¹ã€‚"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://habyss.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“•é˜…è¯»",
      "item": "https://habyss.github.io/posts/read/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº«",
      "item": "https://habyss.github.io/posts/read/mysql%E4%BA%BF%E7%BA%A7%E5%88%AB%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº«",
  "name": "MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº«",
  "description": "MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº« xä¸šåŠ¡èƒŒæ™¯ æŸä¸€é¡¹æŠ€æœ¯çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³é—®é¢˜çš„ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥è¦å­¦ä¹ æŸä¸ªæŠ€æœ¯ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªæŠ€æœ¯è§£å†³äº†æˆ‘ä»¬å·¥ä½œä¸­é‡åˆ°çš„ç—›ç‚¹ã€‚",
  "keywords": [
    
  ],
  "articleBody": "MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº« xä¸šåŠ¡èƒŒæ™¯ æŸä¸€é¡¹æŠ€æœ¯çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³é—®é¢˜çš„ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥è¦å­¦ä¹ æŸä¸ªæŠ€æœ¯ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªæŠ€æœ¯è§£å†³äº†æˆ‘ä»¬å·¥ä½œä¸­é‡åˆ°çš„ç—›ç‚¹ã€‚ä¸Šäº¿æ¡æ•°æ®åœ¨ MySQL ä¸­æœ‰ç´¢å¼•çš„æ¡ä»¶ä¸‹ï¼Œå®é™…ä¸Šåªæ˜¯æŸ¥è¯¢æ˜¯æ²¡æœ‰å¤ªå¤§é—®é¢˜çš„ï¼Œåœ¨æ²¡æœ‰ç‰¹åˆ«å¤§çš„å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œåªæ˜¯æ’å…¥ç‰¹åˆ«æ…¢ã€‚\nåœ¨è¿ç§»å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹é¢ä¸´çš„é—®é¢˜ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š\næ€ä¹ˆä¿è¯æŸ¥è¯¢å¤§æ•°æ®é‡ä¸‹æ²¡æœ‰æ€§èƒ½çš„ç“¶é¢ˆã€‚ ä¸èƒ½å½±å“æ­£å¸¸çš„ä¸šåŠ¡æŸ¥è¯¢ï¼Œä¸è¦æœ‰å¤ªå¤šçš„æ€§èƒ½æŸè€—ï¼Œå¯ä»¥çµæ´»æ§åˆ¶è¿ç§»çš„å¯åŠ¨ä¸åœæ­¢ã€‚ å®é™…çš„è¿ç§»å‚æ•°å¯ä»¥åŠ¨æ€çš„æ‰©å±•ï¼Œæ¯”å¦‚ä¸€æ¬¡æ‰¹é‡æäº¤å¤šå°‘æ¡æ•°æ®ï¼Œä¸€æ¬¡è¿ç§»å¤šå°‘ï¼Œè¿ç§»è¿‡ç¨‹ä¸­æ€ä¹ˆè½¬åŒ–æ•°æ®ã€‚ å¯¹äºä¸€äº›é”™è¯¯å¯ä»¥å®¹å¿çš„è¯æ€ä¹ˆè·³è¿‡å¼‚å¸¸ï¼Œæ¯”å¦‚å¯ä»¥å®¹å¿å‡ æ¡æ•°æ®çš„å¤±è´¥ã€‚ æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„æµ‹è¯•å®é™…ä¸€èˆ¬å¾ˆéš¾è¾¾åˆ°ç™¾åˆ†ç™¾ä¸€è‡´ï¼Œå¦‚ä½•åœ¨çº¿ä¸Šå¯¹è¿ç§»çš„æ€§èƒ½è¿›è¡Œå¯é…ç½®çš„æ§åˆ¶ã€‚ äº‹åŠ¡çš„æäº¤é—®é¢˜ï¼Œå› ä¸ºæ•°æ®é‡è¿‡å¤§ï¼Œä¸èƒ½å°†æ‰€æœ‰æ•°æ®æŸ¥è¯¢åˆ°å†…å­˜ä¹‹ä¸­ï¼Œæ•°æ®å¦‚ä½•åˆ†è€Œæ²»ä¹‹ã€‚ è¿ç§»çš„è¿‡ç¨‹éœ€è¦è®°å½•ï¼Œæ¯”å¦‚æ¯æ¬¡çš„ä»»åŠ¡æ‰§è¡Œçš„å¤šé•¿æ—¶é—´ï¼Œäº‹åŠ¡æäº¤äº†å¤šå°‘æ¬¡ï¼Œè¿™äº›éƒ½å¯ä»¥æŸ¥è¯¢ï¼Œæ ¹æ®è¿™äº›æŒ‡æ ‡å†æ¬¡åŠ¨æ€è°ƒæ•´ã€‚ é’ˆå¯¹ä¸Šé¢æå‡ºçš„é—®é¢˜ï¼Œæˆ‘ä»¬è‡ªå·±å»å†™è¿™æ ·ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ä¸”ç¨³å®šçš„åŠŸèƒ½ï¼Œå®é™…ä¸­è¿˜æ˜¯æ¯”è¾ƒå›°éš¾çš„ã€‚æŒ‰ç…§é€šå¸¸çš„ Service å’Œ Dao çš„å†™æ³•ï¼Œæ»¡è¶³ä¸äº†æˆ‘ä»¬çš„éœ€æ±‚ã€‚\nSpring Batch æ ¸å¿ƒåŠŸèƒ½çš„ä»‹ç» Spring Batch æ˜¯ Spring å®˜æ–¹çš„ä¸€ä¸ªä¸“é—¨ç”¨äºå¤„ç†å¤§æ•°æ®ä½“é‡ä¸‹æ•°æ®è¿ç§»çš„å¼€æºæ¡†æ¶ï¼Œä¸»è¦è§£å†³çš„é—®é¢˜å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„é‚£äº›é—®é¢˜ï¼Œé€šè¿‡åˆ†æ‰¹è¯»å–å’Œå†™æ•°æ®ï¼Œä¿è¯å†…å­˜ä¸ä¼šå‘ç”Ÿæº¢å‡ºã€‚å¹¶ä¸”é€šè¿‡çµæ´»çš„ç»„ä»¶ç»„åˆï¼Œå¯ä»¥æ»¡è¶³æ•°æ®è¿ç§»ä¸­çš„å„ç§éœ€æ±‚ã€‚\næ ¸å¿ƒçš„åŠŸèƒ½å’Œç‰¹ç‚¹ äº‹åŠ¡ç®¡ç† åŸºäºåˆ†å—çš„å¤„ç† å£°æ˜å¼ IO å¯çµæ´»æ§åˆ¶å¼€å§‹ã€åœæ­¢ã€é‡å¯ é‡è¯•å’Œè·³è¿‡ åŸºäºç½‘é¡µçš„åå°ç®¡ç† Spring Cloud Data Flow Spring Batch çš„æ–‡æ¡£å¾ˆå…¨é¢ï¼Œä½†å¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œæ•´ä¸ªæ–‡æ¡£è¯»å®Œéœ€è¦è€—è´¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œè¿™é‡Œåªçœ‹ä¸¤å¼  Spring Batch çš„æ¶æ„å›¾ï¼Œåé¢æˆ‘ä¼šé€šè¿‡å®é™…å·¥ä½œä¸­çš„è¿ç§»æ¡ˆä¾‹æ¥è®²è§£æ€ä¹ˆä½¿ç”¨å®ƒã€‚\næ¶æ„å›¾ ç¬¬ä¸€å¼ å›¾æ˜¯æ¶æ„å›¾ï¼Œç¬¬äºŒå¼ åˆ†åŒºå¤„ç†å›¾ã€‚\nä»è¿™ä¸¤å¼ å›¾å¯ä»¥çœ‹åˆ°è¿™æ­£æ˜¯æˆ‘ä»¬è¿ç§»å¤§æ•°æ®é‡ä¸‹çš„æ ¸å¿ƒè¯‰æ±‚ã€‚è¾“å…¥ç«¯æ˜¯ä»æ•°æ®æºè¯»å–æ•°æ®ï¼Œæ•°æ®æºå¯ä»¥æ¥æºäºæ–‡ä»¶æˆ–è€…æ•°æ®åº“ï¼Œä¸­é—´çš„å¤„ç†æµç¨‹æ˜¯å¯¹æ•°æ®è¿›è¡ŒåŠ å·¥ï¼Œå› ä¸ºæœ‰äº›æ•°æ®æˆ‘ä»¬éœ€è¦è¿›è¡Œè½¬æ¢å’Œå¤„ç†ï¼Œè¾“å‡ºç«¯æ˜¯å†™å‡ºæ•°æ®ï¼Œå¯ä»¥å†™å…¥åˆ°æ–‡ä»¶æˆ–è€…æ•°æ®åº“ã€‚\næ ¸å¿ƒç»„ä»¶ Readerï¼šè´Ÿè´£æ•°æ®çš„è¯»å– Processorï¼šè´Ÿè´£æ•°æ®çš„å¤„ç† Writerï¼šè´Ÿè´£æ•°æ®çš„å†™å‡º Stepï¼šæµç¨‹ç¼–æ’ Jobï¼šä»»åŠ¡é…ç½® è¿™äº›ä¸šåŠ¡ç»„ä»¶ç”¨æˆ‘ä»¬ç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥ç†è§£çš„è¯ï¼Œå¯ä»¥æƒ³è±¡ä¸€ä¸‹å¦‚ä¸‹çš„åœºæ™¯ï¼š\næ•°æ®è¿ç§»å°±å¥½æ¯”ä»ä¸€ä¸ªæ²¹ç”°é‡Œè¿è¾“åŸæ²¹åˆ°ç‚¼æ²¹å‚ï¼Œæç‚¼å®Œæˆåæœ€ç»ˆæŠŠæˆå“æ²¹é€åˆ°åŠ æ²¹ç«™çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚åŸæ²¹åœ¨åˆ°æˆå“æ²¹çš„è¿‡ç¨‹ä¸­è¦ç»å†å¾ˆå¤šçš„æµç¨‹å’Œè¿è¾“æ­¥éª¤ï¼Œå°±åƒæˆ‘ä»¬çš„æ•°æ®è¦ç»è¿‡è½¬æ¢ä¸€æ ·ã€‚\nReader å°±å¥½æ¯”ä»æ²¹ç”°é‡Œå°†åŸæ²¹è£…ä¸Šè¿è¾“è½¦ï¼ŒProcessor å°±å¥½æ¯”å°†åŸæ²¹æç‚¼å‡ºæˆå“æ²¹ï¼ŒWriter å°±å¥½æ¯”å°†æ²¹è¿åˆ°åŠ æ²¹ç«™çš„æ²¹ç®±é‡Œï¼ŒStep å°±æ˜¯è¿™ä¸ªè£…æ²¹ -\u003e æç‚¼æ²¹ -\u003e è¿è¾“åˆ°åŠ æ²¹ç«™è¿™ä¸ªæµæ°´çº¿ä¸€æ ·çš„å¤„ç†æ­¥éª¤ï¼ŒJob ç›¸å½“ä¸ä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡å°±æ˜¯ Step å®šä¹‰å¥½çš„è¿™ä¸ªæµç¨‹ï¼Œä»»åŠ¡å¯ä»¥æ‰§è¡Œå¤šæ¬¡ï¼Œä½†æ˜¯æ¯ä¸€æ¬¡éƒ½æ˜¯æŒ‰ç…§æå‰å®šä¹‰å¥½çš„ Step æ¥æ‰§è¡Œã€‚\nå®é™…ä¸­çš„ä¸šåŠ¡éœ€æ±‚æ€ä¹ˆå®ç° å¯ä»¥å…ˆä¸‹è½½æºç ï¼š\nhttps://gitee.com/smartGim/batchsrv\nå…ˆä»å•è¡¨æ•°æ®å¤‡ä»½å¿«é€Ÿäº†è§£è¿ç§»æµç¨‹ è¿™ç§åœºæ™¯å¤šè§äºé¡¹ç›®åˆ›å»ºåˆæœŸä¸ºäº†å¿«é€Ÿä¸Šçº¿ï¼Œåœ¨é¡¹ç›®åˆæœŸæ²¡æœ‰åšåˆ†åº“åˆ†è¡¨ï¼ˆåœ¨é¡¹ç›®åˆæœŸä¸€èˆ¬ä¸ä¼šåšåˆ†åº“åˆ†è¡¨ï¼‰ï¼Œæ¯”å¦‚è®¢å•è¡¨ï¼Œè¿˜æœ‰é“¶è¡Œæµæ°´è¡¨ã€å†å²å¯¹è´¦æ•°æ®ã€æ”¯ä»˜è®°å½•æ•°æ®è¡¨ç­‰ã€‚è¿™ç§æ•°æ®çš„ç‰¹ç‚¹ä¸ºæ—¶é—´åœ¨åŠå¹´æˆ–è€…ä¸€å¹´ä»¥ä¸Šå°†å˜ä¸ºå†·æ•°æ®ï¼Œæ•°æ®æŸ¥è¯¢çš„æƒ…å†µæ¯”è¾ƒå°‘ï¼Œå¹¶ä¸”æ•°æ®ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦å°†æ—¶é—´å¤§äºä¸€å®šæ—¶æœŸçš„æ•°æ®å®šæ—¶å¤‡ä»½ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯æ¥æ‰‹ä¸€äº›å†å²é—ç•™çš„é¡¹ç›®ï¼Œæœ‰äº›æ•°æ®çš„å•è¡¨å·²ç»è¾¾åˆ°äº†ä¸€ä¸ªæé™ã€‚\næˆ‘ä»¬ä»¥ä¸€ä¸ªæ•°æ®åº“çš„æ•°æ® db_source è¿ç§»åˆ°å¦å¤–ä¸€ä¸ªæ•°æ®åº“ db_target ä¸ºä¾‹ï¼Œè¿ç§»è¿‡ç¨‹ä¸­åŒæ—¶åˆ é™¤å·²ç»è¿ç§»èµ°çš„è®°å½•ã€‚å¹¶å°†è¿ç§»çš„è¿‡ç¨‹å’Œè®°å½•è¿›è¡Œè®°å½•ä¸‹æ¥åˆ° db_source ä¸­ã€‚\nå®ç°æ­¥éª¤ï¼š\n1. æ–°å»ºä¸€ä¸ª Spring Boot å·¥ç¨‹å¼•å…¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u003cdependency\u003e \u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e \u003cartifactId\u003espring-boot-starter-batch\u003c/artifactId\u003e \u003c/dependency\u003e @SpringBootApplication @EnableBatchProcessing public class BatchsrvApplication { public static void main(String[] args) { SpringApplication.run(BatchsrvApplication.class, args); } } åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ @EnableBatchProcessingã€‚\næ³¨æ„ï¼šæ·»åŠ ä¸Šäº†æ­¤æ³¨è§£ï¼Œé‚£ä¹ˆé¡¹ç›®å¯åŠ¨å Spring Batch å°±ä¼šè‡ªåŠ¨åŒ–åˆå§‹ç›¸å…³çš„æ•°æ®åº“æ–‡ä»¶ï¼Œå¹¶ä¸”ç›´æ¥å¯åŠ¨ç›¸å…³çš„è¿ç§»ä»»åŠ¡ã€‚åœ¨å®é™…çš„çº¿ä¸Šè¿ç§»ä¸­æ˜¯ä¸ä¼šç›´æ¥ä¸Šçº¿åå°±è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡çš„ï¼Œé€šå¸¸ä¼šå…ˆé€šè¿‡æ‰‹åŠ¨æ‰§è¡Œæ¥çœ‹ä¸‹æ‰§è¡Œæƒ…å†µï¼Œå†åŠ¨æ€é…ç½®ä¸€äº›æŒ‡æ ‡ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„é¡¹ç›®ä¼šç¦ç”¨è‡ªåŠ¨æ‰§è¡Œï¼Œå¹¶ä¸”æ‰‹åŠ¨æ‰§è¡Œ Spring batch çš„æ•°æ®åº“æ–‡ä»¶ï¼Œæ•°æ®åº“åˆå§‹æ–‡ä»¶åœ¨ spring-batch-core ä¸­ï¼Œæ ¹æ®æ•°æ®åº“è¿›è¡Œé€‰æ‹©å³å¯ã€‚\nç¦ç”¨è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡é€‰é¡¹ï¼Œbatch.job.enabled = falseã€‚\n1 2 3 4 5 6 7 8 server: port: 8096 spring: profiles: active: dev batch: job: enabled: false 2. å¤šæ•°æ®æºé…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package cn.gitchat.share.config; import javax.sql.DataSource; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.context.annotation.Primary; import org.springframework.core.env.Environment; import org.springframework.jdbc.core.JdbcTemplate; import org.springframework.jdbc.datasource.DriverManagerDataSource; /** * @Author: Gim * @Date: 2019-12-04 17:05 * @Description: */ @Configuration public class DataSourceConfig { @Autowired private Environment env; @Bean @Primary public DataSource primaryDatasource() { DriverManagerDataSource dataSource = new DriverManagerDataSource(); dataSource.setDriverClassName(env.getProperty(\"source.driver-class-name\")); dataSource.setUrl(env.getProperty(\"source.jdbc-url\")); dataSource.setUsername(env.getProperty(\"source.username\")); dataSource.setPassword(env.getProperty(\"source.password\")); return dataSource; } @Bean public DataSource targetDatasource() { DriverManagerDataSource dataSource = new DriverManagerDataSource(); dataSource.setDriverClassName(env.getProperty(\"target.driver-class-name\")); dataSource.setUrl(env.getProperty(\"target.jdbc-url\")); dataSource.setUsername(env.getProperty(\"target.username\")); dataSource.setPassword(env.getProperty(\"target.password\")); return dataSource; } @Bean public JdbcTemplate primaryTemplate(){ return new JdbcTemplate(primaryDatasource()); } @Bean public JdbcTemplate targetJdbcTemplate(){ return new JdbcTemplate(targetDatasource()); } } æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨å¤šæ•°æ®æºçš„é…ç½®ï¼Œå¹¶ä¸”ä½¿ç”¨ JdbcTemplate è¿›è¡Œæ•°æ®çš„è¯»å–ã€‚\nä¸»æ•°æ®æºä¸­é…ç½® Spring Batch çš„æ•°æ®åº“æ–‡ä»¶ï¼ˆå¦‚æœä¸åœ¨æ„è¿ç§»çš„æƒ…å†µè®°å½•å¯ä»¥ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼Œå­˜å‚¨ Spring Batch çš„è¿ç§»è®°å½•æƒ…å†µï¼Œè¿™æ ·èƒ½æé«˜è¿ç§»æ€§èƒ½ï¼Œä½†æ˜¯å®é™…ä¸­ä¸å»ºè®®åšï¼Œè¿ç§»æ€§èƒ½çš„å¤§å¹…æå‡ä¼šå½±å“çº¿ä¸Šçš„ä¸šåŠ¡æ­£å¸¸è¿è¡Œï¼Œé™¤éè¿ç§»æœ‰åŠæ—¶æ€§è¿™ç§éœ€æ±‚å†å¼€å¯å†…å­˜æ•°æ®æºï¼‰ã€‚\nå¦‚ä½•å®šåˆ¶ Spring Batch çš„æ¡†æ¶ä½¿ç”¨çš„æ•°æ®æºï¼Ÿ\nä»æºç ä¸­æ‰¾åˆ°ï¼š\n1 public class BatchConfig extends DefaultBatchConfigurer è¿™ä¸ªç±»ç»§æ‰¿äº DefaultBatchConfigurer ç„¶åæˆ‘ä»¬å¯¹ JobRepository è¿›è¡Œé‡å†™ï¼š\n1 2 3 4 5 6 7 8 9 //å°†spring batch çš„è®°å½•å­˜å–åœ¨ä¸»æ•°æ®æºä¸­ @Override protected JobRepository createJobRepository() throws Exception { JobRepositoryFactoryBean factory = new JobRepositoryFactoryBean(); factory.setDataSource(primaryDatasource); factory.setTransactionManager(this.getTransactionManager()); factory.afterPropertiesSet(); return factory.getObject(); } 3. è¯»å–çš„é…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 /** * æ•°æ®è¯»å– æ ¹æ®id æŸ¥è¯¢ä¿è¯æ€§èƒ½ åˆ†é¡µè¯»å– */ @Bean @StepScope public JdbcPagingItemReader\u003cPayRecord\u003e payRecordReader(@Value(\"#{jobParameters[minId]}\") Long minId, @Value(\"#{jobParameters[maxId]}\") Long maxId) throws Exception { JdbcPagingItemReader\u003cPayRecord\u003e reader = new JdbcPagingItemReader(); final SqlPagingQueryProviderFactoryBean sqlPagingQueryProviderFactoryBean = new SqlPagingQueryProviderFactoryBean(); sqlPagingQueryProviderFactoryBean.setDataSource(primaryDatasource); sqlPagingQueryProviderFactoryBean.setSelectClause(\"select * \"); sqlPagingQueryProviderFactoryBean.setFromClause(\"from pay_record\"); sqlPagingQueryProviderFactoryBean.setWhereClause(\"id \u003e \" + minId + \" and id \u003c= \" + maxId); sqlPagingQueryProviderFactoryBean.setSortKey(\"id\"); reader.setQueryProvider(sqlPagingQueryProviderFactoryBean.getObject()); reader.setDataSource(primaryDatasource); reader.setPageSize(config.getPageSize()); reader.setRowMapper(new PayRecordRowMapper()); reader.afterPropertiesSet(); reader.setSaveState(true); return reader; } åœ¨è¯»å–çš„é…ç½®ä¸­æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹ï¼š\nç¬¬ä¸€ç‚¹å¯ä»¥çœ‹åˆ°åœ¨ @Bean ä¸‹æ–¹æœ‰ä¸ªæ³¨è§£ @StepScope è¿™ä¸ªæ³¨è§£çš„ä½œç”¨æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ Job æ‰§è¡Œæ—¶ç»™ Job æ·»åŠ å˜é‡ï¼Œç”¨äºæˆ‘ä»¬å¯ä»¥åŠ¨æ€çš„æ§åˆ¶æ¯æ¬¡ä»»åŠ¡è¦è¿ç§»çš„è®°å½•ï¼Œé€šè¿‡ @Value (\"#{jobParameters [minId]}\" è¿™ç§æ–¹å¼è¿›è¡Œæ¥æ”¶å‚æ•°ï¼Œä¼ é€’å‚æ•°å¯ä»¥åœ¨ä»»åŠ¡æ‰§è¡Œæ—¶è¿›è¡Œ Job ä¼ å‚ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 @Scheduled(cron = \"0 0 2 * * ?\") public void migratePayRecord() throws Exception { Map\u003cString, Object\u003e result = primaryJdbcTemplate .queryForMap(\"select * from job_config where config_key = ?\", MigrateConstants.PAY_RECORD_JOB_CONFIG_KEY); String value = (String) result.get(\"config_value\"); JobExecuteConfig payRecordJobConfig = JSON.parseObject(value, JobExecuteConfig.class); JobParameters params = new JobParametersBuilder() .addLong(\"maxId\", payRecordJobConfig.getExecuteMaxId()) .addLong(\"minId\", payRecordJobConfig.getMinId()) .toJobParameters(); jobLauncher.run(migratePayRecordJob, params); } ç¬¬äºŒç‚¹å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¯»å–æ•°æ®ä½¿ç”¨çš„æ˜¯ JdbcPagingItemReader è¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»çš„ç‰¹ç‚¹æ˜¯å¯ä»¥é€šè¿‡åˆ†é¡µçš„æ–¹å¼å¯¹æ•°æ®è®°å½•è¿›è¡Œè¯»å–ï¼Œä¿è¯ä¸ä¼šå†…å­˜æº¢å‡ºï¼Œè¿™é‡Œé¢ SortKey æ˜¯ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼Œä¸€å®šè¦ä¿è¯æ•°æ®çš„å”¯ä¸€æ€§ï¼Œè¿™ä¸ªç”¨äºä»»åŠ¡é‡æ–°å¯åŠ¨åˆ¤æ–­ä»å“ªå†æ¬¡å¼€å§‹ã€‚ PageSize æˆ‘ä»¬å¯ä»¥æ§åˆ¶æ¯ä¸€æ¬¡è¯»å–å¤šå°‘æ¡è®°å½•ï¼Œè¿™ä¸ªç”¨äºè°ƒä¼˜ç”¨ï¼Œæ ¹æ®å®é™…çš„æƒ…å†µè¿›è¡Œæ§åˆ¶ã€‚SaveState ç”¨äºå°†è¿ç§»çš„è®°å½•æƒ…å†µè¿›è¡Œè®°å½•ã€‚ è¿™ä¸ª Reader çš„é…ç½®éå¸¸é‡è¦æ˜¯ä¿è¯äº¿çº§åˆ«æ•°æ®ä¸ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºçš„å…³é”®é…ç½®ã€‚åœ¨è¿™é‡Œçš„é…ç½®ç›¸å½“äºæˆ‘ä»¬å¯¹å¤§æ•°é‡çº§åˆ«çš„æ•°æ®è¿›è¡Œäº†ä¸€ä¸ªåˆ†æ®µå¤„ç†ã€‚æ˜¯åˆ†è€Œæ²»ä¹‹çš„å…³é”®ç‚¹ã€‚ 4. å†™å…¥çš„é…ç½®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 /** * å†™å…¥åˆ°æ–°åº“ */ @Bean public ItemWriter\u003c? super PayRecord\u003e targetPayRecordWriter() { return new JdbcBatchItemWriterBuilder\u003cPayRecord\u003e() .dataSource(targetDatasource) .itemSqlParameterSourceProvider(new BeanPropertyItemSqlParameterSourceProvider\u003c\u003e()) .sql( \"INSERT INTO `pay_record` (\\n\" + \"`id`,\\n\" + \"`user_id`,\\n\" + \"`pay_detail`,\\n\" + \"`pay_status`,\\n\" + \"`create_time`,\\n\" + \"`update_time`\\n\" + \")\\n\" + \"VALUES\\n\" + \"\\t(\\n\" + \":id,\" + \":userId,\" + \":payDetail,\" + \":payStatus,\" + \":createTime,\" + \":updateTime\" + \")\") .build(); } /** * åˆ é™¤å™¨ * * @return */ @Bean public ItemWriter\u003cPayRecord\u003e deletePayRecordWriter() { return new JdbcBatchItemWriterBuilder\u003cPayRecord\u003e() .dataSource(primaryDatasource) .itemSqlParameterSourceProvider(new BeanPropertyItemSqlParameterSourceProvider\u003c\u003e()) .sql(\"delete from pay_record where id = :id\") .build(); } @Bean public CompositeItemWriter\u003cPayRecord\u003e compositePayRecordItemWriter(@Qualifier(\"deletePayRecordWriter\") ItemWriter deleteWriter, @Qualifier(\"targetPayRecordWriter\") ItemWriter targetPayRecordWriter) { CompositeItemWriter\u003cPayRecord\u003e compositeItemWriter = new CompositeItemWriter\u003c\u003e(); List\u003cItemWriter\u003c? super PayRecord\u003e\u003e list = new ArrayList\u003c\u003e(); list.add(deleteWriter); list.add(targetPayRecordWriter); compositeItemWriter.setDelegates(list); return compositeItemWriter; } å†™å…¥çš„é…ç½®è¿™é‡Œé¢ä½¿ç”¨äº†ä¸¤ä¸ªé…ç½®ï¼Œä¸€ä¸ªæ˜¯å†™å…¥æ–°çš„æ•°æ®æºï¼Œä¸€ä¸ªæ˜¯åˆ é™¤åŸæ¥çš„è¿ç§»æ•°æ®è¿æ¥çš„æ˜¯åŸæ¥çš„ä¸»æ•°æ®æºã€‚å†™å…¥å™¨ä½¿ç”¨çš„æ˜¯æ¡†æ¶æä¾›çš„ JdbcBatchItemWriter ï¼Œçœ‹åå­—å°±çŸ¥é“è¿™ä¸ªç±»çš„ä½œç”¨äº†ï¼Œå®ƒæ”¯æŒæ‰¹é‡çš„å†™å…¥ï¼Œæ€§èƒ½éå¸¸é«˜ã€‚Spring Batch æ”¯æŒå„ç§ Writer çš„ç»„åˆï¼Œé€šè¿‡ CompositeItemWriter æ¥å®ç°ã€‚åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºç»„åˆ Writer çš„ç”¨æ³•ï¼Œå®é™…ä¸­æœ€å¥½åˆ†æˆä¸¤æ­¥æ¥å®Œæˆè¿™ç§ä»»åŠ¡ã€‚\n5. Step çš„é…ç½®\n1 2 3 4 5 6 7 8 9 10 11 @Bean public Step migratePayRecordStep(@Qualifier(\"payRecordReader\") JdbcPagingItemReader\u003cPayRecord\u003e payRecordReader, @Qualifier(value = \"compositePayRecordItemWriter\") CompositeItemWriter compositeItemWriter) { return this.stepBuilderFactory.get(\"migratePayRecordStep\") .\u003cPayRecord, PayRecord\u003echunk(config.getChunkSize()) .reader(payRecordReader) .processor(new PassThroughItemProcessor()) .writer(compositeItemWriter) .taskExecutor(new SimpleAsyncTaskExecutor(\"migrate_thread\")) .throttleLimit(config.getThreadSize()) .build(); } åƒä¸Šé¢è®²åˆ°çš„é‚£æ · Step çš„ä½œç”¨å°±æ˜¯é…ç½®æ•´ä¸ªæµç¨‹çš„ï¼Œè¿™é‡Œé¢ chunk æ˜¯å¯¹æ•°æ®è¿›è¡Œåˆ†å—ï¼Œå¯ä»¥åŠ¨æ€çš„æ§åˆ¶æ¯æ¬¡äº‹åŠ¡æäº¤å¤šå°‘æ¡è®°å½•ã€‚\nProcessor æ˜¯å¤„ç†å™¨ã€‚ è¿™é‡Œé¢ç›´æ¥ä¼ é€’äº†ä¸€ä¸ª PassThroughItemProcessor ï¼Œè¿™ä¸ªç±»çš„ä½œç”¨æ˜¯å¯¹ä¼ é€’è¿‡æ¥çš„å¯¹è±¡ä¸åšä»»ä½•çš„å¤„ç†ã€‚å¦‚æœæˆ‘ä»¬æƒ³å¯¹åŸæœ‰çš„è®°å½•è¿›è¡Œæ‰©å±•ï¼Œé‚£ä¹ˆå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªå¤„ç†å™¨ï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 @Component public class PayRecordExtProcessor implements ItemProcessor\u003cPayRecord,PayRecordExt\u003e { @Override public PayRecordExt process(PayRecord payRecord) throws Exception { //other service PayRecordExt ext = new PayRecordExt(); return ext; } } åœ¨è¿™é‡Œè¿›è¡Œæ•°æ®å¤„ç†ã€‚\ntaskExecutor è¿™ä¸ªæ˜¯çº¿ç¨‹æ± çš„é…ç½®ã€‚å› ä¸ºæ¯æ¡è®°å½•çš„è¯»å–ã€å¤„ç†ã€å†™å…¥éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œäº’ç›¸ä¹‹é—´æ²¡æœ‰ä»»ä½•çš„å½±å“ï¼Œæ‰€ä»¥ä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥å®ç°æµç¨‹çš„å¹¶è¡Œå¤„ç†ï¼Œæé«˜å¤„ç†é€Ÿåº¦ã€‚throttleLimit ç”¨æ¥æ§åˆ¶æœ€å¤§çš„çº¿ç¨‹æ•°ã€‚çº¿ç¨‹å¤ªå¤šäº†ä¼šé€ æˆèµ„æºçš„æµªè´¹ã€‚\n6. Job çš„é…ç½®\n1 2 3 4 5 6 7 @Bean public Job migratePayRecordJob(@Qualifier(\"migratePayRecordStep\") Step step) { return this.jobBuilderFactory.get(\"migratePayRecordJob\") .start(step) .incrementer(new RunIdIncrementer()) .build(); } Job ç”¨äºå°† step é…ç½®å¥½çš„æµç¨‹å‘å¤–ä»¥ä»»åŠ¡çš„å½¢å¼æš´éœ²ã€‚\n7. å¦‚ä½•å¯åŠ¨ Job\né»˜è®¤æƒ…å†µä¸‹ Spring Batch ä¼šè‡ªåŠ¨å¯åŠ¨ä»»åŠ¡ï¼Œä¸Šé¢æåˆ°äº†ï¼Œåœ¨çº¿ä¸Šæ—¶ä¸€å®šä¸è¦è‡ªåŠ¨å¯åŠ¨ä»»åŠ¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 @Component @Slf4j public class PayRecordTask { @Autowired private Job migratePayRecordJob; @Autowired private JobLauncher jobLauncher; @Autowired @Qualifier(\"primaryTemplate\") private JdbcTemplate primaryJdbcTemplate; /** *è¿ç§»ä»»åŠ¡ * @throws Exception */ @Scheduled(cron = \"0 0 2 * * ?\") public void migratePayRecord() throws Exception { Map\u003cString, Object\u003e result = primaryJdbcTemplate .queryForMap(\"select * from job_config where config_key = ?\", MigrateConstants.PAY_RECORD_JOB_CONFIG_KEY); String value = (String) result.get(\"config_value\"); JobExecuteConfig payRecordJobConfig = JSON.parseObject(value, JobExecuteConfig.class); JobParameters params = new JobParametersBuilder() .addLong(\"maxId\", payRecordJobConfig.getExecuteMaxId()) .addLong(\"minId\", payRecordJobConfig.getMinId()) .toJobParameters(); jobLauncher.run(migratePayRecordJob, params); } /** * * æ‰§è¡Œè¿ç§»ä»»åŠ¡ä¹‹å‰æ•°æ®è¿ç§»é…ç½®åˆå§‹åŒ– * å‡Œæ™¨ä¸€ç‚¹ */ @Scheduled(cron = \"0 0 1 * * ?\") public void initBillMigrateConfig() { //TODO æ ¹æ®å®é™…éœ€è¦çš„ä¸šåŠ¡é€»è¾‘åŠ¨æ€è®¡ç®—å‡ºï¼Œæ¯æ¬¡è¦è¿ç§»çš„æ•°æ®æ˜¯å“ªäº› ï¼Œæœ€å¥½æ ¹æ®æ—¶é—´ç®—å‡ºMaxId, ç„¶åæ¯å¤©æ‰§è¡Œå›ºå®šçš„æ­¥é•¿ ï¼Œæ¯”å¦‚æ¯å¤©è¿ç§»100ä¸‡ } } å½“åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ @EnableBatchProcessing ä¹‹åï¼ŒSpring Batch ä¼šåœ¨å®¹å™¨ä¸­è‡ªåŠ¨æ³¨å…¥ Spring Batch çš„ç»„ä»¶ï¼Œè¿™é‡Œé¢æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ JobLauncher è¿›è¡Œä»»åŠ¡çš„å¯åŠ¨ï¼Œåœ¨å¯åŠ¨æ—¶å¯ä»¥é…ç½®ä»»åŠ¡å¯åŠ¨çš„å‚æ•°ã€‚\n1 2 3 4 JobParameters params = new JobParametersBuilder() .addLong(\"maxId\", payRecordJobConfig.getExecuteMaxId()) .addLong(\"minId\", payRecordJobConfig.getMinId()) .toJobParameters(); è¿™ä¼ é€’çš„å‚æ•°ï¼Œé€šè¿‡ @StepScope æ³¨è§£çš„ Bean å°±å¯ä»¥åŠ¨æ€è·å–è¿™ä¸ªå‚æ•°ã€‚\n8. Job å¦‚ä½•å¯åŠ¨ã€åœæ­¢ã€é‡å¯\nJob çš„å¦ä¸€ç§å¯åŠ¨å’Œåœæ­¢æ˜¯é€šè¿‡ç±» JobOperator è¿™ä¸ªç±»æ¥å®ç°çš„ï¼Œåœ¨å¯åŠ¨å’Œé‡å¯ä¹‹å‰è¦å°† Job æ³¨å†Œåˆ° JobRegistry ä¸­ï¼Œåœ¨ JobController ä¸­å¯ä»¥çœ‹åˆ°å…·ä½“çš„å®ç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Autowired private JobRegistry registry; @PostConstruct public void registry() throws DuplicateJobException { ReferenceJobFactory factory = new ReferenceJobFactory(migratePayRecordJob); registry.register(factory); } @PostMapping(value = \"startJob\") @SneakyThrows public ResponseEntity\u003cString\u003e startJob() { Properties properties = new Properties(); properties.put(\"minId\", \"20\"); properties.put(\"maxId\", \"50\"); executePayRecordId = jobOperator.start(\"migratePayRecordJob\", PropertiesConverter.propertiesToString(properties)); return ResponseEntity.ok(\"æ“ä½œæˆåŠŸ\"); } @PostMapping(value = \"stopJob\") @SneakyThrows public ResponseEntity\u003cString\u003e stopJob() { Assert.notNull(executePayRecordId,\"æ‰§è¡Œidä¸èƒ½ä¸ºç©ºï¼\"); jobOperator.stop(executePayRecordId); return ResponseEntity.ok(\"æ“ä½œæˆåŠŸ\"); } @PostMapping(value = \"restartJob\") @SneakyThrows public ResponseEntity\u003cString\u003e restartJob(){ Assert.notNull(executePayRecordId,\"æ‰§è¡Œidä¸èƒ½ä¸ºç©ºï¼\"); jobOperator.restart(executePayRecordId); return ResponseEntity.ok(\"æ“ä½œæˆåŠŸ\"); } è¿™ä¸ªç±»çš„æ–¹æ³•éå¸¸çš„ä¸°å¯Œï¼Œé™¤äº†èƒ½å¯åŠ¨æ‰§è¡Œå¤–è¿˜æœ‰å¤§é‡çš„ APIï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 List\u003cLong\u003e getExecutions(long var1) throws NoSuchJobInstanceException; List\u003cLong\u003e getJobInstances(String var1, int var2, int var3) throws NoSuchJobException; Set\u003cLong\u003e getRunningExecutions(String var1) throws NoSuchJobException; String getParameters(long var1) throws NoSuchJobExecutionException; Long start(String var1, String var2) throws NoSuchJobException, JobInstanceAlreadyExistsException, JobParametersInvalidException; Long restart(long var1) throws JobInstanceAlreadyCompleteException, NoSuchJobExecutionException, NoSuchJobException, JobRestartException, JobParametersInvalidException; Long startNextInstance(String var1) throws NoSuchJobException, JobParametersNotFoundException, JobRestartException, JobExecutionAlreadyRunningException, JobInstanceAlreadyCompleteException, UnexpectedJobExecutionException, JobParametersInvalidException; boolean stop(long var1) throws NoSuchJobExecutionException, JobExecutionNotRunningException; String getSummary(long var1) throws NoSuchJobExecutionException; Map\u003cLong, String\u003e getStepExecutionSummaries(long var1) throws NoSuchJobExecutionException; Set\u003cString\u003e getJobNames(); JobExecution abandon(long var1) throws NoSuchJobExecutionException, JobExecutionAlreadyRunningException; åœ¨ Spring Batch çš„ Admin ç®¡ç†ç³»ç»Ÿä¸­ä¸»è¦å°±æ˜¯é€šè¿‡è¿™ä¸ªç±»æ¥è·å–ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µã€‚\n9. æ€»ç»“\né€šè¿‡ä¸Šé¢çš„æ¼”ç¤ºå¯ä»¥æ¸…æ¥šçš„çœ‹åˆ° Spring Batch çš„æ‰§è¡Œé€»è¾‘ï¼ŒSpring Batch å®šä¹‰äº†æ¨¡æ¿ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­åªéœ€è¦æŒ‰ç…§æ¥å£æä¾›ç›¸åº”çš„æ•°æ®æ¥æºå’Œè¾“å‡ºçš„æ¥å£å³å¯ã€‚å…¶ä»–çš„äº‹åŠ¡å¤„ç†ï¼Œå¤šçº¿ç¨‹æ± ï¼Œæ‰¹é‡å¤„ç†ï¼Œå†…å­˜æ§åˆ¶éƒ½ç”±æ¡†æ¶æ¥å®Œæˆã€‚é‚£ä¹ˆ Spring Batch æ˜¯æ€ä¹ˆæ ·ä¿è¯åœ¨å¤§æ•°æ®é‡çº§çš„æƒ…å†µä¸‹ï¼Œå†…å­˜ä¸æº¢å‡ºç„¶ååˆä¿è¯æ€§èƒ½çš„å‘¢ï¼Œä¸‹é¢ç”¨ä¸€å¼ å›¾è¿›è¡Œå±•ç¤º Spring Batch æ˜¯é€šè¿‡æ€ä¹ˆçš„å¤„ç†ï¼Œä¿è¯åœ¨æ•°æ®é‡å·¨å¤§çš„æƒ…å†µä¸‹ï¼Œé«˜æ€§èƒ½çš„è¿›è¡Œæ•°æ®çš„è¯»å†™çš„ã€‚\nå…¶ä»–ä¸šåŠ¡åœºæ™¯çš„æ‰©å±• åœ¨å®é™…ä¸­é¡¹ç›®å¤„ç†ä¸­ï¼Œæˆ‘ä»¬é¢å¯¹çš„ç³»ç»Ÿæƒ…å†µå¯èƒ½å¹¶ä¸æ˜¯ä¸€ä¸ªå•è¡¨è¿™æ ·ç®€å•çš„ä¸šåŠ¡æƒ…å†µï¼Œæ¯”å¦‚å¤šè¡¨åˆä¸€ã€ä¸€è¡¨åˆ†è¡¨ä¸ºå¤šè¡¨ï¼Œåœ¨è¿ç§»è¿‡ç¨‹ä¸­æ•°æ®å˜æ›´çš„æƒ…å½¢ã€‚é‚£ä¹ˆè¿™äº›åœºæ™¯è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ\n1. å¤šè¡¨åˆä¸€çš„åœºæ™¯\nåœ¨å¤šè¡¨åˆä¸€çš„åœºæ™¯ä¸‹ï¼Œå®é™…ä¸Šå¦‚ä½•ä¸¤å¼ è¡¨æœ‰å…³è”ï¼Œé‚£ä¹ˆé™„è¡¨ä¸Šä¸€å®šè¦å»ºç«‹ç´¢å¼•ã€‚æˆ‘ä»¬è¿˜æ˜¯ä¼šè®©æŸ¥è¯¢é€»è¾‘åœ¨ä¸»è¡¨ä¸Šï¼Œåƒä¸‡ä¸è¦ä½¿ç”¨ Join è”æŸ¥ï¼Œäº¿çº§åˆ«çš„æ•°æ®å¦‚ä½•è”æŸ¥ï¼Œé‚£ä¹ˆåŸºç¡€ç³»ç»Ÿå°±è¦å´©æºƒäº†ã€‚æ­¤æ—¶æˆ‘ä»¬éœ€è¦å°†éœ€è¦æ‹¼è£…çš„ä¸šåŠ¡é€»è¾‘æ”¾åœ¨ Processor é‡Œé¢ï¼Œæ¯”å¦‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹åœºæ™¯ä¸‹ï¼Œéœ€è¦å°† User çš„ä¿¡æ¯å†—ä½™åˆ°æ–°çš„ä¸€ä¸ªè¡¨ä¸­é‚£ä¹ˆåªéœ€è¦å°† UserService æ³¨å…¥åˆ° PayRecordExtProcessor ä¸­ï¼Œç„¶åå†é€šè¿‡ userService.getId(payRecord.getUserId ()) è¿™ç§æ–¹å¼å» load ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·çš„ Id è‚¯å®šæœ‰ç´¢å¼•ï¼Œè¿™æ ·æŸ¥è¯¢æ€§èƒ½ä¸ä¼šæœ‰å¤ªå¤šçš„æŸè€—ã€‚è¿™ä¹Ÿæ˜¯ç°åœ¨å¤§å‚ä¸ºå•¥è¦æ±‚åœ¨ä¸šåŠ¡ç³»ç»Ÿå¼€å‘çš„è¿‡ç¨‹ä¸­å°½å¿«ä¸è¦ä½¿ç”¨ Join è”æŸ¥çš„åŸå› ã€‚\n1 2 3 4 5 6 7 8 9 10 @Component public class PayRecordExtProcessor implements ItemProcessor\u003cPayRecord,PayRecordExt\u003e { @Override public PayRecordExt process(PayRecord payRecord) throws Exception { //æ­¤å¤„æ³¨å…¥ User service é€šè¿‡userService .getId(payRecord.getUserId()); PayRecordExt ext = new PayRecordExt(); return ext; } } 2. æ‹†åˆ†ä¸ºå¤šè¡¨çš„åœºæ™¯\nç³»ç»Ÿæœ‰äº›æƒ…å†µä¸‹éœ€è¦å°†å•è¡¨æ‹†åˆ†ä¸ºå¤šè¡¨ï¼Œæ¯”å¦‚æ ¹æ®ç”¨æˆ· id åˆ†ç‰‡ï¼Œè¿™ç§æƒ…å†µä¸‹ Spring Batch æä¾›äº†ä¸€ä¸ªç±» ClassifierCompositeItemWriter å¯ä»¥æ ¹æ®æ¡ä»¶åŠ¨æ€é€‰æ‹© Writerï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿå°† pay_record è¿™ä¸ªè¡¨æ‹†åˆ†ä¸ºä¸¤ä¸ªè¡¨çš„åœºæ™¯ pay_record_1ã€pay_record2ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 create TABLE pay_record_1 like pay_record; create TABLE pay_record_2 like pay_record; //æ ¹æ®æ¡ä»¶æ‹†åˆ†ä¸ºå¤šè¡¨ @Bean public ClassifierCompositeItemWriter\u003c? super PayRecord\u003e classifierItemWriter(@Qualifier(\"payRecordOneWriter\") ItemWriter payRecordOneWriter,@Qualifier(\"payRecordTwoWriter\") ItemWriter payRecordTwoWriter){ ClassifierCompositeItemWriter\u003cPayRecord\u003e classifierCompositeItemWriter = new ClassifierCompositeItemWriter\u003c\u003e(); classifierCompositeItemWriter.setClassifier( (Classifier\u003cPayRecord, ItemWriter\u003c? super PayRecord\u003e\u003e) record -\u003e { ItemWriter\u003c? super PayRecord\u003e itemWriter; if(record.getId() %2 ==0 ){ itemWriter = payRecordOneWriter; }else { itemWriter = payRecordTwoWriter; } return itemWriter; }); return classifierCompositeItemWriter; } @Bean public Step splitPayRecordStep(@Qualifier(\"payRecordReader\") JdbcPagingItemReader\u003cPayRecord\u003e payRecordReader, @Qualifier(value = \"classifierItemWriter\") ClassifierCompositeItemWriter itemWriter) { return this.stepBuilderFactory.get(\"splitPayRecordStep\") .\u003cPayRecord, PayRecord\u003echunk(config.getChunkSize()) .reader(payRecordReader) .processor(new PassThroughItemProcessor()) .writer(itemWriter) .taskExecutor(new SimpleAsyncTaskExecutor(\"migrate_thread\")) .throttleLimit(config.getThreadSize()) .build(); } @Bean public Job splitPayRecordJob(@Qualifier(\"splitPayRecordStep\") Step step) { return this.jobBuilderFactory.get(\"splitPayRecordJob\") .start(step) .incrementer(new RunIdIncrementer()) .build(); } åœ¨è¿™é‡Œé¢æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª ClassifierCompositeItemWriter æ ¹æ® Id % è¡¨ä¸ªæ•°è¿›è¡Œåˆ†ç‰‡ã€‚å…·ä½“çš„å®ç°å¯ä»¥çœ‹ä»£ç ã€‚\n3. è¿ç§»è¿‡ç¨‹ä¸­æ•°æ®æœ‰å˜æ›´å’Œå¢é‡çš„åœºæ™¯\nä¸€èˆ¬æ¥è¯´æœ‰å•è¡¨æ€§èƒ½çš„è¡¨æ•°æ®ï¼Œéƒ½æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œéšç€æ—¶é—´çš„è¿ç§»ä¼šæœ‰å¤§é‡çš„å†·æ•°æ®ï¼Œä¸Šåƒä¸‡é¢‘ç¹å˜æ›´çš„åœºæ™¯è¿˜æ˜¯æ¯”è¾ƒå°‘çš„ã€‚å¦‚æœæƒ³ä¿è¯ç³»ç»Ÿä¸é—´æ–­è¿è¡Œï¼ŒåŒæ—¶åˆèƒ½è¿›è¡Œç³»ç»Ÿçš„è¿ç§»ï¼Œè¿ç§»å®Œæˆåå†è¿›è¡Œç”¨æˆ·æ— æ„ŸçŸ¥çš„åˆ‡æ¢ã€‚éœ€è¦è€ƒè™‘åˆ°è¿ç§»è¿‡ç¨‹ä¸­æœ‰å¢é‡å˜æ›´çš„æƒ…å†µã€‚è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä¸€èˆ¬å¼•å…¥ CDC (change data capture) ç»„ä»¶ã€‚æ¯”è¾ƒå¸¸ç”¨çš„å¦‚é˜¿é‡Œçš„ Canalã€Debeziumï¼Œè¿™ç§ä¸­é—´ä»¶ç›‘å¬æ•°æ®çš„å˜æ›´ã€‚å…³äºå®ƒä»¬çš„ä½¿ç”¨å¯ä»¥å»çœ‹å®˜æ–¹çš„æ–‡æ¡£ï¼Œéå¸¸çš„ç®€å•ï¼Œæ·»åŠ å¥½é…ç½®é¡¹å°±å¯ä»¥äº†ã€‚\né…ç½®å¥½åå°†å˜æ›´çš„æ•°æ®å†å¯¼å…¥çš„æ–°çš„æ•°æ®æºã€‚åˆ‡æ¢åå®Œæˆå†é€šè¿‡ Spring Batch è¿›è¡Œæ¯”å¯¹è¿ç§»çš„æ•°æ®å’Œå˜åŒ–æ•°æ®å°±å¯ä»¥äº†ã€‚å¦‚æœå˜åŒ–çš„é‡çº§ç‰¹åˆ«å¤§ï¼Œæœ€å¥½é€‰ç”¨ååŠå¤œï¼Œæ•°æ®å˜æ›´è¾ƒå°çš„æƒ…å†µä¸‹è¿›è¡Œæ•°æ®è¿ç§»ã€‚å› ä¸ºäº¿çº§åˆ«çš„æ•°æ®å®æ—¶åŒæ­¥è¿™ä¸ªæ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰¾ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆå³å¯ã€‚\nå¦‚ä½•æ§åˆ¶éƒ¨ç½²çš„å®ä¾‹ä¸åŒæ—¶è¿è¡Œ ä¸ºäº†ä¿è¯æœåŠ¡çš„å¯é æ€§ï¼Œé€šå¸¸æˆ‘ä»¬éƒ¨ç½²çš„è¿ç§»æœåŠ¡å®ä¾‹æ˜¯å¤šä¸ªçš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯æ•°æ®ä¸èƒ½è¿ç§»é‡å¤ã€‚åœ¨ Spring Batch é‡Œé¢ Job çš„æ¦‚å¿µç›¸å½“äºä»»åŠ¡ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µå« JobInstanceã€‚\nä»€ä¹ˆæ„æ€å‘¢ï¼Œä¸Šé¢æåˆ° Step ç›¸å½“äºé…ç½®çš„æµç¨‹ï¼ŒJob æ˜¯ä»»åŠ¡ï¼Œé‚£ä¹ˆä»»åŠ¡æ˜¯å¯èƒ½æœ‰å¤šä¸ªçš„ï¼Œå°±åƒä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥ new å‡ºæ¥å¤šä¸ªå¯¹è±¡ä¸€æ ·ã€‚ä¸€ä¸ª JonInstance åœ¨ç›¸åŒçš„ JobParameter ä¸‹åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚è¿™æ ·åœ¨å¤šå®ä¾‹çš„æƒ…å†µä¸‹ï¼Œå®é™…ä¸Šéƒ¨ç½²å¤šå°å®ä¾‹ä¹Ÿèƒ½æ§åˆ¶ä»»åŠ¡ä¸ä¼šé‡å¤æ‰§è¡Œï¼Œåªä¸è¿‡ä¼šæŠ¥ä¸€ä¸ªä»»åŠ¡å·²ç»å­˜åœ¨çš„å¼‚å¸¸ã€‚ä½†æ˜¯åœ¨å®é™…çš„é¡¹ç›®è¿ç§»ä¸­æˆ‘ä»¬å¸Œæœ› Job çš„å‚æ•°å¯ä»¥æ¯å¤©åŠ¨æ€è®¡ç®—ï¼Œæ¯”å¦‚åœ¨ä»»åŠ¡ä¹‹å‰æˆ‘ä»¬éœ€è¦åŠ¨æ€çš„è®¡ç®—å‡ºï¼Œä»Šå¤©çš„ä»»åŠ¡è¦è¿ç§»å“ªäº›æ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 /** * * æ‰§è¡Œè¿ç§»ä»»åŠ¡ä¹‹å‰æ•°æ®è¿ç§»é…ç½®åˆå§‹åŒ– * å‡Œæ™¨ä¸€ç‚¹ */ @Scheduled(cron = \"0 0 1 * * ?\") public void initMigrateConfig() { //TODO æ ¹æ®å®é™…éœ€è¦çš„ä¸šåŠ¡é€»è¾‘åŠ¨æ€è®¡ç®—å‡ºï¼Œæ¯æ¬¡è¦è¿ç§»çš„æ•°æ®æ˜¯å“ªäº› ï¼Œæœ€å¥½æ ¹æ®æ—¶é—´ç®—å‡ºMaxId, ç„¶åæ¯å¤©æ‰§è¡Œå›ºå®šçš„æ­¥é•¿ ï¼Œæ¯”å¦‚æ¯å¤©è¿ç§»100ä¸‡ } åƒè¿™ç§ä»»åŠ¡å¦‚æœæ˜¯å¤šå°å®ä¾‹ï¼Œå¦‚æœä¸åŠ é”å®é™…ä¸Šä¼šæœ‰é—®é¢˜çš„ã€‚è¿™é‡Œé¢æˆ‘ä»¬å†å¼•å…¥ä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u003cdependency\u003e \u003cgroupId\u003enet.javacrumbs.shedlock\u003c/groupId\u003e \u003cartifactId\u003eshedlock-spring\u003c/artifactId\u003e \u003cversion\u003e4.1.0\u003c/version\u003e \u003c/dependency\u003e \u003cdependency\u003e \u003cgroupId\u003enet.javacrumbs.shedlock\u003c/groupId\u003e \u003cartifactId\u003eshedlock-provider-jdbc-template\u003c/artifactId\u003e \u003cversion\u003e4.0.4\u003c/version\u003e \u003c/dependency\u003e @Bean public LockProvider lockProvider(@Qualifier(value = \"primaryDatasource\") DataSource dataSource) { return new JdbcTemplateLockProvider(dataSource); } æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨ JdbcTemplateLock å½“åšæˆ‘ä»¬çš„åˆ†å¸ƒå¼é”çš„å®ç°ã€‚è¿™æ ·é…ç½®ä¹‹åæˆ‘ä»¬çš„ä»»åŠ¡åœ¨åŒä¸€æ—¶é—´å°±åªä¼šåœ¨ä¸€ä¸ªå®ä¾‹ä¸Šè¿è¡Œäº†ã€‚\nå“ªäº›ç‚¹å¯ä»¥ä¼˜åŒ– \\1. æ¯æ¬¡å¯ä»¥æ§åˆ¶è¯»å–çš„æ¡æ•°ï¼Œæ¯æ¬¡äº‹åŠ¡æäº¤çš„ä¸ªæ•°ï¼Œæ¯ä¸ª Step å¯ç”¨çš„çº¿ç¨‹æ•°éƒ½å¯ä»¥è¿›è¡Œé…ç½®ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­æä¾›äº†ä¸€ä¸ªé…ç½®ç±»ï¼Œå¯ä»¥å¯¹è¿™äº›é…ç½®é¡¹è¿›è¡ŒåŠ¨æ€çš„é…ç½®ã€‚\n1 2 3 4 5 6 7 8 9 @ConfigurationProperties(prefix = \"migrate.config\") @Data public class MigrateConfig { //æ¯æ¬¡è¯»å–æ•°æ®æ¡æ•° private Integer pageSize; //æ¯æ¬¡äº‹åŠ¡æäº¤è®°å½•æ•° private Integer chunkSize; private Integer threadSize; } \\2. åœ¨è¿ç§»ä¹‹å‰ MySQL è¦æŸ¥çœ‹è¿æ¥æƒ…å†µï¼Œè®¾ç½®ç¼“å†²æ± å¤§å°ç­‰æŒ‡æ ‡ï¼Œè¿™ä¸ªä¹Ÿæ˜¯åœ¨è¿ç§»ä¹‹å‰è¦è€ƒè™‘çš„ç‚¹ã€‚\n1 2 3 4 show processlist set global innodb_buffer_pool_size = ç¼“å†²æ± å¤§å° ; show variables like 'max_connections'; set global max_connections= æœ€å¤§è¿æ¥æ•°; \\3. åƒä¸Šé¢æåˆ°çš„ Spring Batch åœ¨è¿ç§»è¿‡ç¨‹ä¸­ä¼šå°†ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µéƒ½åˆå§‹åŒ–åˆ°æ•°æ®åº“ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¸æƒ³è¦è¿™äº›æ•°æ®æŒä¹…åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€‰æ‹©å†…å­˜æ•°æ®åº“ï¼Œè¿™ä¸ªä¼šå¤§å¤§æå‡è¿ç§»çš„é€Ÿåº¦ï¼Œæ›´æ”¹æ•°æ®æºå³å¯ã€‚\nSpring Cloud Data Flow å…¥é—¨ç®€ä»‹ Spring Cloud Data Flow è¿™ä¸ªæ˜¯ç°åœ¨ Spring åœ¨æ•°æ®æµå¤„ç†æ–¹é¢ä¸€ä¸ªåŠŸèƒ½éå¸¸å¼ºå¤§çš„æ¡†æ¶ã€‚ç›®å‰è¢« Spring æ”¾åœ¨äº†é¦–é¡µä¸Šï¼Œè·Ÿ Spring Cloud å¹¶åˆ—ã€‚åœ¨å•æœºæ¡ä»¶ä¸‹å¯¹ Spring Batch çš„æ”¯æŒæœ‰é™ï¼Œä¸æ”¯æŒä»»åŠ¡çš„åŠ¨æ€è°ƒåº¦ï¼Œæƒ³ä½¿ç”¨è°ƒåº¦éœ€è¦ K8s éƒ¨ç½²ï¼ŒSpring Cloud Data Flow åœ¨æœ¬æœºæ­å»ºæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯ç”¨ Dockerï¼Œä¸€ä¸ªæ˜¯ç›´æ¥å¯åŠ¨ jar åŒ…ã€‚å…·ä½“çš„ jar åŒ…æˆ‘æ”¾åœ¨äº†é¡¹ç›®çš„ resources ä¸‹é¢ã€‚\nå¦‚æœä½¿ç”¨ Dockerï¼Œcd åˆ° dataflow ç›®å½•ä¸‹è¿è¡Œã€‚\n1 2 3 4 5 export DATAFLOW_VERSION=2.2.1.RELEASE export SKIPPER_VERSION=2.1.2.RELEASE docker-compose up å¦‚æœä¸ä½¿ç”¨ Docker è€Œé€‰æ‹©ç›´æ¥è¿è¡Œ jar åŒ…ï¼š\n1 2 3 java -jar spring-cloud-skipper-server-2.1.2.RELEASE.jar java -jar spring-cloud-dataflow-server-2.2.1.RELEASE.jar æ‰“å¼€æµè§ˆå™¨ è¾“å…¥ http://localhost:9393/dashboard/ å³å¯è®¿é—®æ§åˆ¶å°ã€‚\næ³¨æ„ä¸€ç‚¹ï¼šå¦‚æœéœ€è¦ä½¿ç”¨ Spring Batch Job éœ€è¦é›†æˆ Spring Cloud Taskï¼Œå®é™…çš„é¡¹ç›®ä¸­ä½¿ç”¨ JobOperator å³å¯ï¼Œè¿™ä¸ª UI ä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸ªç±»è¿›è¡Œ UI å±•ç¤ºçš„ã€‚å¦‚æœå¯¹è¿™ä¸ªæ„Ÿå…´è¶£çš„å¯ä»¥å»æ¢ç´¢ã€‚\nåœ¨å®é™…çš„è¿ç§»è¿‡ç¨‹ä¸­å¯ä»¥æŸ¥è¯¢åœ¨é¡¹ç›®å¯åŠ¨æ—¶åˆå§‹åŒ–é‚£å‡ å¼ è¡¨ï¼ŒSpring Batch ä¼šæŠŠæ¯æ¬¡æ‰§è¡Œçš„å‚æ•°å’Œæ‰§è¡Œæƒ…å†µå…¨éƒ¨åˆå§‹åŒ–åˆ°æ•°æ®åº“è¡¨ä¸­ä»¥ BATCH_å¼€å¤´çš„è¡¨ä¸­ã€‚\né¡¹ç›®ä»£ç åœ°å€ https://gitee.com/smartGim/batchsrv\nè¯¥é¡¹ç›®æ˜¯ Spring Boot é¡¹ç›®ï¼Œæ‰“å¼€ application-dev.yml ä¸­æŒ‰ç…§è¦æ±‚åˆ›å»ºè‡ªå·±çš„æ•°æ®åº“ï¼Œdb æ–‡ä»¶åœ¨ resources/db æ–‡ä»¶ä¸‹ï¼Œsource_db å¼€å¤´çš„åˆå§‹åŒ–åˆ° source æ•°æ®åº“ä¸­ï¼Œtarget_db å¼€å¤´çš„åˆå§‹åŒ–åˆ° target æ•°æ®åº“ä¸­å³å¯ã€‚\nå®æˆ˜ä»£ç å¹¶éç†è®ºçš„è®²è§£ï¼Œæ‰€ä»¥è¯·åŠ¡å¿…æŸ¥çœ‹æºç è¿›è¡Œç»ƒä¹ ã€‚\nå¦‚ä½•è¿›è¡Œæµ‹è¯•ï¼Œåœ¨ jobconfig è¡¨ä¸­æ›´æ”¹ minId å’Œ maxIdï¼Œè¿™ä¸ªæ˜¯æ§åˆ¶è¦è¿ç§»å“ªäº›æ•°æ®çš„ï¼Œä½ ä¹Ÿå¯ä»¥å†™ä¸ªè‡ªåŠ¨åŒ–çš„ä»»åŠ¡å»æ¯å¤©åŠ¨æ€æ›´æ–°è¿™ä¸ªé…ç½®é¡¹ã€‚\nåœ¨ web åŒ…ä¸‹æœ‰ JobController æ˜¯å‰ç«¯çš„å…¥å£ï¼Œç”¨äºæœ¬åœ°çš„æµ‹è¯•ï¼Œå¯ä»¥é€šè¿‡ Postman ç­‰å·¥å…·ç›´æ¥å‘é€è¯·æ±‚å³å¯ã€‚\nå¦‚æœåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­æœ‰ä»»ä½•é—®é¢˜å¯ä»¥æ Issueã€‚\nå…¶ä»–å­¦ä¹ çš„èµ„æº ä¸€ä¸ªä¸é”™çš„ç¤ºä¾‹é¡¹ç›®ï¼š\nhttps://github.com/pkainulainen/spring-batch-examples.git\nå¦‚æœæƒ³å†™å…¥åˆ° Excelï¼ŒSpring Batch ä¹Ÿæ”¯æŒ Excelï¼ŒES çš„æ‰©å±•ï¼š\nhttps://github.com/spring-projects/spring-batch-extensions.git\nå®˜æ–¹çš„ Samplesï¼š\nhttps://github.com/spring-projects/spring-batch.git\n",
  "wordCount" : "6945",
  "inLanguage": "zh",
  "datePublished": "2022-08-23T15:36:53+08:00",
  "dateModified": "2022-11-29T15:36:53+08:00",
  "author":[{
    "@type": "Person",
    "name": "å¶ç°ç°"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://habyss.github.io/posts/read/mysql%E4%BA%BF%E7%BA%A7%E5%88%AB%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "å¶ç°ç°çš„å°çª",
    "logo": {
      "@type": "ImageObject",
      "url": "https://habyss.github.io/gif/hwlm.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://habyss.github.io/" accesskey="h" title="å¶ç°ç°çš„å°çª (Alt + H)">å¶ç°ç°çš„å°çª</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://habyss.github.io/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/archives" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://habyss.github.io/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://habyss.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://habyss.github.io/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="https://habyss.github.io/posts/read/">ğŸ“•é˜…è¯»</a></div>
    <h1 class="post-title">
      MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº«
    </h1>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#mysql-%e4%ba%bf%e7%ba%a7%e5%88%ab%e6%95%b0%e6%8d%ae%e8%bf%81%e7%a7%bb%e5%ae%9e%e6%88%98%e4%bb%a3%e7%a0%81%e5%88%86%e4%ba%ab" aria-label="MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº«">MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº«</a><ul>
                        <ul>
                        
                <li>
                    <a href="#x%e4%b8%9a%e5%8a%a1%e8%83%8c%e6%99%af" aria-label="xä¸šåŠ¡èƒŒæ™¯">xä¸šåŠ¡èƒŒæ™¯</a></li>
                <li>
                    <a href="#spring-batch-%e6%a0%b8%e5%bf%83%e5%8a%9f%e8%83%bd%e7%9a%84%e4%bb%8b%e7%bb%8d" aria-label="Spring Batch æ ¸å¿ƒåŠŸèƒ½çš„ä»‹ç»">Spring Batch æ ¸å¿ƒåŠŸèƒ½çš„ä»‹ç»</a><ul>
                        
                <li>
                    <a href="#%e6%a0%b8%e5%bf%83%e7%9a%84%e5%8a%9f%e8%83%bd%e5%92%8c%e7%89%b9%e7%82%b9" aria-label="æ ¸å¿ƒçš„åŠŸèƒ½å’Œç‰¹ç‚¹">æ ¸å¿ƒçš„åŠŸèƒ½å’Œç‰¹ç‚¹</a></li>
                <li>
                    <a href="#%e6%9e%b6%e6%9e%84%e5%9b%be" aria-label="æ¶æ„å›¾">æ¶æ„å›¾</a></li>
                <li>
                    <a href="#%e6%a0%b8%e5%bf%83%e7%bb%84%e4%bb%b6" aria-label="æ ¸å¿ƒç»„ä»¶">æ ¸å¿ƒç»„ä»¶</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e9%99%85%e4%b8%ad%e7%9a%84%e4%b8%9a%e5%8a%a1%e9%9c%80%e6%b1%82%e6%80%8e%e4%b9%88%e5%ae%9e%e7%8e%b0" aria-label="å®é™…ä¸­çš„ä¸šåŠ¡éœ€æ±‚æ€ä¹ˆå®ç°">å®é™…ä¸­çš„ä¸šåŠ¡éœ€æ±‚æ€ä¹ˆå®ç°</a><ul>
                        
                <li>
                    <a href="#%e5%85%88%e4%bb%8e%e5%8d%95%e8%a1%a8%e6%95%b0%e6%8d%ae%e5%a4%87%e4%bb%bd%e5%bf%ab%e9%80%9f%e4%ba%86%e8%a7%a3%e8%bf%81%e7%a7%bb%e6%b5%81%e7%a8%8b" aria-label="å…ˆä»å•è¡¨æ•°æ®å¤‡ä»½å¿«é€Ÿäº†è§£è¿ç§»æµç¨‹">å…ˆä»å•è¡¨æ•°æ®å¤‡ä»½å¿«é€Ÿäº†è§£è¿ç§»æµç¨‹</a></li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e4%b8%9a%e5%8a%a1%e5%9c%ba%e6%99%af%e7%9a%84%e6%89%a9%e5%b1%95" aria-label="å…¶ä»–ä¸šåŠ¡åœºæ™¯çš„æ‰©å±•">å…¶ä»–ä¸šåŠ¡åœºæ™¯çš„æ‰©å±•</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e6%8e%a7%e5%88%b6%e9%83%a8%e7%bd%b2%e7%9a%84%e5%ae%9e%e4%be%8b%e4%b8%8d%e5%90%8c%e6%97%b6%e8%bf%90%e8%a1%8c" aria-label="å¦‚ä½•æ§åˆ¶éƒ¨ç½²çš„å®ä¾‹ä¸åŒæ—¶è¿è¡Œ">å¦‚ä½•æ§åˆ¶éƒ¨ç½²çš„å®ä¾‹ä¸åŒæ—¶è¿è¡Œ</a></li>
                <li>
                    <a href="#%e5%93%aa%e4%ba%9b%e7%82%b9%e5%8f%af%e4%bb%a5%e4%bc%98%e5%8c%96" aria-label="å“ªäº›ç‚¹å¯ä»¥ä¼˜åŒ–">å“ªäº›ç‚¹å¯ä»¥ä¼˜åŒ–</a></li></ul>
                </li>
                <li>
                    <a href="#spring-cloud-data-flow-%e5%85%a5%e9%97%a8%e7%ae%80%e4%bb%8b" aria-label="Spring Cloud Data Flow å…¥é—¨ç®€ä»‹">Spring Cloud Data Flow å…¥é—¨ç®€ä»‹</a></li>
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae%e4%bb%a3%e7%a0%81%e5%9c%b0%e5%9d%80" aria-label="é¡¹ç›®ä»£ç åœ°å€">é¡¹ç›®ä»£ç åœ°å€</a></li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e5%ad%a6%e4%b9%a0%e7%9a%84%e8%b5%84%e6%ba%90" aria-label="å…¶ä»–å­¦ä¹ çš„èµ„æº">å…¶ä»–å­¦ä¹ çš„èµ„æº</a>
                </li>
            </ul>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="mysql-äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº«">MySQL äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº«<a hidden class="anchor" aria-hidden="true" href="#mysql-äº¿çº§åˆ«æ•°æ®è¿ç§»å®æˆ˜ä»£ç åˆ†äº«">#</a></h1>
<h3 id="xä¸šåŠ¡èƒŒæ™¯">xä¸šåŠ¡èƒŒæ™¯<a hidden class="anchor" aria-hidden="true" href="#xä¸šåŠ¡èƒŒæ™¯">#</a></h3>
<p>æŸä¸€é¡¹æŠ€æœ¯çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³é—®é¢˜çš„ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥è¦å­¦ä¹ æŸä¸ªæŠ€æœ¯ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªæŠ€æœ¯è§£å†³äº†æˆ‘ä»¬å·¥ä½œä¸­é‡åˆ°çš„ç—›ç‚¹ã€‚ä¸Šäº¿æ¡æ•°æ®åœ¨ MySQL ä¸­æœ‰ç´¢å¼•çš„æ¡ä»¶ä¸‹ï¼Œå®é™…ä¸Šåªæ˜¯æŸ¥è¯¢æ˜¯æ²¡æœ‰å¤ªå¤§é—®é¢˜çš„ï¼Œåœ¨æ²¡æœ‰ç‰¹åˆ«å¤§çš„å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œåªæ˜¯æ’å…¥ç‰¹åˆ«æ…¢ã€‚</p>
<p>åœ¨è¿ç§»å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹é¢ä¸´çš„é—®é¢˜ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li>æ€ä¹ˆä¿è¯æŸ¥è¯¢å¤§æ•°æ®é‡ä¸‹æ²¡æœ‰æ€§èƒ½çš„ç“¶é¢ˆã€‚</li>
<li>ä¸èƒ½å½±å“æ­£å¸¸çš„ä¸šåŠ¡æŸ¥è¯¢ï¼Œä¸è¦æœ‰å¤ªå¤šçš„æ€§èƒ½æŸè€—ï¼Œå¯ä»¥çµæ´»æ§åˆ¶è¿ç§»çš„å¯åŠ¨ä¸åœæ­¢ã€‚</li>
<li>å®é™…çš„è¿ç§»å‚æ•°å¯ä»¥åŠ¨æ€çš„æ‰©å±•ï¼Œæ¯”å¦‚ä¸€æ¬¡æ‰¹é‡æäº¤å¤šå°‘æ¡æ•°æ®ï¼Œä¸€æ¬¡è¿ç§»å¤šå°‘ï¼Œè¿ç§»è¿‡ç¨‹ä¸­æ€ä¹ˆè½¬åŒ–æ•°æ®ã€‚</li>
<li>å¯¹äºä¸€äº›é”™è¯¯å¯ä»¥å®¹å¿çš„è¯æ€ä¹ˆè·³è¿‡å¼‚å¸¸ï¼Œæ¯”å¦‚å¯ä»¥å®¹å¿å‡ æ¡æ•°æ®çš„å¤±è´¥ã€‚</li>
<li>æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„æµ‹è¯•å®é™…ä¸€èˆ¬å¾ˆéš¾è¾¾åˆ°ç™¾åˆ†ç™¾ä¸€è‡´ï¼Œå¦‚ä½•åœ¨çº¿ä¸Šå¯¹è¿ç§»çš„æ€§èƒ½è¿›è¡Œå¯é…ç½®çš„æ§åˆ¶ã€‚</li>
<li>äº‹åŠ¡çš„æäº¤é—®é¢˜ï¼Œå› ä¸ºæ•°æ®é‡è¿‡å¤§ï¼Œä¸èƒ½å°†æ‰€æœ‰æ•°æ®æŸ¥è¯¢åˆ°å†…å­˜ä¹‹ä¸­ï¼Œæ•°æ®å¦‚ä½•åˆ†è€Œæ²»ä¹‹ã€‚</li>
<li>è¿ç§»çš„è¿‡ç¨‹éœ€è¦è®°å½•ï¼Œæ¯”å¦‚æ¯æ¬¡çš„ä»»åŠ¡æ‰§è¡Œçš„å¤šé•¿æ—¶é—´ï¼Œäº‹åŠ¡æäº¤äº†å¤šå°‘æ¬¡ï¼Œè¿™äº›éƒ½å¯ä»¥æŸ¥è¯¢ï¼Œæ ¹æ®è¿™äº›æŒ‡æ ‡å†æ¬¡åŠ¨æ€è°ƒæ•´ã€‚</li>
</ol>
<p>é’ˆå¯¹ä¸Šé¢æå‡ºçš„é—®é¢˜ï¼Œæˆ‘ä»¬è‡ªå·±å»å†™è¿™æ ·ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ä¸”ç¨³å®šçš„åŠŸèƒ½ï¼Œå®é™…ä¸­è¿˜æ˜¯æ¯”è¾ƒå›°éš¾çš„ã€‚æŒ‰ç…§é€šå¸¸çš„ Service å’Œ Dao çš„å†™æ³•ï¼Œæ»¡è¶³ä¸äº†æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>
<h3 id="spring-batch-æ ¸å¿ƒåŠŸèƒ½çš„ä»‹ç»">Spring Batch æ ¸å¿ƒåŠŸèƒ½çš„ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#spring-batch-æ ¸å¿ƒåŠŸèƒ½çš„ä»‹ç»">#</a></h3>
<p>Spring Batch æ˜¯ Spring å®˜æ–¹çš„ä¸€ä¸ªä¸“é—¨ç”¨äºå¤„ç†å¤§æ•°æ®ä½“é‡ä¸‹æ•°æ®è¿ç§»çš„å¼€æºæ¡†æ¶ï¼Œä¸»è¦è§£å†³çš„é—®é¢˜å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„é‚£äº›é—®é¢˜ï¼Œé€šè¿‡åˆ†æ‰¹è¯»å–å’Œå†™æ•°æ®ï¼Œä¿è¯å†…å­˜ä¸ä¼šå‘ç”Ÿæº¢å‡ºã€‚å¹¶ä¸”é€šè¿‡çµæ´»çš„ç»„ä»¶ç»„åˆï¼Œå¯ä»¥æ»¡è¶³æ•°æ®è¿ç§»ä¸­çš„å„ç§éœ€æ±‚ã€‚</p>
<h4 id="æ ¸å¿ƒçš„åŠŸèƒ½å’Œç‰¹ç‚¹">æ ¸å¿ƒçš„åŠŸèƒ½å’Œç‰¹ç‚¹<a hidden class="anchor" aria-hidden="true" href="#æ ¸å¿ƒçš„åŠŸèƒ½å’Œç‰¹ç‚¹">#</a></h4>
<ol>
<li>äº‹åŠ¡ç®¡ç†</li>
<li>åŸºäºåˆ†å—çš„å¤„ç†</li>
<li>å£°æ˜å¼ IO</li>
<li>å¯çµæ´»æ§åˆ¶å¼€å§‹ã€åœæ­¢ã€é‡å¯</li>
<li>é‡è¯•å’Œè·³è¿‡</li>
<li>åŸºäºç½‘é¡µçš„åå°ç®¡ç† Spring Cloud Data Flow</li>
</ol>
<p>Spring Batch çš„æ–‡æ¡£å¾ˆå…¨é¢ï¼Œä½†å¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œæ•´ä¸ªæ–‡æ¡£è¯»å®Œéœ€è¦è€—è´¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œè¿™é‡Œåªçœ‹ä¸¤å¼  Spring Batch çš„æ¶æ„å›¾ï¼Œåé¢æˆ‘ä¼šé€šè¿‡å®é™…å·¥ä½œä¸­çš„è¿ç§»æ¡ˆä¾‹æ¥è®²è§£æ€ä¹ˆä½¿ç”¨å®ƒã€‚</p>
<h4 id="æ¶æ„å›¾">æ¶æ„å›¾<a hidden class="anchor" aria-hidden="true" href="#æ¶æ„å›¾">#</a></h4>
<p><img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/8bd2ac90-2f8f-11ea-a6f3-07a41d160500.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p><img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/96a647d0-2f8f-11ea-a6f3-07a41d160500.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<p>ç¬¬ä¸€å¼ å›¾æ˜¯æ¶æ„å›¾ï¼Œç¬¬äºŒå¼ åˆ†åŒºå¤„ç†å›¾ã€‚</p>
<p>ä»è¿™ä¸¤å¼ å›¾å¯ä»¥çœ‹åˆ°è¿™æ­£æ˜¯æˆ‘ä»¬è¿ç§»å¤§æ•°æ®é‡ä¸‹çš„æ ¸å¿ƒè¯‰æ±‚ã€‚è¾“å…¥ç«¯æ˜¯ä»æ•°æ®æºè¯»å–æ•°æ®ï¼Œæ•°æ®æºå¯ä»¥æ¥æºäºæ–‡ä»¶æˆ–è€…æ•°æ®åº“ï¼Œä¸­é—´çš„å¤„ç†æµç¨‹æ˜¯å¯¹æ•°æ®è¿›è¡ŒåŠ å·¥ï¼Œå› ä¸ºæœ‰äº›æ•°æ®æˆ‘ä»¬éœ€è¦è¿›è¡Œè½¬æ¢å’Œå¤„ç†ï¼Œè¾“å‡ºç«¯æ˜¯å†™å‡ºæ•°æ®ï¼Œå¯ä»¥å†™å…¥åˆ°æ–‡ä»¶æˆ–è€…æ•°æ®åº“ã€‚</p>
<h4 id="æ ¸å¿ƒç»„ä»¶">æ ¸å¿ƒç»„ä»¶<a hidden class="anchor" aria-hidden="true" href="#æ ¸å¿ƒç»„ä»¶">#</a></h4>
<ol>
<li>Readerï¼šè´Ÿè´£æ•°æ®çš„è¯»å–</li>
<li>Processorï¼šè´Ÿè´£æ•°æ®çš„å¤„ç†</li>
<li>Writerï¼šè´Ÿè´£æ•°æ®çš„å†™å‡º</li>
<li>Stepï¼šæµç¨‹ç¼–æ’</li>
<li>Jobï¼šä»»åŠ¡é…ç½®</li>
</ol>
<p>è¿™äº›ä¸šåŠ¡ç»„ä»¶ç”¨æˆ‘ä»¬ç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥ç†è§£çš„è¯ï¼Œå¯ä»¥æƒ³è±¡ä¸€ä¸‹å¦‚ä¸‹çš„åœºæ™¯ï¼š</p>
<blockquote>
<p>æ•°æ®è¿ç§»å°±å¥½æ¯”ä»ä¸€ä¸ªæ²¹ç”°é‡Œè¿è¾“åŸæ²¹åˆ°ç‚¼æ²¹å‚ï¼Œæç‚¼å®Œæˆåæœ€ç»ˆæŠŠæˆå“æ²¹é€åˆ°åŠ æ²¹ç«™çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚åŸæ²¹åœ¨åˆ°æˆå“æ²¹çš„è¿‡ç¨‹ä¸­è¦ç»å†å¾ˆå¤šçš„æµç¨‹å’Œè¿è¾“æ­¥éª¤ï¼Œå°±åƒæˆ‘ä»¬çš„æ•°æ®è¦ç»è¿‡è½¬æ¢ä¸€æ ·ã€‚</p>
<p>Reader å°±å¥½æ¯”ä»æ²¹ç”°é‡Œå°†åŸæ²¹è£…ä¸Šè¿è¾“è½¦ï¼ŒProcessor å°±å¥½æ¯”å°†åŸæ²¹æç‚¼å‡ºæˆå“æ²¹ï¼ŒWriter å°±å¥½æ¯”å°†æ²¹è¿åˆ°åŠ æ²¹ç«™çš„æ²¹ç®±é‡Œï¼ŒStep å°±æ˜¯è¿™ä¸ªè£…æ²¹ -&gt; æç‚¼æ²¹ -&gt; è¿è¾“åˆ°åŠ æ²¹ç«™è¿™ä¸ªæµæ°´çº¿ä¸€æ ·çš„å¤„ç†æ­¥éª¤ï¼ŒJob ç›¸å½“ä¸ä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡å°±æ˜¯ Step å®šä¹‰å¥½çš„è¿™ä¸ªæµç¨‹ï¼Œä»»åŠ¡å¯ä»¥æ‰§è¡Œå¤šæ¬¡ï¼Œä½†æ˜¯æ¯ä¸€æ¬¡éƒ½æ˜¯æŒ‰ç…§æå‰å®šä¹‰å¥½çš„ Step æ¥æ‰§è¡Œã€‚</p>
</blockquote>
<h3 id="å®é™…ä¸­çš„ä¸šåŠ¡éœ€æ±‚æ€ä¹ˆå®ç°">å®é™…ä¸­çš„ä¸šåŠ¡éœ€æ±‚æ€ä¹ˆå®ç°<a hidden class="anchor" aria-hidden="true" href="#å®é™…ä¸­çš„ä¸šåŠ¡éœ€æ±‚æ€ä¹ˆå®ç°">#</a></h3>
<p>å¯ä»¥å…ˆä¸‹è½½æºç ï¼š</p>
<p><a href="https://gitee.com/smartGim/batchsrv">https://gitee.com/smartGim/batchsrv</a></p>
<h4 id="å…ˆä»å•è¡¨æ•°æ®å¤‡ä»½å¿«é€Ÿäº†è§£è¿ç§»æµç¨‹">å…ˆä»å•è¡¨æ•°æ®å¤‡ä»½å¿«é€Ÿäº†è§£è¿ç§»æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#å…ˆä»å•è¡¨æ•°æ®å¤‡ä»½å¿«é€Ÿäº†è§£è¿ç§»æµç¨‹">#</a></h4>
<p>è¿™ç§åœºæ™¯å¤šè§äºé¡¹ç›®åˆ›å»ºåˆæœŸä¸ºäº†å¿«é€Ÿä¸Šçº¿ï¼Œåœ¨é¡¹ç›®åˆæœŸæ²¡æœ‰åšåˆ†åº“åˆ†è¡¨ï¼ˆåœ¨é¡¹ç›®åˆæœŸä¸€èˆ¬ä¸ä¼šåšåˆ†åº“åˆ†è¡¨ï¼‰ï¼Œæ¯”å¦‚è®¢å•è¡¨ï¼Œè¿˜æœ‰é“¶è¡Œæµæ°´è¡¨ã€å†å²å¯¹è´¦æ•°æ®ã€æ”¯ä»˜è®°å½•æ•°æ®è¡¨ç­‰ã€‚è¿™ç§æ•°æ®çš„ç‰¹ç‚¹ä¸ºæ—¶é—´åœ¨åŠå¹´æˆ–è€…ä¸€å¹´ä»¥ä¸Šå°†å˜ä¸ºå†·æ•°æ®ï¼Œæ•°æ®æŸ¥è¯¢çš„æƒ…å†µæ¯”è¾ƒå°‘ï¼Œå¹¶ä¸”æ•°æ®ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦å°†æ—¶é—´å¤§äºä¸€å®šæ—¶æœŸçš„æ•°æ®å®šæ—¶å¤‡ä»½ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯æ¥æ‰‹ä¸€äº›å†å²é—ç•™çš„é¡¹ç›®ï¼Œæœ‰äº›æ•°æ®çš„å•è¡¨å·²ç»è¾¾åˆ°äº†ä¸€ä¸ªæé™ã€‚</p>
<p>æˆ‘ä»¬ä»¥ä¸€ä¸ªæ•°æ®åº“çš„æ•°æ® db_source è¿ç§»åˆ°å¦å¤–ä¸€ä¸ªæ•°æ®åº“ db_target ä¸ºä¾‹ï¼Œè¿ç§»è¿‡ç¨‹ä¸­åŒæ—¶åˆ é™¤å·²ç»è¿ç§»èµ°çš„è®°å½•ã€‚å¹¶å°†è¿ç§»çš„è¿‡ç¨‹å’Œè®°å½•è¿›è¡Œè®°å½•ä¸‹æ¥åˆ° db_source ä¸­ã€‚</p>
<p>å®ç°æ­¥éª¤ï¼š</p>
<p><strong>1. æ–°å»ºä¸€ä¸ª Spring Boot å·¥ç¨‹å¼•å…¥</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">batch</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableBatchProcessing</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BatchsrvApplication</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">BatchsrvApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ @EnableBatchProcessingã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šæ·»åŠ ä¸Šäº†æ­¤æ³¨è§£ï¼Œé‚£ä¹ˆé¡¹ç›®å¯åŠ¨å Spring Batch å°±ä¼šè‡ªåŠ¨åŒ–åˆå§‹ç›¸å…³çš„æ•°æ®åº“æ–‡ä»¶ï¼Œå¹¶ä¸”ç›´æ¥å¯åŠ¨ç›¸å…³çš„è¿ç§»ä»»åŠ¡ã€‚åœ¨å®é™…çš„çº¿ä¸Šè¿ç§»ä¸­æ˜¯ä¸ä¼šç›´æ¥ä¸Šçº¿åå°±è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡çš„ï¼Œé€šå¸¸ä¼šå…ˆé€šè¿‡æ‰‹åŠ¨æ‰§è¡Œæ¥çœ‹ä¸‹æ‰§è¡Œæƒ…å†µï¼Œå†åŠ¨æ€é…ç½®ä¸€äº›æŒ‡æ ‡ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„é¡¹ç›®ä¼šç¦ç”¨è‡ªåŠ¨æ‰§è¡Œï¼Œå¹¶ä¸”æ‰‹åŠ¨æ‰§è¡Œ Spring batch çš„æ•°æ®åº“æ–‡ä»¶ï¼Œæ•°æ®åº“åˆå§‹æ–‡ä»¶åœ¨ spring-batch-core ä¸­ï¼Œæ ¹æ®æ•°æ®åº“è¿›è¡Œé€‰æ‹©å³å¯ã€‚</p>
<p>ç¦ç”¨è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡é€‰é¡¹ï¼Œ<code>batch.job.enabled = false</code>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">server:</span>
</span></span><span class="line"><span class="cl">  <span class="n">port</span><span class="o">:</span> <span class="mi">8096</span>
</span></span><span class="line"><span class="cl"><span class="nl">spring:</span>
</span></span><span class="line"><span class="cl">  <span class="n">profiles</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">active</span><span class="o">:</span> <span class="n">dev</span>
</span></span><span class="line"><span class="cl">  <span class="n">batch</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">job</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">enabled</span><span class="o">:</span> <span class="kc">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2. å¤šæ•°æ®æºé…ç½®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">cn.gitchat.share.config</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Primary</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.core.env.Environment</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.DriverManagerDataSource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Author: Gim
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Date: 2019-12-04 17:05
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @Description:
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSourceConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Environment</span> <span class="n">env</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Primary</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DataSource</span> <span class="nf">primaryDatasource</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DriverManagerDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DriverManagerDataSource</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataSource</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;source.driver-class-name&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataSource</span><span class="o">.</span><span class="na">setUrl</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;source.jdbc-url&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataSource</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;source.username&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;source.password&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DataSource</span> <span class="nf">targetDatasource</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DriverManagerDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DriverManagerDataSource</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataSource</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;target.driver-class-name&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataSource</span><span class="o">.</span><span class="na">setUrl</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;target.jdbc-url&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataSource</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;target.username&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;target.password&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">JdbcTemplate</span> <span class="nf">primaryTemplate</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">JdbcTemplate</span><span class="o">(</span><span class="n">primaryDatasource</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">JdbcTemplate</span> <span class="nf">targetJdbcTemplate</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">JdbcTemplate</span><span class="o">(</span><span class="n">targetDatasource</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨å¤šæ•°æ®æºçš„é…ç½®ï¼Œå¹¶ä¸”ä½¿ç”¨ JdbcTemplate è¿›è¡Œæ•°æ®çš„è¯»å–ã€‚</p>
<p>ä¸»æ•°æ®æºä¸­é…ç½® Spring Batch çš„æ•°æ®åº“æ–‡ä»¶ï¼ˆå¦‚æœä¸åœ¨æ„è¿ç§»çš„æƒ…å†µè®°å½•å¯ä»¥ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼Œå­˜å‚¨ Spring Batch çš„è¿ç§»è®°å½•æƒ…å†µï¼Œè¿™æ ·èƒ½æé«˜è¿ç§»æ€§èƒ½ï¼Œä½†æ˜¯å®é™…ä¸­ä¸å»ºè®®åšï¼Œè¿ç§»æ€§èƒ½çš„å¤§å¹…æå‡ä¼šå½±å“çº¿ä¸Šçš„ä¸šåŠ¡æ­£å¸¸è¿è¡Œï¼Œé™¤éè¿ç§»æœ‰åŠæ—¶æ€§è¿™ç§éœ€æ±‚å†å¼€å¯å†…å­˜æ•°æ®æºï¼‰ã€‚</p>
<p><strong>å¦‚ä½•å®šåˆ¶ Spring Batch çš„æ¡†æ¶ä½¿ç”¨çš„æ•°æ®æºï¼Ÿ</strong></p>
<p>ä»æºç ä¸­æ‰¾åˆ°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BatchConfig</span> <span class="kd">extends</span> <span class="n">DefaultBatchConfigurer</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªç±»ç»§æ‰¿äº DefaultBatchConfigurer ç„¶åæˆ‘ä»¬å¯¹ JobRepository è¿›è¡Œé‡å†™ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//å°†spring batch çš„è®°å½•å­˜å–åœ¨ä¸»æ•°æ®æºä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">JobRepository</span> <span class="nf">createJobRepository</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">JobRepositoryFactoryBean</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JobRepositoryFactoryBean</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">factory</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">primaryDatasource</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">factory</span><span class="o">.</span><span class="na">setTransactionManager</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getTransactionManager</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">factory</span><span class="o">.</span><span class="na">afterPropertiesSet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">factory</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3. è¯»å–çš„é…ç½®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ•°æ®è¯»å– æ ¹æ®id æŸ¥è¯¢ä¿è¯æ€§èƒ½ åˆ†é¡µè¯»å–
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="nd">@StepScope</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">JdbcPagingItemReader</span><span class="o">&lt;</span><span class="n">PayRecord</span><span class="o">&gt;</span> <span class="nf">payRecordReader</span><span class="o">(</span><span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;#{jobParameters[minId]}&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">minId</span><span class="o">,</span> <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;#{jobParameters[maxId]}&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">maxId</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">JdbcPagingItemReader</span><span class="o">&lt;</span><span class="n">PayRecord</span><span class="o">&gt;</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JdbcPagingItemReader</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">SqlPagingQueryProviderFactoryBean</span> <span class="n">sqlPagingQueryProviderFactoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SqlPagingQueryProviderFactoryBean</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlPagingQueryProviderFactoryBean</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">primaryDatasource</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlPagingQueryProviderFactoryBean</span><span class="o">.</span><span class="na">setSelectClause</span><span class="o">(</span><span class="s">&#34;select * &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlPagingQueryProviderFactoryBean</span><span class="o">.</span><span class="na">setFromClause</span><span class="o">(</span><span class="s">&#34;from pay_record&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlPagingQueryProviderFactoryBean</span><span class="o">.</span><span class="na">setWhereClause</span><span class="o">(</span><span class="s">&#34;id &gt; &#34;</span> <span class="o">+</span> <span class="n">minId</span> <span class="o">+</span> <span class="s">&#34; and id &lt;= &#34;</span> <span class="o">+</span> <span class="n">maxId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlPagingQueryProviderFactoryBean</span><span class="o">.</span><span class="na">setSortKey</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">reader</span><span class="o">.</span><span class="na">setQueryProvider</span><span class="o">(</span><span class="n">sqlPagingQueryProviderFactoryBean</span><span class="o">.</span><span class="na">getObject</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">reader</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">primaryDatasource</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">reader</span><span class="o">.</span><span class="na">setPageSize</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getPageSize</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">reader</span><span class="o">.</span><span class="na">setRowMapper</span><span class="o">(</span><span class="k">new</span> <span class="n">PayRecordRowMapper</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">reader</span><span class="o">.</span><span class="na">afterPropertiesSet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">reader</span><span class="o">.</span><span class="na">setSaveState</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">reader</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>åœ¨è¯»å–çš„é…ç½®ä¸­æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹ï¼š</strong></p>
<ul>
<li>ç¬¬ä¸€ç‚¹å¯ä»¥çœ‹åˆ°åœ¨ @Bean ä¸‹æ–¹æœ‰ä¸ªæ³¨è§£ @StepScope è¿™ä¸ªæ³¨è§£çš„ä½œç”¨æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ Job æ‰§è¡Œæ—¶ç»™ Job æ·»åŠ å˜é‡ï¼Œç”¨äºæˆ‘ä»¬å¯ä»¥åŠ¨æ€çš„æ§åˆ¶æ¯æ¬¡ä»»åŠ¡è¦è¿ç§»çš„è®°å½•ï¼Œé€šè¿‡ <code>@Value (&quot;#{jobParameters [minId]}&quot;</code> è¿™ç§æ–¹å¼è¿›è¡Œæ¥æ”¶å‚æ•°ï¼Œä¼ é€’å‚æ•°å¯ä»¥åœ¨ä»»åŠ¡æ‰§è¡Œæ—¶è¿›è¡Œ Job ä¼ å‚ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Scheduled</span><span class="o">(</span><span class="n">cron</span> <span class="o">=</span> <span class="s">&#34;0 0 2 * * ?&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">migratePayRecord</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">primaryJdbcTemplate</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">queryForMap</span><span class="o">(</span><span class="s">&#34;select * from job_config where config_key = ?&#34;</span><span class="o">,</span> <span class="n">MigrateConstants</span><span class="o">.</span><span class="na">PAY_RECORD_JOB_CONFIG_KEY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;config_value&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">JobExecuteConfig</span> <span class="n">payRecordJobConfig</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">JobExecuteConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">JobParameters</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JobParametersBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLong</span><span class="o">(</span><span class="s">&#34;maxId&#34;</span><span class="o">,</span> <span class="n">payRecordJobConfig</span><span class="o">.</span><span class="na">getExecuteMaxId</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">addLong</span><span class="o">(</span><span class="s">&#34;minId&#34;</span><span class="o">,</span> <span class="n">payRecordJobConfig</span><span class="o">.</span><span class="na">getMinId</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">toJobParameters</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">jobLauncher</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">migratePayRecordJob</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¬¬äºŒç‚¹å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¯»å–æ•°æ®ä½¿ç”¨çš„æ˜¯ JdbcPagingItemReader è¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»çš„ç‰¹ç‚¹æ˜¯å¯ä»¥é€šè¿‡åˆ†é¡µçš„æ–¹å¼å¯¹æ•°æ®è®°å½•è¿›è¡Œè¯»å–ï¼Œä¿è¯ä¸ä¼šå†…å­˜æº¢å‡ºï¼Œè¿™é‡Œé¢ SortKey æ˜¯ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼Œä¸€å®šè¦ä¿è¯æ•°æ®çš„å”¯ä¸€æ€§ï¼Œè¿™ä¸ªç”¨äºä»»åŠ¡é‡æ–°å¯åŠ¨åˆ¤æ–­ä»å“ªå†æ¬¡å¼€å§‹ã€‚</li>
<li>PageSize æˆ‘ä»¬å¯ä»¥æ§åˆ¶æ¯ä¸€æ¬¡è¯»å–å¤šå°‘æ¡è®°å½•ï¼Œè¿™ä¸ªç”¨äºè°ƒä¼˜ç”¨ï¼Œæ ¹æ®å®é™…çš„æƒ…å†µè¿›è¡Œæ§åˆ¶ã€‚SaveState ç”¨äºå°†è¿ç§»çš„è®°å½•æƒ…å†µè¿›è¡Œè®°å½•ã€‚</li>
<li>è¿™ä¸ª Reader çš„é…ç½®éå¸¸é‡è¦æ˜¯ä¿è¯äº¿çº§åˆ«æ•°æ®ä¸ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºçš„å…³é”®é…ç½®ã€‚åœ¨è¿™é‡Œçš„é…ç½®ç›¸å½“äºæˆ‘ä»¬å¯¹å¤§æ•°é‡çº§åˆ«çš„æ•°æ®è¿›è¡Œäº†ä¸€ä¸ªåˆ†æ®µå¤„ç†ã€‚æ˜¯åˆ†è€Œæ²»ä¹‹çš„å…³é”®ç‚¹ã€‚</li>
</ul>
<p><strong>4. å†™å…¥çš„é…ç½®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å†™å…¥åˆ°æ–°åº“
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ItemWriter</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">PayRecord</span><span class="o">&gt;</span> <span class="nf">targetPayRecordWriter</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">JdbcBatchItemWriterBuilder</span><span class="o">&lt;</span><span class="n">PayRecord</span><span class="o">&gt;()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">dataSource</span><span class="o">(</span><span class="n">targetDatasource</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">itemSqlParameterSourceProvider</span><span class="o">(</span><span class="k">new</span> <span class="n">BeanPropertyItemSqlParameterSourceProvider</span><span class="o">&lt;&gt;())</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">sql</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;INSERT INTO `pay_record` (\n&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;`id`,\n&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;`user_id`,\n&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;`pay_detail`,\n&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;`pay_status`,\n&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;`create_time`,\n&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;`update_time`\n&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;)\n&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;VALUES\n&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;\t(\n&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;:id,&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;:userId,&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;:payDetail,&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;:payStatus,&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;:createTime,&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;:updateTime&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">+</span> <span class="s">&#34;)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åˆ é™¤å™¨
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ItemWriter</span><span class="o">&lt;</span><span class="n">PayRecord</span><span class="o">&gt;</span> <span class="nf">deletePayRecordWriter</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">JdbcBatchItemWriterBuilder</span><span class="o">&lt;</span><span class="n">PayRecord</span><span class="o">&gt;()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">dataSource</span><span class="o">(</span><span class="n">primaryDatasource</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">itemSqlParameterSourceProvider</span><span class="o">(</span><span class="k">new</span> <span class="n">BeanPropertyItemSqlParameterSourceProvider</span><span class="o">&lt;&gt;())</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">&#34;delete from pay_record where id = :id&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">CompositeItemWriter</span><span class="o">&lt;</span><span class="n">PayRecord</span><span class="o">&gt;</span> <span class="nf">compositePayRecordItemWriter</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;deletePayRecordWriter&#34;</span><span class="o">)</span> <span class="n">ItemWriter</span> <span class="n">deleteWriter</span><span class="o">,</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;targetPayRecordWriter&#34;</span><span class="o">)</span> <span class="n">ItemWriter</span> <span class="n">targetPayRecordWriter</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CompositeItemWriter</span><span class="o">&lt;</span><span class="n">PayRecord</span><span class="o">&gt;</span> <span class="n">compositeItemWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CompositeItemWriter</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">ItemWriter</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">PayRecord</span><span class="o">&gt;&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">deleteWriter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">targetPayRecordWriter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">compositeItemWriter</span><span class="o">.</span><span class="na">setDelegates</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">compositeItemWriter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†™å…¥çš„é…ç½®è¿™é‡Œé¢ä½¿ç”¨äº†ä¸¤ä¸ªé…ç½®ï¼Œä¸€ä¸ªæ˜¯å†™å…¥æ–°çš„æ•°æ®æºï¼Œä¸€ä¸ªæ˜¯åˆ é™¤åŸæ¥çš„è¿ç§»æ•°æ®è¿æ¥çš„æ˜¯åŸæ¥çš„ä¸»æ•°æ®æºã€‚å†™å…¥å™¨ä½¿ç”¨çš„æ˜¯æ¡†æ¶æä¾›çš„ JdbcBatchItemWriter ï¼Œçœ‹åå­—å°±çŸ¥é“è¿™ä¸ªç±»çš„ä½œç”¨äº†ï¼Œå®ƒæ”¯æŒæ‰¹é‡çš„å†™å…¥ï¼Œæ€§èƒ½éå¸¸é«˜ã€‚Spring Batch æ”¯æŒå„ç§ Writer çš„ç»„åˆï¼Œé€šè¿‡ CompositeItemWriter æ¥å®ç°ã€‚åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºç»„åˆ Writer çš„ç”¨æ³•ï¼Œå®é™…ä¸­æœ€å¥½åˆ†æˆä¸¤æ­¥æ¥å®Œæˆè¿™ç§ä»»åŠ¡ã€‚</p>
<p><strong>5. Step çš„é…ç½®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Step</span> <span class="nf">migratePayRecordStep</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;payRecordReader&#34;</span><span class="o">)</span> <span class="n">JdbcPagingItemReader</span><span class="o">&lt;</span><span class="n">PayRecord</span><span class="o">&gt;</span> <span class="n">payRecordReader</span><span class="o">,</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;compositePayRecordItemWriter&#34;</span><span class="o">)</span> <span class="n">CompositeItemWriter</span> <span class="n">compositeItemWriter</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">stepBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;migratePayRecordStep&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.&lt;</span><span class="n">PayRecord</span><span class="o">,</span> <span class="n">PayRecord</span><span class="o">&gt;</span><span class="n">chunk</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getChunkSize</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">reader</span><span class="o">(</span><span class="n">payRecordReader</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">processor</span><span class="o">(</span><span class="k">new</span> <span class="n">PassThroughItemProcessor</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">writer</span><span class="o">(</span><span class="n">compositeItemWriter</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">taskExecutor</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleAsyncTaskExecutor</span><span class="o">(</span><span class="s">&#34;migrate_thread&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">throttleLimit</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getThreadSize</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åƒä¸Šé¢è®²åˆ°çš„é‚£æ · Step çš„ä½œç”¨å°±æ˜¯é…ç½®æ•´ä¸ªæµç¨‹çš„ï¼Œè¿™é‡Œé¢ chunk æ˜¯å¯¹æ•°æ®è¿›è¡Œåˆ†å—ï¼Œå¯ä»¥åŠ¨æ€çš„æ§åˆ¶æ¯æ¬¡äº‹åŠ¡æäº¤å¤šå°‘æ¡è®°å½•ã€‚</p>
<p>Processor æ˜¯å¤„ç†å™¨ã€‚ è¿™é‡Œé¢ç›´æ¥ä¼ é€’äº†ä¸€ä¸ª PassThroughItemProcessor ï¼Œè¿™ä¸ªç±»çš„ä½œç”¨æ˜¯å¯¹ä¼ é€’è¿‡æ¥çš„å¯¹è±¡ä¸åšä»»ä½•çš„å¤„ç†ã€‚å¦‚æœæˆ‘ä»¬æƒ³å¯¹åŸæœ‰çš„è®°å½•è¿›è¡Œæ‰©å±•ï¼Œé‚£ä¹ˆå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªå¤„ç†å™¨ï¼Œæ¯”å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PayRecordExtProcessor</span> <span class="kd">implements</span> <span class="n">ItemProcessor</span><span class="o">&lt;</span><span class="n">PayRecord</span><span class="o">,</span><span class="n">PayRecordExt</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">PayRecordExt</span> <span class="nf">process</span><span class="o">(</span><span class="n">PayRecord</span> <span class="n">payRecord</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//other service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PayRecordExt</span> <span class="n">ext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PayRecordExt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ext</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™é‡Œè¿›è¡Œæ•°æ®å¤„ç†ã€‚</p>
<p>taskExecutor è¿™ä¸ªæ˜¯çº¿ç¨‹æ± çš„é…ç½®ã€‚å› ä¸ºæ¯æ¡è®°å½•çš„è¯»å–ã€å¤„ç†ã€å†™å…¥éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œäº’ç›¸ä¹‹é—´æ²¡æœ‰ä»»ä½•çš„å½±å“ï¼Œæ‰€ä»¥ä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥å®ç°æµç¨‹çš„å¹¶è¡Œå¤„ç†ï¼Œæé«˜å¤„ç†é€Ÿåº¦ã€‚throttleLimit ç”¨æ¥æ§åˆ¶æœ€å¤§çš„çº¿ç¨‹æ•°ã€‚çº¿ç¨‹å¤ªå¤šäº†ä¼šé€ æˆèµ„æºçš„æµªè´¹ã€‚</p>
<p><strong>6. Job çš„é…ç½®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Job</span> <span class="nf">migratePayRecordJob</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;migratePayRecordStep&#34;</span><span class="o">)</span> <span class="n">Step</span> <span class="n">step</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">jobBuilderFactory</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;migratePayRecordJob&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">step</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">incrementer</span><span class="o">(</span><span class="k">new</span> <span class="n">RunIdIncrementer</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Job ç”¨äºå°† step é…ç½®å¥½çš„æµç¨‹å‘å¤–ä»¥ä»»åŠ¡çš„å½¢å¼æš´éœ²ã€‚</p>
<p><strong>7. å¦‚ä½•å¯åŠ¨ Job</strong></p>
<p>é»˜è®¤æƒ…å†µä¸‹ Spring Batch ä¼šè‡ªåŠ¨å¯åŠ¨ä»»åŠ¡ï¼Œä¸Šé¢æåˆ°äº†ï¼Œåœ¨çº¿ä¸Šæ—¶ä¸€å®šä¸è¦è‡ªåŠ¨å¯åŠ¨ä»»åŠ¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PayRecordTask</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Job</span> <span class="n">migratePayRecordJob</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">JobLauncher</span> <span class="n">jobLauncher</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">&#34;primaryTemplate&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">JdbcTemplate</span> <span class="n">primaryJdbcTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *è¿ç§»ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Scheduled</span><span class="o">(</span><span class="n">cron</span> <span class="o">=</span> <span class="s">&#34;0 0 2 * * ?&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">migratePayRecord</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">primaryJdbcTemplate</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">queryForMap</span><span class="o">(</span><span class="s">&#34;select * from job_config where config_key = ?&#34;</span><span class="o">,</span> <span class="n">MigrateConstants</span><span class="o">.</span><span class="na">PAY_RECORD_JOB_CONFIG_KEY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;config_value&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">JobExecuteConfig</span> <span class="n">payRecordJobConfig</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">JobExecuteConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">JobParameters</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JobParametersBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">addLong</span><span class="o">(</span><span class="s">&#34;maxId&#34;</span><span class="o">,</span> <span class="n">payRecordJobConfig</span><span class="o">.</span><span class="na">getExecuteMaxId</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">addLong</span><span class="o">(</span><span class="s">&#34;minId&#34;</span><span class="o">,</span> <span class="n">payRecordJobConfig</span><span class="o">.</span><span class="na">getMinId</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">toJobParameters</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">jobLauncher</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">migratePayRecordJob</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * æ‰§è¡Œè¿ç§»ä»»åŠ¡ä¹‹å‰æ•°æ®è¿ç§»é…ç½®åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="cm">     * å‡Œæ™¨ä¸€ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Scheduled</span><span class="o">(</span><span class="n">cron</span> <span class="o">=</span> <span class="s">&#34;0 0 1 * * ?&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBillMigrateConfig</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//TODO æ ¹æ®å®é™…éœ€è¦çš„ä¸šåŠ¡é€»è¾‘åŠ¨æ€è®¡ç®—å‡ºï¼Œæ¯æ¬¡è¦è¿ç§»çš„æ•°æ®æ˜¯å“ªäº›  ï¼Œæœ€å¥½æ ¹æ®æ—¶é—´ç®—å‡ºMaxId, ç„¶åæ¯å¤©æ‰§è¡Œå›ºå®šçš„æ­¥é•¿ ï¼Œæ¯”å¦‚æ¯å¤©è¿ç§»100ä¸‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ @EnableBatchProcessing ä¹‹åï¼ŒSpring Batch ä¼šåœ¨å®¹å™¨ä¸­è‡ªåŠ¨æ³¨å…¥ Spring Batch çš„ç»„ä»¶ï¼Œè¿™é‡Œé¢æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ JobLauncher è¿›è¡Œä»»åŠ¡çš„å¯åŠ¨ï¼Œåœ¨å¯åŠ¨æ—¶å¯ä»¥é…ç½®ä»»åŠ¡å¯åŠ¨çš„å‚æ•°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">JobParameters</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JobParametersBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">addLong</span><span class="o">(</span><span class="s">&#34;maxId&#34;</span><span class="o">,</span> <span class="n">payRecordJobConfig</span><span class="o">.</span><span class="na">getExecuteMaxId</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">addLong</span><span class="o">(</span><span class="s">&#34;minId&#34;</span><span class="o">,</span> <span class="n">payRecordJobConfig</span><span class="o">.</span><span class="na">getMinId</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">toJobParameters</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¼ é€’çš„å‚æ•°ï¼Œé€šè¿‡ @StepScope æ³¨è§£çš„ Bean å°±å¯ä»¥åŠ¨æ€è·å–è¿™ä¸ªå‚æ•°ã€‚</p>
<p><strong>8. Job å¦‚ä½•å¯åŠ¨ã€åœæ­¢ã€é‡å¯</strong></p>
<p>Job çš„å¦ä¸€ç§å¯åŠ¨å’Œåœæ­¢æ˜¯é€šè¿‡ç±» JobOperator è¿™ä¸ªç±»æ¥å®ç°çš„ï¼Œåœ¨å¯åŠ¨å’Œé‡å¯ä¹‹å‰è¦å°† Job æ³¨å†Œåˆ° JobRegistry ä¸­ï¼Œåœ¨ JobController ä¸­å¯ä»¥çœ‹åˆ°å…·ä½“çš„å®ç°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">JobRegistry</span> <span class="n">registry</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@PostConstruct</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">registry</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">DuplicateJobException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ReferenceJobFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReferenceJobFactory</span><span class="o">(</span><span class="n">migratePayRecordJob</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">registry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;startJob&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SneakyThrows</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">startJob</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;minId&#34;</span><span class="o">,</span> <span class="s">&#34;20&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;maxId&#34;</span><span class="o">,</span> <span class="s">&#34;50&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">executePayRecordId</span> <span class="o">=</span> <span class="n">jobOperator</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">&#34;migratePayRecordJob&#34;</span><span class="o">,</span> <span class="n">PropertiesConverter</span><span class="o">.</span><span class="na">propertiesToString</span><span class="o">(</span><span class="n">properties</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="s">&#34;æ“ä½œæˆåŠŸ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;stopJob&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SneakyThrows</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">stopJob</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">executePayRecordId</span><span class="o">,</span><span class="s">&#34;æ‰§è¡Œidä¸èƒ½ä¸ºç©ºï¼&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">jobOperator</span><span class="o">.</span><span class="na">stop</span><span class="o">(</span><span class="n">executePayRecordId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="s">&#34;æ“ä½œæˆåŠŸ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;restartJob&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SneakyThrows</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">restartJob</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">executePayRecordId</span><span class="o">,</span><span class="s">&#34;æ‰§è¡Œidä¸èƒ½ä¸ºç©ºï¼&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">jobOperator</span><span class="o">.</span><span class="na">restart</span><span class="o">(</span><span class="n">executePayRecordId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="s">&#34;æ“ä½œæˆåŠŸ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªç±»çš„æ–¹æ³•éå¸¸çš„ä¸°å¯Œï¼Œé™¤äº†èƒ½å¯åŠ¨æ‰§è¡Œå¤–è¿˜æœ‰å¤§é‡çš„ APIï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">getExecutions</span><span class="o">(</span><span class="kt">long</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchJobInstanceException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">getJobInstances</span><span class="o">(</span><span class="n">String</span> <span class="n">var1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">var2</span><span class="o">,</span> <span class="kt">int</span> <span class="n">var3</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchJobException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Set</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">getRunningExecutions</span><span class="o">(</span><span class="n">String</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchJobException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="nf">getParameters</span><span class="o">(</span><span class="kt">long</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchJobExecutionException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Long</span> <span class="nf">start</span><span class="o">(</span><span class="n">String</span> <span class="n">var1</span><span class="o">,</span> <span class="n">String</span> <span class="n">var2</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchJobException</span><span class="o">,</span> <span class="n">JobInstanceAlreadyExistsException</span><span class="o">,</span> <span class="n">JobParametersInvalidException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Long</span> <span class="nf">restart</span><span class="o">(</span><span class="kt">long</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">JobInstanceAlreadyCompleteException</span><span class="o">,</span> <span class="n">NoSuchJobExecutionException</span><span class="o">,</span> <span class="n">NoSuchJobException</span><span class="o">,</span> <span class="n">JobRestartException</span><span class="o">,</span> <span class="n">JobParametersInvalidException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Long</span> <span class="nf">startNextInstance</span><span class="o">(</span><span class="n">String</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchJobException</span><span class="o">,</span> <span class="n">JobParametersNotFoundException</span><span class="o">,</span> <span class="n">JobRestartException</span><span class="o">,</span> <span class="n">JobExecutionAlreadyRunningException</span><span class="o">,</span> <span class="n">JobInstanceAlreadyCompleteException</span><span class="o">,</span> <span class="n">UnexpectedJobExecutionException</span><span class="o">,</span> <span class="n">JobParametersInvalidException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="nf">stop</span><span class="o">(</span><span class="kt">long</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchJobExecutionException</span><span class="o">,</span> <span class="n">JobExecutionNotRunningException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="nf">getSummary</span><span class="o">(</span><span class="kt">long</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchJobExecutionException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">getStepExecutionSummaries</span><span class="o">(</span><span class="kt">long</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchJobExecutionException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getJobNames</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">JobExecution</span> <span class="nf">abandon</span><span class="o">(</span><span class="kt">long</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchJobExecutionException</span><span class="o">,</span> <span class="n">JobExecutionAlreadyRunningException</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ Spring Batch çš„ Admin ç®¡ç†ç³»ç»Ÿä¸­ä¸»è¦å°±æ˜¯é€šè¿‡è¿™ä¸ªç±»æ¥è·å–ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µã€‚</p>
<p><strong>9. æ€»ç»“</strong></p>
<p>é€šè¿‡ä¸Šé¢çš„æ¼”ç¤ºå¯ä»¥æ¸…æ¥šçš„çœ‹åˆ° Spring Batch çš„æ‰§è¡Œé€»è¾‘ï¼ŒSpring Batch å®šä¹‰äº†æ¨¡æ¿ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­åªéœ€è¦æŒ‰ç…§æ¥å£æä¾›ç›¸åº”çš„æ•°æ®æ¥æºå’Œè¾“å‡ºçš„æ¥å£å³å¯ã€‚å…¶ä»–çš„äº‹åŠ¡å¤„ç†ï¼Œå¤šçº¿ç¨‹æ± ï¼Œæ‰¹é‡å¤„ç†ï¼Œå†…å­˜æ§åˆ¶éƒ½ç”±æ¡†æ¶æ¥å®Œæˆã€‚é‚£ä¹ˆ Spring Batch æ˜¯æ€ä¹ˆæ ·ä¿è¯åœ¨å¤§æ•°æ®é‡çº§çš„æƒ…å†µä¸‹ï¼Œå†…å­˜ä¸æº¢å‡ºç„¶ååˆä¿è¯æ€§èƒ½çš„å‘¢ï¼Œä¸‹é¢ç”¨ä¸€å¼ å›¾è¿›è¡Œå±•ç¤º Spring Batch æ˜¯é€šè¿‡æ€ä¹ˆçš„å¤„ç†ï¼Œä¿è¯åœ¨æ•°æ®é‡å·¨å¤§çš„æƒ…å†µä¸‹ï¼Œé«˜æ€§èƒ½çš„è¿›è¡Œæ•°æ®çš„è¯»å†™çš„ã€‚</p>
<p><img loading="lazy" src="https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/assets/d9d2ef90-2f8f-11ea-b7a2-bd62e8fb625b.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"  />
</p>
<h4 id="å…¶ä»–ä¸šåŠ¡åœºæ™¯çš„æ‰©å±•">å…¶ä»–ä¸šåŠ¡åœºæ™¯çš„æ‰©å±•<a hidden class="anchor" aria-hidden="true" href="#å…¶ä»–ä¸šåŠ¡åœºæ™¯çš„æ‰©å±•">#</a></h4>
<p>åœ¨å®é™…ä¸­é¡¹ç›®å¤„ç†ä¸­ï¼Œæˆ‘ä»¬é¢å¯¹çš„ç³»ç»Ÿæƒ…å†µå¯èƒ½å¹¶ä¸æ˜¯ä¸€ä¸ªå•è¡¨è¿™æ ·ç®€å•çš„ä¸šåŠ¡æƒ…å†µï¼Œæ¯”å¦‚å¤šè¡¨åˆä¸€ã€ä¸€è¡¨åˆ†è¡¨ä¸ºå¤šè¡¨ï¼Œåœ¨è¿ç§»è¿‡ç¨‹ä¸­æ•°æ®å˜æ›´çš„æƒ…å½¢ã€‚é‚£ä¹ˆè¿™äº›åœºæ™¯è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p>
<p><strong>1. å¤šè¡¨åˆä¸€çš„åœºæ™¯</strong></p>
<p>åœ¨å¤šè¡¨åˆä¸€çš„åœºæ™¯ä¸‹ï¼Œå®é™…ä¸Šå¦‚ä½•ä¸¤å¼ è¡¨æœ‰å…³è”ï¼Œé‚£ä¹ˆé™„è¡¨ä¸Šä¸€å®šè¦å»ºç«‹ç´¢å¼•ã€‚æˆ‘ä»¬è¿˜æ˜¯ä¼šè®©æŸ¥è¯¢é€»è¾‘åœ¨ä¸»è¡¨ä¸Šï¼Œåƒä¸‡ä¸è¦ä½¿ç”¨ Join è”æŸ¥ï¼Œäº¿çº§åˆ«çš„æ•°æ®å¦‚ä½•è”æŸ¥ï¼Œé‚£ä¹ˆåŸºç¡€ç³»ç»Ÿå°±è¦å´©æºƒäº†ã€‚æ­¤æ—¶æˆ‘ä»¬éœ€è¦å°†éœ€è¦æ‹¼è£…çš„ä¸šåŠ¡é€»è¾‘æ”¾åœ¨ Processor é‡Œé¢ï¼Œæ¯”å¦‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹åœºæ™¯ä¸‹ï¼Œéœ€è¦å°† User çš„ä¿¡æ¯å†—ä½™åˆ°æ–°çš„ä¸€ä¸ªè¡¨ä¸­é‚£ä¹ˆåªéœ€è¦å°† UserService æ³¨å…¥åˆ° PayRecordExtProcessor ä¸­ï¼Œç„¶åå†é€šè¿‡ <code>userService.getId(payRecord.getUserId ())</code> è¿™ç§æ–¹å¼å» load ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·çš„ Id è‚¯å®šæœ‰ç´¢å¼•ï¼Œè¿™æ ·æŸ¥è¯¢æ€§èƒ½ä¸ä¼šæœ‰å¤ªå¤šçš„æŸè€—ã€‚è¿™ä¹Ÿæ˜¯ç°åœ¨å¤§å‚ä¸ºå•¥è¦æ±‚åœ¨ä¸šåŠ¡ç³»ç»Ÿå¼€å‘çš„è¿‡ç¨‹ä¸­å°½å¿«ä¸è¦ä½¿ç”¨ Join è”æŸ¥çš„åŸå› ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PayRecordExtProcessor</span> <span class="kd">implements</span> <span class="n">ItemProcessor</span><span class="o">&lt;</span><span class="n">PayRecord</span><span class="o">,</span><span class="n">PayRecordExt</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">PayRecordExt</span> <span class="nf">process</span><span class="o">(</span><span class="n">PayRecord</span> <span class="n">payRecord</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//æ­¤å¤„æ³¨å…¥ User service é€šè¿‡userService .getId(payRecord.getUserId());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PayRecordExt</span> <span class="n">ext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PayRecordExt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ext</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2. æ‹†åˆ†ä¸ºå¤šè¡¨çš„åœºæ™¯</strong></p>
<p>ç³»ç»Ÿæœ‰äº›æƒ…å†µä¸‹éœ€è¦å°†å•è¡¨æ‹†åˆ†ä¸ºå¤šè¡¨ï¼Œæ¯”å¦‚æ ¹æ®ç”¨æˆ· id åˆ†ç‰‡ï¼Œè¿™ç§æƒ…å†µä¸‹ Spring Batch æä¾›äº†ä¸€ä¸ªç±» ClassifierCompositeItemWriter å¯ä»¥æ ¹æ®æ¡ä»¶åŠ¨æ€é€‰æ‹© Writerï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿå°† pay_record è¿™ä¸ªè¡¨æ‹†åˆ†ä¸ºä¸¤ä¸ªè¡¨çš„åœºæ™¯ pay_record_1ã€pay_record2ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="nx">create</span> <span class="nx">TABLE</span>  <span class="nx">pay_record_1</span> <span class="nx">like</span>  <span class="nx">pay_record</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">create</span> <span class="nx">TABLE</span>  <span class="nx">pay_record_2</span> <span class="nx">like</span> <span class="nx">pay_record</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//æ ¹æ®æ¡ä»¶æ‹†åˆ†ä¸ºå¤šè¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kd">@Bean</span>
</span></span><span class="line"><span class="cl"> <span class="kr">public</span> <span class="nx">ClassifierCompositeItemWriter</span><span class="o">&lt;?</span> <span class="kr">super</span> <span class="nx">PayRecord</span><span class="o">&gt;</span> <span class="nx">classifierItemWriter</span><span class="p">(</span><span class="kd">@Qualifier</span><span class="p">(</span><span class="s2">&#34;payRecordOneWriter&#34;</span><span class="p">)</span> <span class="nx">ItemWriter</span> <span class="nx">payRecordOneWriter</span><span class="p">,</span><span class="kd">@Qualifier</span><span class="p">(</span><span class="s2">&#34;payRecordTwoWriter&#34;</span><span class="p">)</span> <span class="nx">ItemWriter</span> <span class="nx">payRecordTwoWriter</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">     <span class="nx">ClassifierCompositeItemWriter</span><span class="p">&lt;</span><span class="nt">PayRecord</span><span class="p">&gt;</span> <span class="nx">classifierCompositeItemWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ClassifierCompositeItemWriter</span><span class="p">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">     <span class="nx">classifierCompositeItemWriter</span><span class="p">.</span><span class="nx">setClassifier</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="nx">Classifier</span><span class="p">&lt;</span><span class="nt">PayRecord</span><span class="err">,</span> <span class="na">ItemWriter</span><span class="err">&lt;?</span> <span class="na">super</span> <span class="na">PayRecord</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">)</span> <span class="nx">record</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                 <span class="nx">ItemWriter</span><span class="o">&lt;?</span> <span class="kr">super</span> <span class="nx">PayRecord</span><span class="o">&gt;</span> <span class="nx">itemWriter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                 <span class="k">if</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">getId</span><span class="p">()</span> <span class="o">%</span><span class="mi">2</span> <span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">itemWriter</span> <span class="o">=</span> <span class="nx">payRecordOneWriter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                 <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">itemWriter</span> <span class="o">=</span> <span class="nx">payRecordTwoWriter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                 <span class="p">}</span>
</span></span><span class="line"><span class="cl">                 <span class="k">return</span> <span class="nx">itemWriter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">             <span class="p">});</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nx">classifierCompositeItemWriter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">@Bean</span>
</span></span><span class="line"><span class="cl"> <span class="kr">public</span> <span class="nx">Step</span> <span class="nx">splitPayRecordStep</span><span class="p">(</span><span class="kd">@Qualifier</span><span class="p">(</span><span class="s2">&#34;payRecordReader&#34;</span><span class="p">)</span> <span class="nx">JdbcPagingItemReader</span><span class="p">&lt;</span><span class="nt">PayRecord</span><span class="p">&gt;</span> <span class="nx">payRecordReader</span><span class="p">,</span> <span class="kd">@Qualifier</span><span class="p">(</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&#34;classifierItemWriter&#34;</span><span class="p">)</span> <span class="nx">ClassifierCompositeItemWriter</span> <span class="nx">itemWriter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stepBuilderFactory</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s2">&#34;splitPayRecordStep&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="p">.&lt;</span><span class="nt">PayRecord</span><span class="err">,</span> <span class="na">PayRecord</span><span class="p">&gt;</span><span class="nx">chunk</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">getChunkSize</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">             <span class="p">.</span><span class="nx">reader</span><span class="p">(</span><span class="nx">payRecordReader</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="p">.</span><span class="nx">processor</span><span class="p">(</span><span class="k">new</span> <span class="nx">PassThroughItemProcessor</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">             <span class="p">.</span><span class="nx">writer</span><span class="p">(</span><span class="nx">itemWriter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="p">.</span><span class="nx">taskExecutor</span><span class="p">(</span><span class="k">new</span> <span class="nx">SimpleAsyncTaskExecutor</span><span class="p">(</span><span class="s2">&#34;migrate_thread&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">             <span class="p">.</span><span class="nx">throttleLimit</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">getThreadSize</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">             <span class="p">.</span><span class="nx">build</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">@Bean</span>
</span></span><span class="line"><span class="cl"> <span class="kr">public</span> <span class="nx">Job</span> <span class="nx">splitPayRecordJob</span><span class="p">(</span><span class="kd">@Qualifier</span><span class="p">(</span><span class="s2">&#34;splitPayRecordStep&#34;</span><span class="p">)</span> <span class="nx">Step</span> <span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">jobBuilderFactory</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s2">&#34;splitPayRecordJob&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">step</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="p">.</span><span class="nx">incrementer</span><span class="p">(</span><span class="k">new</span> <span class="nx">RunIdIncrementer</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">             <span class="p">.</span><span class="nx">build</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™é‡Œé¢æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª ClassifierCompositeItemWriter æ ¹æ® Id % è¡¨ä¸ªæ•°è¿›è¡Œåˆ†ç‰‡ã€‚å…·ä½“çš„å®ç°å¯ä»¥çœ‹ä»£ç ã€‚</p>
<p><strong>3. è¿ç§»è¿‡ç¨‹ä¸­æ•°æ®æœ‰å˜æ›´å’Œå¢é‡çš„åœºæ™¯</strong></p>
<p>ä¸€èˆ¬æ¥è¯´æœ‰å•è¡¨æ€§èƒ½çš„è¡¨æ•°æ®ï¼Œéƒ½æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œéšç€æ—¶é—´çš„è¿ç§»ä¼šæœ‰å¤§é‡çš„å†·æ•°æ®ï¼Œä¸Šåƒä¸‡é¢‘ç¹å˜æ›´çš„åœºæ™¯è¿˜æ˜¯æ¯”è¾ƒå°‘çš„ã€‚å¦‚æœæƒ³ä¿è¯ç³»ç»Ÿä¸é—´æ–­è¿è¡Œï¼ŒåŒæ—¶åˆèƒ½è¿›è¡Œç³»ç»Ÿçš„è¿ç§»ï¼Œè¿ç§»å®Œæˆåå†è¿›è¡Œç”¨æˆ·æ— æ„ŸçŸ¥çš„åˆ‡æ¢ã€‚éœ€è¦è€ƒè™‘åˆ°è¿ç§»è¿‡ç¨‹ä¸­æœ‰å¢é‡å˜æ›´çš„æƒ…å†µã€‚è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä¸€èˆ¬å¼•å…¥ CDC (change data capture) ç»„ä»¶ã€‚æ¯”è¾ƒå¸¸ç”¨çš„å¦‚é˜¿é‡Œçš„ Canalã€Debeziumï¼Œè¿™ç§ä¸­é—´ä»¶ç›‘å¬æ•°æ®çš„å˜æ›´ã€‚å…³äºå®ƒä»¬çš„ä½¿ç”¨å¯ä»¥å»çœ‹å®˜æ–¹çš„æ–‡æ¡£ï¼Œéå¸¸çš„ç®€å•ï¼Œæ·»åŠ å¥½é…ç½®é¡¹å°±å¯ä»¥äº†ã€‚</p>
<p>é…ç½®å¥½åå°†å˜æ›´çš„æ•°æ®å†å¯¼å…¥çš„æ–°çš„æ•°æ®æºã€‚åˆ‡æ¢åå®Œæˆå†é€šè¿‡ Spring Batch è¿›è¡Œæ¯”å¯¹è¿ç§»çš„æ•°æ®å’Œå˜åŒ–æ•°æ®å°±å¯ä»¥äº†ã€‚å¦‚æœå˜åŒ–çš„é‡çº§ç‰¹åˆ«å¤§ï¼Œæœ€å¥½é€‰ç”¨ååŠå¤œï¼Œæ•°æ®å˜æ›´è¾ƒå°çš„æƒ…å†µä¸‹è¿›è¡Œæ•°æ®è¿ç§»ã€‚å› ä¸ºäº¿çº§åˆ«çš„æ•°æ®å®æ—¶åŒæ­¥è¿™ä¸ªæ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰¾ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆå³å¯ã€‚</p>
<h4 id="å¦‚ä½•æ§åˆ¶éƒ¨ç½²çš„å®ä¾‹ä¸åŒæ—¶è¿è¡Œ">å¦‚ä½•æ§åˆ¶éƒ¨ç½²çš„å®ä¾‹ä¸åŒæ—¶è¿è¡Œ<a hidden class="anchor" aria-hidden="true" href="#å¦‚ä½•æ§åˆ¶éƒ¨ç½²çš„å®ä¾‹ä¸åŒæ—¶è¿è¡Œ">#</a></h4>
<p>ä¸ºäº†ä¿è¯æœåŠ¡çš„å¯é æ€§ï¼Œé€šå¸¸æˆ‘ä»¬éƒ¨ç½²çš„è¿ç§»æœåŠ¡å®ä¾‹æ˜¯å¤šä¸ªçš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯æ•°æ®ä¸èƒ½è¿ç§»é‡å¤ã€‚åœ¨ Spring Batch é‡Œé¢ Job çš„æ¦‚å¿µç›¸å½“äºä»»åŠ¡ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µå« JobInstanceã€‚</p>
<p>ä»€ä¹ˆæ„æ€å‘¢ï¼Œä¸Šé¢æåˆ° Step ç›¸å½“äºé…ç½®çš„æµç¨‹ï¼ŒJob æ˜¯ä»»åŠ¡ï¼Œé‚£ä¹ˆä»»åŠ¡æ˜¯å¯èƒ½æœ‰å¤šä¸ªçš„ï¼Œå°±åƒä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥ new å‡ºæ¥å¤šä¸ªå¯¹è±¡ä¸€æ ·ã€‚ä¸€ä¸ª JonInstance åœ¨ç›¸åŒçš„ JobParameter ä¸‹åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚è¿™æ ·åœ¨å¤šå®ä¾‹çš„æƒ…å†µä¸‹ï¼Œå®é™…ä¸Šéƒ¨ç½²å¤šå°å®ä¾‹ä¹Ÿèƒ½æ§åˆ¶ä»»åŠ¡ä¸ä¼šé‡å¤æ‰§è¡Œï¼Œåªä¸è¿‡ä¼šæŠ¥ä¸€ä¸ªä»»åŠ¡å·²ç»å­˜åœ¨çš„å¼‚å¸¸ã€‚ä½†æ˜¯åœ¨å®é™…çš„é¡¹ç›®è¿ç§»ä¸­æˆ‘ä»¬å¸Œæœ› Job çš„å‚æ•°å¯ä»¥æ¯å¤©åŠ¨æ€è®¡ç®—ï¼Œæ¯”å¦‚åœ¨ä»»åŠ¡ä¹‹å‰æˆ‘ä»¬éœ€è¦åŠ¨æ€çš„è®¡ç®—å‡ºï¼Œä»Šå¤©çš„ä»»åŠ¡è¦è¿ç§»å“ªäº›æ•°æ®ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ‰§è¡Œè¿ç§»ä»»åŠ¡ä¹‹å‰æ•°æ®è¿ç§»é…ç½®åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å‡Œæ™¨ä¸€ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Scheduled</span><span class="o">(</span><span class="n">cron</span> <span class="o">=</span> <span class="s">&#34;0 0 1 * * ?&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">initMigrateConfig</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//TODO æ ¹æ®å®é™…éœ€è¦çš„ä¸šåŠ¡é€»è¾‘åŠ¨æ€è®¡ç®—å‡ºï¼Œæ¯æ¬¡è¦è¿ç§»çš„æ•°æ®æ˜¯å“ªäº›  ï¼Œæœ€å¥½æ ¹æ®æ—¶é—´ç®—å‡ºMaxId, ç„¶åæ¯å¤©æ‰§è¡Œå›ºå®šçš„æ­¥é•¿ ï¼Œæ¯”å¦‚æ¯å¤©è¿ç§»100ä¸‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åƒè¿™ç§ä»»åŠ¡å¦‚æœæ˜¯å¤šå°å®ä¾‹ï¼Œå¦‚æœä¸åŠ é”å®é™…ä¸Šä¼šæœ‰é—®é¢˜çš„ã€‚è¿™é‡Œé¢æˆ‘ä»¬å†å¼•å…¥ä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">net</span><span class="o">.</span><span class="na">javacrumbs</span><span class="o">.</span><span class="na">shedlock</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">shedlock</span><span class="o">-</span><span class="n">spring</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">4.1.0</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">net</span><span class="o">.</span><span class="na">javacrumbs</span><span class="o">.</span><span class="na">shedlock</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">shedlock</span><span class="o">-</span><span class="n">provider</span><span class="o">-</span><span class="n">jdbc</span><span class="o">-</span><span class="n">template</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">4.0.4</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">LockProvider</span> <span class="nf">lockProvider</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;primaryDatasource&#34;</span><span class="o">)</span> <span class="n">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">JdbcTemplateLockProvider</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨ JdbcTemplateLock å½“åšæˆ‘ä»¬çš„åˆ†å¸ƒå¼é”çš„å®ç°ã€‚è¿™æ ·é…ç½®ä¹‹åæˆ‘ä»¬çš„ä»»åŠ¡åœ¨åŒä¸€æ—¶é—´å°±åªä¼šåœ¨ä¸€ä¸ªå®ä¾‹ä¸Šè¿è¡Œäº†ã€‚</p>
<h4 id="å“ªäº›ç‚¹å¯ä»¥ä¼˜åŒ–">å“ªäº›ç‚¹å¯ä»¥ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#å“ªäº›ç‚¹å¯ä»¥ä¼˜åŒ–">#</a></h4>
<p>\1. æ¯æ¬¡å¯ä»¥æ§åˆ¶è¯»å–çš„æ¡æ•°ï¼Œæ¯æ¬¡äº‹åŠ¡æäº¤çš„ä¸ªæ•°ï¼Œæ¯ä¸ª Step å¯ç”¨çš„çº¿ç¨‹æ•°éƒ½å¯ä»¥è¿›è¡Œé…ç½®ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­æä¾›äº†ä¸€ä¸ªé…ç½®ç±»ï¼Œå¯ä»¥å¯¹è¿™äº›é…ç½®é¡¹è¿›è¡ŒåŠ¨æ€çš„é…ç½®ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;migrate.config&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Data</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MigrateConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//æ¯æ¬¡è¯»å–æ•°æ®æ¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//æ¯æ¬¡äº‹åŠ¡æäº¤è®°å½•æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">chunkSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">threadSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>\2. åœ¨è¿ç§»ä¹‹å‰ MySQL è¦æŸ¥çœ‹è¿æ¥æƒ…å†µï¼Œè®¾ç½®ç¼“å†²æ± å¤§å°ç­‰æŒ‡æ ‡ï¼Œè¿™ä¸ªä¹Ÿæ˜¯åœ¨è¿ç§»ä¹‹å‰è¦è€ƒè™‘çš„ç‚¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">show</span><span class="w"> </span><span class="n">processlist</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">innodb_buffer_pool_size</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="err">ç¼“å†²æ± å¤§å°</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;max_connections&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">set</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">max_connections</span><span class="o">=</span><span class="w"> </span><span class="err">æœ€å¤§è¿æ¥æ•°</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>\3. åƒä¸Šé¢æåˆ°çš„ Spring Batch åœ¨è¿ç§»è¿‡ç¨‹ä¸­ä¼šå°†ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µéƒ½åˆå§‹åŒ–åˆ°æ•°æ®åº“ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¸æƒ³è¦è¿™äº›æ•°æ®æŒä¹…åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€‰æ‹©å†…å­˜æ•°æ®åº“ï¼Œè¿™ä¸ªä¼šå¤§å¤§æå‡è¿ç§»çš„é€Ÿåº¦ï¼Œæ›´æ”¹æ•°æ®æºå³å¯ã€‚</p>
<h3 id="spring-cloud-data-flow-å…¥é—¨ç®€ä»‹">Spring Cloud Data Flow å…¥é—¨ç®€ä»‹<a hidden class="anchor" aria-hidden="true" href="#spring-cloud-data-flow-å…¥é—¨ç®€ä»‹">#</a></h3>
<p>Spring Cloud Data Flow è¿™ä¸ªæ˜¯ç°åœ¨ Spring åœ¨æ•°æ®æµå¤„ç†æ–¹é¢ä¸€ä¸ªåŠŸèƒ½éå¸¸å¼ºå¤§çš„æ¡†æ¶ã€‚ç›®å‰è¢« Spring æ”¾åœ¨äº†é¦–é¡µä¸Šï¼Œè·Ÿ Spring Cloud å¹¶åˆ—ã€‚åœ¨å•æœºæ¡ä»¶ä¸‹å¯¹ Spring Batch çš„æ”¯æŒæœ‰é™ï¼Œä¸æ”¯æŒä»»åŠ¡çš„åŠ¨æ€è°ƒåº¦ï¼Œæƒ³ä½¿ç”¨è°ƒåº¦éœ€è¦ K8s éƒ¨ç½²ï¼ŒSpring Cloud Data Flow åœ¨æœ¬æœºæ­å»ºæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯ç”¨ Dockerï¼Œä¸€ä¸ªæ˜¯ç›´æ¥å¯åŠ¨ jar åŒ…ã€‚å…·ä½“çš„ jar åŒ…æˆ‘æ”¾åœ¨äº†é¡¹ç›®çš„ resources ä¸‹é¢ã€‚</p>
<p>å¦‚æœä½¿ç”¨ Dockerï¼Œcd åˆ° dataflow ç›®å½•ä¸‹è¿è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">export</span> <span class="n">DATAFLOW_VERSION</span><span class="o">=</span><span class="mf">2.2.1</span><span class="o">.</span><span class="na">RELEASE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">export</span> <span class="n">SKIPPER_VERSION</span><span class="o">=</span><span class="mf">2.1.2</span><span class="o">.</span><span class="na">RELEASE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœä¸ä½¿ç”¨ Docker è€Œé€‰æ‹©ç›´æ¥è¿è¡Œ jar åŒ…ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">java -jar spring-cloud-skipper-server-2.1.2.RELEASE.jar
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">java -jar spring-cloud-dataflow-server-2.2.1.RELEASE.jar
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰“å¼€æµè§ˆå™¨ è¾“å…¥ http://localhost:9393/dashboard/ å³å¯è®¿é—®æ§åˆ¶å°ã€‚</p>
<p>æ³¨æ„ä¸€ç‚¹ï¼šå¦‚æœéœ€è¦ä½¿ç”¨ Spring Batch Job éœ€è¦é›†æˆ Spring Cloud Taskï¼Œå®é™…çš„é¡¹ç›®ä¸­ä½¿ç”¨ JobOperator å³å¯ï¼Œè¿™ä¸ª UI ä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸ªç±»è¿›è¡Œ UI å±•ç¤ºçš„ã€‚å¦‚æœå¯¹è¿™ä¸ªæ„Ÿå…´è¶£çš„å¯ä»¥å»æ¢ç´¢ã€‚</p>
<p>åœ¨å®é™…çš„è¿ç§»è¿‡ç¨‹ä¸­å¯ä»¥æŸ¥è¯¢åœ¨é¡¹ç›®å¯åŠ¨æ—¶åˆå§‹åŒ–é‚£å‡ å¼ è¡¨ï¼ŒSpring Batch ä¼šæŠŠæ¯æ¬¡æ‰§è¡Œçš„å‚æ•°å’Œæ‰§è¡Œæƒ…å†µå…¨éƒ¨åˆå§‹åŒ–åˆ°æ•°æ®åº“è¡¨ä¸­ä»¥ BATCH_å¼€å¤´çš„è¡¨ä¸­ã€‚</p>
<h3 id="é¡¹ç›®ä»£ç åœ°å€">é¡¹ç›®ä»£ç åœ°å€<a hidden class="anchor" aria-hidden="true" href="#é¡¹ç›®ä»£ç åœ°å€">#</a></h3>
<blockquote>
<p><a href="https://gitee.com/smartGim/batchsrv">https://gitee.com/smartGim/batchsrv</a></p>
</blockquote>
<p>è¯¥é¡¹ç›®æ˜¯ Spring Boot é¡¹ç›®ï¼Œæ‰“å¼€ application-dev.yml ä¸­æŒ‰ç…§è¦æ±‚åˆ›å»ºè‡ªå·±çš„æ•°æ®åº“ï¼Œdb æ–‡ä»¶åœ¨ resources/db æ–‡ä»¶ä¸‹ï¼Œsource_db å¼€å¤´çš„åˆå§‹åŒ–åˆ° source æ•°æ®åº“ä¸­ï¼Œtarget_db å¼€å¤´çš„åˆå§‹åŒ–åˆ° target æ•°æ®åº“ä¸­å³å¯ã€‚</p>
<p>å®æˆ˜ä»£ç å¹¶éç†è®ºçš„è®²è§£ï¼Œæ‰€ä»¥è¯·åŠ¡å¿…æŸ¥çœ‹æºç è¿›è¡Œç»ƒä¹ ã€‚</p>
<p>å¦‚ä½•è¿›è¡Œæµ‹è¯•ï¼Œåœ¨ jobconfig è¡¨ä¸­æ›´æ”¹ minId å’Œ maxIdï¼Œè¿™ä¸ªæ˜¯æ§åˆ¶è¦è¿ç§»å“ªäº›æ•°æ®çš„ï¼Œä½ ä¹Ÿå¯ä»¥å†™ä¸ªè‡ªåŠ¨åŒ–çš„ä»»åŠ¡å»æ¯å¤©åŠ¨æ€æ›´æ–°è¿™ä¸ªé…ç½®é¡¹ã€‚</p>
<p>åœ¨ web åŒ…ä¸‹æœ‰ JobController æ˜¯å‰ç«¯çš„å…¥å£ï¼Œç”¨äºæœ¬åœ°çš„æµ‹è¯•ï¼Œå¯ä»¥é€šè¿‡ Postman ç­‰å·¥å…·ç›´æ¥å‘é€è¯·æ±‚å³å¯ã€‚</p>
<p>å¦‚æœåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­æœ‰ä»»ä½•é—®é¢˜å¯ä»¥æ Issueã€‚</p>
<h3 id="å…¶ä»–å­¦ä¹ çš„èµ„æº">å…¶ä»–å­¦ä¹ çš„èµ„æº<a hidden class="anchor" aria-hidden="true" href="#å…¶ä»–å­¦ä¹ çš„èµ„æº">#</a></h3>
<p>ä¸€ä¸ªä¸é”™çš„ç¤ºä¾‹é¡¹ç›®ï¼š</p>
<blockquote>
<p><a href="https://github.com/pkainulainen/spring-batch-examples.git">https://github.com/pkainulainen/spring-batch-examples.git</a></p>
</blockquote>
<p>å¦‚æœæƒ³å†™å…¥åˆ° Excelï¼ŒSpring Batch ä¹Ÿæ”¯æŒ Excelï¼ŒES çš„æ‰©å±•ï¼š</p>
<blockquote>
<p><a href="https://github.com/spring-projects/spring-batch-extensions.git">https://github.com/spring-projects/spring-batch-extensions.git</a></p>
</blockquote>
<p>å®˜æ–¹çš„ Samplesï¼š</p>
<blockquote>
<p><a href="https://github.com/spring-projects/spring-batch.git">https://github.com/spring-projects/spring-batch.git</a></p>
</blockquote>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://habyss.github.io/posts/read/linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Linuxæ€§èƒ½ä¼˜åŒ–</span>
  </a>
  <a class="next" href="https://habyss.github.io/posts/read/mysql%E5%9C%B0%E5%9F%BA_%E4%BC%98%E5%8C%96/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>MySQLè¡¥å……</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://habyss.github.io/">å¶ç°ç°çš„å°çª</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
